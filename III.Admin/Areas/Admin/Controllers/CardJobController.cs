using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Net;
using System.Threading.Tasks;
using ESEIM.Models;
using ESEIM.Utils;
using FTU.Utils.HelperNet;
using III.Domain.Enums;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Localization;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using EntityFrameworkCore.MemoryJoin;
using System.Data;
using Microsoft.AspNetCore.Authorization;

namespace III.Admin.Controllers
{
    [Area("Admin")]
    public class CardJobController : Controller
    {
        private readonly EIMDBContext _context;
        private readonly IUploadService _upload;
        private readonly IHostingEnvironment _hostingEnvironment;
        private readonly ICardJobService _cardService;
        private readonly IFCMPushNotification _notification;
        private readonly IGoogleApiService _googleAPI;
        private readonly IStringLocalizer<CardJobController> _stringLocalizer;
        private readonly IStringLocalizer<SharedResources> _sharedResources;
        private readonly IStringLocalizer<ProjectController> _stringLocalizerProject;
        private readonly IStringLocalizer<CustomerController> _stringLocalizerCustomer;
        private readonly IStringLocalizer<SupplierController> _stringLocalizerSupplier;
        private readonly IStringLocalizer<ContractController> _stringLocalizerContract;
        private readonly IStringLocalizer<SendRequestWorkPriceController> _stringLocalizerRQWPrice;
        private readonly IStringLocalizer<ContractPoController> _stringLocalizerContractPO;
        private readonly IStringLocalizer<OrderRequestRawController> _stringLocalizerRQRaw;
        private readonly IStringLocalizer<ServiceCategoryController> _stringLocalizerSVC;
        private readonly IStringLocalizer<MaterialProductController> _stringLocalizerMaterialProd;
        private readonly IStringLocalizer<StaffTimeKeepingController> _staffTimeKeepingController;
        private readonly IStringLocalizer<EDMSRepositoryController> _stringLocalizerEDMSFile;
        private readonly IRepositoryService _repositoryService;
        private static AsyncLocker<string> objLock = new AsyncLocker<string>();
        public readonly string module_name = "CARD_JOB";
        public string path_upload_file = "";
        public string repos_code = "";
        public string cat_code = "";
        public int host_type = 1;
        public IActionResult Index()
        {
            return View();
        }
        public CardJobController(EIMDBContext context, IUploadService upload, IHostingEnvironment hostingEnvironment,
            ICardJobService cardService, IFCMPushNotification notification, IGoogleApiService googleAPI,
            IStringLocalizer<CardJobController> stringLocalizer, IStringLocalizer<SharedResources> sharedResources,
            IStringLocalizer<ProjectController> stringLocalizerProject, IStringLocalizer<CustomerController> stringLocalizerCustomer,
            IStringLocalizer<SupplierController> stringLocalizerSupplier, IStringLocalizer<ContractController> stringLocalizerContract,
            IStringLocalizer<SendRequestWorkPriceController> stringLocalizerRQWPrice, IStringLocalizer<ContractPoController> stringLocalizerContractPO,
            IStringLocalizer<OrderRequestRawController> stringLocalizerRQRaw, IStringLocalizer<ServiceCategoryController> stringLocalizerSVC,
            IStringLocalizer<MaterialProductController> stringLocalizerMaterialProd, IStringLocalizer<StaffTimeKeepingController> staffTimeKeepingController,
            IStringLocalizer<EDMSRepositoryController> stringLocalizerEDMSFile, IRepositoryService repositoryService)
        {
            _context = context;
            _upload = upload;
            _hostingEnvironment = hostingEnvironment;
            _cardService = cardService;
            _notification = notification;
            _googleAPI = googleAPI;
            _stringLocalizer = stringLocalizer;
            _sharedResources = sharedResources;
            _stringLocalizerProject = stringLocalizerProject;
            _stringLocalizerCustomer = stringLocalizerCustomer;
            _stringLocalizerSupplier = stringLocalizerSupplier;
            _stringLocalizerContract = stringLocalizerContract;
            _stringLocalizerRQWPrice = stringLocalizerRQWPrice;
            _stringLocalizerContractPO = stringLocalizerContractPO;
            _stringLocalizerRQRaw = stringLocalizerRQRaw;
            _stringLocalizerSVC = stringLocalizerSVC;
            _stringLocalizerMaterialProd = stringLocalizerMaterialProd;
            _staffTimeKeepingController = staffTimeKeepingController;
            _stringLocalizerEDMSFile = stringLocalizerEDMSFile;
            _repositoryService = repositoryService;
            var obj = (EDMSCatRepoSetting)_upload.GetPathByModule(module_name).Object;
            repos_code = obj.ReposCode;
            cat_code = obj.CatCode;
            if (obj.Path == "")
            {
                host_type = 1;
                path_upload_file = obj.FolderId;
            }
            else
            {
                host_type = 0;
                path_upload_file = obj.Path;
            }
        }
        #region CardJobLink
        [HttpPost]
        public object GetAllCardJob()
        {
            //var data = _context.WORKOSCards.Where(x => !x.IsDeleted).Select(x => new { x.CardCode, x.CardName }).ToList();
            var data = from a in _context.WORKOSCards.Where(x => !x.IsDeleted && x.Status != "TRASH")
                       select new
                       {
                           Code = a.CardCode,
                           Name = a.CardName,
                           Status = _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.Status).ValueSet,
                           EndDate = a.EndTime.HasValue ? a.EndTime.Value.ToString("dd/MM/yyyy") : ""
                       };
            return data;
        }
        public class LinkCardJob
        {
            public string cardCode { get; set; }
        }
        [HttpPost]
        public JsonResult GetListLinkCardJob([FromBody] LinkCardJob jtablePara)
        {
            var query = (from a in _context.JobCardLinks
                         join b in _context.WORKOSCards on a.CardLink equals b.CardCode
                         where a.IsDeleted == false && b.IsDeleted == false && a.CardCode == jtablePara.cardCode
                         select new
                         {
                             a.Id,
                             b.CardCode,
                             b.CardName
                         });

            return Json(query);
        }
        public class InsertCardJobLink
        {
            public string cardCode { get; set; }
            public string cardLink { get; set; }
        }
        [HttpPost]
        public JsonResult InsertLinkCardJob([FromBody] InsertCardJobLink obj)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var data = _context.JobCardLinks.FirstOrDefault(x => !x.IsDeleted && x.CardCode == obj.cardCode && x.CardLink == obj.cardLink);
                if (data == null)
                {
                    JobCardLink cardLinkObj = new JobCardLink()
                    {
                        CardCode = obj.cardCode,
                        CardLink = obj.cardLink,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now,
                    };
                    _context.JobCardLinks.Add(cardLinkObj);

                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "ADD",
                        IdObject = "CARDLINK",
                        IsCheck = true,
                        CardCode = obj.cardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Thẻ việc liên kết " + _context.WORKOSCards.FirstOrDefault(x => x.CardCode == obj.cardLink).CardName
                    };
                    _context.CardUserActivities.Add(activity);
                    UpdateChangeCard(obj.cardCode);
                    _context.SaveChanges();
                    msg.Title = _stringLocalizer["CJ_MSG_ADD_LINK_SUCCESS"];
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_LINK_EXIST"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_ADD_FAILED"), _stringLocalize[""));//"Có lỗi xảy ra!";
            }
            return Json(msg);
        }
        [HttpPost]
        public JsonResult DeleteCardLink(int Id)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var userName = ESEIM.AppContext.UserName;
                //deleted card
                var data = _context.JobCardLinks.FirstOrDefault(x => x.Id == Id);
                data.IsDeleted = true;
                data.DeletedBy = ESEIM.AppContext.UserName;
                data.DeletedTime = DateTime.Now;
                _context.JobCardLinks.Update(data);

                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    Action = "DELETE",
                    IdObject = "CARDLINK",
                    IsCheck = true,
                    CardCode = data.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = "Thẻ việc liên kết " + _context.WORKOSCards.FirstOrDefault(x => x.CardCode == data.CardLink).CardName
                };
                _context.CardUserActivities.Add(activity);
                UpdateChangeCard(data.CardCode);
                _context.SaveChanges();
                msg.Title = _stringLocalizer["CJ_MSG_DELETE_LINK_SUCCESS"];

                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_DELETE_FAIL"), _stringLocalize["")); //"Có lỗi xảy ra!";
                msg.Object = ex;
                return Json(msg);
            }
        }
        #endregion

        #region Search
        public class AdvanceSearchObj : JTableModel
        {
            public string ListCode { get; set; }
            public string BoardCode { get; set; }
            public string CardName { get; set; }
            public string Member { get; set; }
            public string FromDate { get; set; }
            public string ToDate { get; set; }
            public string Status { get; set; }
            public string ObjDependency { get; set; }
            public string ObjCode { get; set; }
            public List<Properties> ListObjCode { get; set; }
            public int TabBoard { get; set; }
            public int Page { get; set; }
            public string Description { get; set; }
            public string Comment { get; set; }
            public string SubItem { get; set; }
            public string Object { get; set; }
            public string BranchId { get; set; }
            public string ObjType { get; set; }
            public string Project { get; set; }
            public string Department { get; set; }
            public string Group { get; set; }
            public string UserId { get; set; }
            public string Supplier { get; set; }
            public string Customer { get; set; }
            public string Contract { get; set; }
            public string UserName { get; set; }
            public string BoardSearch { get; set; }
            public int CurrentPageList { get; set; }
            public string WorkflowInstCode { get; set; }
            public string TimeType { get; set; }
            public bool TimeTypeCreated { get; set; }
            public bool TimeTypeStart { get; set; }
            public bool TimeTypeEnd { get; set; }
            public bool TimeTypeCompleted { get; set; }
        }
        #endregion

        #region Department
        [HttpPost]
        public object GetDepartment()
        {
            return _context.AdDepartments.Where(x => x.IsEnabled && !x.IsDeleted).Select(x => new
            {
                Code = x.DepartmentCode,
                Name = x.Title,
                Type = 2,
                Group = "Phòng ban"
            });
        }

        [HttpPost]
        public JsonResult GetDepartmentInBranch(string branch)
        {
            var list = new List<AssignObject>();
            var orgs = _context.AdOrganizations.FirstOrDefault(x => x.IsEnabled && x.OrgAddonCode.Equals(branch));
            if (orgs != null)
            {
                if (!string.IsNullOrEmpty(orgs.DepartmentCode))
                {
                    var arrDpm = orgs.DepartmentCode.Split(",", StringSplitOptions.None);
                    list = (from a in arrDpm
                            join b in _context.AdDepartments.Where(x => !x.IsDeleted && x.IsEnabled) on a equals b.DepartmentCode
                            select new AssignObject
                            {
                                Code = b.DepartmentCode,
                                Name = b.Title,
                                Type = 2,
                                Group = "Phòng ban",
                                CountUser = 0
                            }).ToList();
                    foreach (var item in list)
                    {
                        item.CountUser = GetCountUserInDpt(item.Code, orgs.OrgAddonCode);
                    }
                }
            }

            return Json(list);
        }

        [NonAction]
        public int GetCountUserInDpt(string departmentCode, string branch)
        {
            var listMember = (from a in _context.AdUserDepartments.Where(x => !x.IsDeleted && x.Branch.Equals(branch)
                                && x.DepartmentCode.Equals(departmentCode))
                              join b in _context.Users on a.UserId equals b.Id
                              join c in _context.Roles.Where(x => x.Status) on a.RoleId equals c.Id
                              join d in _context.AdDepartments.Where(x => !x.IsDeleted && x.IsEnabled) on a.DepartmentCode equals d.DepartmentCode
                              select new MemberInDepartment
                              {
                                  UserId = b.Id,
                                  GivenName = b.GivenName,
                                  Type = 2,
                                  DepartmentId = b.DepartmentId,
                                  RoleSys = c.Title,
                                  Priority = c.Priority,
                                  DepartmentName = d.Title,
                                  Branch = a.Branch
                              }).OrderByDescending(x => x.Priority).GroupBy(x => new { x.UserId, x.DepartmentId });
            var members = listMember.Select(x => new
            {
                x.Key.UserId,
                x.Key.DepartmentId,
                x.First().Type,
                x.First().GivenName,
                x.First().RoleSys,
                x.First().Priority,
                x.First().DepartmentName,
                x.First().Branch
            });
            return members.Count();
        }

        public class AssignObject
        {
            public string Code { get; set; }
            public string Name { get; set; }
            public int Type { get; set; }
            public string Group { get; set; }
            public int CountUser { get; set; }
        }

        public class MemberInDepartment
        {
            public string UserId { get; set; }
            public string GivenName { get; set; }
            public int Type { get; set; }
            public string DepartmentId { get; set; }
            public string RoleSys { get; set; }
            public int? Priority { get; set; }
            public string DepartmentName { get; set; }
            public string Branch { get; set; }
        }

        [HttpGet]
        public object GetListUserInDepartment(string departmentCode, string branch)
        {
            var listMember = (from a in _context.AdUserDepartments.Where(x => !x.IsDeleted && x.Branch.Equals(branch)
                                && x.DepartmentCode.Equals(departmentCode))
                              join b in _context.Users on a.UserId equals b.Id
                              join c in _context.Roles.Where(x => x.Status) on a.RoleId equals c.Id
                              join d in _context.AdDepartments.Where(x => !x.IsDeleted && x.IsEnabled) on a.DepartmentCode equals d.DepartmentCode
                              select new MemberInDepartment
                              {
                                  UserId = b.Id,
                                  GivenName = b.GivenName,
                                  Type = 2,
                                  DepartmentId = b.DepartmentId,
                                  RoleSys = c.Title,
                                  Priority = c.Priority,
                                  DepartmentName = d.Title,
                                  Branch = a.Branch
                              }).OrderByDescending(x => x.Priority).GroupBy(x => new { x.UserId, x.DepartmentId });
            var members = listMember.Select(x => new
            {
                x.Key.UserId,
                x.Key.DepartmentId,
                x.First().Type,
                x.First().GivenName,
                x.First().RoleSys,
                x.First().Priority,
                x.First().DepartmentName,
                x.First().Branch
            });
            return members;
        }

        //check Trưởng Phòng
        [HttpPost]
        public object CheckLeader(string userId, string branch, string department)
        {
            var userLeader = new UserTempAssign();
            if (!string.IsNullOrEmpty(department))
            {
                var chkLeader = _context.AdUserDepartments.FirstOrDefault(x => !x.IsDeleted && x.UserId.Equals(userId) && x.Branch.Equals(branch)
                && x.DepartmentCode.Equals(department) && x.RoleId.Equals("49b018ad-68af-4625-91fd-2273bb5cf749"));
                if (chkLeader != null)
                {
                    return new
                    {
                        IsLeader = true,
                        User = userLeader
                    };
                }

                userLeader = (from a in _context.AdUserDepartments.Where(x => !x.IsDeleted && x.DepartmentCode.Equals(department) && x.Branch.Equals(branch)
                                    && x.RoleId.Equals("49b018ad-68af-4625-91fd-2273bb5cf749"))
                              join b in _context.Users on a.UserId equals b.Id
                              join c in _context.AdDepartments.Where(x => !x.IsDeleted && x.IsEnabled) on a.DepartmentCode equals c.DepartmentCode
                              select new UserTempAssign
                              {
                                  Id = b.Id,
                                  GivenName = b.GivenName,
                                  Responsibility = "ROLE_LEADER_ACCEPTED",
                                  DepartmentId = c.Title,
                                  Branch = a.Branch
                              }).FirstOrDefault();

                return new
                {
                    IsLeader = false,
                    User = userLeader
                };
            }
            else
            {
                var user = _context.Users.FirstOrDefault(x => x.Id == userId);
                var check = _context.UserRoles.FirstOrDefault(x => x.RoleId.Equals("49b018ad-68af-4625-91fd-2273bb5cf749") && x.UserId.Equals(userId));
                if (check != null)
                {
                    return new
                    {
                        IsLeader = true,
                        User = userLeader
                    };
                }
                if (!string.IsNullOrEmpty(user.DepartmentId))
                {
                    userLeader = (from a in _context.Users
                                  join b in _context.UserRoles.Where(x => x.RoleId.Equals("49b018ad-68af-4625-91fd-2273bb5cf749")) on a.Id equals b.UserId
                                  join c in _context.AdDepartments.Where(x => !x.IsDeleted && x.IsEnabled && x.DepartmentCode.Equals(user.DepartmentId)) on a.DepartmentId equals c.DepartmentCode
                                  select new UserTempAssign
                                  {
                                      Id = a.Id,
                                      GivenName = a.GivenName,
                                      Responsibility = "ROLE_LEADER_ACCEPTED",
                                      DepartmentId = c.Title,
                                      Branch = a.BranchId
                                  }).FirstOrDefault();
                }
                return new
                {
                    IsLeader = false,
                    User = userLeader
                };
            }
        }

        [HttpPost]
        public object GetLeaderInDepartment(string code)
        {
            var data = (from a in _context.Users.Where(x => x.Active && x.DepartmentId == code)
                        join b in _context.UserRoles.Where(x => x.RoleId == "49b018ad-68af-4625-91fd-2273bb5cf749") on a.Id equals b.UserId
                        select new UserTempAssign
                        {
                            Id = a.Id,
                            GivenName = a.GivenName,
                            Responsibility = "ROLE_LEADER_ACCEPTED"
                        }).FirstOrDefault();
            return data;
        }
        public class UserTempAssign
        {
            public string Id { get; set; }
            public string GivenName { get; set; }
            public string Responsibility { get; set; }
            public string DepartmentId { get; set; }
            public string Branch { get; set; }
        }

        [HttpPost]
        public JsonResult GetCardWithDepartment([FromBody] AdvanceSearchObj data)
        {
            //if (data.ListObjCode.Any())
            //{
            //    return Json(GetCardDataInDepartment(data));
            //}
            //else
            //{
            //    return Json(GetCardDataOutDepartment(data));
            //}
            return Json(GetCardDataInDepartment(data));
        }

        [NonAction]
        public object GetCardDataInDepartment(AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var list = (from a in _context.WORKOSLists.Where(x => !x.IsDeleted)
                        join b in _context.WORKOSCards.Where(x => !x.IsDeleted && x.Status != "TRASH") on a.ListCode equals b.ListCode
                        select new
                        {
                            a.ListID,
                            a.ListCode,
                            a.ListName,
                            a.Completed,
                            a.WeightNum,
                            a.Status,
                            a.BeginTime,
                            a.Deadline,
                            a.Background,
                            a.Order
                        }).DistinctBy(x => x.ListCode);
            var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
            {
                x.ListID,
                x.ListCode,
                x.ListName,
                x.Completed,
                x.WeightNum,
                x.Status,
                x.BeginTime,
                x.Deadline,
                x.Background,
                x.Order,
                ListCard = ListCardInOutDepartment(data, x.ListCode, !string.IsNullOrEmpty(user.DepartmentId) ? user.BranchId : "", !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "")
            });
            return new
            {
                Data = listPaging,
                TotalPage = (list.Count() % data.Length == 0) ? (list.Count() / data.Length) : (list.Count() / data.Length + 1),
            };
        }

        [NonAction]
        private List<ListAndCard> ListCardInOutDepartment(AdvanceSearchObj dataSearch, string listCode, string branch, string department)
        {
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var session = HttpContext.GetSessionUser();
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            var listObject = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            if (dataSearch.ListObjCode.Any())
            {
                listObject = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }

            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName",
                "@ListUserOfBranch", "@UserId", "@BranchId", "@Status", "@Object", "@ListCode", "@CardName", "@ListObjCode", "@boardCode" };
            object[] val = new object[] {dataSearch.CurrentPageList, 10,fromDatePara, toDatePara , session.IsAllData, session.IsUser, session.IsBranch,
                !string.IsNullOrEmpty(department) ? department : "", session.UserName, listUserOfBranch, session.UserId, !string.IsNullOrEmpty(branch) ? branch : "",
                 dataSearch.Status, dataSearch.Object, listCode, dataSearch.CardName, listObject, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_LIST_AND_CARD_DEPARTMENT", param, val);
            var query = CommonUtil.ConvertDataTable<ListAndCard>(rs);
            return query;
        }


        [NonAction]
        public object GetCardDataOutDepartment(AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //danh sách card mới,thẻ mới
            if (fromDate == null && toDate == null && string.IsNullOrEmpty(data.CardName) && string.IsNullOrEmpty(data.Status) && string.IsNullOrEmpty(data.BranchId))
            {
                var query = (from a in _context.WORKOSCards
                             let lt = a.LstUser.Split(",", StringSplitOptions.None)
                             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
                             from g2 in g1.DefaultIfEmpty()
                             join c in _context.CardCommentLists on a.CardCode equals c.CardCode
                             where a.IsDeleted == false
                             && (session.IsAllData
                            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
                            || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
                             group a by a.ListCode into g
                             select new
                             {
                                 ListCode = g.Key,
                                 ListCard = g.Select(y => new
                                 {
                                     y.CardID,
                                     y.CardCode,
                                     y.CardName,
                                     y.Deadline,
                                     y.Quantitative,
                                     y.Unit,
                                     y.Currency,
                                     CurrencyValue = "",
                                     y.BeginTime,
                                     y.EndTime,
                                     Status = y.Status,
                                     CountCheckListDone = "",
                                     CountCheckList = "",
                                     y.Cost,
                                     y.Completed,
                                 }).Distinct()
                             }).AsNoTracking();
                var listPaging = from a in query.Skip(intBeginFor).Take(data.Length)
                                 join b in _context.WORKOSLists on a.ListCode equals b.ListCode
                                 select new
                                 {
                                     b.ListCode,
                                     b.ListID,
                                     b.ListName,
                                     b.Completed,
                                     b.WeightNum,
                                     b.Status,
                                     b.BeginTime,
                                     b.Deadline,
                                     b.Background,
                                     b.Order,
                                     ListCard = a.ListCard.Select(y => new
                                     {
                                         y.CardID,
                                         y.CardCode,
                                         y.CardName,
                                         y.Deadline,
                                         y.Quantitative,
                                         y.Unit,
                                         y.Currency,
                                         CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                                         BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
                                         EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
                                         Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                                         CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                                         CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                                         y.Cost,
                                         y.Completed,
                                     })
                                 };
                return new
                {
                    Data = listPaging,
                    Total = query.Count(),
                };
            }
            else
            {
                var query = (from a in _context.WORKOSCards
                             let lt = a.LstUser.Split(",", StringSplitOptions.None)
                             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
                             from g2 in g1.DefaultIfEmpty()
                             join b in _context.Users.Where(x => x.Active) on a.CreatedBy equals b.UserName
                             where (fromDate == null || a.BeginTime >= fromDate) &&
                             (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
                             (string.IsNullOrEmpty(data.CardName) || a.CardName.ToUpper().Contains(data.CardName.ToUpper())) &&
                             ((string.IsNullOrEmpty(data.Status) && a.Status != "TRASH") || (!string.IsNullOrEmpty(a.Status) && a.Status.Equals(data.Status))) &&
                             (string.IsNullOrEmpty(data.BranchId) || b.BranchId.Equals(data.BranchId)) &&
                             a.IsDeleted == false
                             && (session.IsAllData
                            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
                            || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
                             group a by a.ListCode into g
                             select new
                             {
                                 ListCode = g.Key,
                                 ListCard = g.Select(y => new
                                 {
                                     y.CardID,
                                     y.CardCode,
                                     y.CardName,
                                     y.Deadline,
                                     y.Quantitative,
                                     y.Unit,
                                     y.Currency,
                                     y.Status,
                                     BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
                                     EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
                                     y.Cost,
                                     y.Completed,

                                 }).Distinct()
                             }).AsNoTracking();
                var list = (from a in query
                            join b in _context.WORKOSLists on a.ListCode equals b.ListCode
                            where b.IsDeleted == false
                            select new { a, b });
                var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
                {
                    x.b.ListID,
                    x.b.ListCode,
                    x.b.ListName,
                    x.b.Completed,
                    x.b.WeightNum,
                    x.b.Status,
                    x.b.BeginTime,
                    x.b.Deadline,
                    x.b.Background,
                    x.b.Order,
                    ListCard = x.a.ListCard.Select(y => new
                    {
                        y.CardID,
                        y.CardCode,
                        y.CardName,
                        y.Deadline,
                        y.Quantitative,
                        y.Unit,
                        y.Currency,
                        CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                        y.BeginTime,
                        y.EndTime,
                        Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                        CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                        CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                        y.Cost,
                        y.Completed,
                    })
                });
                return new
                {
                    Data = listPaging,
                    Total = list.Count(),
                };
            }
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardDepartment(AdvanceSearchObj dataSearch)
        {
            List<GridCardJtable> query = new List<GridCardJtable>();
            if (dataSearch.ListObjCode.Any())
            {
                query = GetGirdCardInDepartment(dataSearch);
            }
            else
            {
                query = GetGirdCardOutDepartment(dataSearch);
            }
            return query;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardInDepartment(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }
            if (string.IsNullOrEmpty(dataSearch.FromDate) && string.IsNullOrEmpty(dataSearch.ToDate) && string.IsNullOrEmpty(dataSearch.CardName)
                && string.IsNullOrEmpty(dataSearch.ObjCode) && string.IsNullOrEmpty(dataSearch.Status) && string.IsNullOrEmpty(dataSearch.WorkflowInstCode))
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch",
                "@DepartmentId", "@UserName", "@ListUserOfBranch", "@UserId", "@listObjCode", "@Branch" };
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , session.IsAllData, session.IsUser, session.IsBranch,
                !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                    !string.IsNullOrEmpty(session.BranchId) ? session.BranchId : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_DEPARTMENT_NO_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }
            else
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch",
                    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@UserId", "@listObjCode", "@Branch", "@CardName", "@FromDate",
                        "@ToDate", "@Status", "@WorkflowInstCode" };
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , session.IsAllData, session.IsUser, session.IsBranch,
                    !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                    !string.IsNullOrEmpty(session.BranchId) ? session.BranchId : "", dataSearch.CardName, fromDatePara, toDatePara, dataSearch.Status,
                    !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_DEPARTMENT_WITH_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }

        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardOutDepartment(AdvanceSearchObj dataSearch)
        {
            //return GetGirdCardOut(dataSearch);

            //var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            //var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            //var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            //var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            //var listUserOfBranch = "";
            //if (session.IsBranch)
            //{
            //    if (session.ListUserOfBranch.Any())
            //    {
            //        listUserOfBranch = string.Join(",", session.ListUserOfBranch);
            //    }
            //}
            //string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
            //    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            //object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
            //    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch,
            //    !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",session.UserId,  !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "",
            //    dataSearch.Status, dataSearch.Object, dataSearch.ObjType, dataSearch.CardName};
            //DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_OUT_DEPARTMENT", param, val);
            //var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
            //return query;
            return new List<GridCardJtable>();
        }

        [NonAction]
        public IQueryable<CardMemberCustom> GetMemberInDepartment(IEnumerable<string> listDepartment)
        {
            var listUserInDepartment = from a in _context.AdDepartments.Where(x => listDepartment.Any(y => x.DepartmentCode == y))
                                       join b in _context.Users on a.DepartmentCode equals b.DepartmentId
                                       select new CardMemberCustom
                                       {
                                           UserId = b.Id,
                                       };
            return listUserInDepartment;
        }
        #endregion

        #region Project 
        public class PageProjectModel
        {
            public int Id { get; set; }
            public string Code { get; set; }
            public string Name { get; set; }
            public DateTime? CreatedTime { get; set; }
            public decimal PercentObject { get; set; }
            public int CountWork { get; set; }
            public bool IsCheck { get; set; }
            public bool IsShowPercent { get; set; }
            public string Type { get; set; }
        };
        [HttpGet]
        public object GetListPageProject(int page, int length, string name)
        {
            var session = HttpContext.GetSessionUser();
            var lstUserBranch = "";
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            if (session.ListUserOfBranch != null)
            {
                lstUserBranch = string.Join(",", session.ListUserOfBranch);
            }

            int intBeginFor = (page - 1) * length;
            var count = _context.Projects.Where(x => (string.IsNullOrEmpty(name) || x.ProjectTitle.ToLower().Contains(name.ToLower())) && x.FlagDeleted == false && session.IsAllData || session.ListProject.Any(p => p.Equals(x.ProjectCode))).Count();
            var data = _context.Projects.Where(x => (string.IsNullOrEmpty(name) || (x.ProjectTitle.ToLower().Contains(name.ToLower()))) &&
              (x.FlagDeleted == false) && (session.IsAllData || session.ListProject.Any(p => p.Equals(x.ProjectCode)))).OrderByDescending(x => x.Id).Skip(intBeginFor).Take(length).Select(x => new PageProjectModel
              {
                  Id = x.Id,
                  Code = x.ProjectCode,
                  Name = x.ProjectTitle,
                  CreatedTime = x.CreatedTime,
                  PercentObject = 0,
                  CountWork = 0,
                  IsCheck = false,
                  IsShowPercent = false,
                  Type = "PROJECT"
              }).ToList();
            var lstCountWork = GetCountCardObject("PROJECT", string.Join(",", data.Select(x => x.Code)), session.IsAllData, session.IsBranch,
                    session.IsUser, session.UserName, lstUserBranch, session.UserId, !string.IsNullOrEmpty(session.DepartmentCode) ? session.DepartmentCode : "");

            foreach (var item in data)
            {
                foreach (var k in lstCountWork)
                {
                    if (item.Code.Equals(k.ObjID))
                    {
                        item.CountWork = k.CountCard;
                        break;
                    }
                }
            }

            return (new
            {
                Tab = "Dự án",
                Icon = "fas fa-folder-open",
                Total = count,
                ListData = data,
            });
        }

        [HttpPost]
        public JsonResult GetCardWithProject([FromBody] AdvanceSearchObj data)
        {
            //if (data.ListObjCode.Any())
            //{
            //    return Json(GetCardDataInProject(data));
            //}
            //else
            //{
            //    return Json(GetCardDataOutProject(data));
            //}
            return Json(GetCardDataInProject(data));
        }

        [NonAction]
        public List<ModelCountCardObj> GetCountCardObject(string objType, string lstCode, bool isAllData, bool isBranch, bool isUser,
            string userName, string lstUserBranch, string userId, string departmentCode)
        {
            string[] param = new string[] { "@ObjType", "@LstObjCode", "@IsAllData", "@IsBranch", "@IsUser", "@UserName", "@ListUserOfBranch", "@UserId", "@DepartmentId" };
            object[] val = new object[] { objType, lstCode, isAllData, isBranch, isUser, userName, lstUserBranch, userId, departmentCode };
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_CAL_OBJECT_COUNT", param, val);
            var query = CommonUtil.ConvertDataTable<ModelCountCardObj>(rs);
            return query;
        }

        [NonAction]
        public List<ResultPercentObj> GetPercentObject(string objType, string lstCode, bool isAllData, bool isBranch, bool isUser,
            string userName, string lstUserBranch, string userId, string departmentCode)
        {
            string[] param = new string[] { "@ObjType", "@LstObjCode", "@IsAllData", "@IsBranch", "@IsUser", "@UserName", "@ListUserOfBranch", "@UserId", "@DepartmentId" };
            object[] val = new object[] { objType, lstCode, isAllData, isBranch, isUser, userName, lstUserBranch, userId, departmentCode };
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_CAL_OBJECT_PERCENT", param, val);
            var query = CommonUtil.ConvertDataTable<ModePercentObject>(rs);

            var group = query.GroupBy(x => x.ObjID);
            var lst = new List<ResultPercentObj>();
            foreach (var item in group)
            {
                var success = item.Sum(x => (x.Weight * x.Completed) / 100);
                var result = new ResultPercentObj
                {
                    ObjID = item.Key,
                    Completed = success
                };
                lst.Add(result);
            }
            return lst;
        }

        [HttpPost]
        public JsonResult GetPercentObject(string objCode, string objType)
        {
            var session = HttpContext.GetSessionUser();
            string[] param = new string[] { "@ObjType", "@ObjCode", "@IsAllData", "@IsBranch", "@IsUser", "@UserName", "@ListUserOfBranch", "@UserId", "@DepartmentId" };
            object[] val = new object[] { objType, objCode, session.IsAllData, session.IsBranch, session.IsUser,
                session.UserName, session.ListUserOfBranch != null ? string.Join(",", session.ListUserOfBranch) : "", session.UserId, !string.IsNullOrEmpty(session.DepartmentCode) ? session.DepartmentCode : "" };
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_CAL_PERCENT_CURRENT_OBJECT", param, val);
            var query = CommonUtil.ConvertDataTable<ModePercentObject>(rs);

            var weightUsed = query.Where(x => x.Weight > 0).Sum(x => x.Weight);
            var weightNoUse = 100 - weightUsed;
            var count = query.Where(x => x.Weight == 0).Count();
            foreach (var item in query)
            {
                if (item.Weight == 0)
                {
                    item.Weight = weightNoUse / count;
                }
            }
            var success = Math.Round(query.Sum(x => (x.Weight * x.Completed) / 100), 2);

            return Json(success);
        }

        [NonAction]
        public object GetCardDataInProject(AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var query = (from a in _context.JcObjectIdRelatives.Where(x => x.ObjTypeCode == "PROJECT" && !x.IsDeleted)
            //             join b in _context.WORKOSCards on a.CardCode equals b.CardCode
            //             let lt = b.LstUser.Split(",", StringSplitOptions.None)
            //             join g in _context.CardMappings on b.CardCode equals g.CardCode into g1
            //             from g2 in g1.DefaultIfEmpty()
            //             join c in _context.Users.Where(x => x.Active) on b.CreatedBy equals c.UserName
            //             where data.ListObjCode.Any(x => x.Code == a.ObjID) &&
            //             (fromDate == null || b.BeginTime >= fromDate) &&
            //             (toDate == null || (b.EndTime.HasValue ? b.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
            //             ((string.IsNullOrEmpty(data.Status) && b.Status != "TRASH") || (!string.IsNullOrEmpty(b.Status) && b.Status.Equals(data.Status))) &&
            //             (string.IsNullOrEmpty(data.CardName) || b.CardName.ToUpper().Contains(data.CardName.ToUpper())) &&
            //             (string.IsNullOrEmpty(data.BranchId) || c.BranchId.ToUpper().Equals(data.BranchId.ToUpper())) &&
            //             b.IsDeleted == false
            //             //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(b.LstUser) && lt.Any(y => session.UserId == y)) || b.CreatedBy == session.UserName)
            //             && (session.IsAllData
            //            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(b.LstUser) && lt.Any(y => session.UserId == y)) || b.CreatedBy == session.UserName))
            //            || (session.IsBranch && (!string.IsNullOrEmpty(b.LstUser) && lt.Any(k => k == session.UserId) || b.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == b.CreatedBy))))

            //             group b by b.ListCode into g
            //             select new
            //             {
            //                 ListCode = g.Key,
            //                 ListCard = g.Select(y => new
            //                 {
            //                     y.CardID,
            //                     y.CardCode,
            //                     y.CardName,
            //                     y.Deadline,
            //                     y.Quantitative,
            //                     y.Unit,
            //                     y.Currency,
            //                     y.Status,
            //                     BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
            //                     EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
            //                     y.Cost,
            //                     y.Completed,
            //                 }).Distinct()
            //             }).AsNoTracking();
            //var list = (from a in query
            //            join b in _context.WORKOSLists on a.ListCode equals b.ListCode
            //            where b.IsDeleted == false
            //            select new { a, b });

            var list = (from a in _context.WORKOSLists.Where(x => !x.IsDeleted)
                        join b in _context.WORKOSCards.Where(x => !x.IsDeleted && x.Status != "TRASH") on a.ListCode equals b.ListCode
                        select new
                        {
                            a.ListID,
                            a.ListCode,
                            a.ListName,
                            a.Completed,
                            a.WeightNum,
                            a.Status,
                            a.BeginTime,
                            a.Deadline,
                            a.Background,
                            a.Order
                        }).DistinctBy(x => x.ListCode);
            var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
            {
                x.ListID,
                x.ListCode,
                x.ListName,
                x.Completed,
                x.WeightNum,
                x.Status,
                x.BeginTime,
                x.Deadline,
                x.Background,
                x.Order,
                //ListCard = x.ListCard.Select(y => new
                //{
                //    y.CardID,
                //    y.CardCode,
                //    y.CardName,
                //    y.Deadline,
                //    y.Quantitative,
                //    y.Unit,
                //    y.Currency,
                //    CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                //    y.BeginTime,
                //    y.EndTime,
                //    Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                //    CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                //    CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                //    y.Cost,
                //    y.Completed,
                //})
                ListCard = ListCardInOutProject(data, x.ListCode, user.BranchId, user.DepartmentId)
            });
            return new
            {
                Data = listPaging,
                Total = list.Count(),
            };
        }

        [NonAction]
        public object GetCardDataOutProject(AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //danh sách card mới,thẻ mới
            if (fromDate == null && toDate == null && string.IsNullOrEmpty(data.CardName) && string.IsNullOrEmpty(data.Status) && string.IsNullOrEmpty(data.BranchId))
            {
                var query = (from a in _context.WORKOSCards
                             let lt = a.LstUser.Split(",", StringSplitOptions.None)
                             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
                             from g2 in g1.DefaultIfEmpty()
                             where a.CreatedDate.Date == DateTime.Today && a.IsDeleted == false
                             //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
                             && (session.IsAllData
                            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
                            || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))

                             group a by a.ListCode into g
                             select new
                             {
                                 ListCode = g.Key,
                             }).AsNoTracking();
                var list = (from a in _context.WORKOSLists
                            from b in query
                            where ((a.ListCode == b.ListCode) || (a.CreatedDate.Date == DateTime.Today) && a.IsDeleted == false)
                            select a).Distinct().AsNoTracking();
                var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
                {
                    x.ListID,
                    x.ListCode,
                    x.ListName,
                    x.Completed,
                    x.WeightNum,
                    x.Status,
                    x.BeginTime,
                    x.Deadline,
                    x.Background,
                    x.Order,
                    ListCard = _context.WORKOSCards.Where(y => y.ListCode == x.ListCode && y.CreatedDate.Date == DateTime.Today && y.IsDeleted == false).Select(y => new
                    {
                        y.CardID,
                        y.CardCode,
                        y.CardName,
                        y.Deadline,
                        y.Quantitative,
                        y.Unit,
                        y.Currency,
                        CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                        BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
                        EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
                        Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                        CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                        CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                        y.Cost,
                        y.Completed,
                    })
                });
                return new
                {
                    Data = listPaging,
                    Total = list.Count(),
                };
            }
            else
            {
                var query = (from a in _context.WORKOSCards
                             let lt = a.LstUser.Split(",", StringSplitOptions.None)
                             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
                             from g2 in g1.DefaultIfEmpty()
                             join b in _context.Users.Where(x => x.Active) on a.CreatedBy equals b.UserName
                             where (fromDate == null || a.BeginTime >= fromDate) &&
                             (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
                             ((string.IsNullOrEmpty(data.Status) && a.Status != "TRASH") || (!string.IsNullOrEmpty(a.Status) && a.Status.Equals(data.Status))) &&
                             (string.IsNullOrEmpty(data.BranchId) || b.BranchId.Equals(data.BranchId)) &&
                             (string.IsNullOrEmpty(data.CardName) || a.CardName.ToUpper().Contains(data.CardName.ToUpper())) &&
                             a.IsDeleted == false
                             //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
                             && (session.IsAllData
                            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
                            || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))

                             group a by a.ListCode into g
                             select new
                             {
                                 ListCode = g.Key,
                                 ListCard = g.Select(y => new
                                 {
                                     y.CardID,
                                     y.CardCode,
                                     y.CardName,
                                     y.Deadline,
                                     y.Quantitative,
                                     y.Unit,
                                     y.Currency,
                                     y.Status,
                                     BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
                                     EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
                                     y.Cost,
                                     y.Completed,
                                 }).Distinct()
                             }).AsNoTracking();
                var list = (from a in query
                            join b in _context.WORKOSLists on a.ListCode equals b.ListCode
                            where b.IsDeleted == false
                            select new { a, b });
                var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
                {
                    x.b.ListID,
                    x.b.ListCode,
                    x.b.ListName,
                    x.b.Completed,
                    x.b.WeightNum,
                    x.b.Status,
                    x.b.BeginTime,
                    x.b.Deadline,
                    x.b.Background,
                    x.b.Order,
                    ListCard = x.a.ListCard.Select(y => new
                    {
                        y.CardID,
                        y.CardCode,
                        y.CardName,
                        y.Deadline,
                        y.Quantitative,
                        y.Unit,
                        y.Currency,
                        CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                        y.BeginTime,
                        y.EndTime,
                        Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                        CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                        CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                        y.Cost,
                        y.Completed,
                    })
                });
                return new
                {
                    Data = listPaging,
                    Total = list.Count(),
                };
            }
        }

        [NonAction]
        private List<ListAndCard> ListCardInOutProject(AdvanceSearchObj dataSearch, string listCode, string branch, string department)
        {
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var session = HttpContext.GetSessionUser();
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            var listObject = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            if (dataSearch.ListObjCode.Any())
            {
                listObject = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }

            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName",
                "@ListUserOfBranch", "@UserId", "@BranchId", "@Status", "@Object", "@ListCode", "@CardName", "@ListObjCode", "@boardCode" };
            object[] val = new object[] {dataSearch.CurrentPageList, 10,fromDatePara, toDatePara , session.IsAllData, session.IsUser, session.IsBranch,
                !string.IsNullOrEmpty(department) ? department : "", session.UserName, listUserOfBranch, session.UserId, !string.IsNullOrEmpty(branch) ? branch : "",
                 dataSearch.Status, dataSearch.Object, listCode, dataSearch.CardName, listObject, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_LIST_AND_CARD_PROJECT", param, val);
            var query = CommonUtil.ConvertDataTable<ListAndCard>(rs);
            return query;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardProject(AdvanceSearchObj dataSearch)
        {
            var query = new List<GridCardJtable>();
            if (dataSearch.ListObjCode.Any())
            {
                query = GetGirdCardInProject(dataSearch);
            }
            else
            {
                query = GetGirdCardOutProject(dataSearch);
            }
            return query;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardInProject(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }

            if (string.IsNullOrEmpty(dataSearch.CardName) && string.IsNullOrEmpty(dataSearch.FromDate) && string.IsNullOrEmpty(dataSearch.ToDate)
                && string.IsNullOrEmpty(dataSearch.Status) && string.IsNullOrEmpty(dataSearch.WorkflowInstCode))
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                "@UserId", "@listObjCode", "@Branch" };
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , session.IsAllData, session.IsUser, session.IsBranch,
                 !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                  !string.IsNullOrEmpty(dataSearch.BranchId) ? dataSearch.BranchId : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_PROJECT_NO_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }
            else
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                "@UserId", "@listObjCode", "@Branch", "@CardName", "@FromDate", "@toDate", "@Status", "@WorkflowInstCode" };
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , session.IsAllData, session.IsUser, session.IsBranch,
                    !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                    !string.IsNullOrEmpty(dataSearch.BranchId) ? dataSearch.BranchId : "", dataSearch.CardName, fromDatePara,
                    toDatePara, dataSearch.Status, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_PROJECT_WITH_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }


            //var query = (from a in _context.WORKOSCards.Where(x => !x.IsDeleted)
            //             let lt = a.LstUser.Split(",", StringSplitOptions.None)
            //             //join c in _context.Users on a.CreatedBy equals c.UserName into c1
            //             //from c2 in c1.DefaultIfEmpty()
            //             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
            //             from g2 in g1.DefaultIfEmpty()
            //             join h in _context.Users.Where(x => x.Active) on a.CreatedBy equals h.UserName into h1
            //             from h2 in h1.DefaultIfEmpty()
            //             join i in _context.WORKOSLists.Where(x => !x.IsDeleted) on a.ListCode equals i.ListCode
            //             join k in _context.WORKOSBoards.Where(x => !x.IsDeleted) on i.BoardCode equals k.BoardCode
            //             join b in _context.JcObjectIdRelatives.Where(x => dataSearch.ListObjCode.Any(y => y.Code == x.ObjID) && !x.IsDeleted) on a.CardCode equals b.CardCode
            //             where (fromDate == null || a.BeginTime.Date >= fromDate) &&
            //                   (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
            //                   ((string.IsNullOrEmpty(dataSearch.Status) && a.Status != "TRASH") || a.Status.Equals(dataSearch.Status)) &&
            //                   (string.IsNullOrEmpty(dataSearch.BranchId) || h2.BranchId.Equals(dataSearch.BranchId)) &&
            //                   ((string.IsNullOrEmpty(dataSearch.CardName) || a.CardCode.ToLower().Contains(dataSearch.CardName.ToLower())) || (string.IsNullOrEmpty(dataSearch.CardName) || a.CardName.ToUpper().Contains(dataSearch.CardName.ToUpper())))
            //                   //&& (session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
            //                   && (session.IsAllData
            //                    || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
            //                    || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
            //             select new GridCardJtable
            //             {
            //                 CardID = a.CardID,
            //                 CardCode = a.CardCode,
            //                 CardName = a.CardName,
            //                 ListName = _context.WORKOSLists.FirstOrDefault(y => y.ListCode.Equals(a.ListCode)).ListName ?? "",
            //                 BoardName = k.BoardName,
            //                 Deadline = a.Deadline,
            //                 Currency = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == a.Currency).ValueSet ?? "",
            //                 Cost = a.Cost,
            //                 Completed = a.Completed,
            //                 BeginTime = a.BeginTime,
            //                 EndTime = a.EndTime,
            //                 Status = _context.CommonSettings.FirstOrDefault(y => y.CodeSet.Equals(a.Status)).ValueSet,
            //                 UpdateTime = a.UpdatedTime,
            //                 CreatedBy = h2.GivenName,
            //                 CreatedTime = a.CreatedDate.ToString("dd/MM/yyyy"),
            //                 CreatedDate = a.CreatedDate,
            //                 UpdatedTimeTxt = a.UpdatedTime.HasValue ? a.UpdatedTime.Value.ToString("dd/MM/yyyy HH:mm:ss") : "",
            //                 WorkType = !string.IsNullOrEmpty(a.WorkType) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.WorkType).ValueSet : "",
            //                 Priority = !string.IsNullOrEmpty(a.CardLevel) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.CardLevel).ValueSet : "",
            //             }).DistinctBy(x => x.CardCode).OrderByDescending(x => x.UpdateTime.HasValue ? x.UpdateTime.Value : x.CreatedDate).ThenByDescending(x => x.CardID);
            //IQueryable<GridCardJtable> data1 = query.AsQueryable<GridCardJtable>();
            //return data1;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardOutProject(AdvanceSearchObj dataSearch)
        {
            //return GetGirdCardOut(dataSearch);
            //var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            //var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            //var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            //var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            //var listUserOfBranch = "";
            //if (session.IsBranch)
            //{
            //    if (session.ListUserOfBranch.Any())
            //    {
            //        listUserOfBranch = string.Join(",", session.ListUserOfBranch);
            //    }
            //}
            //string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
            //    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            //object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
            //    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",
            //    session.UserId, !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "", dataSearch.Status, dataSearch.Object, dataSearch.ObjType, dataSearch.CardName};
            //DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_OUT_PROJECT", param, val);
            //var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
            //return query;
            return new List<GridCardJtable>();
        }

        [HttpGet]
        public JsonResult GetLastestProject()
        {
            var data = from a in _context.WORKOSCards
                       join b in _context.JcObjectIdRelatives on a.CardCode equals b.CardCode
                       where !a.IsDeleted && !b.IsDeleted && b.ObjTypeCode == "PROJECT"
                       select b;
            var lastestId = data.Max(x => x.ID);
            //var lastestPro = _context.JcObjectIdRelatives.FirstOrDefault(x => x.ID == lastestId).ObjID;
            var lastestPro = _context.JcObjectIdRelatives.FirstOrDefault(x => x.ID == lastestId);
            if (lastestPro != null)
            {
                return Json(lastestPro.ObjID);
            }
            else
            {
                return Json("");
            }

        }

        public class ModelCountCardObj
        {
            public string ObjID { get; set; }
            public int CountCard { get; set; }
        }
        public class ResultPercentObj
        {
            public string ObjID { get; set; }
            public decimal Completed { get; set; }
        }

        public class ModePercentObject
        {
            public string ObjID { get; set; }
            public string CardCode { get; set; }
            public decimal Weight { get; set; }
            public decimal Completed { get; set; }
        }
        #endregion

        #region Customer
        [HttpGet]
        public object GetListPageCustomer(int page, int length, string name)
        {
            int intBeginFor = (page - 1) * length;
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var count = _context.Customerss.Where(x => (string.IsNullOrEmpty(name) || x.CusName.ToLower().Contains(name.ToLower())) && x.IsDeleted == false).Count();
            var data = (_context.Customerss.Where(x => (string.IsNullOrEmpty(name) || (x.CusName.ToLower().Contains(name.ToLower()))) &&
              (x.IsDeleted == false)).OrderByDescending(x => x.CusID).Skip(intBeginFor).Take(length).Select(x => new PageProjectModel
              {
                  Id = x.CusID,
                  Code = x.CusCode,
                  Name = x.CusName,
                  CreatedTime = x.CreatedTime,
                  CountWork = 0,
                  IsCheck = false,
                  IsShowPercent = false,
                  PercentObject = 0,
                  Type = "CUSTOMER"
              })).ToList();
            var lstUserBranch = "";
            if (session.ListUserOfBranch != null)
            {
                lstUserBranch = string.Join(",", session.ListUserOfBranch);
            }
            var lstCountWork = GetCountCardObject("CUSTOMER", string.Join(",", data.Select(x => x.Code)), session.IsAllData, session.IsBranch,
                    session.IsUser, session.UserName, lstUserBranch, session.UserId, !string.IsNullOrEmpty(session.DepartmentCode) ? session.DepartmentCode : "");
            foreach (var item in data)
            {
                foreach (var k in lstCountWork)
                {
                    if (item.Code.Equals(k.ObjID))
                    {
                        item.CountWork = k.CountCard;
                        break;
                    }
                }
            }
            return (new
            {
                Tab = "Khách hàng",
                Icon = "fas fa-user",
                Total = count,
                ListData = data,
            });
        }

        [HttpPost]
        public JsonResult GetCardWithCustomer([FromBody] AdvanceSearchObj data)
        {
            //if (data.ListObjCode.Any())
            //{
            //    return Json(GetCardDataInCustomer(data));
            //}
            //else
            //{
            //    return Json(GetCardDataOutCustomer(data));
            //}
            return Json(GetCardDataInCustomer(data));
        }
        [NonAction]
        public object GetCardDataInCustomer(AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var query = (from a in _context.JcObjectIdRelatives.Where(x => x.ObjTypeCode == "CUSTOMER" && !x.IsDeleted)
            //             join b in _context.WORKOSCards.Where(x => !x.IsDeleted) on a.CardCode equals b.CardCode
            //             let lt = b.LstUser.Split(",", StringSplitOptions.None)
            //             join g in _context.CardMappings on b.CardCode equals g.CardCode into g1
            //             from g2 in g1.DefaultIfEmpty()
            //             join c in _context.Users.Where(x => x.Active) on b.CreatedBy equals c.UserName
            //             where data.ListObjCode.Any(x => x.Code == a.ObjID) &&
            //             (fromDate == null || b.BeginTime >= fromDate) &&
            //             (toDate == null || (b.EndTime.HasValue ? b.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
            //             ((string.IsNullOrEmpty(data.Status) && b.Status != "TRASH") || (!string.IsNullOrEmpty(b.Status) && b.Status.Equals(data.Status))) &&
            //             (string.IsNullOrEmpty(data.CardName) || b.CardName.ToUpper().Contains(data.CardName.ToUpper())) &&
            //             (session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(b.LstUser) && lt.Any(y => session.UserId == y)) || b.CreatedBy == session.UserName)
            //             && (session.IsAllData
            //            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(b.LstUser) && lt.Any(y => session.UserId == y)) || b.CreatedBy == session.UserName))
            //            || (session.IsBranch && (!string.IsNullOrEmpty(b.LstUser) && lt.Any(k => k == session.UserId) || b.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == b.CreatedBy))))

            //             group b by b.ListCode into g
            //             select new
            //             {
            //                 ListCode = g.Key,
            //                 ListCard = g.Select(y => new
            //                 {
            //                     y.CardID,
            //                     y.CardCode,
            //                     y.CardName,
            //                     y.Deadline,
            //                     y.Quantitative,
            //                     y.Unit,
            //                     y.Currency,
            //                     y.Status,
            //                     BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
            //                     EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
            //                     y.Cost,
            //                     y.Completed,

            //                 }).Distinct()
            //             }).AsNoTracking();
            //var list = (from a in query
            //            join b in _context.WORKOSLists on a.ListCode equals b.ListCode
            //            where b.IsDeleted == false
            //            select new { a, b });
            var list = (from a in _context.WORKOSLists.Where(x => !x.IsDeleted)
                        join b in _context.WORKOSCards.Where(x => !x.IsDeleted && x.Status != "TRASH") on a.ListCode equals b.ListCode
                        select new
                        {
                            a.ListID,
                            a.ListCode,
                            a.ListName,
                            a.Completed,
                            a.WeightNum,
                            a.Status,
                            a.BeginTime,
                            a.Deadline,
                            a.Background,
                            a.Order
                        }).DistinctBy(x => x.ListCode);
            var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
            {
                x.ListID,
                x.ListCode,
                x.ListName,
                x.Completed,
                x.WeightNum,
                x.Status,
                x.BeginTime,
                x.Deadline,
                x.Background,
                x.Order,
                //ListCard = x.a.ListCard.Select(y => new
                //{
                //    y.CardID,
                //    y.CardCode,
                //    y.CardName,
                //    y.Deadline,
                //    y.Quantitative,
                //    y.Unit,
                //    y.Currency,
                //    CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                //    y.BeginTime,
                //    y.EndTime,
                //    Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                //    CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                //    CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                //    y.Cost,
                //    y.Completed,

                //})
                ListCard = ListCardInOutCustomer(data, x.ListCode, user.BranchId, user.DepartmentId)
            });
            return new
            {
                Data = listPaging,
                Total = list.Count(),
            };
        }

        [NonAction]
        public object GetCardDataOutCustomer(AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //danh sách card mới,thẻ mới
            if (fromDate == null && toDate == null && string.IsNullOrEmpty(data.CardName) && string.IsNullOrEmpty(data.Status) && string.IsNullOrEmpty(data.BranchId))
            {
                var query = (from a in _context.WORKOSCards
                             let lt = a.LstUser.Split(",", StringSplitOptions.None)
                             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
                             from g2 in g1.DefaultIfEmpty()
                             where a.CreatedDate.Date == DateTime.Today && a.IsDeleted == false
                             //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
                             && (session.IsAllData
                            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
                            || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))

                             group a by a.ListCode into g
                             select new
                             {
                                 ListCode = g.Key,
                             }).AsNoTracking();
                var list = (from a in _context.WORKOSLists
                            from b in query
                            where ((a.ListCode == b.ListCode) || (a.CreatedDate.Date == DateTime.Today) && a.IsDeleted == false)
                            select a).Distinct().AsNoTracking();
                var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
                {
                    x.ListID,
                    x.ListCode,
                    x.ListName,
                    x.Completed,
                    x.WeightNum,
                    x.Status,
                    x.BeginTime,
                    x.Deadline,
                    x.Background,
                    x.Order,
                    ListCard = _context.WORKOSCards.Where(y => y.ListCode == x.ListCode && y.CreatedDate.Date == DateTime.Today && y.IsDeleted == false).Select(y => new
                    {
                        y.CardID,
                        y.CardCode,
                        y.CardName,
                        y.Deadline,
                        y.Quantitative,
                        y.Unit,
                        y.Currency,
                        CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                        BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
                        EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
                        Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                        CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                        CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                        y.Cost,
                        y.Completed,

                    }).Distinct()
                });
                return new
                {
                    Data = listPaging,
                    Total = list.Count(),
                };
            }
            else
            {
                var query = (from a in _context.WORKOSCards
                             let lt = a.LstUser.Split(",", StringSplitOptions.None)
                             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
                             from g2 in g1.DefaultIfEmpty()
                             join b in _context.Users.Where(x => x.Active) on a.CreatedBy equals b.UserName
                             where (fromDate == null || a.BeginTime >= fromDate) &&
                             (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
                             ((string.IsNullOrEmpty(data.Status) && a.Status != "TRASH") || (!string.IsNullOrEmpty(a.Status) && a.Status.Equals(data.Status))) &&
                             (string.IsNullOrEmpty(data.BranchId) || b.BranchId.Equals(data.BranchId)) &&
                             (string.IsNullOrEmpty(data.CardName) || a.CardName.ToUpper().Contains(data.CardName.ToUpper())) &&
                             a.IsDeleted == false
                             //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
                             && (session.IsAllData
                            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
                            || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))

                             group a by a.ListCode into g
                             select new
                             {
                                 ListCode = g.Key,
                                 ListCard = g.Select(y => new
                                 {
                                     y.CardID,
                                     y.CardCode,
                                     y.CardName,
                                     y.Deadline,
                                     y.Quantitative,
                                     y.Unit,
                                     y.Currency,
                                     y.Status,
                                     BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
                                     EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
                                     y.Cost,
                                     y.Completed,

                                 }).Distinct()
                             }).AsNoTracking();
                var list = (from a in query
                            join b in _context.WORKOSLists on a.ListCode equals b.ListCode
                            where b.IsDeleted == false
                            select new { a, b });
                var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
                {
                    x.b.ListID,
                    x.b.ListCode,
                    x.b.ListName,
                    x.b.Completed,
                    x.b.WeightNum,
                    x.b.Status,
                    x.b.BeginTime,
                    x.b.Deadline,
                    x.b.Background,
                    x.b.Order,
                    ListCard = x.a.ListCard.Select(y => new
                    {
                        y.CardID,
                        y.CardCode,
                        y.CardName,
                        y.Deadline,
                        y.Quantitative,
                        y.Unit,
                        y.Currency,
                        CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                        y.BeginTime,
                        y.EndTime,
                        Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                        CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                        CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                        y.Cost,
                        y.Completed,

                    })
                });
                return new
                {
                    Data = listPaging,
                    Total = list.Count(),
                };
            }
        }

        [NonAction]
        private List<ListAndCard> ListCardInOutCustomer(AdvanceSearchObj dataSearch, string listCode, string branch, string department)
        {
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var session = HttpContext.GetSessionUser();
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            var listObject = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            if (dataSearch.ListObjCode.Any())
            {
                listObject = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }

            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName",
                "@ListUserOfBranch", "@UserId", "@BranchId", "@Status", "@Object", "@ListCode", "@CardName", "@ListObjCode", "@boardCode" };
            object[] val = new object[] {dataSearch.CurrentPageList, 10,fromDatePara, toDatePara , session.IsAllData, session.IsUser, session.IsBranch,
                !string.IsNullOrEmpty(department) ? department : "", session.UserName, listUserOfBranch, session.UserId, !string.IsNullOrEmpty(branch) ? branch : "",
                 dataSearch.Status, dataSearch.Object, listCode, dataSearch.CardName, listObject, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_LIST_AND_CARD_CUSTOMER", param, val);
            var query = CommonUtil.ConvertDataTable<ListAndCard>(rs);
            return query;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardCustomer(AdvanceSearchObj dataSearch)
        {
            var query = new List<GridCardJtable>();
            if (dataSearch.ListObjCode.Any())
            {
                query = GetGirdCardInCustomer(dataSearch);
            }
            else
            {
                query = GetGirdCardOutCustomer(dataSearch);
            }
            return query;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardInCustomer(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }
            if (string.IsNullOrEmpty(dataSearch.CardName) && string.IsNullOrEmpty(dataSearch.FromDate) && string.IsNullOrEmpty(dataSearch.ToDate)
                && string.IsNullOrEmpty(dataSearch.Status) && string.IsNullOrEmpty(dataSearch.WorkflowInstCode))
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                "@UserId", "@listObjCode", "@Branch" };
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , session.IsAllData, session.IsUser, session.IsBranch,
                 !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                  !string.IsNullOrEmpty(dataSearch.BranchId) ? dataSearch.BranchId : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_CUSTOMER_NO_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }
            else
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                "@UserId", "@listObjCode", "@Branch", "@CardName", "@FromDate", "@toDate", "@Status", "@WorkflowInstCode" };
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , session.IsAllData, session.IsUser, session.IsBranch,
                    !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                    !string.IsNullOrEmpty(dataSearch.BranchId) ? dataSearch.BranchId : "", dataSearch.CardName, fromDatePara,
                    toDatePara, dataSearch.Status, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_CUSTOMER_WITH_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }

            //var query = (from a in _context.WORKOSCards.Where(x => !x.IsDeleted)
            //             let lt = a.LstUser.Split(",", StringSplitOptions.None)
            //             join c in _context.Users on a.CreatedBy equals c.UserName into c1
            //             from c2 in c1.DefaultIfEmpty()
            //             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
            //             from g2 in g1.DefaultIfEmpty()
            //             join h in _context.Users.Where(x => x.Active) on a.CreatedBy equals h.UserName into h1
            //             from h2 in h1.DefaultIfEmpty()
            //             join i in _context.WORKOSLists.Where(x => !x.IsDeleted) on a.ListCode equals i.ListCode
            //             join k in _context.WORKOSBoards.Where(x => !x.IsDeleted) on i.BoardCode equals k.BoardCode
            //             join b in _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && dataSearch.ListObjCode.Any(y => y.Code == x.ObjID)) on a.CardCode equals b.CardCode
            //             where (fromDate == null || a.BeginTime.Date >= fromDate) &&
            //                   (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
            //                   ((string.IsNullOrEmpty(dataSearch.Status) && a.Status != "TRASH") || a.Status.Equals(dataSearch.Status)) &&
            //                   (string.IsNullOrEmpty(dataSearch.BranchId) || c2.BranchId.Equals(dataSearch.BranchId)) &&
            //                   ((string.IsNullOrEmpty(dataSearch.CardName) || a.CardCode.ToLower().Contains(dataSearch.CardName.ToLower())) || (string.IsNullOrEmpty(dataSearch.CardName) || a.CardName.ToUpper().Contains(dataSearch.CardName.ToUpper())))
            //                   //&& (session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
            //                   && (session.IsAllData
            //                    || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
            //                    || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
            //             select new GridCardJtable
            //             {
            //                 CardID = a.CardID,
            //                 CardCode = a.CardCode,
            //                 CardName = a.CardName,
            //                 ListName = _context.WORKOSLists.FirstOrDefault(y => y.ListCode.Equals(a.ListCode)).ListName ?? "",
            //                 BoardName = k.BoardName,
            //                 Deadline = a.Deadline,
            //                 Currency = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == a.Currency).ValueSet ?? "",
            //                 Cost = a.Cost,
            //                 Completed = a.Completed,
            //                 BeginTime = a.BeginTime,
            //                 EndTime = a.EndTime,
            //                 Status = _context.CommonSettings.FirstOrDefault(y => y.CodeSet.Equals(a.Status)).ValueSet,
            //                 UpdateTime = a.UpdatedTime,
            //                 CreatedBy = h2.GivenName,
            //                 CreatedTime = a.CreatedDate.ToString("dd/MM/yyyy"),
            //                 CreatedDate = a.CreatedDate,
            //                 UpdatedTimeTxt = a.UpdatedTime.HasValue ? a.UpdatedTime.Value.ToString("dd/MM/yyyy HH:mm:ss") : "",
            //                 WorkType = !string.IsNullOrEmpty(a.WorkType) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.WorkType).ValueSet : "",
            //                 Priority = !string.IsNullOrEmpty(a.CardLevel) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.CardLevel).ValueSet : "",
            //             }).DistinctBy(x => x.CardCode).OrderByDescending(x => x.UpdateTime.HasValue ? x.UpdateTime.Value : x.CreatedDate).ThenByDescending(x => x.CardID);
            //IQueryable<GridCardJtable> data1 = query.AsQueryable<GridCardJtable>();
            //return data1;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardOutCustomer(AdvanceSearchObj dataSearch)
        {
            //return GetGirdCardOut(dataSearch);
            //var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            //var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            //var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            //var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            //var listUserOfBranch = "";
            //if (session.IsBranch)
            //{
            //    if (session.ListUserOfBranch.Any())
            //    {
            //        listUserOfBranch = string.Join(",", session.ListUserOfBranch);
            //    }
            //}
            //string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
            //    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            //object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
            //    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",
            //    session.UserId, user.BranchId, dataSearch.Status, dataSearch.Object, dataSearch.ObjType, dataSearch.CardName};
            //DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_OUT_CUSTOMER", param, val);
            //var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
            //return query;
            return new List<GridCardJtable>();
        }
        #endregion

        #region Contract
        [HttpGet]
        public object GetListPageContract(int page, int length, string name)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var lstUserBranch = "";
            if (session.ListUserOfBranch != null)
            {
                lstUserBranch = string.Join(",", session.ListUserOfBranch);
            }

            int intBeginFor = (page - 1) * length;
            var count = _context.PoSaleHeaders.Where(x => (string.IsNullOrEmpty(name) || x.Title.ToLower().Contains(name.ToLower())) && x.IsDeleted == false && session.IsAllData || session.ListContract.Any(p => p.Equals(x.ContractCode))).Count();
            var data = _context.PoSaleHeaders.Where(x => (string.IsNullOrEmpty(name) || (x.Title.ToLower().Contains(name.ToLower()))) &&
              (x.IsDeleted == false) && (session.IsAllData || session.ListContract.Any(p => p.Equals(x.ContractCode)))).OrderByDescending(x => x.ContractHeaderID).Skip(intBeginFor).Take(length).Select(x => new PageProjectModel
              {
                  Id = x.ContractHeaderID,
                  Code = x.ContractCode,
                  Name = x.Title,
                  CreatedTime = x.CreatedTime,
                  PercentObject = 0,
                  CountWork = 0,
                  IsCheck = false,
                  Type = "CONTRACT",
                  IsShowPercent = false
              }).ToList();

            var lstCountWork = GetCountCardObject("CONTRACT", string.Join(",", data.Select(x => x.Code)), session.IsAllData, session.IsBranch,
                   session.IsUser, session.UserName, lstUserBranch, session.UserId, !string.IsNullOrEmpty(session.DepartmentCode) ? session.DepartmentCode : "");

            foreach (var item in data)
            {
                foreach (var k in lstCountWork)
                {
                    if (item.Code.Equals(k.ObjID))
                    {
                        item.CountWork = k.CountCard;
                        break;
                    }
                }
            }

            return (new
            {
                Tab = "Hợp đồng",
                Icon = "fa fa-suitcase",
                Total = count,
                ListData = data,
            });
        }

        [HttpPost]
        public JsonResult GetCardWithContract([FromBody] AdvanceSearchObj data)
        {
            //if (data.ListObjCode.Any())
            //{
            //    return Json(GetCardDataInContract(data));
            //}
            //else
            //{
            //    return Json(GetCardDataOutContract(data));
            //}
            return Json(GetCardDataInContract(data));
        }
        [NonAction]
        public object GetCardDataInContract(AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var query = (from a in _context.JcObjectIdRelatives.Where(x => x.ObjTypeCode == "CONTRACT" && !x.IsDeleted)
            //             join b in _context.WORKOSCards on a.CardCode equals b.CardCode
            //             let lt = b.LstUser.Split(",", StringSplitOptions.None)
            //             join g in _context.CardMappings on b.CardCode equals g.CardCode into g1
            //             from g2 in g1.DefaultIfEmpty()
            //             join c in _context.Users.Where(x => x.Active) on b.CreatedBy equals c.UserName
            //             where data.ListObjCode.Any(x => x.Code == a.ObjID) &&
            //             (fromDate == null || b.BeginTime >= fromDate) &&
            //             (toDate == null || (b.EndTime.HasValue ? b.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
            //             ((string.IsNullOrEmpty(data.Status) && b.Status != "TRASH") || (!string.IsNullOrEmpty(b.Status) && b.Status.Equals(data.Status))) &&
            //             (string.IsNullOrEmpty(data.BranchId) || (!string.IsNullOrEmpty(c.BranchId) && c.BranchId.Equals(data.BranchId))) &&
            //             (string.IsNullOrEmpty(data.CardName) || b.CardName.ToUpper().Contains(data.CardName.ToUpper())) &&
            //             b.IsDeleted == false
            //             //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(b.LstUser) && lt.Any(y => session.UserId == y)) || b.CreatedBy == session.UserName)
            //             && (session.IsAllData
            //            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(b.LstUser) && lt.Any(y => session.UserId == y)) || b.CreatedBy == session.UserName))
            //            || (session.IsBranch && (!string.IsNullOrEmpty(b.LstUser) && lt.Any(k => k == session.UserId) || b.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == b.CreatedBy))))

            //             group b by b.ListCode into g
            //             select new
            //             {
            //                 ListCode = g.Key,
            //                 ListCard = g.Select(y => new
            //                 {
            //                     y.CardID,
            //                     y.CardCode,
            //                     y.CardName,
            //                     y.Deadline,
            //                     y.Quantitative,
            //                     y.Unit,
            //                     y.Currency,
            //                     y.Status,
            //                     BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
            //                     EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
            //                     y.Cost,
            //                     y.Completed,

            //                 }).Distinct()
            //             }).AsNoTracking();
            //var list = (from a in query
            //            join b in _context.WORKOSLists on a.ListCode equals b.ListCode
            //            where b.IsDeleted == false
            //            select new { a, b });
            var list = (from a in _context.WORKOSLists.Where(x => !x.IsDeleted)
                        join b in _context.WORKOSCards.Where(x => !x.IsDeleted && x.Status != "TRASH") on a.ListCode equals b.ListCode
                        select new
                        {
                            a.ListID,
                            a.ListCode,
                            a.ListName,
                            a.Completed,
                            a.WeightNum,
                            a.Status,
                            a.BeginTime,
                            a.Deadline,
                            a.Background,
                            a.Order
                        }).DistinctBy(x => x.ListCode);
            var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
            {
                x.ListID,
                x.ListCode,
                x.ListName,
                x.Completed,
                x.WeightNum,
                x.Status,
                x.BeginTime,
                x.Deadline,
                x.Background,
                x.Order,
                //ListCard = x.a.ListCard.Select(y => new
                //{
                //    y.CardID,
                //    y.CardCode,
                //    y.CardName,
                //    y.Deadline,
                //    y.Quantitative,
                //    y.Unit,
                //    y.Currency,
                //    CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                //    y.BeginTime,
                //    y.EndTime,
                //    Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                //    CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                //    CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                //    y.Cost,
                //    y.Completed,

                //})
                ListCard = ListCardInOutContract(data, x.ListCode, user.BranchId, user.DepartmentId)
            });
            return new
            {
                Data = listPaging,
                Total = list.Count(),
            };
        }

        [NonAction]
        public object GetCardDataOutContract(AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //danh sách card mới,thẻ mới
            if (fromDate == null && toDate == null && string.IsNullOrEmpty(data.CardName) && string.IsNullOrEmpty(data.Status) && string.IsNullOrEmpty(data.BranchId))
            {
                var query = (from a in _context.WORKOSCards
                             let lt = a.LstUser.Split(",", StringSplitOptions.None)
                             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
                             from g2 in g1.DefaultIfEmpty()
                             where a.CreatedDate.Date == DateTime.Today && a.IsDeleted == false
                             //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
                             && (session.IsAllData
                            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
                            || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))

                             group a by a.ListCode into g
                             select new
                             {
                                 ListCode = g.Key,
                             }).AsNoTracking();
                var list = (from a in _context.WORKOSLists
                            from b in query
                            where ((a.ListCode == b.ListCode) || (a.CreatedDate.Date == DateTime.Today) && a.IsDeleted == false)
                            select a).Distinct().AsNoTracking();
                var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
                {
                    x.ListID,
                    x.ListCode,
                    x.ListName,
                    x.Completed,
                    x.WeightNum,
                    x.Status,
                    x.BeginTime,
                    x.Deadline,
                    x.Background,
                    x.Order,
                    ListCard = _context.WORKOSCards.Where(y => y.ListCode == x.ListCode && y.CreatedDate.Date == DateTime.Today && y.IsDeleted == false).Select(y => new
                    {
                        y.CardID,
                        y.CardCode,
                        y.CardName,
                        y.Deadline,
                        y.Quantitative,
                        y.Unit,
                        y.Currency,
                        CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                        BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
                        EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
                        Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                        CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                        CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                        y.Cost,
                        y.Completed,

                    }).Distinct()
                });
                return new
                {
                    Data = listPaging,
                    Total = list.Count(),
                };
            }
            else
            {
                var query = (from a in _context.WORKOSCards
                             let lt = a.LstUser.Split(",", StringSplitOptions.None)
                             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
                             from g2 in g1.DefaultIfEmpty()
                             join b in _context.Users.Where(x => x.Active) on a.CreatedBy equals b.UserName
                             where (fromDate == null || a.BeginTime >= fromDate) &&
                             (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
                             ((string.IsNullOrEmpty(data.Status) && a.Status != "TRASH") || (!string.IsNullOrEmpty(a.Status) && a.Status.Equals(data.Status))) &&
                             (string.IsNullOrEmpty(data.BranchId) || b.BranchId.Equals(data.BranchId)) &&
                             (string.IsNullOrEmpty(data.CardName) || a.CardName.ToUpper().Contains(data.CardName.ToUpper())) &&
                             a.IsDeleted == false
                             //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
                             && (session.IsAllData
                            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
                            || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))

                             group a by a.ListCode into g
                             select new
                             {
                                 ListCode = g.Key,
                                 ListCard = g.Select(y => new
                                 {
                                     y.CardID,
                                     y.CardCode,
                                     y.CardName,
                                     y.Deadline,
                                     y.Quantitative,
                                     y.Unit,
                                     y.Currency,
                                     y.Status,
                                     BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
                                     EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
                                     y.Cost,
                                     y.Completed,

                                 }).Distinct()
                             }).AsNoTracking();
                var list = (from a in query
                            join b in _context.WORKOSLists on a.ListCode equals b.ListCode
                            where b.IsDeleted == false
                            select new { a, b });
                var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
                {
                    x.b.ListID,
                    x.b.ListCode,
                    x.b.ListName,
                    x.b.Completed,
                    x.b.WeightNum,
                    x.b.Status,
                    x.b.BeginTime,
                    x.b.Deadline,
                    x.b.Background,
                    x.b.Order,
                    ListCard = x.a.ListCard.Select(y => new
                    {
                        y.CardID,
                        y.CardCode,
                        y.CardName,
                        y.Deadline,
                        y.Quantitative,
                        y.Unit,
                        y.Currency,
                        CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                        y.BeginTime,
                        y.EndTime,
                        Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                        CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                        CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                        y.Cost,
                        y.Completed,

                    })
                });
                return new
                {
                    Data = listPaging,
                    Total = list.Count(),
                };
            }
        }

        [NonAction]
        private List<ListAndCard> ListCardInOutContract(AdvanceSearchObj dataSearch, string listCode, string branch, string department)
        {
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var session = HttpContext.GetSessionUser();
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            var listObject = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            if (dataSearch.ListObjCode.Any())
            {
                listObject = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }

            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName",
                "@ListUserOfBranch", "@UserId", "@BranchId", "@Status", "@Object", "@ListCode", "@CardName", "@ListObjCode", "@boardCode" };
            object[] val = new object[] {dataSearch.CurrentPageList, 10,fromDatePara, toDatePara , session.IsAllData, session.IsUser, session.IsBranch,
                !string.IsNullOrEmpty(department) ? department : "", session.UserName, listUserOfBranch, session.UserId, !string.IsNullOrEmpty(branch) ? branch : "",
                 dataSearch.Status, dataSearch.Object, listCode, dataSearch.CardName, listObject, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_LIST_AND_CARD_CONTRACT", param, val);
            var query = CommonUtil.ConvertDataTable<ListAndCard>(rs);
            return query;
        }


        [NonAction]
        public List<GridCardJtable> GetGirdCardContract(AdvanceSearchObj dataSearch)
        {
            var query = new List<GridCardJtable>();
            if (dataSearch.ListObjCode.Any())
            {
                query = GetGirdCardInContract(dataSearch);
            }
            else
            {
                query = GetGirdCardOutContract(dataSearch);
            }
            return query;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardInContract(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }
            if (string.IsNullOrEmpty(dataSearch.CardName) && string.IsNullOrEmpty(dataSearch.FromDate) && string.IsNullOrEmpty(dataSearch.ToDate)
                && string.IsNullOrEmpty(dataSearch.Status) && string.IsNullOrEmpty(dataSearch.WorkflowInstCode))
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                "@UserId", "@listObjCode", "@Branch" };
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , session.IsAllData, session.IsUser, session.IsBranch,
                 !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                  !string.IsNullOrEmpty(dataSearch.BranchId) ? dataSearch.BranchId : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_CONTRACT_NO_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }
            else
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                "@UserId", "@listObjCode", "@Branch", "@CardName", "@FromDate", "@toDate", "@Status", "@WorkflowInstCode" };
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , session.IsAllData, session.IsUser, session.IsBranch,
                    !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                    !string.IsNullOrEmpty(dataSearch.BranchId) ? dataSearch.BranchId : "", dataSearch.CardName, fromDatePara,
                    toDatePara, dataSearch.Status, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_CONTRACT_WITH_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }

            //var query = (from a in _context.WORKOSCards.Where(x => !x.IsDeleted)
            //             let lt = a.LstUser.Split(",", StringSplitOptions.None)
            //             join c in _context.Users on a.CreatedBy equals c.UserName into c1
            //             from c2 in c1.DefaultIfEmpty()
            //             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
            //             from g2 in g1.DefaultIfEmpty()
            //             join h in _context.Users.Where(x => x.Active) on a.CreatedBy equals h.UserName into h1
            //             from h2 in h1.DefaultIfEmpty()
            //             join i in _context.WORKOSLists.Where(x => !x.IsDeleted) on a.ListCode equals i.ListCode
            //             join k in _context.WORKOSBoards.Where(x => !x.IsDeleted) on i.BoardCode equals k.BoardCode
            //             join b in _context.JcObjectIdRelatives.Where(x => dataSearch.ListObjCode.Any(y => y.Code == x.ObjID) && !x.IsDeleted) on a.CardCode equals b.CardCode
            //             where (fromDate == null || a.BeginTime.Date >= fromDate) &&
            //                   (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
            //                   ((string.IsNullOrEmpty(dataSearch.Status) && a.Status != "TRASH") || a.Status.Equals(dataSearch.Status)) &&
            //                   (string.IsNullOrEmpty(dataSearch.BranchId) || c2.BranchId.Equals(dataSearch.BranchId)) &&
            //                   ((string.IsNullOrEmpty(dataSearch.CardName) || a.CardCode.ToLower().Contains(dataSearch.CardName.ToLower())) || (string.IsNullOrEmpty(dataSearch.CardName) || a.CardName.ToUpper().Contains(dataSearch.CardName.ToUpper())))
            //                   //&& (session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
            //                   && (session.IsAllData
            //                    || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
            //                    || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
            //             select new GridCardJtable
            //             {
            //                 CardID = a.CardID,
            //                 CardCode = a.CardCode,
            //                 CardName = a.CardName,
            //                 ListName = _context.WORKOSLists.FirstOrDefault(y => y.ListCode.Equals(a.ListCode)).ListName ?? "",
            //                 BoardName = k.BoardName,
            //                 Deadline = a.Deadline,
            //                 Currency = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == a.Currency).ValueSet ?? "",
            //                 Cost = a.Cost,
            //                 Completed = a.Completed,
            //                 BeginTime = a.BeginTime,
            //                 EndTime = a.EndTime,
            //                 Status = _context.CommonSettings.FirstOrDefault(y => y.CodeSet.Equals(a.Status)).ValueSet,
            //                 UpdateTime = a.UpdatedTime,
            //                 CreatedBy = h2.GivenName,
            //                 CreatedTime = a.CreatedDate.ToString("dd/MM/yyyy"),
            //                 CreatedDate = a.CreatedDate,
            //                 UpdatedTimeTxt = a.UpdatedTime.HasValue ? a.UpdatedTime.Value.ToString("dd/MM/yyyy HH:mm:ss") : "",
            //                 WorkType = !string.IsNullOrEmpty(a.WorkType) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.WorkType).ValueSet : "",
            //                 Priority = !string.IsNullOrEmpty(a.CardLevel) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.CardLevel).ValueSet : "",
            //             }).DistinctBy(x => x.CardCode).OrderByDescending(x => x.UpdateTime.HasValue ? x.UpdateTime.Value : x.CreatedDate).ThenByDescending(x => x.CardID);
            //IQueryable<GridCardJtable> data1 = query.AsQueryable<GridCardJtable>();
            //return data1;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardOutContract(AdvanceSearchObj dataSearch)
        {
            //var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            //var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            //var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            //var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            //var listUserOfBranch = "";
            //if (session.IsBranch)
            //{
            //    if (session.ListUserOfBranch.Any())
            //    {
            //        listUserOfBranch = string.Join(",", session.ListUserOfBranch);
            //    }
            //}
            //string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
            //    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            //object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
            //    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",
            //    session.UserId, user.BranchId, dataSearch.Status, dataSearch.Object, dataSearch.ObjType, dataSearch.CardName};
            //DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_OUT_CONTRACT", param, val);
            //var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
            //return query;
            return new List<GridCardJtable>();
        }
        #endregion

        #region Supplier
        [HttpGet]
        public object GetListPageSupplier(int page, int length, string name)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (page - 1) * length;
            var count = _context.Suppliers.Where(x => (string.IsNullOrEmpty(name) || x.SupName.ToLower().Contains(name.ToLower())) && x.IsDeleted == false).Count();
            var data = (_context.Suppliers.Where(x => (string.IsNullOrEmpty(name) || (x.SupName.ToLower().Contains(name.ToLower()))) &&
              (x.IsDeleted == false)).OrderByDescending(x => x.SupID).Skip(intBeginFor).Take(length).Select(x => new PageProjectModel
              {
                  Id = x.SupID,
                  Code = x.SupCode,
                  Name = x.SupName,
                  CreatedTime = x.CreatedTime,
                  CountWork = 0,
                  IsCheck = false,
                  IsShowPercent = false,
                  PercentObject = 0,
                  Type = "SUPPLIER"
              })).ToList();

            var lstUserBranch = "";
            if (session.ListUserOfBranch != null)
            {
                lstUserBranch = string.Join(",", session.ListUserOfBranch);
            }
            var lstCountWork = GetCountCardObject("SUPPLIER", string.Join(",", data.Select(x => x.Code)), session.IsAllData, session.IsBranch,
                    session.IsUser, session.UserName, lstUserBranch, session.UserId, !string.IsNullOrEmpty(session.DepartmentCode) ? session.DepartmentCode : "");
            foreach (var item in data)
            {
                foreach (var k in lstCountWork)
                {
                    if (item.Code.Equals(k.ObjID))
                    {
                        item.CountWork = k.CountCard;
                        break;
                    }
                }
            }

            return (new
            {
                Tab = "Nhà cung cấp",
                Icon = "fas fa-user",
                Total = count,
                ListData = data,
            });
        }

        [HttpPost]
        public JsonResult GetCardWithSupplier([FromBody] AdvanceSearchObj data)
        {
            //if (data.ListObjCode.Any())
            //{
            //    return Json(GetCardDataInSupplier(data));
            //}
            //else
            //{
            //    return Json(GetCardDataOutSupplier(data));
            //}
            return Json(GetCardDataInSupplier(data));
        }

        [NonAction]
        public object GetCardDataInSupplier(AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var query = (from a in _context.JcObjectIdRelatives.Where(x => x.ObjTypeCode == "SUPPLIER" && !x.IsDeleted)
            //             join b in _context.WORKOSCards.Where(x => !x.IsDeleted) on a.CardCode equals b.CardCode
            //             let lt = b.LstUser.Split(",", StringSplitOptions.None)
            //             join g in _context.CardMappings on b.CardCode equals g.CardCode into g1
            //             from g2 in g1.DefaultIfEmpty()
            //             join c in _context.Users.Where(x => x.Active) on b.CreatedBy equals c.UserName
            //             where data.ListObjCode.Any(x => x.Code == a.ObjID) &&
            //             (fromDate == null || b.BeginTime >= fromDate) &&
            //             (toDate == null || (b.EndTime.HasValue ? b.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
            //             ((string.IsNullOrEmpty(data.Status) && b.Status != "TRASH") || (!string.IsNullOrEmpty(b.Status) && b.Status.Equals(data.Status))) &&
            //             (string.IsNullOrEmpty(data.BranchId) || (!string.IsNullOrEmpty(c.BranchId) && c.BranchId.Equals(data.BranchId))) &&
            //             (string.IsNullOrEmpty(data.CardName) || b.CardName.ToUpper().Contains(data.CardName.ToUpper()))
            //             //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(b.LstUser) && lt.Any(y => session.UserId == y)) || b.CreatedBy == session.UserName)
            //             && (session.IsAllData
            //            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(b.LstUser) && lt.Any(y => session.UserId == y)) || b.CreatedBy == session.UserName))
            //            || (session.IsBranch && (!string.IsNullOrEmpty(b.LstUser) && lt.Any(k => k == session.UserId) || b.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == b.CreatedBy))))

            //             group b by b.ListCode into g
            //             select new
            //             {
            //                 ListCode = g.Key,
            //                 ListCard = g.Select(y => new
            //                 {
            //                     y.CardID,
            //                     y.CardCode,
            //                     y.CardName,
            //                     y.Deadline,
            //                     y.Quantitative,
            //                     y.Unit,
            //                     y.Currency,
            //                     y.Status,
            //                     BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
            //                     EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
            //                     y.Cost,
            //                     y.Completed,

            //                 }).Distinct()
            //             }).AsNoTracking();
            //var list = (from a in query
            //            join b in _context.WORKOSLists on a.ListCode equals b.ListCode
            //            where b.IsDeleted == false
            //            select new { a, b });

            var list = (from a in _context.WORKOSLists.Where(x => !x.IsDeleted)
                        join b in _context.WORKOSCards.Where(x => !x.IsDeleted && x.Status != "TRASH") on a.ListCode equals b.ListCode
                        select new
                        {
                            a.ListID,
                            a.ListCode,
                            a.ListName,
                            a.Completed,
                            a.WeightNum,
                            a.Status,
                            a.BeginTime,
                            a.Deadline,
                            a.Background,
                            a.Order
                        }).DistinctBy(x => x.ListCode);
            var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
            {
                x.ListID,
                x.ListCode,
                x.ListName,
                x.Completed,
                x.WeightNum,
                x.Status,
                x.BeginTime,
                x.Deadline,
                x.Background,
                x.Order,
                //ListCard = x.a.ListCard.Select(y => new
                //{
                //    y.CardID,
                //    y.CardCode,
                //    y.CardName,
                //    y.Deadline,
                //    y.Quantitative,
                //    y.Unit,
                //    y.Currency,
                //    CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                //    y.BeginTime,
                //    y.EndTime,
                //    Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                //    CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                //    CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                //    y.Cost,
                //    y.Completed,

                //})
                ListCard = ListCardInOutSupplier(data, x.ListCode, user.BranchId, user.DepartmentId)
            });
            return new
            {
                Data = listPaging,
                Total = list.Count(),
            };
        }

        [NonAction]
        public object GetCardDataOutSupplier(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (dataSearch.Page - 1) * dataSearch.Length;
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //danh sách card mới,thẻ mới

            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    foreach (var item in session.ListUserOfBranch)
                    {
                        listUserOfBranch += item + ",";
                    }
                }
            }

            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
                "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
                session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch,
                !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",session.UserId,  !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "",
                dataSearch.Status, !string.IsNullOrEmpty(dataSearch.Object) ? dataSearch.Object : "", !string.IsNullOrEmpty(dataSearch.ObjType) ? dataSearch.ObjType : "", dataSearch.CardName};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD", param, val);
            var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
            return query;
            //if (fromDate == null && toDate == null && string.IsNullOrEmpty(data.CardName) && string.IsNullOrEmpty(data.Status) && string.IsNullOrEmpty(data.BranchId))
            //{
            //    var query = (from a in _context.WORKOSCards
            //                 let lt = a.LstUser.Split(",", StringSplitOptions.None)
            //                 join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
            //                 from g2 in g1.DefaultIfEmpty()
            //                 where a.CreatedDate.Date == DateTime.Today && a.IsDeleted == false
            //                 //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
            //                 && (session.IsAllData
            //                || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
            //                || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))

            //                 group a by a.ListCode into g
            //                 select new
            //                 {
            //                     ListCode = g.Key,
            //                 }).AsNoTracking();
            //    var list = (from a in _context.WORKOSLists
            //                from b in query
            //                where ((a.ListCode == b.ListCode) || (a.CreatedDate.Date == DateTime.Today) && a.IsDeleted == false)
            //                select a).Distinct().AsNoTracking();
            //    var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
            //    {
            //        x.ListID,
            //        x.ListCode,
            //        x.ListName,
            //        x.Completed,
            //        x.WeightNum,
            //        x.Status,
            //        x.BeginTime,
            //        x.Deadline,
            //        x.Background,
            //        x.Order,
            //        ListCard = _context.WORKOSCards.Where(y => y.ListCode == x.ListCode && y.CreatedDate.Date == DateTime.Today && y.IsDeleted == false).Select(y => new
            //        {
            //            y.CardID,
            //            y.CardCode,
            //            y.CardName,
            //            y.Deadline,
            //            y.Quantitative,
            //            y.Unit,
            //            y.Currency,
            //            CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
            //            BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
            //            EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
            //            Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
            //            CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
            //            CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
            //            y.Cost,
            //            y.Completed,
            //            
            //        }).Distinct()
            //    });
            //    return new
            //    {
            //        Data = listPaging,
            //        Total = list.Count(),
            //    };
            //}
            //else
            //{
            //    var query = (from a in _context.WORKOSCards
            //                 let lt = a.LstUser.Split(",", StringSplitOptions.None)
            //                 join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
            //                 from g2 in g1.DefaultIfEmpty()
            //                 join b in _context.Users.Where(x => x.Active) on a.CreatedBy equals b.UserName
            //                 where (fromDate == null || a.BeginTime >= fromDate) &&
            //                 (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
            //                 ((string.IsNullOrEmpty(data.Status) && a.Status != "TRASH") || (!string.IsNullOrEmpty(a.Status) && a.Status.Equals(data.Status))) &&
            //                 (string.IsNullOrEmpty(data.BranchId) || b.BranchId.Equals(data.BranchId)) &&
            //                 (string.IsNullOrEmpty(data.CardName) || a.CardName.ToUpper().Contains(data.CardName.ToUpper())) &&
            //                 a.IsDeleted == false
            //                 //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
            //                 && (session.IsAllData
            //                || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
            //                || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))

            //                 group a by a.ListCode into g
            //                 select new
            //                 {
            //                     ListCode = g.Key,
            //                     ListCard = g.Select(y => new
            //                     {
            //                         y.CardID,
            //                         y.CardCode,
            //                         y.CardName,
            //                         y.Deadline,
            //                         y.Quantitative,
            //                         y.Unit,
            //                         y.Currency,
            //                         y.Status,
            //                         BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
            //                         EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
            //                         y.Cost,
            //                         y.Completed,
            //                         
            //                     }).Distinct()
            //                 }).AsNoTracking();
            //    var list = (from a in query
            //                join b in _context.WORKOSLists on a.ListCode equals b.ListCode
            //                where b.IsDeleted == false
            //                select new { a, b });
            //    var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
            //    {
            //        x.b.ListID,
            //        x.b.ListCode,
            //        x.b.ListName,
            //        x.b.Completed,
            //        x.b.WeightNum,
            //        x.b.Status,
            //        x.b.BeginTime,
            //        x.b.Deadline,
            //        x.b.Background,
            //        x.b.Order,
            //        ListCard = x.a.ListCard.Select(y => new
            //        {
            //            y.CardID,
            //            y.CardCode,
            //            y.CardName,
            //            y.Deadline,
            //            y.Quantitative,
            //            y.Unit,
            //            y.Currency,
            //            CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
            //            y.BeginTime,
            //            y.EndTime,
            //            Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
            //            CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
            //            CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
            //            y.Cost,
            //            y.Completed,
            //            
            //        })
            //    });
            //    return new
            //    {
            //        Data = listPaging,
            //        Total = list.Count(),
            //    };
            //}
        }

        [NonAction]
        private List<ListAndCard> ListCardInOutSupplier(AdvanceSearchObj dataSearch, string listCode, string branch, string department)
        {
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var session = HttpContext.GetSessionUser();
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            var listObject = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            if (dataSearch.ListObjCode.Any())
            {
                listObject = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }

            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName",
                "@ListUserOfBranch", "@UserId", "@BranchId", "@Status", "@Object", "@ListCode", "@CardName", "@ListObjCode", "@boardCode" };
            object[] val = new object[] {dataSearch.CurrentPageList, 10,fromDatePara, toDatePara , session.IsAllData, session.IsUser, session.IsBranch,
                !string.IsNullOrEmpty(department) ? department : "", session.UserName, listUserOfBranch, session.UserId, !string.IsNullOrEmpty(branch) ? branch : "",
                 dataSearch.Status, dataSearch.Object, listCode, dataSearch.CardName, listObject, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_LIST_AND_CARD_SUPPLIER", param, val);
            var query = CommonUtil.ConvertDataTable<ListAndCard>(rs);
            return query;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardSupplier(AdvanceSearchObj dataSearch)
        {
            var query = new List<GridCardJtable>();
            if (dataSearch.ListObjCode.Any())
            {
                query = GetGirdCardInSupplier(dataSearch);
            }
            else
            {
                query = GetGirdCardOutSupplier(dataSearch);
            }
            return query;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardInSupplier(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }
            if (string.IsNullOrEmpty(dataSearch.CardName) && string.IsNullOrEmpty(dataSearch.FromDate) && string.IsNullOrEmpty(dataSearch.ToDate)
                && string.IsNullOrEmpty(dataSearch.Status) && string.IsNullOrEmpty(dataSearch.WorkflowInstCode))
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                "@UserId", "@listObjCode", "@Branch" };
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , session.IsAllData, session.IsUser, session.IsBranch,
                 !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                  !string.IsNullOrEmpty(dataSearch.BranchId) ? dataSearch.BranchId : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_SUPPLIER_NO_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }
            else
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                "@UserId", "@listObjCode", "@Branch", "@CardName", "@FromDate", "@toDate", "@Status", "@WorkflowInstCode" };
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , session.IsAllData, session.IsUser, session.IsBranch,
                    !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                    !string.IsNullOrEmpty(dataSearch.BranchId) ? dataSearch.BranchId : "", dataSearch.CardName, fromDatePara,
                    toDatePara, dataSearch.Status, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_SUPPLIER_WITH_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }

            //var query = (from a in _context.WORKOSCards.Where(x => !x.IsDeleted)
            //             join c in _context.Users on a.CreatedBy equals c.UserName into c1
            //             from c2 in c1.DefaultIfEmpty()
            //             let lt = a.LstUser.Split(",", StringSplitOptions.None)
            //             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
            //             from g2 in g1.DefaultIfEmpty()
            //             join h in _context.Users.Where(x => x.Active) on a.CreatedBy equals h.UserName into h1
            //             from h2 in h1.DefaultIfEmpty()
            //             join i in _context.WORKOSLists.Where(x => !x.IsDeleted) on a.ListCode equals i.ListCode
            //             join k in _context.WORKOSBoards.Where(x => !x.IsDeleted) on i.BoardCode equals k.BoardCode
            //             join b in _context.JcObjectIdRelatives.Where(x => x.ObjTypeCode == "SUPPLIER" && dataSearch.ListObjCode.Any(y => y.Code == x.ObjID)) on a.CardCode equals b.CardCode
            //             where (fromDate == null || a.BeginTime.Date >= fromDate) &&
            //                   (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
            //                   ((string.IsNullOrEmpty(dataSearch.Status) && a.Status != "TRASH") || a.Status.Equals(dataSearch.Status)) &&
            //                   (string.IsNullOrEmpty(dataSearch.BranchId) || c2.BranchId.Equals(dataSearch.BranchId)) &&
            //                   ((string.IsNullOrEmpty(dataSearch.CardName) || a.CardCode.ToLower().Contains(dataSearch.CardName.ToLower())) || (string.IsNullOrEmpty(dataSearch.CardName) || a.CardName.ToUpper().Contains(dataSearch.CardName.ToUpper())))
            //                   //&& (session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
            //                   && (session.IsAllData
            //                || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
            //                || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
            //             select new GridCardJtable
            //             {
            //                 CardID = a.CardID,
            //                 CardCode = a.CardCode,
            //                 CardName = a.CardName,
            //                 ListName = _context.WORKOSLists.FirstOrDefault(y => y.ListCode.Equals(a.ListCode)).ListName ?? "",
            //                 BoardName = k.BoardName,
            //                 Deadline = a.Deadline,
            //                 Currency = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == a.Currency).ValueSet ?? "",
            //                 Cost = a.Cost,
            //                 Completed = a.Completed,
            //                 BeginTime = a.BeginTime,
            //                 EndTime = a.EndTime,
            //                 Status = _context.CommonSettings.FirstOrDefault(y => y.CodeSet.Equals(a.Status)).ValueSet,
            //                 UpdateTime = a.UpdatedTime,
            //                 CreatedBy = h2.GivenName,
            //                 CreatedTime = a.CreatedDate.ToString("dd/MM/yyyy"),
            //                 CreatedDate = a.CreatedDate,
            //                 UpdatedTimeTxt = a.UpdatedTime.HasValue ? a.UpdatedTime.Value.ToString("dd/MM/yyyy HH:mm:ss") : "",
            //                 WorkType = !string.IsNullOrEmpty(a.WorkType) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.WorkType).ValueSet : "",
            //                 Priority = !string.IsNullOrEmpty(a.CardLevel) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.CardLevel).ValueSet : "",
            //             }).DistinctBy(x => x.CardCode).OrderByDescending(x => x.UpdateTime.HasValue ? x.UpdateTime.Value : x.CreatedDate).ThenByDescending(x => x.CardID);
            //IQueryable<GridCardJtable> data1 = query.AsQueryable<GridCardJtable>();
            //return data1;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardOutSupplier(AdvanceSearchObj dataSearch)
        {
            //var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            //var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            //var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            //var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            //var listUserOfBranch = "";
            //if (session.IsBranch)
            //{
            //    if (session.ListUserOfBranch.Any())
            //    {
            //        listUserOfBranch = string.Join(",", session.ListUserOfBranch);
            //    }
            //}
            //string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
            //    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            //object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
            //    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",
            //    session.UserId, user.BranchId, dataSearch.Status, dataSearch.Object, dataSearch.ObjType, dataSearch.CardName};
            //DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_OUT_SUPPLIER", param, val);
            //var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
            //return query;
            return new List<GridCardJtable>();
        }
        #endregion

        #region Group User
        [HttpGet]
        public object GetListGroupUserPage(int page, int length, string name)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (page - 1) * length;
            var count = _context.AdGroupUsers
                .Where(x => string.IsNullOrEmpty(name) || x.Title.ToLower().Contains(name.ToLower())).Count();

            var data = _context.AdGroupUsers.Where(x => x.IsEnabled == true && !x.IsDeleted && (string.IsNullOrEmpty(name) || (x.Title.ToLower().Contains(name.ToLower())))).OrderByDescending(x => x.GroupUserId).Skip(intBeginFor).Take(length).Select(x => new
            {
                Id = x.GroupUserId,
                Code = x.GroupUserCode,
                Name = x.Title,
                CountWork = (from a in _context.WORKOSCards.Where(k => !k.IsDeleted && k.Status != "TRASH")
                             let lt = a.LstUser.Split(",", StringSplitOptions.None)
                             join b in _context.JobCardAssignees.Where(k => !k.IsDeleted && !string.IsNullOrEmpty(k.GroupCode)) on a.CardCode equals b.CardCode
                             where b.GroupCode.Equals(x.GroupUserCode) && (session.IsAllData
                             || (session.IsUser && ((!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || b.CreatedBy == session.UserName))
                             || (session.IsBranch && ((!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId)) || b.CreatedBy == session.UserName ||
                             (session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == b.CreatedBy)))))
                             select new
                             {
                                 a.CardID
                             }).Distinct().Count(),
                CreatedTime = x.CreatedDate,
                IsCheck = false
            });
            return (new
            {
                Tab = "Nhóm",
                Icon = "fa fa-users",
                Total = count,
                ListData = data,
            });
        }

        [HttpPost]
        public JsonResult GetCardWithGroupUser([FromBody] AdvanceSearchObj data)
        {
            //if (data.ListObjCode.Any())
            //{
            //    return Json(GetCardDataInGroupUser(data));
            //}
            //else
            //{
            //    return Json(GetCardDataOutGroupUser(data));
            //}
            return Json(GetCardDataInGroupUser(data));
        }

        //[HttpPost]
        //public JsonResult InsertTeam([FromBody]Team data)
        //{
        //    var msg = new JMessage() { Error = true };
        //    try
        //    {
        //        string code = "TEAM_" + (_context.Teams.Count() > 0 ? _context.Teams.Last().Id + 1 : 1);
        //        data.TeamCode = code;

        //        _context.Teams.Add(data);
        //        _context.SaveChanges();

        //        msg.Title = String.Format(_sharedResources["COM_MSG_ADD_SUCCESS"], _stringLocalizer["CJ_CURD_TXT_TEAM_CODE"]);//"Thêm nhóm mới thành công!";
        //        msg.Error = false;
        //        return Json(msg);
        //    }
        //    catch (Exception ex)
        //    {
        //        msg.Object = ex;
        //        msg.Title = _sharedResources["COM_MSG_ERR"];
        //        //msg.Title = String.Format(_stringLocalize["COM_MSG_ADD_FAILED"), _stringLocalize["CJ_CURD_TXT_TEAM_CODE"));//"Có lỗi xảy ra khi thêm!";
        //        return Json(msg);
        //    }
        //}

        //[HttpPost]
        //public JsonResult EditTeam([FromBody]Team data)
        //{
        //    var msg = new JMessage() { Error = true };
        //    try
        //    {
        //        var currentData = _context.Teams.FirstOrDefault(x => x.TeamCode == data.TeamCode);
        //        currentData.TeamName = data.TeamName;
        //        currentData.Members = data.Members;
        //        currentData.Leader = data.Leader;
        //        _context.SaveChanges();

        //        msg.Error = false;
        //        //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_SUCCESS"), _stringLocalize["CJ_CURD_TXT_TEAM_CODE")); //"Cập nhật thành công";
        //        msg.Title = String.Format(_sharedResources["COM_MSG_UPDATE_SUCCESS"], _stringLocalizer["CJ_CURD_TXT_TEAM_CODE"]);
        //        return Json(msg);
        //    }
        //    catch (Exception ex)
        //    {
        //        msg.Object = ex;
        //        msg.Title = _sharedResources["COM_MSG_ERR"];
        //        //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_FAILED"), _stringLocalize["CJ_CURD_TXT_TEAM_CODE"));//"Có lỗi xảy ra!";
        //        return Json(msg);
        //    }
        //}

        [HttpPost]
        public JsonResult GetListGroupUser(string branch)
        {
            var data = (_context.AdGroupUsers.Where(x => x.IsEnabled == true && !x.IsDeleted).Select(x => new AssignObject
            {
                Code = x.GroupUserCode,
                Name = x.Title,
                Type = 1,
                Group = "Nhóm",
                CountUser = 0
            })).ToList();
            foreach (var item in data)
            {
                item.CountUser = GetCountMemberInGroupUser(item.Code, branch);
            }
            return Json(data);
        }

        [NonAction]
        public int GetCountMemberInGroupUser(string groupUserCode, string branch)
        {
            var query = (from a in _context.AdUserInGroups.Where(x => !x.IsDeleted)
                         join b in _context.Users on a.UserId equals b.Id
                         join c in _context.Roles.Where(x => x.Status) on a.RoleId equals c.Id
                         join d in _context.AdDepartments.Where(x => !x.IsDeleted && x.IsEnabled) on b.DepartmentId equals d.DepartmentCode
                         where a.GroupUserCode == groupUserCode && a.Branch.Equals(branch)
                         select new
                         {
                             UserId = b.Id,
                             b.GivenName,
                             Type = 1,
                             b.DepartmentId,
                             RoleSys = c.Title,
                             Branch = a.Branch,
                             DepartmentName = d.Title
                         }).DistinctBy(x => x.UserId);
            return query.Count();
        }

        [HttpPost]
        public JsonResult GetMemberInGroupUser(string groupUserCode, string branch)
        {
            var query = (from a in _context.AdUserInGroups.Where(x => !x.IsDeleted)
                         join b in _context.Users on a.UserId equals b.Id
                         join c in _context.Roles.Where(x => x.Status) on a.RoleId equals c.Id
                         join d in _context.AdDepartments.Where(x => !x.IsDeleted && x.IsEnabled) on b.DepartmentId equals d.DepartmentCode
                         where a.GroupUserCode == groupUserCode && a.Branch.Equals(branch)
                         select new
                         {
                             UserId = b.Id,
                             b.GivenName,
                             Type = 1,
                             b.DepartmentId,
                             RoleSys = c.Title,
                             Branch = a.Branch,
                             DepartmentName = d.Title
                         }).DistinctBy(x => x.UserId);
            return Json(query);
        }

        [NonAction]
        public object GetCardDataInGroupUser(AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var list = (from a in _context.WORKOSLists.Where(x => !x.IsDeleted)
                        join b in _context.WORKOSCards.Where(x => !x.IsDeleted && x.Status != "TRASH") on a.ListCode equals b.ListCode
                        select new
                        {
                            a.ListID,
                            a.ListCode,
                            a.ListName,
                            a.Completed,
                            a.WeightNum,
                            a.Status,
                            a.BeginTime,
                            a.Deadline,
                            a.Background,
                            a.Order
                        }).DistinctBy(x => x.ListCode);
            var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
            {
                x.ListID,
                x.ListCode,
                x.ListName,
                x.Completed,
                x.WeightNum,
                x.Status,
                x.BeginTime,
                x.Deadline,
                x.Background,
                x.Order,
                ListCard = ListCardInOutGroup(data, x.ListCode, user.BranchId, user.DepartmentId)
            });
            return new
            {
                Data = listPaging,
                Total = list.Count(),
            };
        }

        [NonAction]
        public object GetCardDataOutGroupUser(AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //danh sách card mới,thẻ mới
            if (fromDate == null && toDate == null && string.IsNullOrEmpty(data.CardName) && string.IsNullOrEmpty(data.Status) && string.IsNullOrEmpty(data.BranchId))
            {
                var query = (from a in _context.WORKOSCards
                             let lt = a.LstUser.Split(",", StringSplitOptions.None)
                             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
                             from g2 in g1.DefaultIfEmpty()
                             where a.CreatedDate.Date == DateTime.Today && a.IsDeleted == false
                             //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
                             && (session.IsAllData
                            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
                            || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
                             group a by a.ListCode into g
                             select new
                             {
                                 ListCode = g.Key,
                             }).AsNoTracking();
                var list = (from a in _context.WORKOSLists
                            from b in query
                            where ((a.ListCode == b.ListCode) || (a.CreatedDate.Date == DateTime.Today) && a.IsDeleted == false)
                            select a).Distinct().AsNoTracking();
                var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
                {
                    x.ListID,
                    x.ListCode,
                    x.ListName,
                    x.Completed,
                    x.WeightNum,
                    x.Status,
                    x.BeginTime,
                    x.Deadline,
                    x.Background,
                    x.Order,
                    ListCard = _context.WORKOSCards.Where(y => y.ListCode == x.ListCode && y.CreatedDate.Date == DateTime.Today && y.IsDeleted == false).Select(y => new
                    {
                        y.CardID,
                        y.CardCode,
                        y.CardName,
                        y.Deadline,
                        y.Quantitative,
                        y.Unit,
                        y.Currency,
                        CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                        BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
                        EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
                        Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                        CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                        CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                        y.Cost,
                        y.Completed,

                    }).Distinct()
                });
                return new
                {
                    Data = listPaging,
                    Total = list.Count(),
                };
            }
            else
            {
                var query = (from a in _context.WORKOSCards
                             join b in _context.Users.Where(x => x.Active) on a.CreatedBy equals b.UserName
                             let lt = a.LstUser.Split(",", StringSplitOptions.None)
                             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
                             from g2 in g1.DefaultIfEmpty()
                             where (fromDate == null || a.BeginTime >= fromDate) &&
                             (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
                             ((string.IsNullOrEmpty(data.Status) && a.Status != "TRASH") || (!string.IsNullOrEmpty(a.Status) && a.Status.Equals(data.Status))) &&
                             (string.IsNullOrEmpty(data.CardName) || a.CardName.ToUpper().Contains(data.CardName.ToUpper())) &&
                             (string.IsNullOrEmpty(data.BranchId) || b.BranchId.ToUpper().Equals(data.BranchId.ToUpper())) &&
                             a.IsDeleted == false &&
                             (session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
                             group a by a.ListCode into g
                             select new
                             {
                                 ListCode = g.Key,
                                 ListCard = g.Select(y => new
                                 {
                                     y.CardID,
                                     y.CardCode,
                                     y.CardName,
                                     y.Deadline,
                                     y.Quantitative,
                                     y.Unit,
                                     y.Currency,
                                     y.Status,
                                     BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
                                     EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
                                     y.Cost,
                                     y.Completed,

                                 }).Distinct()
                             }).AsNoTracking();
                var list = (from a in query
                            join b in _context.WORKOSLists on a.ListCode equals b.ListCode
                            where b.IsDeleted == false
                            select new { a, b });
                var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
                {
                    x.b.ListID,
                    x.b.ListCode,
                    x.b.ListName,
                    x.b.Completed,
                    x.b.WeightNum,
                    x.b.Status,
                    x.b.BeginTime,
                    x.b.Deadline,
                    x.b.Background,
                    x.b.Order,
                    ListCard = x.a.ListCard.Select(y => new
                    {
                        y.CardID,
                        y.CardCode,
                        y.CardName,
                        y.Deadline,
                        y.Quantitative,
                        y.Unit,
                        y.Currency,
                        CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                        y.BeginTime,
                        y.EndTime,
                        Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                        CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                        CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                        y.Cost,
                        y.Completed,

                    })
                });
                return new
                {
                    Data = listPaging,
                    Total = list.Count(),
                };
            }
        }

        [NonAction]
        private List<ListAndCard> ListCardInOutGroup(AdvanceSearchObj dataSearch, string listCode, string branch, string department)
        {
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var session = HttpContext.GetSessionUser();
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            var listObject = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            if (dataSearch.ListObjCode.Any())
            {
                listObject = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }

            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName",
                "@ListUserOfBranch", "@UserId", "@BranchId", "@Status", "@Object", "@ListCode", "@CardName", "@ListObjCode", "@boardCode" };
            object[] val = new object[] {dataSearch.CurrentPageList, 10,fromDatePara, toDatePara , session.IsAllData, session.IsUser, session.IsBranch,
                !string.IsNullOrEmpty(department) ? department : "", session.UserName, listUserOfBranch, session.UserId, !string.IsNullOrEmpty(branch) ? branch : "",
                 dataSearch.Status, dataSearch.Object, listCode, dataSearch.CardName, listObject, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_LIST_AND_CARD_GROUP", param, val);
            var query = CommonUtil.ConvertDataTable<ListAndCard>(rs);
            return query;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardGroupUser(AdvanceSearchObj dataSearch)
        {
            var query = new List<GridCardJtable>();
            if (dataSearch.ListObjCode.Any())
            {
                query = GetGirdCardInGroupUser(dataSearch);
            }
            else
            {
                query = GetGirdCardOutGroupUser(dataSearch);
            }
            return query;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardInGroupUser(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }

            if (string.IsNullOrEmpty(dataSearch.CardName) && string.IsNullOrEmpty(dataSearch.FromDate) && string.IsNullOrEmpty(dataSearch.ToDate))
            {

            }

            if (string.IsNullOrEmpty(dataSearch.CardName) && string.IsNullOrEmpty(dataSearch.FromDate)
                && string.IsNullOrEmpty(dataSearch.ToDate) && string.IsNullOrEmpty(dataSearch.Status)
                && string.IsNullOrEmpty(dataSearch.WorkflowInstCode))
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                "@UserId", "@listObjCode", "@Branch"};
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length, session.IsAllData, session.IsUser, session.IsBranch,
                !string.IsNullOrEmpty(session.DepartmentCode) ? session.DepartmentCode : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                !string.IsNullOrEmpty(session.BranchId) ? session.BranchId : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_GROUP_NO_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }
            else
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                "@UserId", "@listObjCode", "@Branch", "@CardName", "@FromDate", "@ToDate", "@Status", "@WorkflowInstCode"};
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length, session.IsAllData, session.IsUser, session.IsBranch,
                    !string.IsNullOrEmpty(session.DepartmentCode) ? session.DepartmentCode : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                    !string.IsNullOrEmpty(session.BranchId) ? session.BranchId : "", dataSearch.CardName, fromDatePara, toDatePara,
                    dataSearch.Status, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_GROUP_WITH_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }

            //var query = (from a in _context.WORKOSCards.Where(x => !x.IsDeleted)
            //             let lt = a.LstUser.Split(",", StringSplitOptions.None)
            //             join c in _context.Users on a.CreatedBy equals c.UserName into c1
            //             from c2 in c1.DefaultIfEmpty()
            //             join b in _context.CardMappings.Where(x => dataSearch.ListObjCode.Any(y => y.Code == x.TeamCode)) on a.CardCode equals b.CardCode
            //             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
            //             from g2 in g1.DefaultIfEmpty()
            //             join h in _context.Users.Where(x => x.Active) on a.CreatedBy equals h.UserName into h1
            //             from h2 in h1.DefaultIfEmpty()
            //             join i in _context.WORKOSLists.Where(x => !x.IsDeleted) on a.ListCode equals i.ListCode
            //             join k in _context.WORKOSBoards.Where(x => !x.IsDeleted) on i.BoardCode equals k.BoardCode
            //             where (fromDate == null || a.BeginTime >= fromDate) &&
            //                   (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
            //                   ((string.IsNullOrEmpty(dataSearch.Status) && a.Status != "TRASH") || a.Status.Equals(dataSearch.Status)) &&
            //                   (string.IsNullOrEmpty(dataSearch.BranchId) || c2.BranchId.Equals(dataSearch.BranchId)) &&
            //                   (string.IsNullOrEmpty(dataSearch.CardName) || a.CardName.ToUpper().Contains(dataSearch.CardName.ToUpper()))
            //                    // && (session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
            //                    && (session.IsAllData
            //                    || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
            //                    || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
            //             select new GridCardJtable
            //             {
            //                 CardID = a.CardID,
            //                 CardCode = a.CardCode,
            //                 CardName = a.CardName,
            //                 ListName = _context.WORKOSLists.FirstOrDefault(y => y.ListCode.Equals(a.ListCode)).ListName ?? "",
            //                 BoardName = k.BoardName,
            //                 Deadline = a.Deadline,
            //                 Currency = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == a.Currency).ValueSet ?? "",
            //                 Cost = a.Cost,
            //                 Completed = a.Completed,
            //                 BeginTime = a.BeginTime,
            //                 EndTime = a.EndTime,
            //                 Status = _context.CommonSettings.FirstOrDefault(y => y.CodeSet.Equals(a.Status)).ValueSet,
            //                 UpdateTime = a.UpdatedTime,
            //                 CreatedBy = h2.GivenName,
            //                 CreatedTime = a.CreatedDate.ToString("dd/MM/yyyy"),
            //                 CreatedDate = a.CreatedDate,
            //                 UpdatedTimeTxt = a.UpdatedTime.HasValue ? a.UpdatedTime.Value.ToString("dd/MM/yyyy HH:mm:ss") : "",
            //                 WorkType = !string.IsNullOrEmpty(a.WorkType) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.WorkType).ValueSet : "",
            //                 Priority = !string.IsNullOrEmpty(a.CardLevel) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.CardLevel).ValueSet : "",
            //             }).DistinctBy(x => x.CardCode).OrderByDescending(x => x.UpdateTime.HasValue ? x.UpdateTime.Value : x.CreatedDate).ThenByDescending(x => x.CardID);
            //IQueryable<GridCardJtable> data1 = query.AsQueryable<GridCardJtable>();
            //return data1;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardOutGroupUser(AdvanceSearchObj dataSearch)
        {
            //return GetGirdCardOut(dataSearch);

            //var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            //var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            //var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            //var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            //var listUserOfBranch = "";
            //if (session.IsBranch)
            //{
            //    if (session.ListUserOfBranch.Any())
            //    {
            //        listUserOfBranch = string.Join(",", session.ListUserOfBranch);
            //    }
            //}
            //string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
            //    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            //object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
            //    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch,
            //    !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",session.UserId,  !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "",
            //    dataSearch.Status, dataSearch.Object, dataSearch.ObjType, dataSearch.CardName};
            //DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_OUT_GROUP_USER", param, val);
            //var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
            //return query;
            return new List<GridCardJtable>();
        }
        #endregion

        #region Board
        [HttpPost]
        public object GetBoardsType()
        {
            var list = _context.CommonSettings
                .Where(x => x.IsDeleted == false && x.Group == "BOARD_TYPE")
                .Select(x => new { Code = x.CodeSet, Name = x.ValueSet })
                .AsNoTracking();
            return Json(list);
        }

        [HttpPost]
        public JsonResult GetBoardsWithGroupBy()
        {
            var query = from a in _context.WORKOSBoards
                        where a.IsDeleted == false
                        //group a by a.BoardType into grp
                        group a by new { a.BoardType } into grp
                        orderby grp.Key.BoardType descending
                        select new
                        {
                            BoardType = grp.FirstOrDefault().BoardType,
                            BoardTypeText = _context.CommonSettings.FirstOrDefault(x => x.CodeSet == grp.First().BoardType).ValueSet ?? "",
                            ListBoard = grp.Select(x => new
                            {
                                x.BoardID,
                                x.BoardCode,
                                x.BoardName,
                                x.Completed,
                                x.Cost,
                                x.LocationText,
                                x.LocationGps,
                                x.BoardType,
                                x.Visibility,
                                x.BackgroundColor,
                                x.BackgroundImage,
                                x.Avatar,
                                x.BeginTime,
                                x.Deadline,
                                x.DeadLineView,
                                x.Branch,
                                x.Department,
                                BranchText = _context.AdOrganizations.FirstOrDefault(k => k.IsEnabled && k.OrgAddonCode == x.Branch).OrgName ?? "",
                                DepartmentText = _context.AdDepartments.FirstOrDefault(k => k.IsEnabled && k.DepartmentCode == x.Department).Title ?? ""
                            }).GroupBy(x => new { x.Branch, x.Department })
                        };
            return Json(query);
        }

        [HttpPost]
        public JsonResult GetBoardsWithWorkFlow(string objCode)
        {
            if (string.IsNullOrEmpty(objCode))
            {
                var query = (from a in _context.WORKOSBoards
                             join b in _context.WfObjects on a.BoardCode equals b.WfObjCode
                             where a.IsDeleted == false && b.WfObjType == "BOARD"
                             group a by new { a.BoardType } into grp
                             orderby grp.Key.BoardType descending
                             select new
                             {
                                 BoardType = grp.FirstOrDefault(),
                                 BoardTypeText = _context.CommonSettings.FirstOrDefault(x => x.CodeSet == grp.First().BoardType).ValueSet ?? "",
                                 ListBoard = grp.Select(x => new
                                 {
                                     x.BoardID,
                                     x.BoardCode,
                                     x.BoardName,
                                     x.Completed,
                                     x.Cost,
                                     x.LocationText,
                                     x.LocationGps,
                                     x.BoardType,
                                     x.Visibility,
                                     x.BackgroundColor,
                                     x.BackgroundImage,
                                     x.Avatar,
                                     x.BeginTime,
                                     x.Deadline,
                                     x.DeadLineView,
                                 })
                             });
                return Json(query);
            }
            else
            {
                var query = (from a in _context.WORKOSBoards
                             join b in _context.WfObjects on a.BoardCode equals b.WfObjCode
                             where a.IsDeleted == false && b.WfObjType == "BOARD"
                             group a by new { a.BoardType } into grp
                             orderby grp.Key.BoardType descending
                             select new
                             {
                                 BoardType = grp.FirstOrDefault(),
                                 BoardTypeText = _context.CommonSettings.FirstOrDefault(x => x.CodeSet == grp.First().BoardType).ValueSet ?? "",
                                 ListBoard = grp.Select(x => new
                                 {
                                     x.BoardID,
                                     x.BoardCode,
                                     x.BoardName,
                                     Completed = _cardService.GetCompletedBoard(x.BoardCode, objCode),
                                     x.Cost,
                                     x.LocationText,
                                     x.LocationGps,
                                     x.BoardType,
                                     x.Visibility,
                                     x.BackgroundColor,
                                     x.BackgroundImage,
                                     x.Avatar,
                                     x.BeginTime,
                                     x.Deadline,
                                     x.DeadLineView,
                                 })
                             });
                return Json(query);
            }

        }

        [HttpPost]
        public JsonResult GetListBoard()
        {
            var data = _context.WORKOSBoards.Where(x => x.IsDeleted == false).Select(x => new
            {
                x.BoardID,
                x.BoardCode,
                x.BoardName,
                x.BoardType,
                BoardTypeText = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == x.BoardType).ValueSet ?? "",
                OrderBoardType = (x.BoardType == "BOARD_REPEAT") ? 1 : x.BoardType == "BOARD_PROJECT" ? 2 : 3,
                x.Avatar,
                x.BackgroundColor,
                x.BackgroundImage,
                x.BeginTime,
                x.Completed,
                x.Cost,
                x.Deadline,
                x.LocationGps,
                x.LocationText,
            }).OrderBy(x => x.OrderBoardType).AsNoTracking();
            return Json(data);
        }

        [HttpPost]
        public JsonResult GetBoardDetail(string BoardCode, string objCode)
        {
            var data = _context.WORKOSBoards.FirstOrDefault(x => x.BoardCode.Equals(BoardCode));
            if (data != null && string.IsNullOrEmpty(objCode))
            {
                data.BeginTimeView = data.BeginTime.ToString("dd/MM/yyyy");
                data.DeadLineView = data.Deadline.ToString("dd/MM/yyyy");
                data.TeamName = _context.Teams.FirstOrDefault(x => x.TeamCode == data.TeamCode)?.TeamName;

            }
            else if (data != null && !string.IsNullOrEmpty(objCode))
            {
                data.BeginTimeView = data.BeginTime.ToString("dd/MM/yyyy");
                data.DeadLineView = data.Deadline.ToString("dd/MM/yyyy");
                data.TeamName = _context.Teams.FirstOrDefault(x => x.TeamCode == data.TeamCode)?.TeamName;
                data.Completed = _cardService.GetCompletedBoard(data.BoardCode, objCode);
            }
            return Json(data);
        }

        [HttpPost]
        public JsonResult InsertBoard([FromBody] WORKOSBoard data)
        {
            if (string.IsNullOrEmpty(data.BoardName))
            {
                return Json(new JMessage() { Error = true, Title = String.Format(_stringLocalizer["CJ_CURD_MSG_CONTENT_BLANK"]) });//"Chưa nhập nội dung!"
            }
            var msg = new JMessage() { Error = false };
            try
            {
                data.BoardCode = "BOARD_" + (Guid.NewGuid().ToString());
                if (string.IsNullOrEmpty(data.BackgroundColor) && string.IsNullOrEmpty(data.BackgroundImage))
                {
                    data.BackgroundColor = "#179da7";
                }
                data.BoardType = string.IsNullOrEmpty(data.BoardType) ? "BOARD_OTHER" : data.BoardType;
                data.BeginTime = !string.IsNullOrEmpty(data.BeginTimeView) ? DateTime.ParseExact(data.BeginTimeView, "dd/MM/yyyy", CultureInfo.InvariantCulture) : DateTime.Now;
                if (string.IsNullOrEmpty(data.Avatar))
                {
                    data.Avatar = "trello";
                }
                data.Deadline = !string.IsNullOrEmpty(data.DeadLineView) ? DateTime.ParseExact(data.DeadLineView, "dd/MM/yyyy", CultureInfo.InvariantCulture) : DateTime.Now;
                _context.WORKOSBoards.Add(data);

                //Insert list default

                var workOSList = new WORKOSList
                {
                    ListCode = "LIST_" + Guid.NewGuid().ToString().ToUpper(),
                    BoardCode = data.BoardCode,
                    Avatar = "/images/logo/trello.png",
                    Status = 1,
                    Order = _context.WORKOSLists.Count() + 1,
                    Background = "background-color: rgb(68, 190, 199);",
                    BeginTime = DateTime.Now,
                    Deadline = data.Deadline,
                    ListName = data.BoardName,
                };
                _context.WORKOSLists.Add(workOSList);
                _context.SaveChanges();
                msg.Object = data.BoardCode;
                msg.Title = String.Format(_sharedResources["COM_MSG_ADD_SUCCESS"], _stringLocalizer["CJ_CURD_LBL_BOARD_CODE"]);//"Thêm bảng mới thành công";
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_ADD_FAILED"), _stringLocalize["CJ_CURD_LBL_BOARD_CODE"));// "Có lỗi khi thêm bảng mới!";
                msg.Object = ex;
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult CheckExistBoardName([FromBody] WORKOSBoard data)
        {
            bool isExistBoard = false;
            var checkExist = _context.WORKOSBoards.FirstOrDefault(x => x.IsDeleted == false && x.BoardName.ToLower() == data.BoardName.ToLower());
            if (checkExist != null)
            {
                isExistBoard = true;
            }
            return Json(isExistBoard);
        }

        [HttpPost]
        public JsonResult EditBoard([FromBody] WORKOSBoard data)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var editData = _context.WORKOSBoards.FirstOrDefault(x => x.BoardID == data.BoardID);
                editData.BoardName = data.BoardName;
                editData.Visibility = data.Visibility;
                editData.BackgroundColor = data.BackgroundColor;
                editData.BackgroundImage = data.BackgroundImage;
                editData.Avatar = data.Avatar;
                editData.TeamCode = data.TeamCode;
                editData.BoardType = data.BoardType;
                editData.BeginTime = !string.IsNullOrEmpty(data.BeginTimeView) ? DateTime.ParseExact(data.BeginTimeView, "dd/MM/yyyy", CultureInfo.InvariantCulture) : DateTime.Now;
                editData.Deadline = !string.IsNullOrEmpty(data.DeadLineView) ? DateTime.ParseExact(data.DeadLineView, "dd/MM/yyyy", CultureInfo.InvariantCulture) : DateTime.Now;
                editData.Branch = data.Branch;
                editData.Department = data.Department;
                _context.WORKOSBoards.Update(editData);
                _context.SaveChanges();
                msg.Title = String.Format(_sharedResources["COM_MSG_UPDATE_SUCCESS"], _stringLocalizer["CJ_CURD_LBL_BOARD_CODE"]);//"Cập nhật thành công!";
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_FAILED"), _stringLocalize["CJ_CURD_LBL_BOARD_CODE"));// "Có lỗi khi cập nhật bảng!";
                return Json(msg);
            }
        }

        [HttpPost]
        public JsonResult DeleteBoard(int id)
        {
            var msg = new JMessage() { Error = true };
            try
            {
                //deleted board
                var data = _context.WORKOSBoards.FirstOrDefault(x => x.BoardID == id);
                data.IsDeleted = true;
                _context.WORKOSBoards.Update(data);
                //deleted list
                var list = _context.WORKOSLists.Where(x => x.BoardCode == data.BoardCode).ToList();
                list.ForEach(x => x.IsDeleted = true);

                //deleted card
                var card = _context.WORKOSCards.Where(x => list.Any(y => y.ListCode == x.ListCode)).ToList();
                card.ForEach(x => x.IsDeleted = true);

                ////delete relative
                //var relative = _context.CardMappings.Where(x => x.BoardCode == data.BoardCode).AsNoTracking().ToList();
                //_context.CardMappings.RemoveRange(relative);

                _context.SaveChanges();
                msg.Error = false;
                msg.Title = String.Format(_sharedResources["COM_MSG_DELETE_SUCCESS"], _stringLocalizer["CJ_CURD_LBL_BOARD_CODE"]);//"Xóa bảng thành công";
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_DELETE_FAIL"), _stringLocalize["CJ_CURD_LBL_BOARD_CODE"));//"Có lỗi khi xóa bảng!";
                return Json(msg);
            }
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardBoard(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            if (!string.IsNullOrEmpty(dataSearch.BoardCode))
            {
                if (string.IsNullOrEmpty(dataSearch.CardName) && string.IsNullOrEmpty(dataSearch.Object) && string.IsNullOrEmpty(dataSearch.FromDate)
                    && string.IsNullOrEmpty(dataSearch.ToDate) && string.IsNullOrEmpty(dataSearch.Status) && string.IsNullOrEmpty(dataSearch.WorkflowInstCode)
                     && string.IsNullOrEmpty(dataSearch.TimeType))
                {
                    string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                    "@boardCode", "@UserId", "@BranchId", "@WorkflowInstCode" };
                    object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , session.IsAllData, session.IsUser, session.IsBranch,
                 !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, dataSearch.BoardCode,
                 session.UserId, !string.IsNullOrEmpty(dataSearch.BranchId) ? dataSearch.BranchId : "", ""};
                    DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_BOARD_CARD_NO_CONDITION", param, val);
                    var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                    return query;
                }
                else
                {
                    string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                        "@boardCode", "@UserId", "@BranchId", "@CardName", "@ObjID", "@FromDate", "@ToDate", "@Status", "@WorkflowInstCode", "@TimeType" };
                    object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , session.IsAllData, session.IsUser, session.IsBranch,
                        !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, dataSearch.BoardCode,
                        session.UserId, !string.IsNullOrEmpty(dataSearch.BranchId) ? dataSearch.BranchId : "", dataSearch.CardName, dataSearch.Object,
                        fromDatePara, toDatePara, dataSearch.Status, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : "",
                        !string.IsNullOrEmpty(dataSearch.TimeType) ? dataSearch.TimeType : ""};
                    DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_BOARD_CARD_WITH_CONDITION", param, val);
                    var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                    return query;
                }
            }
            else
            {
                if (string.IsNullOrEmpty(dataSearch.CardName) && string.IsNullOrEmpty(dataSearch.Status) && string.IsNullOrEmpty(dataSearch.BoardSearch)
                    && string.IsNullOrEmpty(dataSearch.Contract) && string.IsNullOrEmpty(dataSearch.Project) && string.IsNullOrEmpty(dataSearch.ToDate)
                    && string.IsNullOrEmpty(dataSearch.Supplier) && string.IsNullOrEmpty(dataSearch.Customer) && string.IsNullOrEmpty(dataSearch.Department)
                    && string.IsNullOrEmpty(dataSearch.ListCode) && string.IsNullOrEmpty(dataSearch.Group) && string.IsNullOrEmpty(dataSearch.UserId)
                    && string.IsNullOrEmpty(dataSearch.FromDate) && string.IsNullOrEmpty(dataSearch.WorkflowInstCode) && string.IsNullOrEmpty(dataSearch.TimeType))
                {
                    string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName",
                        "@ListUserOfBranch", "@UserId", "@Branch", "@WorkflowInstCode" };
                    object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , session.IsAllData, session.IsUser, session.IsBranch,
                    !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, session.UserId,
                        !string.IsNullOrEmpty(dataSearch.BranchId) ? dataSearch.BranchId : "", ""};
                    DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_ALL_BOARD_CARD_NO_CONDITION", param, val);
                    var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                    return query;
                }
                else
                {
                    string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch", "@UserName",
                        "@ListUserOfBranch", "@DepartmentId", "@BoardSearch", "@UserId", "@BranchId", "@Status", "@CardName", "@ListCode", "@Group",
                        "@Project", "@Customer", "@Supplier", "@Contract", "@UserIdSearch", "@UserNameSearch", "@DepartmentSearch", "@WorkflowInstCode",
                        "@TimeTypeCreated", "@TimeTypeStart", "@TimeTypeEnd", "@TimeTypeCompleted"};

                    object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length ,fromDatePara, toDatePara, session.IsAllData, session.IsUser,
                        session.IsBranch, session.UserName, listUserOfBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "",
                        !string.IsNullOrEmpty(dataSearch.BoardSearch) ? dataSearch.BoardSearch : "", session.UserId, !string.IsNullOrEmpty(dataSearch.BranchId) ? dataSearch.BranchId : "",
                        !string.IsNullOrEmpty(dataSearch.Status) ? dataSearch.Status : "", dataSearch.CardName, !string.IsNullOrEmpty(dataSearch.ListCode) ? dataSearch.ListCode : "",
                        !string.IsNullOrEmpty(dataSearch.Group) ? dataSearch.Group : "", !string.IsNullOrEmpty(dataSearch.Project) ? dataSearch.Project : "",
                        !string.IsNullOrEmpty(dataSearch.Customer) ? dataSearch.Customer : "", !string.IsNullOrEmpty(dataSearch.Supplier) ? dataSearch.Supplier: "",
                        !string.IsNullOrEmpty(dataSearch.Contract) ? dataSearch.Contract: "", !string.IsNullOrEmpty(dataSearch.UserId) ? dataSearch.UserId : "",
                        !string.IsNullOrEmpty(dataSearch.UserName) ? dataSearch.UserName : "", !string.IsNullOrEmpty(dataSearch.Department) ? dataSearch.Department: "",
                        !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : "",
                        dataSearch.TimeTypeCreated, dataSearch.TimeTypeStart, dataSearch.TimeTypeEnd, dataSearch.TimeTypeCompleted };
                    DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_ALL_BOARD_CARD_WITH_CONDITION", param, val);
                    var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                    return query;
                }
            }


            //if (!string.IsNullOrEmpty(dataSearch.BoardCode))
            //{
            //    var query = (from a in _context.WORKOSCards.Where(x => !x.IsDeleted)
            //                 let lt = a.LstUser.Split(",", StringSplitOptions.None)
            //                 join b in _context.WORKOSLists.Where(x => !x.IsDeleted) on a.ListCode equals b.ListCode
            //                 join k in _context.WORKOSBoards.Where(x => !x.IsDeleted) on b.BoardCode equals k.BoardCode
            //                 join c in _context.CardCommentLists.Where(x => !x.Flag) on a.CardCode equals c.CardCode into c1
            //                 from c2 in c1.DefaultIfEmpty()
            //                 join d in _context.CardItemChecks.Where(x => !x.Flag) on a.CardCode equals d.CardCode into d1
            //                 from d2 in d1.DefaultIfEmpty()
            //                 join e in _context.JcObjectIdRelatives.Where(x => !x.IsDeleted) on a.CardCode equals e.CardCode into e1
            //                 from e2 in e1.DefaultIfEmpty()
            //                     //join f in _context.Users.Where(x => x.Active) on a.CreatedBy equals f.UserName
            //                 join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
            //                 from g2 in g1.DefaultIfEmpty()
            //                 join h in _context.Users.Where(x => x.Active) on a.CreatedBy equals h.UserName into h1
            //                 from h2 in h1.DefaultIfEmpty()
            //                 where k.BoardCode.Equals(dataSearch.BoardCode) &&
            //                 ((string.IsNullOrEmpty(dataSearch.CardName) || a.CardName.ToUpper().Contains(dataSearch.CardName.ToUpper())) ||
            //                  (string.IsNullOrEmpty(dataSearch.CardName) || a.CardCode.ToLower().Contains(dataSearch.CardName.ToLower())) ||
            //                 (string.IsNullOrEmpty(dataSearch.CardName) || c2.CmtContent.ToUpper().Contains(dataSearch.CardName.ToUpper())) ||
            //                 (string.IsNullOrEmpty(dataSearch.CardName) || d2.CheckTitle.ToUpper().Contains(dataSearch.CardName.ToUpper())) ||
            //                 (string.IsNullOrEmpty(dataSearch.CardName) || a.Description.ToLower().Contains(dataSearch.CardName.ToLower()))) &&
            //                 ((string.IsNullOrEmpty(dataSearch.Status) && a.Status != "TRASH") || a.Status.Equals(dataSearch.Status)) &&
            //                 (string.IsNullOrEmpty(dataSearch.Object) || e2.ObjID.Equals(dataSearch.Object)) &&
            //                 (string.IsNullOrEmpty(dataSearch.BranchId) || h2.BranchId.Equals(dataSearch.BranchId)) &&
            //                 (string.IsNullOrEmpty(dataSearch.ObjType) || e2.ObjTypeCode.Equals(dataSearch.ObjType)) &&
            //                 (fromDate == null || a.BeginTime.Date >= fromDate) &&
            //                 (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate)
            //                 && (session.IsAllData
            //                 || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
            //                 || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
            //                 select new GridCardJtable
            //                 {
            //                     CardID = a.CardID,
            //                     CardCode = a.CardCode,
            //                     CardName = a.CardName,
            //                     ListName = b.ListName,
            //                     BoardName = k.BoardName,
            //                     Deadline = a.Deadline,
            //                     Currency = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == a.Currency).ValueSet ?? "",
            //                     Cost = a.Cost,
            //                     Completed = a.Completed,
            //                     BeginTime = a.BeginTime,
            //                     Status = _context.CommonSettings.FirstOrDefault(y => y.CodeSet.Equals(a.Status)).ValueSet,
            //                     EndTime = a.EndTime,
            //                     UpdateTime = a.UpdatedTime,
            //                     CreatedBy = h2.GivenName,
            //                     CreatedTime = a.CreatedDate.ToString("dd/MM/yyyy"),
            //                     CreatedDate = a.CreatedDate,
            //                     UpdatedTimeTxt = a.UpdatedTime.HasValue ? a.UpdatedTime.Value.ToString("dd/MM/yyyy HH:mm:ss") : "",
            //                     WorkType = !string.IsNullOrEmpty(a.WorkType) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.WorkType).ValueSet : "",
            //                     Priority = !string.IsNullOrEmpty(a.CardLevel) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.CardLevel).ValueSet : "",
            //                 }).DistinctBy(x => x.CardCode).OrderByDescending(x => x.UpdateTime.HasValue ? x.UpdateTime.Value : x.CreatedDate).ThenByDescending(x => x.CardID);
            //    IQueryable<GridCardJtable> data1 = query.AsQueryable<GridCardJtable>();
            //    return data1;
            //}
            //else
            //{
            //    if (fromDate == null && toDate == null && string.IsNullOrEmpty(dataSearch.Status) && string.IsNullOrEmpty(dataSearch.CardName)
            //        && string.IsNullOrEmpty(dataSearch.BranchId) && string.IsNullOrEmpty(dataSearch.BoardSearch) && string.IsNullOrEmpty(dataSearch.Department)
            //        && string.IsNullOrEmpty(dataSearch.Group) && string.IsNullOrEmpty(dataSearch.UserId) && string.IsNullOrEmpty(dataSearch.Project)
            //        && string.IsNullOrEmpty(dataSearch.Supplier) && string.IsNullOrEmpty(dataSearch.Customer) && string.IsNullOrEmpty(dataSearch.Contract) && string.IsNullOrEmpty(dataSearch.ListCode))
            //    {
            //        var query = (from a in _context.WORKOSCards.Where(x => !x.IsDeleted)
            //                     let lt = a.LstUser.Split(",", StringSplitOptions.None)
            //                     join b in _context.CardCommentLists.Where(x => !x.Flag) on a.CardCode equals b.CardCode
            //                     join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
            //                     from g2 in g1.DefaultIfEmpty()
            //                     join h in _context.Users.Where(x => x.Active) on a.CreatedBy equals h.UserName into h1
            //                     from h2 in h1.DefaultIfEmpty()
            //                     join h in _context.WORKOSLists.Where(x => !x.IsDeleted) on a.ListCode equals h.ListCode
            //                     join k in _context.WORKOSBoards.Where(x => !x.IsDeleted) on h.BoardCode equals k.BoardCode
            //                     where (session.IsAllData
            //                        || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
            //                        || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0
            //                            && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
            //                     select new GridCardJtable
            //                     {
            //                         CardID = a.CardID,
            //                         CardCode = a.CardCode,
            //                         CardName = a.CardName,
            //                         ListName = _context.WORKOSLists.FirstOrDefault(y => y.ListCode.Equals(a.ListCode)).ListName ?? "",
            //                         BoardName = k.BoardName,
            //                         Deadline = a.Deadline,
            //                         Currency = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == a.Currency).ValueSet ?? "",
            //                         Cost = a.Cost,
            //                         Completed = a.Completed,
            //                         BeginTime = a.BeginTime,
            //                         EndTime = a.EndTime,
            //                         Status = _context.CommonSettings.FirstOrDefault(y => y.CodeSet.Equals(a.Status)).ValueSet,
            //                         UpdateTime = a.UpdatedTime,
            //                         CreatedBy = h2.GivenName,
            //                         CreatedTime = a.CreatedDate.ToString("dd/MM/yyyy"),
            //                         CreatedDate = a.CreatedDate,
            //                         UpdatedTimeTxt = a.UpdatedTime.HasValue ? a.UpdatedTime.Value.ToString("dd/MM/yyyy HH:mm:ss") : "",
            //                         WorkType = !string.IsNullOrEmpty(a.WorkType) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.WorkType).ValueSet : "",
            //                         Priority = !string.IsNullOrEmpty(a.CardLevel) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.CardLevel).ValueSet : "",
            //                     }).DistinctBy(x => x.CardCode).OrderByDescending(x => x.UpdateTime.HasValue ? x.UpdateTime.Value : x.CreatedDate).ThenByDescending(x => x.CardID);
            //        IQueryable<GridCardJtable> data1 = query.AsQueryable<GridCardJtable>();
            //        return data1;
            //    }
            //    else
            //    {
            //        var query = (from a in _context.WORKOSCards.Where(x => !x.IsDeleted)
            //                     let lt = a.LstUser.Split(",", StringSplitOptions.None)
            //                     join b in _context.CardCommentLists.Where(x => !x.Flag) on a.CardCode equals b.CardCode into b1
            //                     from b2 in b1.DefaultIfEmpty()
            //                     join c in _context.CardItemChecks.Where(x => !x.Flag) on a.CardCode equals c.CardCode into c1
            //                     from c2 in c1.DefaultIfEmpty()
            //                     join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
            //                     from g2 in g1.DefaultIfEmpty()
            //                     join h in _context.Users.Where(x => x.Active) on a.CreatedBy equals h.UserName into h1
            //                     from h2 in h1.DefaultIfEmpty()
            //                     join k in _context.WORKOSLists.Where(x => !x.IsDeleted) on a.ListCode equals k.ListCode
            //                     join h in _context.WORKOSBoards.Where(x => !x.IsDeleted) on k.BoardCode equals h.BoardCode
            //                     join m in _context.JcObjectIdRelatives.Where(x => !x.IsDeleted) on a.CardCode equals m.CardCode into m1
            //                     from m2 in m1.DefaultIfEmpty()
            //                     where (fromDate == null || a.BeginTime >= fromDate) &&
            //                           (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
            //                           ((string.IsNullOrEmpty(dataSearch.CardName) || a.CardName.ToLower().Contains(dataSearch.CardName.ToLower())) ||
            //                           (string.IsNullOrEmpty(dataSearch.CardName) || a.CardCode.ToLower().Contains(dataSearch.CardName.ToLower())) ||
            //                           (string.IsNullOrEmpty(dataSearch.CardName) || a.Description.ToLower().Contains(dataSearch.CardName.ToLower())) ||
            //                           (string.IsNullOrEmpty(dataSearch.CardName) || c2.CheckTitle.ToLower().Contains(dataSearch.CardName.ToLower())) ||
            //                           (string.IsNullOrEmpty(dataSearch.CardName) || b2.CmtContent.ToLower().Contains(dataSearch.CardName.ToLower()))) &&
            //                           ((string.IsNullOrEmpty(dataSearch.Status) && a.Status != "TRASH") || a.Status.Equals(dataSearch.Status)) &&
            //                           (string.IsNullOrEmpty(dataSearch.BranchId) || h2.BranchId.Equals(dataSearch.BranchId)) &&
            //                           (string.IsNullOrEmpty(dataSearch.BoardSearch) || h.BoardCode.Equals(dataSearch.BoardSearch)) &&
            //                           (string.IsNullOrEmpty(dataSearch.ListCode) || k.ListCode.Equals(dataSearch.ListCode)) &&
            //                           (string.IsNullOrEmpty(dataSearch.Department) || g2.GroupUserCode.Equals(dataSearch.Department)) &&
            //                           (string.IsNullOrEmpty(dataSearch.Group) || g2.TeamCode.Equals(dataSearch.Group)) &&
            //                           (string.IsNullOrEmpty(dataSearch.Project) || m2.ObjID.Equals(dataSearch.Project)) &&
            //                           (string.IsNullOrEmpty(dataSearch.Customer) || m2.ObjID.Equals(dataSearch.Customer)) &&
            //                           (string.IsNullOrEmpty(dataSearch.Supplier) || m2.ObjID.Equals(dataSearch.Supplier)) &&
            //                           (string.IsNullOrEmpty(dataSearch.Contract) || m2.ObjID.Equals(dataSearch.Contract)) &&
            //                           (string.IsNullOrEmpty(dataSearch.UserId) && string.IsNullOrEmpty(dataSearch.UserName) || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(x => x == dataSearch.UserId)) || a.CreatedBy == dataSearch.UserName) &&
            //                           (session.IsAllData
            //                        || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
            //                        || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0
            //                            && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
            //                     select new GridCardJtable
            //                     {
            //                         CardID = a.CardID,
            //                         CardCode = a.CardCode,
            //                         CardName = a.CardName,
            //                         ListName = _context.WORKOSLists.FirstOrDefault(y => y.ListCode.Equals(a.ListCode)).ListName ?? "",
            //                         BoardName = h.BoardName,
            //                         Deadline = a.Deadline,
            //                         Currency = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == a.Currency).ValueSet ?? "",
            //                         Cost = a.Cost,
            //                         Completed = a.Completed,
            //                         BeginTime = a.BeginTime,
            //                         EndTime = a.EndTime,
            //                         Status = _context.CommonSettings.FirstOrDefault(y => y.CodeSet.Equals(a.Status)).ValueSet,
            //                         UpdateTime = a.UpdatedTime,
            //                         CreatedBy = h2.GivenName,
            //                         CreatedTime = a.CreatedDate.ToString("dd/MM/yyyy"),
            //                         CreatedDate = a.CreatedDate,
            //                         UpdatedTimeTxt = a.UpdatedTime.HasValue ? a.UpdatedTime.Value.ToString("dd/MM/yyyy HH:mm:ss") : "",
            //                         WorkType = !string.IsNullOrEmpty(a.WorkType) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.WorkType).ValueSet : "",
            //                         Priority = !string.IsNullOrEmpty(a.CardLevel) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.CardLevel).ValueSet : "",
            //                     }).DistinctBy(x => x.CardCode).OrderByDescending(x => x.UpdateTime.HasValue ? x.UpdateTime.Value : x.CreatedDate).ThenByDescending(x => x.CardID);
            //        IQueryable<GridCardJtable> data1 = query.AsQueryable<GridCardJtable>();
            //        return data1;
            //    }
            //}
        }
        #endregion

        #region List
        [HttpGet]
        public JsonResult GetLists(string BoardCode)
        {
            try
            {
                var data = _context.WORKOSLists.Where(x => x.BoardCode.Equals(BoardCode) && x.IsDeleted == false).OrderBy(x => x.Order);
                return Json(data);
            }
            catch (Exception ex)
            {
                var msg = new JMessage() { Error = true, Title = _sharedResources["COM_MSG_ERR"], Object = ex };//Có lỗi xảy ra!
                return Json(msg);
            }
        }
        [HttpPost]
        public JsonResult InsertList([FromBody] WORKOSList data)
        {
            var msg = new JMessage() { Error = true };
            if (string.IsNullOrEmpty(data.ListName))
            {
                return Json(new JMessage() { Error = true, Title = _stringLocalizer["CJ_CURD_MSG_ADD_CONTENT"] });//"Nhập nội dung"
            }
            if (string.IsNullOrEmpty(data.BoardCode))
            {
                return Json(new JMessage() { Error = true, Title = _stringLocalizer["CJ_MSG_PLS_SELECT_TABLE_WORKING"] });
            }
            try
            {
                var getSumWeightNum = _context.WORKOSLists.Where(x => x.BoardCode == data.BoardCode && x.IsDeleted == false).Sum(x => x.WeightNum);
                if ((getSumWeightNum + data.WeightNum) > 100)
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_MAXIMUM_WEIGHT"] + " " + (100 - getSumWeightNum) + " % !";
                }
                else
                {
                    data.ListCode = "LIST_" + Guid.NewGuid().ToString();
                    if (data.Status == null)
                    {
                        data.Status = 1;
                    }
                    data.WeightNum = data.WeightNum;
                    data.ListCode = data.ListCode.ToUpper();
                    data.Order = _context.WORKOSLists.Count() + 1;
                    data.Background = "background-color: rgb(68, 190, 199);";
                    data.BeginTime = DateTime.Now;
                    data.Deadline = _context.WORKOSBoards.FirstOrDefault(x => x.BoardCode == data.BoardCode).Deadline;
                    _context.WORKOSLists.Add(data);
                    msg.Object = _cardService.UpdatePercentParentList(data.ListCode);
                    _context.SaveChanges();

                    msg.Error = false;
                    msg.Title = String.Format(_sharedResources["COM_MSG_ADD_SUCCESS"], _stringLocalizer["CJ_CURD_LBL_LIST_CODE"]);//"Thêm danh sách mới thành công";
                    msg.Object = data;
                }
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_ADD_FAILED"), _stringLocalize["CJ_CURD_LBL_LIST_CODE"));//"Có lỗi khi thêm danh sách mới!";
            }
            return Json(msg);
        }
        [HttpPost]
        public JsonResult CheckExistListNameInBoard([FromBody] WORKOSList data)
        {
            bool isExistListName = false;
            var checkExist = _context.WORKOSLists.FirstOrDefault(x => x.IsDeleted == false && x.ListName.ToLower() == data.ListName.ToLower() && x.BoardCode == data.BoardCode.ToLower());
            if (checkExist != null)
            {
                isExistListName = true;
            }
            return Json(isExistListName);
        }
        [HttpPost]
        public JsonResult UpdateListName([FromBody] WORKOSList obj)
        {
            var msg = new JMessage() { Error = true };
            try
            {
                var data = _context.WORKOSLists.FirstOrDefault(x => x.ListID == obj.ListID);
                data.ListName = obj.ListName;
                _context.SaveChanges();

                msg.Error = false;
                msg.Title = String.Format(_sharedResources["COM_MSG_UPDATE_SUCCESS"], _stringLocalizer["CJ_CURD_LBL_LIST_CODE"]);//"Cập nhật thành công";
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_FAILED"), _stringLocalize["CJ_CURD_LBL_LIST_CODE"));//"Có lỗi xảy ra!";
                return Json(msg);
                throw;
            }
        }
        [HttpPost]
        public JsonResult UpdateOrder(string Orther, string Entry)
        {
            var msg = new JMessage() { Error = true };
            List<string> orther = Orther.Split(',').ToList();
            List<string> entry = Entry.Split(',').ToList();
            List<string> a = new List<string>();
            List<string> b = new List<string>();

            for (int i = 0; i < orther.Count; i++)
            {
                if (orther[i] != entry[i])
                {
                    a.Add(orther[i]);
                    b.Add(entry[i]);
                }
            }

            //List<WORKOSList> data = new List<WORKOSList>();
            for (int i = 0; i < a.Count; i++)
            {
                var data = _context.WORKOSLists.FirstOrDefault(x => x.Order == int.Parse(b[i]));
                data.Order = int.Parse(a[i]);
            }

            _context.SaveChanges();

            return Json("");
        }
        [HttpPost]
        public JsonResult SortListByStatus(string BoardCode, int Orther)
        {
            var msg = new JMessage() { Error = true };
            try
            {
                List<WORKOSList> data = new List<WORKOSList>();
                List<int> orther = new List<int>();

                if (Orther == 0)
                {
                    data = _context.WORKOSLists.Where(x => x.BoardCode.Equals(BoardCode)).OrderBy(x => x.Status).ToList();
                }
                else
                {
                    data = _context.WORKOSLists.Where(x => x.BoardCode.Equals(BoardCode)).OrderByDescending(x => x.Status).ToList();
                }

                for (int i = 0; i < data.Count; i++)
                {
                    orther.Add(data[i].Order);
                }
                orther.Sort();
                for (int i = 0; i < data.Count; i++)
                {
                    data[i].Order = orther[i];
                }

                _context.SaveChanges();

                msg.Error = false;
                msg.Title = String.Format(_sharedResources["COM_MSG_DELETE_SUCCESS"], _stringLocalizer["CJ_CURD_LBL_LIST_CODE"]);//"Sắp xếp thành công";
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_DELETE_FAIL"), _stringLocalize["CJ_CURD_LBL_LIST_CODE"));//"Có lỗi xảy ra!";
                return Json(msg);
            }
        }
        [HttpPost]
        public JsonResult ChangeListStatus(int ListID, int Status)
        {
            var msg = new JMessage() { Error = true };
            try
            {
                var data = _context.WORKOSLists.FirstOrDefault(x => x.ListID == ListID);
                data.Status = Status;
                _context.SaveChanges();

                msg.Error = false;
                msg.Title = String.Format(_stringLocalizer["COM_MSG_UPDATE_SUCCESS"], _stringLocalizer["CJ_COL_STATUS"]);//"Cập nhật trạng thái thành công";
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_FAILED"), _stringLocalize["CJ_COL_STATUS")); //"Có lỗi xảy ra khi cập nhật trạng thái!";
                return Json(msg);
            }
        }
        [HttpPost]
        public JsonResult ChangeListBackground([FromBody] dynamic obj)
        {
            var msg = new JMessage() { Error = true };
            try
            {
                int id = obj.ListID.Value != null ? Convert.ToInt32(obj.ListID.Value) : 0;
                string backGround = obj.Background.Value;
                var data = _context.WORKOSLists.FirstOrDefault(x => x.ListID == id);
                data.Background = backGround;
                _context.SaveChanges();

                msg.Error = false;
                msg.Title = String.Format(_sharedResources["COM_MSG_UPDATE_SUCCESS"], _stringLocalizer["CJ_CURD_BTN_CHANGE_HEADER_BACKGROUND"]);//"Cập nhật trạng thái thành công";
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_FAILED"), _stringLocalize["CJ_CURD_BTN_CHANGE_HEADER_BACKGROUND")); //"Có lỗi xảy ra khi cập nhật trạng thái!";
                return Json(msg);
            }
        }
        [HttpPost]
        public JsonResult ChangeListWeightNum([FromBody] dynamic obj)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                int id = obj.ListID.Value != null ? Convert.ToInt32(obj.ListID.Value) : 0;
                decimal weightNum = obj.ListID.Value != null ? Convert.ToDecimal(obj.WeightNum.Value) : 0;
                var data = _context.WORKOSLists.FirstOrDefault(x => x.ListID == id);
                var getSumWeightNum = _context.WORKOSLists.Where(x => x.BoardCode == data.BoardCode && x.ListCode != data.ListCode && x.IsDeleted == false).Sum(x => x.WeightNum);
                if ((getSumWeightNum + weightNum) > 100)
                {
                    msg.Error = true;
                    //msg.Title = "Trọng số tối đa cho phép " + (100 - getSumWeightNum) + "%!";
                    msg.Title = _stringLocalizer["CJ_MSG_MAXIMUM_WEIGHT"] + " " + (100 - getSumWeightNum) + "%!";
                }
                else
                {
                    data.WeightNum = weightNum;
                    msg.Object = _cardService.UpdatePercentParentList(data.ListCode);
                    _context.SaveChanges();
                    //msg.Title = "Cập nhập trọng số thành công!";
                    msg.Title = String.Format(_sharedResources["COM_MSG_UPDATE_SUCCESS"], _stringLocalizer["CJ_MSG_WEIGHT"]);
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                //msg.Title = "Có lỗi xảy ra khi cập nhập trọng số!";
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult ChangeListBeginTime([FromBody] dynamic obj)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                int id = obj.ListID.Value != null ? Convert.ToInt32(obj.ListID.Value) : 0;
                var beginTime = DateTime.ParseExact(obj.BeginTime.Value, "dd/MM/yyyy", CultureInfo.InvariantCulture);
                var data = _context.WORKOSLists.FirstOrDefault(x => x.ListID == id);
                if (data != null)
                {
                    if (beginTime > data.Deadline)
                    {
                        msg.Error = true;
                        //msg.Title = "Ngày bắt đầu nhỏ hơn ngày kết thúc";
                        msg.Title = _stringLocalizer["CJ_MSG_START_DATE_LESS_EQUAL_END_DATE"];
                    }
                    else
                    {
                        data.BeginTime = beginTime;
                        _context.SaveChanges();
                        //msg.Title = "Cập nhập ngày bắt đầu thành công";
                        msg.Title = String.Format(_sharedResources["COM_MSG_UPDATE_SUCCESS"], _stringLocalizer["CJ_MSG_DATE_START"]);
                    }
                }
                else
                {
                    msg.Error = true;
                    //msg.Title = "Không tồn tại danh sách!";
                    msg.Title = _stringLocalizer["CJ_MSG_LIST_NOT_EXISTS"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                //msg.Title = "Có lỗi xảy ra khi cập nhập trọng số!";
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult ChangeListDeadLine([FromBody] dynamic obj)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                int id = obj.ListID.Value != null ? Convert.ToInt32(obj.ListID.Value) : 0;
                var deadLine = DateTime.ParseExact(obj.DeadLine.Value, "dd/MM/yyyy", CultureInfo.InvariantCulture);
                var data = _context.WORKOSLists.FirstOrDefault(x => x.ListID == id);
                if (data != null)
                {
                    data.Deadline = deadLine;
                    _context.SaveChanges();
                    //msg.Title = "Cập nhập ngày hết hạn thành công";
                    msg.Title = String.Format(_sharedResources["COM_MSG_UPDATE_SUCCESS"], _stringLocalizer["CJ_MSG_EXPIRED"]);
                }
                else
                {
                    msg.Error = true;
                    //msg.Title = "Không tồn tại danh sách!";
                    msg.Title = _stringLocalizer["CJ_MSG_LIST_NOT_EXISTS"];
                }

            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                //msg.Title = "Có lỗi xảy ra khi cập nhập trọng số!";
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        //[HttpPost]
        //public JsonResult ChangeBoard(int ListID, string BoardCode)
        //{
        //    var msg = new JMessage() { Error = true };

        //    try
        //    {
        //        var data = _context.WORKOSLists.FirstOrDefault(x => x.ListID == ListID);
        //        data.BoardCode = BoardCode;
        //        _context.WORKOSLists.Update(data);
        //        _context.SaveChanges();

        //        msg.Title = String.Format(_stringLocalize["CJ_CURD_MSG_CHANGE_BOARD_SUCCESS"));//"Di chuyển danh sách thành công!";
        //        msg.Error = false;
        //        return Json(msg);
        //    }
        //    catch (Exception ex)
        //    {
        //        msg.Object = ex;
        //        msg.Title = String.Format(_stringLocalize["CJ_CURD_MSG_CHANGE_BOARD_FAILED"));// "Có lỗi xảy ra khi di chuyển danh sách!";
        //        return Json(msg);
        //    }
        //}
        [HttpPost]
        public JsonResult DeleteList(int id)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                //deleted List
                var data = _context.WORKOSLists.FirstOrDefault(x => x.ListID == id);
                data.IsDeleted = true;

                //deleted card
                var listCard = _context.WORKOSCards.Where(x => x.ListCode == data.ListCode).ToList();
                listCard.ForEach(x => x.IsDeleted = true);

                ////delete relative
                //var relative = _context.CardMappings.Where(x => x.ListCode == data.ListCode).AsNoTracking().ToList();
                //_context.CardMappings.RemoveRange(relative);

                msg.Object = _cardService.UpdatePercentParentList(data.ListCode);
                _context.SaveChanges();
                msg.Title = String.Format(_sharedResources["COM_MSG_DELETE_SUCCESS"], _stringLocalizer["CJ_CURD_LBL_LIST_CODE"]);//"Xóa danh sách thành công!";
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_DELETE_FAIL"), _stringLocalize["CJ_CURD_LBL_LIST_CODE"));//"Có lỗi khi xóa danh sách!";
            }
            return Json(msg);
        }

        #endregion

        #region Card
        public class GridCardJtable
        {
            public int CardID { get; set; }
            public string CardCode { get; set; }
            public string CardName { get; set; }
            public string ListName { get; set; }
            public DateTime Deadline { get; set; }
            public string Currency { get; set; }
            public decimal Cost { get; set; }
            public decimal Completed { get; set; }
            public DateTime BeginTime { get; set; }
            public DateTime? EndTime { get; set; }
            public DateTime? UpdateTime { get; set; }
            public string Status { get; set; }
            public string CreatedBy { get; set; }
            public string CreatedTime { get; set; }
            public string UpdatedTimeTxt { get; set; }
            public string Priority { get; set; }
            public string WorkType { get; set; }
            public string BoardName { get; set; }
            public DateTime CreatedDate { get; set; }
            public string Total { get; set; }
            public string TotalRow { get; set; }
            public string BoardCode { get; set; }
            public string BoardType { get; set; }
            public bool IsShowLabelAssign { get; set; }
            public string GroupAssign { get; set; }
            public string DepartmentAssign { get; set; }
            public string WfName { get; set; }
            public string ActName { get; set; }
            public string WorkflowCode { get; set; }
            public string LastActivity { get; set; }
            public string Description { get; set; }
            public bool IsRead { get; set; }
        }
        public class GridCardGantt
        {
            public int BoardID { get; set; }
            public string BoardCode { get; set; }
            public string BoardName { get; set; }
            public DateTime? StartTime { get; set; }
            public DateTime? EndTime { get; set; }
            public int? Duration { get; set; }
            public int CardID { get; set; }
            public string CardCode { get; set; }
            public string CardName { get; set; }
            public string Cycle { get; set; }
            public DateTime? BeginTime { get; set; }
            public DateTime? Deadline { get; set; }
            public decimal? Completed { get; set; }
        }
        public class DescriptionModel
        {
            public string CardCode { get; set; }
            public string Description { get; set; }
        }
        public class CardRelative
        {
            public string BoardCode { get; set; }
            public string ListCode { get; set; }
            public int TabBoard { get; set; }
            public List<Properties> ListCodeRelative { get; set; }
            public string CardName { get; set; }
        }
        [HttpGet]
        public object GetUnit()
        {
            return _context.CommonSettings.Where(x => !x.IsDeleted && x.Group == EnumHelper<CommonEnum>.GetDisplayValue(CommonEnum.Unit)).Select(x => new { Code = x.CodeSet, Value = x.ValueSet });
        }

        [HttpPost]
        public JsonResult GetLevels()
        {
            var data = _context.CommonSettings.Where(x => x.AssetCode.Equals("CARDJOB") && x.Group.Equals("LEVEL") && x.IsDeleted == false)
                        .Select(x => new { Code = x.CodeSet, Value = x.ValueSet }).ToList();
            return Json(data);
        }

        [HttpPost]
        public object GetCurrency()
        {
            return _context.CommonSettings.Where(x => !x.IsDeleted && x.Group == EnumHelper<CommonEnum>.GetDisplayValue(CommonEnum.Currency))
                .OrderBy(x => x.SettingID).Select(x => new { Code = x.CodeSet, Name = x.ValueSet });
        }

        [HttpPost]
        public JsonResult GetWorkType()
        {
            var data = _context.CommonSettings.Where(x => x.AssetCode.Equals("CARDJOB") && x.Group.Equals("OBJ_WORKTYPE") && x.IsDeleted == false)
                        .Select(x => new { Code = x.CodeSet, Value = x.ValueSet }).ToList();
            return Json(data);
        }

        [HttpPost]
        public JsonResult GetStatus()
        {
            var data = _context.CommonSettings.Where(x => x.Group == EnumHelper<CardEnum>.GetDisplayValue(CardEnum.Stautus) && x.IsDeleted == false)
                        .Select(x => new { Code = x.CodeSet, Value = x.ValueSet });
            return Json(data);
        }

        [HttpPost]
        public object GetBoardListSugges()
        {
            var maping = _cardService.GetJobCardSuggest(ESEIM.AppContext.UserName);
            if (maping != null)
            {
                return new { BoadCode = maping.BoardCode, ListCode = maping.ListCode };
            }
            else
            {
                return null;
            }
        }

        [HttpGet]
        public object GetCardActivityByUser(string CardCode)
        {
            var userId = ESEIM.AppContext.UserId;
            var actionView = _context.CardUserActivities.FirstOrDefault(x => x.UserId == userId && x.CardCode == CardCode && x.Action == EnumHelper<CardAction>.GetDisplayValue(CardAction.Review));
            if (actionView == null)
            {
                var activity = new CardUserActivity
                {
                    UserId = userId,
                    CardCode = CardCode,
                    Action = EnumHelper<CardAction>.GetDisplayValue(CardAction.Review),
                    IsCheck = true,
                    FromDevice = "Mobile",
                    CreatedTime = DateTime.Now
                };
                _context.CardUserActivities.Add(activity);
                _context.SaveChanges();
            }
            var actionReject = _context.CardUserActivities.Where(x => x.UserId == userId && x.CardCode == CardCode
                && x.Action == EnumHelper<CardAction>.GetDisplayValue(CardAction.Reject)).MaxBy(x => x.CreatedTime);
            var actionAcceipt = _context.CardUserActivities.Where(x => x.UserId == userId && x.CardCode == CardCode
                && x.Action == EnumHelper<CardAction>.GetDisplayValue(CardAction.Accept)).MaxBy(x => x.CreatedTime);

            var isReject = false;
            var isAccept = false;
            if (actionReject != null && actionAcceipt != null)
            {
                if (actionReject.CreatedTime > actionAcceipt.CreatedTime)
                {
                    if (actionReject.IsCheck)
                    {
                        isReject = true;
                        isAccept = false;
                    }
                }
                else
                {
                    if (actionAcceipt.IsCheck)
                    {
                        isReject = false;
                        isAccept = true;
                    }
                }
            }
            else if (actionReject == null && actionAcceipt != null)

            {
                if (actionAcceipt.IsCheck)
                {
                    isReject = false;
                    isAccept = true;
                }
                else
                {
                    isReject = false;
                    isAccept = false;
                }

            }
            else if (actionReject != null && actionAcceipt == null)
            {
                if (actionReject.IsCheck)
                {
                    isReject = true;
                    isAccept = false;
                }
                else
                {
                    isReject = false;
                    isAccept = false;
                }
            }

            return new[]
            {
                new
                {
                    Name= CardAction.Review.DescriptionAttr(),
                    Value= CardAction.Review.GetHashCode(),
                    Date = actionView != null ? actionView.CreatedTime.ToString("dd/MM/yyyy") : DateTime.Now.ToString("dd/MM/yyyy"),
                    Time = actionView != null ? actionView.CreatedTime.ToString("hh:mm:ssy") : DateTime.Now.ToString("hh:mm:ss"),
                    IsCheck = true,
                },
                 new
                {
                    Name= CardAction.Reject.DescriptionAttr(),
                    Value = CardAction.Reject.GetHashCode(),
                    Date = actionReject != null ? actionReject.CreatedTime.ToString("dd/MM/yyyy") : DateTime.Now.ToString("dd/MM/yyyy"),
                    Time = actionReject != null ? actionReject.CreatedTime.ToString("hh:mm:ss") : DateTime.Now.ToString("hh:mm:ss"),
                    IsCheck = isReject,
                },
                new
                {
                    Name= actionAcceipt != null? CardAction.Accept.DescriptionAttr() : "Hãy đồng ý!",
                    Value = CardAction.Accept.GetHashCode(),
                    Date = actionAcceipt != null ? actionAcceipt.CreatedTime.ToString("dd/MM/yyyy") : DateTime.Now.ToString("dd/MM/yyyy"),
                    Time = actionAcceipt != null ? actionAcceipt.CreatedTime.ToString("hh:mm:ss") : DateTime.Now.ToString("hh:mm:ss"),
                    IsCheck = isAccept,
                },
            };
        }

        [HttpGet]
        public JsonResult GetCardDetail(string CardCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            WORKOSList list = null;
            WORKOSBoard board = null;
            try
            {
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(CardCode) && !x.IsDeleted);

                var lockShare = new InfoLockShare();

                var session = HttpContext.GetSessionUser();
                if (data != null)
                {
                    list = _context.WORKOSLists.FirstOrDefault(x => x.ListCode == data.ListCode && !x.IsDeleted);
                    if (list != null)
                    {
                        board = _context.WORKOSBoards.FirstOrDefault(x => x.BoardCode == (list.BoardCode) && !x.IsDeleted);
                    }
                }
                var checkNotification = _context.CommonSettings.FirstOrDefault(x => x.CodeSet == "NOTIFICATION_CARD" && !x.IsDeleted).ValueSet;
                msg.Object = new
                {
                    CardDetail = data,
                    BoardCompleted = board?.Completed,
                    ListCompleted = list?.Completed,
                    Notification = checkNotification,
                    CurrenUser = ESEIM.AppContext.UserName,
                    Session = session.IsAllData,
                    TimeStart = DateTime.Now,
                    Board = board.BoardCode,
                    List = list.ListCode,
                    BoardFullData = board
                };
                //AutoAcceptCard(CardCode);
                RemoveUserInNotify(data.CardCode, EnumHelper<NotificationType>.GetDisplayValue(NotificationType.CardJob), false);
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                msg.Object = ex.Message;
            }
            return Json(msg);
        }

        [NonAction]
        private void AutoAcceptCard(string cardCode)
        {
            var check = _context.CardUserActivities.FirstOrDefault(x => x.CardCode.Equals(cardCode)
                    && x.UserId.Equals(ESEIM.AppContext.UserId) && x.Action != EnumHelper<CardAction>.GetDisplayValue(CardAction.Review));
            if (check == null)
            {
                var actionText = EnumHelper<CardAction>.GetDisplayValue(CardAction.Accept);
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    CardCode = cardCode,
                    Action = actionText,
                    IsCheck = true,
                    FromDevice = "Laptop/Desktop",
                    CreatedTime = DateTime.Now
                };
                _context.CardUserActivities.Add(activity);
                _context.SaveChanges();
            }
        }

        [HttpGet]
        public JsonResult GetCardProgress(string CardCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(CardCode));
                msg.Object = new
                {
                    data.Progress,
                };
            }
            catch (Exception ex)
            {
                msg.Error = true;
                // msg.Title = "Có lỗi khi lấy dữ liệu!";
                msg.Title = _sharedResources["COM_MSG_ERR"];
                msg.Object = ex.Message;
            }
            return Json(msg);
        }

        [HttpPost]
        public object GetListsAndCard([FromBody] AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            if (!string.IsNullOrEmpty(data.BoardCode))
            {
                var query = (from a in _context.WORKOSLists
                             where a.IsDeleted == false && a.BoardCode == data.BoardCode
                             orderby a.Order
                             select a).AsNoTracking();
                var count = query.Count();
                var list = query.Skip(intBeginFor).Take(data.Length).AsNoTracking()
                    .Select(a => new
                    {
                        a.ListID,
                        a.ListCode,
                        a.ListName,
                        a.Completed,
                        a.WeightNum,
                        a.Status,
                        a.BeginTime,
                        a.Deadline,
                        a.Background,
                        a.Order,
                        ListCard = ListCard(data, a.ListCode, user.BranchId, user.DepartmentId)
                    });
                return new
                {
                    Data = list,
                    Total = count
                };
            }
            else
            {
                var list = (from a in _context.WORKOSLists.Where(x => !x.IsDeleted)
                            join b in _context.WORKOSCards.Where(x => !x.IsDeleted
                                && x.Status != "TRASH") on a.ListCode equals b.ListCode
                            select new
                            {
                                a.ListID,
                                a.ListCode,
                                a.ListName,
                                a.Completed,
                                a.WeightNum,
                                a.Status,
                                a.BeginTime,
                                a.Deadline,
                                a.Background,
                                a.Order
                            }).DistinctBy(x => x.ListCode);
                var listPaging = list.Skip(intBeginFor).Take(data.Length)
                    .Select(x => new
                    {
                        x.ListID,
                        x.ListCode,
                        x.ListName,
                        x.Completed,
                        x.WeightNum,
                        x.Status,
                        x.BeginTime,
                        x.Deadline,
                        x.Background,
                        x.Order,
                        ListCard = ListCard(data, x.ListCode, user.BranchId, user.DepartmentId)
                    });
                return new
                {
                    Data = listPaging,
                    Total = list.Count(),
                };
            }
        }

        [NonAction]
        private List<ListAndCard> ListCard(AdvanceSearchObj dataSearch, string listCode,
            string branch, string department)
        {
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);

            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }

            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate",
                "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName",
                "@ListUserOfBranch", "@UserId", "@BranchId", "@Status", "@Object",
                "@ListCode", "@CardName" };
            object[] val = new object[] {dataSearch.CurrentPageList, 10,fromDatePara, toDatePara ,
                session.IsAllData, session.IsUser, session.IsBranch,
                !string.IsNullOrEmpty(department) ? department : "", session.UserName,listUserOfBranch,
                session.UserId,  !string.IsNullOrEmpty(branch) ? branch : "",
                !string.IsNullOrEmpty(dataSearch.Status) ? dataSearch.Status : "",
                dataSearch.Object, listCode, dataSearch.CardName};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_LIST_AND_CARD", param, val);
            var query = CommonUtil.ConvertDataTable<ListAndCard>(rs);
            return query;
        }
        public class ListAndCard
        {
            public string ListCode { get; set; }
            public int CardID { get; set; }
            public string CardCode { get; set; }
            public string CardName { get; set; }
            public DateTime Deadline { get; set; }
            public string Unit { get; set; }
            public DateTime BeginTime { get; set; }
            public DateTime EndTime { get; set; }
            public string CurrencyValue { get; set; }
            public string Status { get; set; }
            public int CountCheckListDone { get; set; }
            public int CountCheckList { get; set; }
            public decimal Completed { get; set; }
            public string LocationText { get; set; }
            public DateTime CreatedDate { get; set; }
        }

        public class WfActObjProcess
        {
            public string ObjectType { get; set; }
            public string ObjectInst { get; set; }
            public string Title { get; set; }
            public string WfInstName { get; set; }
        }

        public class JobCardUser
        {
            public string Role { get; set; }
            public string UserId { get; set; }
            public string DepartmentId { get; set; }
            public bool? Approve { get; set; }
            public string CardCode { get; set; }
        }

        [HttpPost]
        public JsonResult GetGridCard([FromBody] AdvanceSearchObj jtablePara)
        {
            //TabBoard = 1(Bảng)                  //TabBoard = 5(Dự án)
            //TabBoard = 2(Phòng ban)             //TabBoard = 6(Khách hàng)
            //TabBoard = 3(Nhân viên)             //TabBoard = 7(Hợp đồng)
            //TabBoard = 4(Nhóm)                  //TabBoard = 8(Nhà cung cấp)
            int intBegin = (jtablePara.CurrentPage - 1) * jtablePara.Length;
            int count = 0;

            if (!String.IsNullOrEmpty(jtablePara.TimeType))
            {
                jtablePara.TimeTypeCreated = jtablePara.TimeType.Contains("CJ_TIME_TYPE_CREATE");
                jtablePara.TimeTypeStart = jtablePara.TimeType.Contains("CJ_TIME_TYPE_START");
                jtablePara.TimeTypeEnd = jtablePara.TimeType.Contains("CJ_TIME_TYPE_END");
                jtablePara.TimeTypeCompleted = jtablePara.TimeType.Contains("CJ_TIME_TYPE_COMPLETE");
            }
            else
            {
                jtablePara.TimeTypeCreated = false;
                jtablePara.TimeTypeStart = true;
                jtablePara.TimeTypeEnd = true;
                jtablePara.TimeTypeCompleted = false;
            }

            List<GridCardJtable> queryTab = new List<GridCardJtable>();
            if (jtablePara.TabBoard == 1)
            {
                queryTab = GetGirdCardBoard(jtablePara);
            }
            else if (jtablePara.TabBoard == 2)
            {
                queryTab = GetGirdCardDepartment(jtablePara);
            }
            else if (jtablePara.TabBoard == 3)
            {
                queryTab = GetGirdCardUser(jtablePara);
            }
            else if (jtablePara.TabBoard == 4)
            {
                queryTab = GetGirdCardGroupUser(jtablePara);
            }
            else if (jtablePara.TabBoard == 5)
            {
                queryTab = GetGirdCardProject(jtablePara);
            }
            else if (jtablePara.TabBoard == 6)
            {
                queryTab = GetGirdCardCustomer(jtablePara);
            }
            else if (jtablePara.TabBoard == 7)
            {
                queryTab = GetGirdCardContract(jtablePara);
            }
            else if (jtablePara.TabBoard == 8)
            {
                queryTab = GetGirdCardSupplier(jtablePara);
            }
            if (queryTab.Count() > 0)
            {
                string[] param = new string[] { "@CardCodeSequence" };
                var cardCodeSequence = String.Join(";", queryTab.Select(x => x.CardCode));
                object[] val = new object[] { cardCodeSequence };
                DataTable rs = null;
                rs = _repositoryService.GetDataTableProcedureSql("P_GET_ACT_CARD_JOB", param, val);
                var acts = CommonUtil.ConvertDataTable<WfActObjProcess>(rs);
                rs = _repositoryService.GetDataTableProcedureSql("P_GET_USER_CARD_JOB", param, val);
                var users = CommonUtil.ConvertDataTable<JobCardUser>(rs);
                rs = _repositoryService.GetDataTableProcedureSql("P_GET_DEPARTMENT_CARD_JOB", param, val);
                var assignees = CommonUtil.ConvertDataTable<DepartmentGroupAssignee>(rs);
                rs = _repositoryService.GetDataTableProcedureSql("P_GET_LAST_CHANGE_CARD_JOB", param, val);
                var activityAssignees = CommonUtil.ConvertDataTable<ActivityAssignee>(rs);
                rs = _repositoryService.GetDataTableProcedureSql("P_GET_NOTI_CARD_JOB", param, val);
                var managers = CommonUtil.ConvertDataTable<NotificationManager>(rs);
                foreach (var item in queryTab)
                {
                    var tuple = GetWfActName(item.CardCode, acts);
                    item.IsShowLabelAssign = CheckShowLabelAssign(item.CardCode, users);
                    var assign = GetDepartmentGroupAssign(item.CardCode, assignees);
                    item.GroupAssign = assign.Item2;
                    item.DepartmentAssign = assign.Item1;
                    item.WfName = tuple.Item1;
                    item.ActName = tuple.Item2;
                    item.CreatedTime = item.CreatedDate.ToString("dd/MM/yyyy");
                    var lastActivity = GetActivityAssignPrivate(item.CardCode, activityAssignees);
                    item.LastActivity = lastActivity != null ? JsonConvert.SerializeObject(lastActivity) : "";
                    item.IsRead = GetIsReadNotification(item.CardCode, managers);
                }
                count = int.Parse(queryTab.FirstOrDefault().TotalRow);
                var jdata = JTableHelper.JObjectTable(
                                queryTab,
                                jtablePara.Draw,
                                count,
                                "CardID", "CardCode", "CardName", "ListName", "Deadline", "Status", "LastActivity",
                                "Completed", "BeginTime", "EndTime", "Cost", "Currency", "CreatedBy", "CreatedTime",
                                "Priority", "WorkType", "UpdatedTimeTxt", "UpdateTime", "BoardName", "IsShowLabelAssign",
                                "GroupAssign", "DepartmentAssign", "WfName", "ActName", "IsRead", "BoardType"
                                );
                return Json(jdata);
            }
            else
            {
                var jdata = JTableHelper.JObjectTable(
                                queryTab,
                                jtablePara.Draw,
                                count,
                                "CardID", "CardCode", "CardName", "ListName", "Deadline", "Status", "LastActivity",
                                "Completed", "BeginTime", "EndTime", "Cost", "Currency", "CreatedBy", "CreatedTime",
                                "Priority", "WorkType", "UpdatedTimeTxt", "UpdateTime", "BoardName", "IsShowLabelAssign",
                                "GroupAssign", "DepartmentAssign", "WfName", "ActName", "IsRead", "BoardType"
                                );
                return Json(jdata);
            }
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardOut(AdvanceSearchObj dataSearch)
        {
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);

            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }

            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
                "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
                session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch,
                !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",session.UserId,  !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "",
                dataSearch.Status, !string.IsNullOrEmpty(dataSearch.Object) ? dataSearch.Object : "", !string.IsNullOrEmpty(dataSearch.ObjType) ? dataSearch.ObjType : "", dataSearch.CardName};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD", param, val);
            var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
            return query;
            //if (fromDate == null && toDate == null && string.IsNullOrEmpty(dataSearch.Status) && string.IsNullOrEmpty(dataSearch.CardName) && string.IsNullOrEmpty(dataSearch.BranchId))
            //{
            //    var query = (from a in _context.WORKOSCards.Where(x => !x.IsDeleted)
            //                 let lt = a.LstUser.Split(",", StringSplitOptions.None)
            //                 join b in _context.CardCommentLists on a.CardCode equals b.CardCode
            //                 join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
            //                 from g2 in g1.DefaultIfEmpty()
            //                 join h in _context.Users.Where(x => x.Active) on a.CreatedBy equals h.UserName into h1
            //                 from h2 in h1.DefaultIfEmpty()
            //                 join i in _context.WORKOSLists.Where(x => !x.IsDeleted) on a.ListCode equals i.ListCode
            //                 join k in _context.WORKOSBoards.Where(x => !x.IsDeleted) on i.BoardCode equals k.BoardCode
            //                 where (session.IsAllData
            //                    || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
            //                    || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0
            //                        && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
            //                 select new GridCardJtable
            //                 {
            //                     CardID = a.CardID,
            //                     CardCode = a.CardCode,
            //                     CardName = a.CardName,
            //                     ListName = _context.WORKOSLists.FirstOrDefault(y => y.ListCode.Equals(a.ListCode)).ListName ?? "",
            //                     BoardName = k.BoardName,
            //                     Deadline = a.Deadline,
            //                     Currency = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == a.Currency).ValueSet ?? "",
            //                     Cost = a.Cost,
            //                     Completed = a.Completed,
            //                     BeginTime = a.BeginTime,
            //                     EndTime = a.EndTime,
            //                     Status = _context.CommonSettings.FirstOrDefault(y => y.CodeSet.Equals(a.Status)).ValueSet,
            //                     UpdateTime = a.UpdatedTime,
            //                     CreatedBy = h2.GivenName,
            //                     CreatedTime = a.CreatedDate.ToString("dd/MM/yyyy"),
            //                     CreatedDate = a.CreatedDate,
            //                     UpdatedTimeTxt = a.UpdatedTime.HasValue ? a.UpdatedTime.Value.ToString("dd/MM/yyyy HH:mm:ss") : "",
            //                     WorkType = !string.IsNullOrEmpty(a.WorkType) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.WorkType).ValueSet : "",
            //                     Priority = !string.IsNullOrEmpty(a.CardLevel) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.CardLevel).ValueSet : "",
            //                 }).DistinctBy(x => x.CardCode).OrderByDescending(x => x.UpdateTime.HasValue ? x.UpdateTime.Value : x.CreatedDate).ThenByDescending(x => x.CardID);
            //    IQueryable<GridCardJtable> data1 = query.AsQueryable<GridCardJtable>();
            //    return data1;
            //}
            //else
            //{
            //    var query = (from a in _context.WORKOSCards.Where(x => !x.IsDeleted)
            //                 let lt = a.LstUser.Split(",", StringSplitOptions.None)
            //                 join b in _context.CardCommentLists on a.CardCode equals b.CardCode into b1
            //                 from b2 in b1.DefaultIfEmpty()
            //                 join c in _context.CardItemChecks on a.CardCode equals c.CardCode into c1
            //                 from c2 in c1.DefaultIfEmpty()
            //                 join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
            //                 from g2 in g1.DefaultIfEmpty()
            //                 join h in _context.Users.Where(x => x.Active) on a.CreatedBy equals h.UserName into h1
            //                 from h2 in h1.DefaultIfEmpty()
            //                 join i in _context.WORKOSLists.Where(x => !x.IsDeleted) on a.ListCode equals i.ListCode
            //                 join k in _context.WORKOSBoards.Where(x => !x.IsDeleted) on i.BoardCode equals k.BoardCode
            //                 where (fromDate == null || a.BeginTime >= fromDate) &&
            //                       (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
            //                       ((string.IsNullOrEmpty(dataSearch.CardName) || a.CardName.ToLower().Contains(dataSearch.CardName.ToLower())) ||
            //                       (string.IsNullOrEmpty(dataSearch.CardName) || a.CardCode.ToLower().Contains(dataSearch.CardName.ToLower())) ||
            //                       (string.IsNullOrEmpty(dataSearch.CardName) || a.Description.ToLower().Contains(dataSearch.CardName.ToLower())) ||
            //                       (string.IsNullOrEmpty(dataSearch.CardName) || c2.CheckTitle.ToLower().Contains(dataSearch.CardName.ToLower())) ||
            //                       (string.IsNullOrEmpty(dataSearch.CardName) || b2.CmtContent.ToLower().Contains(dataSearch.CardName.ToLower()))) &&
            //                       ((string.IsNullOrEmpty(dataSearch.Status) && a.Status != "TRASH") || a.Status.Equals(dataSearch.Status)) &&
            //                       (string.IsNullOrEmpty(dataSearch.BranchId) || h2.BranchId.Equals(dataSearch.BranchId)) &&
            //                       //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
            //                       (session.IsAllData
            //                    || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
            //                    || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0
            //                        && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
            //                 select new GridCardJtable
            //                 {
            //                     CardID = a.CardID,
            //                     CardCode = a.CardCode,
            //                     CardName = a.CardName,
            //                     ListName = _context.WORKOSLists.FirstOrDefault(y => y.ListCode.Equals(a.ListCode)).ListName ?? "",
            //                     BoardName = k.BoardName,
            //                     Deadline = a.Deadline,
            //                     Currency = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == a.Currency).ValueSet ?? "",
            //                     Cost = a.Cost,
            //                     Completed = a.Completed,
            //                     BeginTime = a.BeginTime,
            //                     EndTime = a.EndTime,
            //                     Status = _context.CommonSettings.FirstOrDefault(y => y.CodeSet.Equals(a.Status)).ValueSet,
            //                     UpdateTime = a.UpdatedTime,
            //                     CreatedBy = h2.GivenName,
            //                     CreatedTime = a.CreatedDate.ToString("dd/MM/yyyy"),
            //                     CreatedDate = a.CreatedDate,
            //                     UpdatedTimeTxt = a.UpdatedTime.HasValue ? a.UpdatedTime.Value.ToString("dd/MM/yyyy HH:mm:ss") : "",
            //                     WorkType = !string.IsNullOrEmpty(a.WorkType) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.WorkType).ValueSet : "",
            //                     Priority = !string.IsNullOrEmpty(a.CardLevel) ? _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet == a.CardLevel).ValueSet : "",
            //                 }).DistinctBy(x => x.CardCode).OrderByDescending(x => x.UpdateTime.HasValue ? x.UpdateTime.Value : x.CreatedDate).ThenByDescending(x => x.CardID);
            //    IQueryable<GridCardJtable> data1 = query.AsQueryable<GridCardJtable>();
            //    return data1;
            //}
        }

        [HttpPost]
        public JsonResult InsertCard([FromBody] CardRelative data)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            var session = HttpContext.GetSessionUser();
            IQueryable<CardMemberCustom> lstUser = null;
            try
            {
                //if (string.IsNullOrEmpty(data.CardName))
                //{
                //    return Json(new JMessage() { Error = true, Title = String.Format(_stringLocalizer["CJ_CURD_MSG_ADD_CONTENT"]) });
                //}
                if (string.IsNullOrEmpty(data.ListCode))
                {
                    return Json(new JMessage() { Error = true, Title = "Vui lòng chọn danh sách" });//"Nhập nội dung"
                }
                var list = _context.WORKOSLists.FirstOrDefault(x => x.ListCode == data.ListCode && x.IsDeleted == false);
                var board = _context.WORKOSBoards.FirstOrDefault(x => x.BoardCode == list.BoardCode && x.IsDeleted == false);
                var lstJsonStatus = new List<JsonStatusCard>();
                var jsonStatus = new JsonStatusCard
                {
                    Status = "CREATED",
                    CreatedBy = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now,
                    Lock = false
                };
                lstJsonStatus.Add(jsonStatus);

                var card = new WORKOSCard
                {
                    CardName = !string.IsNullOrEmpty(data.CardName) ? data.CardName : "",
                    CardCode = "" + (_context.WORKOSCards.Count() > 0 ? _context.WORKOSCards.Max(x => x.CardID) + 1 : 1),
                    ListCode = data.ListCode,
                    CreatedBy = ESEIM.AppContext.UserName,
                    CreatedDate = DateTime.Now,
                    Currency = "VND",
                    Status = "CREATED",
                    BeginTime = DateTime.Now,
                    EndTime = DateTime.Now > list.Deadline ? DateTime.Now : list.Deadline,
                    Deadline = DateTime.Now > list.Deadline ? DateTime.Now : list.Deadline,
                    Description = "",
                    JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus)
                };
                //comment
                var comment = new CardCommentList()
                {
                    CardCode = card.CardCode,
                    CmtId = "Comment" + Guid.NewGuid().ToString(),
                    CmtContent = "Đã tạo công việc",
                    MemberId = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now
                };
                _context.CardCommentLists.Add(comment);

                //Add department of member create card
                var user = _context.Users.FirstOrDefault(x => x.UserName == ESEIM.AppContext.UserName && x.Active);
                var addLeader = new JobCardAssignee
                {
                    CardCode = card.CardCode,
                    UserId = ESEIM.AppContext.UserId,
                    CreatedBy = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now,
                    Role = "ROLE_LEADER",
                    DepartmentCode = user != null ? !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "" : "",
                    GroupCode = "",
                    Item = "",
                    Approve = true,
                    ApproveTime = DateTime.Now,
                    Status = "ASSIGN_STATUS_WORK",
                    Branch = !string.IsNullOrEmpty(session.BranchId) ? session.BranchId : ""
                };
                _context.JobCardAssignees.Add(addLeader);
                var json = new List<JobCardAssignee>();
                json.Add(addLeader);
                card.JsonAssign = JsonConvert.SerializeObject(json);

                msg.Object = card;
                //relative (Board)

                //TabBoard = 1(Bảng)                  //TabBoard = 5(Dự án)
                //TabBoard = 2(Phòng ban)             //TabBoard = 6(Khách hàng)
                //TabBoard = 3(Nhân viên)             //TabBoard = 7(Hợp đồng)
                //TabBoard = 4(Nhóm)                  //TabBoard = 8(Nhà cung cấp)
                //TabBoard = 11(Hợp đồng mua)         //TabBoard = 9(Yêu cầu hỏi giá)
                //TabBoard = 10(Yêu cầu đặt hàng)

                if (data.ListCodeRelative.Any())
                {
                    //foreach (var item in data.ListCodeRelative)
                    //{
                    //    var maping = new CardMapping
                    //    {
                    //        CardCode = card.CardCode,
                    //        BoardCode = list.BoardCode,
                    //        ListCode = card.ListCode,
                    //        ProjectCode = data.TabBoard == 5 ? item.Code : null,
                    //        ContractCode = data.TabBoard == 7 ? item.Code : null,
                    //        CustomerCode = data.TabBoard == 6 ? item.Code : null,
                    //        SupplierCode = data.TabBoard == 8 ? item.Code : null,
                    //        Relative = _context.CommonSettings.FirstOrDefault(x => x.Group == EnumHelper<CardEnum>.GetDisplayValue(CardEnum.ObjRelative))?.CodeSet,
                    //        TeamCode = data.TabBoard == 4 ? item.Code : null,
                    //        GroupUserCode = data.TabBoard == 2 ? item.Code : null,
                    //        UserId = data.TabBoard == 3 ? item.Code : null,
                    //        CreatedBy = ESEIM.AppContext.UserName,
                    //        CreatedTime = DateTime.Now,
                    //    };
                    //    _context.CardMappings.Add(maping);
                    //}
                    if (data.TabBoard == 2)
                    {
                        //get all member in groupuser
                        var listUserInDepartment = GetMemberInDepartment(data.ListCodeRelative.Select(x => x.Code));
                        lstUser = listUserInDepartment;
                    }
                    else if (data.TabBoard == 4)
                    {
                        //get all member in team
                        var listUserInTeam = from a in _context.Teams.Where(x => data.ListCodeRelative.Any(y => x.TeamCode == y.Code))
                                             select new
                                             {
                                                 a.Members,
                                             };
                        foreach (var team in listUserInTeam)
                        {
                            var listUser = team.Members.Split(",").Select(x => new CardMemberCustom
                            {
                                UserId = x
                            });
                            lstUser = lstUser != null && lstUser.Any() ? lstUser.Concat(listUser) : listUser.AsQueryable();
                        }
                    }
                    else if (data.TabBoard == 3)
                    {
                        var listUser = data.ListCodeRelative.Select(x => new CardMemberCustom
                        {
                            UserId = x.Code
                        });
                        lstUser = listUser.AsQueryable();
                    }
                    else if (data.TabBoard == 5)
                    {
                        var JcObject = new JcObjectIdRelative
                        {
                            Weight = 0,
                            CardCode = card.CardCode,
                            ObjTypeCode = "PROJECT",
                            ObjID = data.ListCodeRelative[0].Code,
                            Relative = "MAIN",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                        };
                        _context.JcObjectIdRelatives.Add(JcObject);
                    }
                    else if (data.TabBoard == 7)
                    {
                        var JcObject = new JcObjectIdRelative
                        {
                            Weight = 0,
                            CardCode = card.CardCode,
                            ObjTypeCode = "CONTRACT",
                            ObjID = data.ListCodeRelative[0].Code,
                            Relative = "MAIN",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                        };
                        _context.JcObjectIdRelatives.Add(JcObject);
                    }
                    else if (data.TabBoard == 11)
                    {
                        var JcObject = new JcObjectIdRelative
                        {
                            Weight = 0,
                            CardCode = card.CardCode,
                            ObjTypeCode = "CONTRACT_PO",
                            ObjID = data.ListCodeRelative[0].Code,
                            Relative = "MAIN",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                        };
                        _context.JcObjectIdRelatives.Add(JcObject);
                    }
                    else if (data.TabBoard == 9)
                    {
                        var JcObject = new JcObjectIdRelative
                        {
                            Weight = 0,
                            CardCode = card.CardCode,
                            ObjTypeCode = "REQUEST_PRICE",
                            ObjID = data.ListCodeRelative[0].Code,
                            Relative = "MAIN",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                        };
                        _context.JcObjectIdRelatives.Add(JcObject);
                    }
                    else if (data.TabBoard == 10)
                    {
                        var JcObject = new JcObjectIdRelative
                        {
                            Weight = 0,
                            CardCode = card.CardCode,
                            ObjTypeCode = "REQUEST_PRODUCT",
                            ObjID = data.ListCodeRelative[0].Code,
                            Relative = "MAIN",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                        };
                        _context.JcObjectIdRelatives.Add(JcObject);
                    }
                    else if (data.TabBoard == 8)
                    {
                        var JcObject = new JcObjectIdRelative
                        {
                            Weight = 0,
                            CardCode = card.CardCode,
                            ObjTypeCode = "SUPPLIER",
                            ObjID = data.ListCodeRelative[0].Code,
                            Relative = "MAIN",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                        };
                        _context.JcObjectIdRelatives.Add(JcObject);
                    }
                    else if (data.TabBoard == 6)
                    {
                        var JcObject = new JcObjectIdRelative
                        {
                            Weight = 0,
                            CardCode = card.CardCode,
                            ObjTypeCode = "CUSTOMER",
                            ObjID = data.ListCodeRelative[0].Code,
                            Relative = "MAIN",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                        };
                        _context.JcObjectIdRelatives.Add(JcObject);
                    }

                    card.LstUser = lstUser != null && lstUser.Any() ? string.Join(",", lstUser.Select(x => x.UserId)) : null;
                }
                _context.WORKOSCards.Add(card);
                _context.SaveChanges();
                msg.Title = String.Format(_sharedResources["COM_MSG_ADD_SUCCESS"], _stringLocalizer[""]);
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_ADD_FAILED"), _stringLocalize[""));//"Có lỗi xảy ra!";
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult InsertCardNormal(string listCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var lstJsonStatus = new List<JsonStatusCard>();
                var jsonStatus = new JsonStatusCard
                {
                    Status = "CREATED",
                    CreatedBy = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now,
                    Lock = false
                };
                lstJsonStatus.Add(jsonStatus);

                var card = new WORKOSCard
                {
                    CardName = "",
                    CardCode = "" + (_context.WORKOSCards.Count() > 0 ? _context.WORKOSCards.Max(x => x.CardID) + 1 : 1),
                    ListCode = listCode,
                    CreatedBy = ESEIM.AppContext.UserName,
                    CreatedDate = DateTime.Now,
                    Currency = "VND",
                    Status = "CREATED",
                    BeginTime = DateTime.Now,
                    EndTime = DateTime.Now,
                    Deadline = DateTime.Now,
                    Description = "",
                    JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus)
                };
                _context.WORKOSCards.Add(card);

                //comment
                var comment = new CardCommentList()
                {
                    CardCode = card.CardCode,
                    CmtId = "Comment" + Guid.NewGuid().ToString(),
                    CmtContent = "Đã tạo công việc",
                    MemberId = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now
                };
                _context.CardCommentLists.Add(comment);

                //Add department of member create card
                var session = HttpContext.GetSessionUser();
                var addLeader = new JobCardAssignee
                {
                    CardCode = card.CardCode,
                    UserId = ESEIM.AppContext.UserId,
                    CreatedBy = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now,
                    Role = "ROLE_LEADER",
                    DepartmentCode = session.DepartmentCode,
                    GroupCode = "",
                    Item = "",
                    Approve = true,
                    ApproveTime = DateTime.Now,
                    Status = "ASSIGN_STATUS_WORK",
                    Branch = !string.IsNullOrEmpty(session.BranchId) ? session.BranchId : ""
                };

                _context.JobCardAssignees.Add(addLeader);
                var json = new List<JobCardAssignee>();

                json.Add(addLeader);
                card.JsonAssign = JsonConvert.SerializeObject(json);

                card.LstUser = session.UserId;
                _context.SaveChanges();
                msg.Title = "Tạo thẻ việc thành công";
            }
            catch (Exception ex)
            {
                msg.Error = false;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult DeleteCard(int Id)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var userName = ESEIM.AppContext.UserName;
                var admin = "admin";
                //deleted card
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardID == Id);

                if (data != null)
                {
                    if (userName.ToLower() == admin.ToLower()/* || data.CreatedBy == userName*/)
                    {
                        if (data.Status == "TRASH")
                        {
                            data.IsDeleted = true;
                            var listJcObj = _context.JcObjectIdRelatives.Where(x => x.CardCode == data.CardCode && !x.IsDeleted);
                            foreach (var itemJcObj in listJcObj)
                            {
                                itemJcObj.IsDeleted = true;
                                _context.JcObjectIdRelatives.Update(itemJcObj);
                            }
                            var assign = _context.JobCardAssignees.Where(x => !x.IsDeleted && x.CardCode.Equals(data.CardCode));
                            foreach (var item in assign)
                            {
                                item.IsDeleted = true;
                                item.DeletedBy = ESEIM.AppContext.UserName;
                                item.DeletedTime = DateTime.Now;
                                _context.JobCardAssignees.Update(item);
                            }
                            var listWfActivityObj = _context.WfActivityObjectProccessings.Where(x => !x.IsDeleted && x.ObjectType == "CARD_JOB" && x.ObjectInst == data.CardCode);
                            foreach (var obj in listWfActivityObj)
                            {
                                obj.IsDeleted = true;
                                obj.DeletedBy = ESEIM.AppContext.UserName;
                                obj.DeletedTime = DateTime.Now;
                                _context.WfActivityObjectProccessings.Update(obj);
                            }
                        }
                        else
                        {
                            data.Status = "TRASH";
                            var lstStatus = new List<JsonStatusCard>();
                            if (!string.IsNullOrEmpty(data.JsonStatusLog))
                            {
                                lstStatus = JsonConvert.DeserializeObject<List<JsonStatusCard>>(data.JsonStatusLog);
                            }
                            var json = new JsonStatusCard
                            {
                                CreatedBy = ESEIM.AppContext.UserName,
                                CreatedTime = DateTime.Now,
                                Lock = false,
                                Status = "TRASH"
                            };
                            lstStatus.Add(json);
                            data.JsonStatusLog = JsonConvert.SerializeObject(lstStatus);
                        }
                        _context.SaveChanges();
                        msg.Title = String.Format(_sharedResources["COM_MSG_DELETE_SUCCESS"], _stringLocalizer[""]);// "Xóa thành công";

                        RemoveUserInNotify(data.CardCode, EnumHelper<NotificationType>.GetDisplayValue(NotificationType.CardJob), true);
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["CJ_MSG_YOU_NOT_CREATED_CARD"];
                    }
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy bản ghi";
                }

                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Title = _sharedResources["COM_MSG_ERR"];
                msg.Object = ex;
                return Json(msg);
            }
        }

        [HttpPost]
        public JsonResult DeleteNewCard(string cardCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode == cardCode);
                if (card != null)
                {
                    card.IsDeleted = true;
                    var listJcObj = _context.JcObjectIdRelatives.Where(x => x.CardCode == card.CardCode && !x.IsDeleted);
                    foreach (var itemJcObj in listJcObj)
                    {
                        itemJcObj.IsDeleted = true;
                        _context.JcObjectIdRelatives.Update(itemJcObj);
                    }
                    var assign = _context.JobCardAssignees.Where(x => !x.IsDeleted && x.CardCode.Equals(card.CardCode));
                    foreach (var item in assign)
                    {
                        item.IsDeleted = true;
                        item.DeletedBy = ESEIM.AppContext.UserName;
                        item.DeletedTime = DateTime.Now;
                        _context.JobCardAssignees.Update(item);
                    }
                    _context.SaveChanges();
                    msg.Title = "Hủy tạo thẻ việc thành công";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult DelCardNoTitle(string cardCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode == cardCode);
                if (card != null)
                {
                    card.IsDeleted = true;
                    var listJcObj = _context.JcObjectIdRelatives.Where(x => x.CardCode == card.CardCode && !x.IsDeleted);
                    foreach (var itemJcObj in listJcObj)
                    {
                        itemJcObj.IsDeleted = true;
                        _context.JcObjectIdRelatives.Update(itemJcObj);
                    }
                    var assign = _context.JobCardAssignees.Where(x => !x.IsDeleted && x.CardCode.Equals(card.CardCode));
                    foreach (var item in assign)
                    {
                        item.IsDeleted = true;
                        item.DeletedBy = ESEIM.AppContext.UserName;
                        item.DeletedTime = DateTime.Now;
                        _context.JobCardAssignees.Update(item);
                    }
                    _context.SaveChanges();
                    msg.Title = "Xóa thẻ việc thành công";
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Thẻ việc không tồn tại";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateCardName([FromBody] WORKOSCard obj)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardID == obj.CardID);
                if (data.CardName != obj.CardName)
                {
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = data.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Tên thẻ việc từ [" + data.CardName + "] sang [" + obj.CardName + "]"
                    };
                    _context.CardUserActivities.Add(activity);

                    data.CardName = obj.CardName;
                    data.UpdatedBy = ESEIM.AppContext.UserName;
                    data.UpdatedTime = DateTime.Now;
                    _context.SaveChanges();
                    msg.Title = String.Format(_sharedResources["COM_MSG_UPDATE_SUCCESS"], _stringLocalizer[""]);//"Thay đổi thành công!";
                }
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                // msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_FAILED"), _stringLocalize[""));// "CÓ lỗi xảy ra!";
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateCardDescription([FromBody] DescriptionModel obj)
        {
            var msg = new JMessage() { Error = true };
            try
            {
                if (string.IsNullOrEmpty(obj.CardCode))
                {
                    return null;
                }
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(obj.CardCode));
                if (!string.IsNullOrEmpty(data.Description) && data.Description.Equals(obj.Description))
                {
                    return null;
                }
                //log content
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    Action = "UPDATE",
                    IdObject = "DESCRIPTION",
                    IsCheck = true,
                    CardCode = obj.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = !string.IsNullOrEmpty(data.Description) ? "Mô tả từ " + string.Concat(data.Description?.Take(20) ?? "") + "... sang " + string.Concat(obj.Description?.Take(20) ?? "") : "Mô tả thành " + string.Concat(obj.Description?.Take(20) ?? "") + "..."
                };
                _context.CardUserActivities.Add(activity);

                data.Description = obj.Description;
                data.UpdatedTime = DateTime.Now;
                data.UpdatedBy = ESEIM.AppContext.UserName;

                _context.SaveChanges();

                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"]; //"Cập nhật thành công";
                msg.Error = false;
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_FAILED"), _stringLocalize[""));// "Có lỗi xảy ra!"; 
                return Json(msg);
            }
        }

        [HttpPost]
        public JsonResult UpdateCardLabel([FromBody] WORKOSCard obj)
        {
            var msg = new JMessage() { Error = true };
            try
            {
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(obj.CardCode));
                data.Labels = obj.Labels;

                _context.SaveChanges();

                msg.Error = false;
                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];//"Cập nhật thành công"; 
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_FAILED"), _stringLocalize["")); // "Có lỗi xảy ra!"; 
                return Json(msg);
            }
        }

        [HttpPost]
        public JsonResult UpdateWeightNum([FromBody] WORKOSCard obj)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == obj.CardCode && x.IsDeleted == false);
                if (card != null)
                {
                    if (card.WeightNum != obj.WeightNum)
                    {
                        var getSumWeightNum = _context.WORKOSCards.Where(x => x.ListCode == card.ListCode && x.CardCode != obj.CardCode && x.IsDeleted == false).Sum(x => x.WeightNum);
                        if ((getSumWeightNum + obj.WeightNum) > 100)
                        {
                            msg.Error = true;
                            msg.Title = _stringLocalizer["CJ_MSG_MAXIMUM_WEIGHT"] + " " + (100 - getSumWeightNum) + " % !";
                        }
                        else
                        {
                            var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(obj.CardCode));
                            //log content
                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                Action = "UPDATE",
                                IdObject = "ITEMWORK",
                                IsCheck = true,
                                CardCode = obj.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = "Trọng số từ " + data.WeightNum + " sang " + Convert.ToDecimal(obj.WeightNum)
                            };
                            _context.CardUserActivities.Add(activity);

                            data.WeightNum = Convert.ToDecimal(obj.WeightNum);
                            data.UpdatedBy = ESEIM.AppContext.UserName;
                            data.UpdatedTime = DateTime.Now;
                            //_context.WORKOSCards.Load();
                            msg.Object = _cardService.UpdatePercentParentCard(card.CardCode);
                            _context.SaveChanges();
                            msg.Title = _sharedResources["COM_UPDATE_SUCCESS"]; //"Cập nhật thành công";
                        }
                    }
                }
                else
                {
                    msg.Error = true;
                    //msg.Title = "Thẻ không tồn tại!";
                    msg.Title = _stringLocalizer["CJ_MSG_CARD_NOT_EXISTS"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_SUCCESS"), _stringLocalize[""));//"Có lỗi xảy ra!";
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateCost([FromBody] WORKOSCard obj)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == obj.CardCode && x.IsDeleted == false);
                if (card != null)
                {
                    var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(obj.CardCode));
                    if (data.Cost != obj.Cost)
                    {
                        data.Cost = obj.Cost;
                        data.UpdatedTime = DateTime.Now;
                        data.UpdatedBy = ESEIM.AppContext.UserName;
                        //msg.Object = _cardService.UpdatePercentParentCard(card.CardCode);
                        _context.SaveChanges();
                        //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_SUCCESS"), _stringLocalize["")); //"Cập nhật thành công";
                        msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                    }
                }
                else
                {
                    msg.Error = true;
                    //msg.Title = "Thẻ không tồn tại!";
                    msg.Title = _stringLocalizer["CJ_MSG_CARD_NOT_EXISTS"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_SUCCESS"), _stringLocalize[""));//"Có lỗi xảy ra!";
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateCurrenCy([FromBody] WORKOSCard obj)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == obj.CardCode && x.IsDeleted == false);
                if (card != null)
                {
                    var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(obj.CardCode));
                    data.Currency = obj.Currency;
                    msg.Object = _cardService.UpdatePercentParentCard(card.CardCode);
                    _context.SaveChanges();
                    //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_SUCCESS"), _stringLocalize["")); //"Cập nhật thành công";
                    msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                }
                else
                {
                    msg.Error = true;
                    //msg.Title = "Thẻ không tồn tại!";
                    msg.Title = _stringLocalizer["CJ_MSG_CARD_NOT_EXISTS"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_SUCCESS"), _stringLocalize[""));//"Có lỗi xảy ra!";
            }
            return Json(msg);
        }

        [HttpGet]
        public JsonResult UpdateActivity(string CardCode, int Value, bool IsCheck)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var actionText = "";
                var userId = ESEIM.AppContext.UserId;
                if (Value == CardAction.Review.GetHashCode())
                {
                    actionText = EnumHelper<CardAction>.GetDisplayValue(CardAction.Review);
                }
                else if (Value == CardAction.Reject.GetHashCode())
                {
                    actionText = EnumHelper<CardAction>.GetDisplayValue(CardAction.Reject);
                }
                else if (Value == CardAction.Accept.GetHashCode())
                {
                    actionText = EnumHelper<CardAction>.GetDisplayValue(CardAction.Accept);
                }
                if (actionText == EnumHelper<CardAction>.GetDisplayValue(CardAction.Review))
                {
                    var existActivity = _context.CardUserActivities.FirstOrDefault(x => x.CardCode == CardCode && x.UserId == userId && x.Action == EnumHelper<CardAction>.GetDisplayValue(CardAction.Review));
                    if (existActivity != null)
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["CJ_MSG_YOU_WATCHED"];
                        return Json(msg);
                    }
                }
                if (IsCheck)
                {
                    var maxActionOther = _context.CardUserActivities.Where(x => x.UserId == userId && x.CardCode == CardCode && x.Action != EnumHelper<CardAction>.GetDisplayValue(CardAction.Review) && x.Action != actionText).MaxBy(x => x.CreatedTime);
                    if (maxActionOther != null)
                    {
                        maxActionOther.IsCheck = false;
                    }
                }
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    CardCode = CardCode,
                    Action = actionText,
                    IsCheck = IsCheck,
                    FromDevice = "Laptop/Desktop",
                    CreatedTime = DateTime.Now
                };
                _context.CardUserActivities.Add(activity);
                _context.SaveChanges();
                msg.Object = new
                {
                    Date = activity.CreatedTime.ToString("dd/MM/yyyy"),
                    Time = activity.CreatedTime.ToString("hh:mm:ss"),
                    TimeActivity = DateTime.Now
                };
                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [NonAction]
        public void RemoveUserReject(string cardCode, string userId)
        {
            var data = _context.JobCardAssignees.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode) && x.UserId.Equals(User));
            if (data != null)
            {
                data.IsDeleted = true;
                data.DeletedBy = ESEIM.AppContext.UserName;
                data.DeletedTime = DateTime.Now;
                _context.JobCardAssignees.Update(data);
            }

            var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.Status != "TRASH" && x.CardCode == cardCode);
            var jobCardAssignee = !string.IsNullOrEmpty(card.JsonAssign) ? JsonConvert.DeserializeObject<List<JobCardAssignee>>(card.JsonAssign) : new List<JobCardAssignee>();
            for (var i = 0; i < jobCardAssignee.Count(); i++)
            {
                if (jobCardAssignee[i].UserId == userId)
                {
                    jobCardAssignee.Remove(jobCardAssignee[i]);
                    break;
                }
            }
            card.JsonAssign = JsonConvert.SerializeObject(jobCardAssignee);
            var listUser = !string.IsNullOrEmpty(card.LstUser) ? card.LstUser.Split(",", StringSplitOptions.None) : new string[0];
            var lstUser = new List<string>(listUser);
            foreach (var item in listUser)
            {
                if (item == userId)
                {
                    lstUser.Remove(item);
                    break;
                }
            }
            card.LstUser = lstUser != null && lstUser.Any() ? string.Join(",", lstUser) : null;
        }

        [HttpPost]
        public JsonResult UpdateProgress([FromBody] WORKOSCard obj)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                if (obj.Progress < 100)
                {
                    var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == obj.CardCode);
                    if (data != null)
                    {
                        data.Progress = obj.Progress;
                        data.UpdatedTime = DateTime.Now;
                        data.UpdatedBy = ESEIM.AppContext.UserName;

                        var progressTracking = new ProgressTracking
                        {
                            CardCode = data.CardCode,
                            Progress = data.Progress,
                            UpdatedBy = ESEIM.AppContext.UserName,
                            UpdatedTime = DateTime.Now
                        };
                        _context.ProgressTrackings.Add(progressTracking);
                        _context.SaveChanges();
                        //msg.Title = "Cập nhập tiến độ thực tế thành công!";
                        msg.Title = String.Format(_sharedResources["COM_MSG_UPDATE_SUCCESS"], _stringLocalizer["CJ_MSG_REAL_PROGRESS"]);
                    }
                    else
                    {
                        //msg.Title = "Thẻ không tồn tại!";
                        msg.Title = _stringLocalizer["CJ_MSG_CARD_NOT_EXISTS"];
                        msg.Error = true;
                    }
                }
                else
                {
                    msg.Error = true;
                    //msg.Title = "Tiến độ đã vượt quá 100%";
                    msg.Title = _stringLocalizer["CJ_MSG_PROGRESS_OVER_HUNDRED_PRECENT"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                //msg.Title = "Có lỗi khi cập nhập tiến độ";
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateBeginTime(string CardCode, string BeginTime)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var beginTime = DateTime.ParseExact(BeginTime, "dd/MM/yyyy", CultureInfo.InvariantCulture);
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == CardCode);
                if (data != null)
                {
                    if (data.EndTime != null)
                    {
                        if (beginTime.Date > data.EndTime.Value.Date)
                        {
                            msg.Error = true;
                            //msg.Title = "Ngày bắt đầu nhỏ hơn hoặc bằng ngày kết thúc!";
                            msg.Title = _stringLocalizer["CJ_MSG_START_DATE_LESS_EQUAL_END_DATE"];
                            return Json(msg);
                        }
                    }
                }
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    Action = "UPDATE",
                    IdObject = "ITEMWORK",
                    IsCheck = true,
                    CardCode = CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = "Ngày bắt đầu từ " + data.BeginTime.ToString("dd/MM/yyyy") + " sang " + beginTime.ToString("dd/MM/yyyy")
                };
                _context.CardUserActivities.Add(activity);
                data.BeginTime = beginTime;
                _context.SaveChanges();
                //msg.Title = "Cập nhập thành công!";
                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                //msg.Title = "Có lỗi khi cập nhập";
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateEndTime(string CardCode, string EndTime)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var endTime = DateTime.ParseExact(EndTime, "dd/MM/yyyy", CultureInfo.InvariantCulture);
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == CardCode);
                if (data != null)
                {
                    if (endTime.Date < data.Deadline.Date)
                    {
                        msg.Error = true;
                        //msg.Title = "Ngày kết thúc lớn hơn hoặc bằng ngày bắt đầu!";
                        msg.Title = _stringLocalizer["CJ_MSG_END_DATE_GREATER_EQUAL_START_DATE"];
                        return Json(msg);
                    }
                }
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    Action = "UPDATE",
                    IdObject = "ITEMWORK",
                    IsCheck = true,
                    CardCode = CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = data.EndTime.HasValue ? "Ngày kết thúc từ " + data.EndTime.Value.ToString("dd/MM/yyyy") + " sang " + endTime.ToString("dd/MM/yyyy") : "Ngày kết thúc " + endTime.ToString("dd/MM/yyyy")
                };
                _context.CardUserActivities.Add(activity);
                data.EndTime = endTime;
                _context.SaveChanges();
                // msg.Title = "Cập nhập thành công!";
                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                //msg.Title = "Có lỗi khi cập nhập";
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateDeadLine(string CardCode, string DeadLine)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var deadLine = DateTime.ParseExact(DeadLine, "dd/MM/yyyy", CultureInfo.InvariantCulture);
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == CardCode);
                if (deadLine < data.BeginTime)
                {
                    msg.Error = true;
                    //msg.Title = "Ngày hết hạn không được nhỏ hơn ngày bắt đầu";
                    msg.Title = _stringLocalizer["CJ_MSG_DATE_EXPERIED_NOT_LESS_START_DATE"];
                }
                else
                {
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Ngày hết hạn từ " + data.Deadline.ToString("dd/MM/yyyy") + " sang " + deadLine.ToString("dd/MM/yyyy")
                    };
                    _context.CardUserActivities.Add(activity);
                    data.Deadline = deadLine;
                    _context.SaveChanges();
                    //msg.Title = "Cập nhập thành công!";
                    msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                //msg.Title = "Có lỗi khi cập nhập";
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateQuantitative(string CardCode, decimal Quantitative)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == CardCode);
                if (data.Quantitative != Quantitative)
                {
                    data.Quantitative = Quantitative;
                    _context.SaveChanges();
                    //msg.Title = "Cập nhập thành công!";
                    msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                //msg.Title = "Có lỗi khi cập nhập";
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateUnit(string CardCode, string Unit)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == CardCode);
                data.Unit = Unit;
                _context.SaveChanges();
                //msg.Title = "Cập nhập thành công!";
                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                //msg.Title = "Có lỗi khi cập nhập";
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult ChangeWorkType(string CardCode, string Type)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(CardCode));
                //log content
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    Action = "UPDATE",
                    IdObject = "ITEMWORK",
                    IsCheck = true,
                    CardCode = CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = "Kiểu công việc từ " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == data.WorkType && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == data.WorkType && !x.IsDeleted).ValueSet : "")
                    + " sang " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == Type && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == Type && !x.IsDeleted).ValueSet : "")
                };
                _context.CardUserActivities.Add(activity);

                data.WorkType = Type;
                _context.SaveChanges();

                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"]; ;// "Cập nhật thành công";
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_ERR"), _stringLocalize[""));// "Có lỗi xảy ra!";
                msg.Object = ex;
                return Json(msg);
            }
        }

        [HttpPost]
        public JsonResult ChangeListCard(string CardCode, string ListCode)
        {
            var msg = new JMessage() { Error = true };
            try
            {
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(CardCode));
                data.ListCode = ListCode;
                _context.SaveChanges();

                msg.Error = false;
                msg.Title = _stringLocalizer["CJ_CURD_MSG_CHANGE_LIST_CARD_SUCCESS"];//"Di chuyển thành công";
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                return Json(msg);
            }
        }

        [HttpPost]
        public JsonResult ChangeCardStatus(string CardCode, string Status)
        {
            var msg = new JMessage() { Error = true };
            try
            {
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(CardCode));
                if (data.Completed < 100 && Status == "DONE")
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_CARD_NOT_SUCCESS"];
                }
                else
                {
                    if (!data.Status.Equals(Status))
                    {
                        //log content
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "UPDATE",
                            IdObject = "ITEMWORK",
                            IsCheck = true,
                            CardCode = CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = "Trạng thái từ " + _context.CommonSettings.FirstOrDefault(x => x.CodeSet == data.Status && !x.IsDeleted).ValueSet
                            + " sang " + _context.CommonSettings.FirstOrDefault(x => x.CodeSet == Status && !x.IsDeleted).ValueSet
                        };
                        _context.CardUserActivities.Add(activity);

                        var lstJsonStatus = new List<JsonStatusCard>();
                        if (!string.IsNullOrEmpty(data.JsonStatusLog))
                        {
                            lstJsonStatus = JsonConvert.DeserializeObject<List<JsonStatusCard>>(data.JsonStatusLog);
                        }

                        var jsonStatus = new JsonStatusCard
                        {
                            Status = Status,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            Lock = false
                        };
                        lstJsonStatus.Add(jsonStatus);

                        data.JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus);

                        data.Status = Status;
                        _context.SaveChanges();
                        msg.Error = false;
                        msg.Title = String.Format(_sharedResources["COM_MSG_UPDATE_SUCCESS"], _stringLocalizer["CJ_COL_STATUS"]);
                    }
                    else if (data.Status == "TRASH" && Status == "TRASH")
                    {
                        if (ESEIM.AppContext.UserName.Equals("admin") || data.CreatedBy.Equals(ESEIM.AppContext.UserName))
                        {
                            data.IsDeleted = true;
                            var listJcObj = _context.JcObjectIdRelatives.Where(x => x.CardCode == data.CardCode && !x.IsDeleted);
                            foreach (var itemJcObj in listJcObj)
                            {
                                itemJcObj.IsDeleted = true;
                                _context.JcObjectIdRelatives.Update(itemJcObj);
                            }
                            var assign = _context.JobCardAssignees.Where(x => !x.IsDeleted && x.CardCode.Equals(data.CardCode));
                            foreach (var item in assign)
                            {
                                item.IsDeleted = true;
                                item.DeletedBy = ESEIM.AppContext.UserName;
                                item.DeletedTime = DateTime.Now;
                                _context.JobCardAssignees.Update(item);
                            }
                            _context.SaveChanges();
                            msg.Error = false;
                            msg.Title = "Xóa thẻ việc thành công";
                        }
                        else
                        {
                            msg.Error = true;
                            msg.Title = "Bạn không có quyền xóa thẻ việc này";
                        }
                    }
                    else
                    {
                        msg.Error = false;
                        msg.Title = String.Format(_sharedResources["COM_MSG_UPDATE_SUCCESS"], _stringLocalizer["CJ_COL_STATUS"]);
                    }
                }

                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Title = _sharedResources["COM_MSG_ERR"];
                msg.Object = ex;
                return Json(msg);
            }
        }

        [HttpPost]
        public JsonResult ChangeCardLevel(string CardCode, string Level)
        {
            var msg = new JMessage() { Error = true };
            try
            {
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(CardCode));
                //log content
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    Action = "UPDATE",
                    IdObject = "ITEMWORK",
                    IsCheck = true,
                    CardCode = CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = "Độ ưu tiên từ " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == data.CardLevel && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == data.CardLevel && !x.IsDeleted).ValueSet : "")
                    + " sang " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == Level && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == Level && !x.IsDeleted).ValueSet : "")
                };
                _context.CardUserActivities.Add(activity);

                data.CardLevel = Level;
                _context.SaveChanges();

                msg.Error = false;
                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_SUCCESS"), _stringLocalize[""));//"Cập nhật cấp độ thành công";
                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                return Json(msg);
            }
            catch (Exception ex)
            {
                //msg.Title = String.Format(_stringLocalize["CJ_CURD_MSG_ERROR"));// //"Có lỗi xảy ra!";
                msg.Title = _sharedResources["COM_MSG_ERR"];
                msg.Object = ex;
                return Json(msg);
            }
        }

        [HttpPost]
        public JsonResult UpdateCardByBufferData([FromBody] BufferData buffer)
        {
            var timeEnd = DateTime.Now;
            //Update card base
            var msg = new JMessage();
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == buffer.CardJob.CardCode && !x.IsDeleted);
                var list = _context.WORKOSLists.FirstOrDefault(x => x.ListCode == card.ListCode);
                var board = _context.WORKOSBoards.FirstOrDefault(x => x.BoardCode == list.BoardCode);
                if (card != null)
                {
                    //Inherit
                    if (buffer.CardJob.Inherit != card.Inherit && !string.IsNullOrEmpty(buffer.CardJob.Inherit))
                        ChangeInheritInBuffer(card, buffer.CardJob.Inherit);

                    //Update card base
                    if (string.IsNullOrEmpty(buffer.CardJob.BeginTime))
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["CJ_MSG_PLS_ENTER_START_DATE"];
                        return Json(msg);
                    }
                    if (string.IsNullOrEmpty(buffer.CardJob.Deadline))
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["CJ_MSG_PLS_ENTER_END_DATE"];
                        return Json(msg);
                    }

                    var getSumWeightNum = _context.WORKOSCards.Where(x => x.ListCode == card.ListCode && x.CardCode != card.CardCode && x.IsDeleted == false).Sum(x => x.WeightNum);
                    if ((getSumWeightNum + Decimal.Parse(buffer.CardJob.WeightNum)) > 100)
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["CJ_MSG_MAXIMUM_WEIGHT"] + " " + (100 - getSumWeightNum) + " % !";
                        return Json(msg);
                    }
                    var beginTime = !string.IsNullOrEmpty(buffer.CardJob.BeginTime) ? DateTime.ParseExact(buffer.CardJob.BeginTime, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
                    var deadLine = !string.IsNullOrEmpty(buffer.CardJob.Deadline) ? DateTime.ParseExact(buffer.CardJob.Deadline, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
                    var endTime = !string.IsNullOrEmpty(buffer.CardJob.EndTime) ? DateTime.ParseExact(buffer.CardJob.EndTime, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
                    //Log
                    if (card.BeginTime != beginTime)
                    {
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "UPDATE",
                            IdObject = "ITEMWORK",
                            IsCheck = true,
                            CardCode = card.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = "Ngày bắt đầu từ " + card.BeginTime != null ? card.BeginTime.ToString("dd/MM/yyyy") : "trống" + " sang " + beginTime != null ? beginTime.Value.ToString("dd/MM/yyyy") : "trống"
                        };
                        _context.CardUserActivities.Add(activity);
                    }
                    if (card.CardName != buffer.CardJob.CardName)
                    {
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "UPDATE",
                            IdObject = "ITEMWORK",
                            IsCheck = true,
                            CardCode = card.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = "Tên thẻ việc từ [" + card.CardName + "] sang [" + buffer.CardJob.CardName + "]"
                        };
                        _context.CardUserActivities.Add(activity);
                    }
                    if (card.Deadline != deadLine)
                    {
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "UPDATE",
                            IdObject = "ITEMWORK",
                            IsCheck = true,
                            CardCode = card.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = "Ngày hết hạn từ " + card.Deadline != null ? card.Deadline.ToString("dd/MM/yyyy") : "trống" + " sang " + deadLine != null ? deadLine.Value.ToString("dd/MM/yyyy") : "trống"
                        };
                        _context.CardUserActivities.Add(activity);
                    }
                    if (card.EndTime != endTime)
                    {
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "UPDATE",
                            IdObject = "ITEMWORK",
                            IsCheck = true,
                            CardCode = card.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = card.EndTime.HasValue ? "Ngày kết thúc từ " + card.EndTime.Value.ToString("dd/MM/yyyy") + " sang " + (endTime.HasValue ? endTime.Value.ToString("dd/MM/yyyy") : "trống") : "Ngày kết thúc " + (endTime.HasValue ? endTime.Value.ToString("dd/MM/yyyy") : "trống")
                        };
                        _context.CardUserActivities.Add(activity);
                    }
                    if (card.Description != buffer.CardJob.Description)
                    {
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "UPDATE",
                            IdObject = "DESCRIPTION",
                            IsCheck = true,
                            CardCode = card.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = !string.IsNullOrEmpty(card.Description) ? "Mô tả từ " + string.Concat(card.Description?.Take(20) ?? "") + "... sang " + string.Concat(buffer.CardJob.Description?.Take(20) ?? "") : "Thêm mới mô tả " + string.Concat(buffer.CardJob.Description?.Take(20) ?? "") + "..."
                        };
                        _context.CardUserActivities.Add(activity);
                    }
                    if (card.WorkType != buffer.CardJob.WorkType)
                    {
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "UPDATE",
                            IdObject = "ITEMWORK",
                            IsCheck = true,
                            CardCode = card.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = !string.IsNullOrEmpty(card.WorkType) ? "Kiểu công việc từ " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == card.WorkType && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == card.WorkType && !x.IsDeleted).ValueSet : "")
                    + " sang " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == buffer.CardJob.WorkType && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == buffer.CardJob.WorkType && !x.IsDeleted).ValueSet : "") : "Thêm mới kiểu công việc " + _context.CommonSettings.FirstOrDefault(x => x.CodeSet == buffer.CardJob.WorkType && !x.IsDeleted).ValueSet
                        };
                        _context.CardUserActivities.Add(activity);
                    }
                    if (card.CardLevel != buffer.CardJob.CardLevel)
                    {
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "UPDATE",
                            IdObject = "ITEMWORK",
                            IsCheck = true,
                            CardCode = card.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = !(string.IsNullOrEmpty(card.CardLevel)) ? "Độ ưu tiên từ " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == card.CardLevel && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == card.CardLevel && !x.IsDeleted).ValueSet : "")
                    + " sang " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == buffer.CardJob.CardLevel && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == buffer.CardJob.CardLevel && !x.IsDeleted).ValueSet : "") : "Thêm mới độ ưu tiên " + _context.CommonSettings.FirstOrDefault(x => x.CodeSet == buffer.CardJob.CardLevel && !x.IsDeleted).ValueSet
                        };
                        _context.CardUserActivities.Add(activity);
                    }
                    if (card.WeightNum != Decimal.Parse(buffer.CardJob.WeightNum))
                    {
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "UPDATE",
                            IdObject = "ITEMWORK",
                            IsCheck = true,
                            CardCode = card.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = "Trọng số từ " + card.WeightNum + " sang " + Convert.ToDecimal(buffer.CardJob.WeightNum)
                        };
                        _context.CardUserActivities.Add(activity);
                    }
                    if (card.Status != buffer.CardJob.Status)
                    {
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "UPDATE",
                            IdObject = "ITEMWORK",
                            IsCheck = true,
                            CardCode = card.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = "Trạng thái từ " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == card.Status && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == card.Status && !x.IsDeleted).ValueSet : "")
                            + " sang " + _context.CommonSettings.FirstOrDefault(x => x.CodeSet == buffer.CardJob.Status && !x.IsDeleted).ValueSet
                        };
                        _context.CardUserActivities.Add(activity);

                        var lstJsonStatus = new List<JsonStatusCard>();
                        if (!string.IsNullOrEmpty(card.JsonStatusLog))
                        {
                            lstJsonStatus = JsonConvert.DeserializeObject<List<JsonStatusCard>>(card.JsonStatusLog);
                        }

                        var jsonStatus = new JsonStatusCard
                        {
                            Status = buffer.CardJob.Status,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            Lock = false
                        };
                        lstJsonStatus.Add(jsonStatus);
                        card.JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus);
                    }

                    card.CardName = buffer.CardJob.CardName;
                    card.BeginTime = beginTime.Value;
                    card.Deadline = deadLine.Value;
                    card.EndTime = endTime;
                    card.Description = buffer.CardJob.Description;
                    card.WorkType = buffer.CardJob.WorkType;
                    card.Status = buffer.CardJob.Status;
                    card.WeightNum = Decimal.Parse(buffer.CardJob.WeightNum);
                    card.CardLevel = buffer.CardJob.CardLevel;
                    card.Inherit = buffer.CardJob.Inherit;
                    card.Completed = buffer.CardJob.Completed;
                    card.UpdatedTime = DateTime.Now;
                    card.UpdatedBy = ESEIM.AppContext.UserName;
                    card.ListCode = buffer.CardJob.ListCode;
                    card.Cost = buffer.CardJob.Cost;
                    card.Currency = buffer.CardJob.Currency;

                    // Update đối tượng liên quan
                    if (buffer.JcRelative.ListDelRelative.Count > 0)
                    {
                        foreach (var item in buffer.JcRelative.ListDelRelative)
                        {
                            int idDeleted = !string.IsNullOrEmpty(item) ? Convert.ToInt32(item) : 0;
                            if (idDeleted > 0)
                            {
                                var currentData = _context.JcObjectIdRelatives.FirstOrDefault(x => x.ID == idDeleted);
                                if (currentData != null)
                                {
                                    currentData.IsDeleted = true;
                                    currentData.DeletedBy = ESEIM.AppContext.UserName;
                                    currentData.DeletedTime = DateTime.Now;
                                    _context.JcObjectIdRelatives.Update(currentData);
                                }
                            }
                        }
                    }
                    if (buffer.JcRelative.ListRelative.Count > 0)
                    {
                        foreach (var item in buffer.JcRelative.ListRelative)
                        {
                            if (item.ID < 0)
                            {
                                var objRelative = new JcObjectIdRelative();
                                decimal weight = !string.IsNullOrEmpty(item.Weight) ? Convert.ToDecimal(item.Weight) : 0;
                                objRelative.Weight = weight;
                                objRelative.CardCode = card.CardCode;
                                objRelative.ObjTypeCode = item.ObjTypeCode;
                                objRelative.ObjID = item.ObjID;
                                objRelative.Relative = item.RelativeCode;
                                objRelative.CreatedBy = ESEIM.AppContext.UserName;
                                objRelative.CreatedTime = DateTime.Now;
                                _context.JcObjectIdRelatives.Add(objRelative);

                                //if (objRelative.ObjTypeCode == "PROJECT")
                                //{
                                //    var objCardMap = new CardMapping();
                                //    objCardMap.ListCode = card.ListCode;
                                //    objCardMap.BoardCode = list.BoardCode;
                                //    objCardMap.ProjectCode = objRelative.ObjID;
                                //    objCardMap.CardCode = card.CardCode;
                                //    objCardMap.CreatedBy = ESEIM.AppContext.UserName;
                                //    objCardMap.CreatedTime = DateTime.Now;
                                //    _context.CardMappings.Add(objCardMap);
                                //};
                                //if (objRelative.ObjTypeCode == "CONTRACT")
                                //{
                                //    var objCardMap = new CardMapping();
                                //    objCardMap.ListCode = list.ListCode;
                                //    objCardMap.BoardCode = list.BoardCode;
                                //    objCardMap.ContractCode = objRelative.ObjID;
                                //    objCardMap.CardCode = card.CardCode;
                                //    objCardMap.CreatedBy = ESEIM.AppContext.UserName;
                                //    objCardMap.CreatedTime = DateTime.Now;
                                //    _context.CardMappings.Add(objCardMap);
                                //};
                            }
                        }
                    }

                    //Update cardlink
                    if (buffer.CardLink.ListCardLinkDel.Count > 0)
                    {
                        foreach (var item in buffer.CardLink.ListCardLinkDel)
                        {
                            var data = _context.JobCardLinks.FirstOrDefault(x => !x.IsDeleted && x.Id == item);
                            if (data != null)
                            {
                                data.IsDeleted = true;
                                data.DeletedBy = ESEIM.AppContext.UserName;
                                data.DeletedTime = DateTime.Now;
                                _context.JobCardLinks.Update(data);

                                var activity = new CardUserActivity
                                {
                                    UserId = ESEIM.AppContext.UserId,
                                    Action = "DELETE",
                                    IdObject = "CARDLINK",
                                    IsCheck = true,
                                    CardCode = data.CardCode,
                                    CreatedTime = DateTime.Now,
                                    FromDevice = "Laptop/Desktop",
                                    ChangeDetails = "Thẻ việc liên kết " + _context.WORKOSCards.FirstOrDefault(x => x.CardCode == data.CardLink).CardName
                                };
                                _context.CardUserActivities.Add(activity);
                            }
                        }
                    }
                    if (buffer.CardLink.ListCardLink.Count > 0)
                    {
                        foreach (var item in buffer.CardLink.ListCardLink)
                        {
                            var data = _context.JobCardLinks.FirstOrDefault(x => !x.IsDeleted && x.CardCode == card.CardCode && x.CardLink == item.Code);
                            if (data == null)
                            {
                                var link = new JobCardLink
                                {
                                    CardCode = card.CardCode,
                                    CardLink = item.Code,
                                    CreatedBy = ESEIM.AppContext.UserName,
                                    CreatedTime = DateTime.Now
                                };
                                _context.JobCardLinks.Add(link);

                                var activity = new CardUserActivity
                                {
                                    UserId = ESEIM.AppContext.UserId,
                                    Action = "ADD",
                                    IdObject = "CARDLINK",
                                    IsCheck = true,
                                    CardCode = card.CardCode,
                                    CreatedTime = DateTime.Now,
                                    FromDevice = "Laptop/Desktop",
                                    ChangeDetails = "Thẻ việc liên kết " + _context.WORKOSCards.FirstOrDefault(x => x.CardCode == link.CardLink).CardName
                                };
                                _context.CardUserActivities.Add(activity);
                            }
                        }
                    }

                    //Update Product
                    if (buffer.ProductBuffer.ListProduct.Count > 0)
                    {
                        foreach (var item in buffer.ProductBuffer.ListProduct)
                        {
                            var checkProduct = _context.JcProducts.FirstOrDefault(x => x.CardCode == card.CardCode && x.ProductCode == item.ProductCode && !x.IsDeleted);
                            if (checkProduct != null)
                            {
                                checkProduct.Quantity = item.Quantity;
                                checkProduct.UpdatedBy = ESEIM.AppContext.UserName;
                                checkProduct.UpdatedTime = DateTime.Now;
                                _context.JcProducts.Update(checkProduct);
                            }
                            else
                            {
                                var product = new JcProduct
                                {
                                    ProductCode = item.ProductCode,
                                    Quantity = item.Quantity,
                                    JcAct = item.JcAct,
                                    CardCode = card.CardCode,
                                    CreatedBy = item.CreatedBy,
                                    CreatedTime = DateTime.Now
                                };
                                _context.JcProducts.Add(product);
                                //Log
                                var activity = new CardUserActivity
                                {
                                    UserId = ESEIM.AppContext.UserId,
                                    IdObject = "PROD",
                                    Action = "ADD",
                                    IsCheck = true,
                                    CardCode = product.CardCode,
                                    CreatedTime = DateTime.Now,
                                    FromDevice = "Laptop/Desktop",
                                    ChangeDetails = _context.MaterialProducts.FirstOrDefault(x => x.ProductCode == product.ProductCode).ProductName
                                };
                                _context.CardUserActivities.Add(activity);
                            }
                        }
                    }
                    if (buffer.ProductBuffer.ListDelProduct.Count > 0)
                    {
                        foreach (var item in buffer.ProductBuffer.ListDelProduct)
                        {
                            var cardProduct = _context.JcProducts.FirstOrDefault(x => x.ID == item);
                            if (cardProduct != null)
                            {
                                cardProduct.IsDeleted = true;
                                cardProduct.DeletedBy = ESEIM.AppContext.UserName;
                                cardProduct.DeletedTime = DateTime.Now;
                                _context.JcProducts.Update(cardProduct);

                                //Log
                                var activity = new CardUserActivity
                                {
                                    UserId = ESEIM.AppContext.UserId,
                                    IdObject = "PROD",
                                    Action = "DELETE",
                                    IsCheck = true,
                                    CardCode = card.CardCode,
                                    CreatedTime = DateTime.Now,
                                    FromDevice = "Laptop/Desktop",
                                    ChangeDetails = _context.MaterialProducts.FirstOrDefault(x => x.ProductCode == cardProduct.ProductCode).ProductName
                                };
                                _context.CardUserActivities.Add(activity);
                            }
                        }
                    }

                    //Update service
                    if (buffer.ServiceBuffer.ListService.Count > 0)
                    {
                        foreach (var item in buffer.ServiceBuffer.ListService)
                        {
                            var checkSer = _context.JcServices.FirstOrDefault(x => x.CardCode == card.CardCode && x.ServiceCode == item.ServiceCode && !x.IsDeleted);
                            if (checkSer != null)
                            {
                                checkSer.Quantity = item.Quantity;
                                checkSer.UpdatedBy = ESEIM.AppContext.UserName;
                                checkSer.UpdatedTime = DateTime.Now;
                                _context.JcServices.Update(checkSer);
                            }
                            else
                            {
                                var ser = new JcService
                                {
                                    CardCode = card.CardCode,
                                    ServiceCode = item.ServiceCode,
                                    Quantity = item.Quantity,
                                    JcAct = item.JcAct,
                                    CreatedBy = ESEIM.AppContext.UserName,
                                    CreatedTime = DateTime.Now
                                };
                                _context.JcServices.Add(ser);

                                //Log
                                var activity = new CardUserActivity
                                {
                                    UserId = ESEIM.AppContext.UserId,
                                    IdObject = "SER",
                                    Action = "ADD",
                                    IsCheck = true,
                                    CardCode = ser.CardCode,
                                    CreatedTime = DateTime.Now,
                                    FromDevice = "Laptop/Desktop",
                                    ChangeDetails = _context.ServiceCategorys.FirstOrDefault(x => !x.IsDeleted && x.ServiceCode == ser.ServiceCode).ServiceName
                                };
                                _context.CardUserActivities.Add(activity);
                            }
                        }
                    }
                    if (buffer.ServiceBuffer.ListDelService.Count > 0)
                    {
                        foreach (var item in buffer.ServiceBuffer.ListDelService)
                        {
                            var cardService = _context.JcServices.FirstOrDefault(x => x.ID == item);
                            if (cardService != null)
                            {
                                cardService.IsDeleted = true;
                                cardService.DeletedBy = ESEIM.AppContext.UserName;
                                cardService.DeletedTime = DateTime.Now;
                                _context.JcServices.Update(cardService);

                                var activity = new CardUserActivity
                                {
                                    UserId = ESEIM.AppContext.UserId,
                                    IdObject = "SER",
                                    Action = "DELETE",
                                    IsCheck = true,
                                    CardCode = cardService.CardCode,
                                    CreatedTime = DateTime.Now,
                                    FromDevice = "Laptop/Desktop",
                                    ChangeDetails = _context.ServiceCategorys.FirstOrDefault(x => !x.IsDeleted && x.ServiceCode == cardService.ServiceCode).ServiceName
                                };
                                _context.CardUserActivities.Add(activity);
                            }
                        }
                    }

                    //Update address
                    if (buffer.AddressBuffer.ListAddress.Count > 0)
                    {
                        foreach (var item in buffer.AddressBuffer.ListAddress)
                        {
                            if (item.Id < 0)
                            {
                                var address = new WORKOSAddressCard
                                {
                                    CardCode = card.CardCode,
                                    LocationGps = item.LocationGps,
                                    LocationText = item.LocationText,
                                    CreatedBy = item.CreatedBy,
                                    CreatedTime = DateTime.Now
                                };
                                _context.WORKOSAddressCards.Add(address);

                                var activity = new CardUserActivity
                                {
                                    UserId = ESEIM.AppContext.UserId,
                                    IdObject = "ADDR",
                                    Action = "ADD",
                                    IsCheck = true,
                                    CardCode = card.CardCode,
                                    CreatedTime = DateTime.Now,
                                    FromDevice = "Laptop/Desktop",
                                    ChangeDetails = address.LocationText
                                };
                                _context.CardUserActivities.Add(activity);
                            }
                        }
                    }
                    if (buffer.AddressBuffer.ListDelAddress.Count > 0)
                    {
                        foreach (var item in buffer.AddressBuffer.ListDelAddress)
                        {
                            var address = _context.WORKOSAddressCards.FirstOrDefault(x => x.Id == item && !x.IsDeleted);
                            if (address != null)
                            {
                                address.IsDeleted = true;
                                address.DeletedBy = ESEIM.AppContext.UserName;
                                address.DeletedTime = DateTime.Now;
                                _context.WORKOSAddressCards.Update(address);

                                var activity = new CardUserActivity
                                {
                                    UserId = ESEIM.AppContext.UserId,
                                    IdObject = "ADDR",
                                    Action = "DELETE",
                                    IsCheck = true,
                                    CardCode = card.CardCode,
                                    CreatedTime = DateTime.Now,
                                    FromDevice = "Laptop/Desktop",
                                    ChangeDetails = address.LocationText
                                };
                                _context.CardUserActivities.Add(activity);
                            }
                        }
                    }

                    //Update log activity accept, reject
                    //var logs = _context.CardUserActivities.Where(x => x.CardCode == card.CardCode && x.UserId == ESEIM.AppContext.UserId
                    //&& x.CreatedTime >= buffer.TimeSpanActivity.TimeStart && x.CreatedTime <= timeEnd && x.Action != "REVIEW"
                    //).OrderByDescending(x => x.CreatedTime).ToList();
                    //if (logs.Any())
                    //{
                    //    for (int i = 1; i < logs.Count(); i++)
                    //    {
                    //        _context.CardUserActivities.Remove(logs[i]);
                    //    }
                    //}
                    msg.Object = _cardService.UpdatePercentParentCard(card.CardCode);
                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_MSG_SUCCES_SAVE"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult RollbackDataBuffer([FromBody] ItemWorkCheck dataBuffer)
        {
            if (dataBuffer != null)
            {
                var cardCode = "";
                if (dataBuffer.ItemCheck.Any())
                {
                    cardCode = dataBuffer.ItemCheck[0].CardCode;
                }
                var msg = new JMessage();
                try
                {
                    //Clear data item check
                    var data = _context.CardItemChecks.Where(x => !x.Flag && x.CardCode == cardCode)
                      .Select(x => new
                      {
                          x.Id,
                          x.ChkListCode,
                          x.CheckTitle,
                          x.Completed,
                          x.WeightNum,
                          checkItem = false,
                          TitleSubItemChk = "",
                          ListUserItemChk = (from a in _context.WorkItemAssignStaffs
                                             join b in _context.Users on a.UserId equals b.Id
                                             where a.CheckListCode == x.ChkListCode && a.IsDeleted == false && (a.CheckItem == "")
                                             select new
                                             {
                                                 a.ID,
                                             }),
                          ListSubItem = _context.CardSubitemChecks.Where(y => y.ChkListCode == x.ChkListCode && y.Flag == false).Select(y => new
                          {
                              y.Id,
                              y.Title,
                              y.Approve,
                              y.ApprovedTime,
                              y.Completed,
                              y.Approver,
                              y.WeightNum,
                              ListUserSubItem = (from a in _context.WorkItemAssignStaffs
                                                 join b in _context.Users on a.UserId equals b.Id
                                                 where a.CheckItem == y.Id.ToString() && a.IsDeleted == false
                                                 select new
                                                 {
                                                     a.ID,
                                                 }),
                          }),
                      }).ToList();
                    var list = (from a in _context.SessionWorkResults
                                join b in _context.ShiftLogs on a.ShiftCode equals b.ShiftCode
                                where !a.IsDeleted && a.CardCode.Equals(cardCode)
                                select new ViewItem
                                {
                                    Id = a.Id,
                                    WorkSession = a.WorkSession,
                                    ItemWorkList = _context.SessionWorks.Where(x => !x.IsDeleted && x.Session == a.WorkSession).ToList(),
                                    Note = a.Note,
                                    Status = "",
                                    Progress = a.Progress,
                                    UserName = _context.Users.FirstOrDefault(x => x.UserName.Equals(a.CreatedBy)).GivenName,
                                    CheckItem = false,
                                    TimeCheckIn = b.ChkinTime.Value,
                                    Value = "",
                                    listItemActivity = (from c in _context.SessionWorkResults
                                                        join d in _context.SessionWorks on c.WorkSession equals d.Session
                                                        join e in _context.CardItemChecks on d.Item equals e.ChkListCode
                                                        where c.WorkSession.Equals(a.WorkSession) && !c.IsDeleted
                                                        select new WorkSessionResultTemp
                                                        {
                                                            Id = c.Id,
                                                            StartTime = c.StartTime,
                                                            EndTime = c.EndTime,
                                                            ProgressFromLeader = c.ProgressFromLeader,
                                                            ProgressFromStaff = c.ProgressFromStaff,
                                                            CheckTitle = e.CheckTitle
                                                        }).DistinctBy(x => x.Id).ToList(),
                                }).ToList();
                    foreach (var item in list)
                    {
                        string value = "";
                        foreach (var i in item.ItemWorkList)
                        {
                            var CheckTitle = _context.CardItemChecks.FirstOrDefault(x => !x.Flag && x.ChkListCode == i.Item);
                            if (CheckTitle != null)
                            {
                                value += CheckTitle.CheckTitle + ", ";
                            }
                        }
                        item.Value = value;
                    }
                    if (data.Any())
                    {
                        foreach (var item in data)
                        {
                            if (item.ListUserItemChk.Any())
                            {
                                foreach (var user in item.ListUserItemChk)
                                {
                                    var staff = _context.WorkItemAssignStaffs.FirstOrDefault(x => x.ID == user.ID);
                                    if (staff != null)
                                        _context.WorkItemAssignStaffs.Remove(staff);
                                }
                            }
                            if (item.ListSubItem.Any())
                            {
                                foreach (var subItem in item.ListSubItem)
                                {
                                    if (subItem.ListUserSubItem != null && subItem.ListUserSubItem.Any())
                                    {
                                        foreach (var id in subItem.ListUserSubItem)
                                        {
                                            var staff = _context.WorkItemAssignStaffs.FirstOrDefault(x => x.ID == id.ID);
                                            if (staff != null)
                                                _context.WorkItemAssignStaffs.Remove(staff);
                                        }

                                    }
                                }
                                var subs = _context.CardSubitemChecks.Where(y => y.ChkListCode == item.ChkListCode && y.Flag == false);
                                foreach (var sub in subs)
                                {
                                    sub.Flag = true;
                                }
                                _context.CardSubitemChecks.UpdateRange(subs);
                            }
                        }
                        var itemChecks = _context.CardItemChecks.Where(x => x.CardCode == cardCode && !x.Flag);
                        _context.CardItemChecks.RemoveRange(itemChecks);
                    }
                    //Roll back item work
                    if (dataBuffer.ItemCheck.Any())
                    {
                        foreach (var item in dataBuffer.ItemCheck)
                        {
                            var itemCheck = new CardItemCheck()
                            {
                                CardCode = cardCode,
                                CheckTitle = item.CheckTitle,
                                WeightNum = item.WeightNum,
                                ChkListCode = item.ChkListCode,
                                CreatedBy = item.CreatedBy,
                                CreatedTime = item.CreatedTime,
                                Completed = item.Completed,
                                Constraint = item.Constraint
                            };
                            _context.CardItemChecks.Add(itemCheck);

                            if (item.ListUserItemChk.Any())
                            {
                                foreach (var itemU in item.ListUserItemChk)
                                {
                                    var jobCardUser = new WorkItemAssignStaff
                                    {
                                        CardCode = cardCode,
                                        UserId = itemU.UserId,
                                        CheckItem = "",
                                        CheckListCode = item.ChkListCode,
                                        CreatedBy = itemU.CreatedBy,
                                        CreatedTime = itemU.CreatedTime,
                                        EstimateTime = itemU.EstimateTime.ToString(),
                                        Unit = itemU.Unit
                                    };
                                    _context.WorkItemAssignStaffs.Add(jobCardUser);
                                }
                            }
                            if (item.ListSubItem.Any())
                            {
                                foreach (var sI in item.ListSubItem)
                                {
                                    var subItem = new CardSubitemCheck()
                                    {
                                        ChkListCode = item.ChkListCode,
                                        Title = sI.Title,
                                        Approver = sI.Approver,
                                        Approve = sI.Approve,
                                        ApprovedTime = sI.ApprovedTime,
                                        Completed = sI.Completed,
                                        WeightNum = sI.WeightNum,
                                    };
                                    _context.CardSubitemChecks.Add(subItem);

                                    var lastSub = _context.CardSubitemChecks.MaxBy(x => x.Id);
                                    var id = lastSub != null ? lastSub.Id : 0;
                                    if (sI.ListUserSubItem != null)
                                    {
                                        foreach (var itemU in sI.ListUserSubItem)
                                        {
                                            id++;
                                            var jobCardUser = new WorkItemAssignStaff
                                            {
                                                CardCode = cardCode,
                                                UserId = itemU.UserId,
                                                CheckItem = id.ToString(),
                                                CheckListCode = item.ChkListCode,
                                                CreatedBy = itemU.CreatedBy,
                                                CreatedTime = itemU.CreatedTime,
                                                EstimateTime = itemU.EstimateTime.ToString(),
                                                Unit = itemU.Unit
                                            };
                                            _context.WorkItemAssignStaffs.Add(jobCardUser);
                                        }
                                    }
                                }
                            }
                        }
                    }
                    //Roll back Completed
                    var workOSCard = _context.WORKOSCards.SingleOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
                    if (workOSCard != null)
                    {
                        workOSCard.Completed = dataBuffer.CompleteOld + 0.00M;
                    }

                    //Update log activity accept, reject
                    var timeEnd = DateTime.Now;
                    var logs = _context.CardUserActivities.Where(x => x.CardCode == cardCode && x.UserId == ESEIM.AppContext.UserId
                    && x.CreatedTime >= dataBuffer.TimeSpanActivity.TimeStart && x.CreatedTime <= timeEnd && x.Action != "REVIEW"
                    ).OrderByDescending(x => x.CreatedTime).ToList();
                    if (logs.Any())
                    {
                        for (int i = 0; i < logs.Count(); i++)
                        {
                            _context.CardUserActivities.Remove(logs[i]);
                        }
                    }
                    _context.SaveChanges();
                }
                catch (Exception ex)
                {
                    msg.Error = true;
                    msg.Title = _sharedResources["COM_MSG_ERR"];
                }
                return Json(msg);
            }
            else
            {
                return Json("");
            }

        }

        [NonAction]
        public void ChangeInheritInBuffer(WORKOSCard data, string inherit)
        {
            var oldInherit = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == data.Inherit);
            if (string.IsNullOrEmpty(data.Inherit) || oldInherit.IsDeleted)
            {
                //log content
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    Action = "UPDATE",
                    IdObject = "ITEMWORK",
                    IsCheck = true,
                    CardCode = data.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = "Chọn việc kế thừa " + (_context.WORKOSCards.FirstOrDefault(x => x.CardCode == inherit && !x.IsDeleted) != null ? _context.WORKOSCards.FirstOrDefault(x => x.CardCode == inherit && !x.IsDeleted).CardName : "")
                };
                _context.CardUserActivities.Add(activity);
            }
            else
            {
                //log content
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    Action = "UPDATE",
                    IdObject = "ITEMWORK",
                    IsCheck = true,
                    CardCode = data.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = "Việc kế thừa từ " + (_context.WORKOSCards.FirstOrDefault(x => x.CardCode == data.CardCode && !x.IsDeleted) != null ? _context.WORKOSCards.FirstOrDefault(x => x.CardCode == data.Inherit && !x.IsDeleted).CardName : "")
                    + " sang " + (_context.WORKOSCards.FirstOrDefault(x => x.CardCode == inherit && !x.IsDeleted) != null ? _context.WORKOSCards.FirstOrDefault(x => x.CardCode == inherit && !x.IsDeleted).CardName : "")
                };
                _context.CardUserActivities.Add(activity);
            }
            data.Inherit = inherit;
            var cardInherit = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == inherit && !x.IsDeleted);
            var listAttach = _context.CardAttachments.Where(x => x.CardCode == cardInherit.CardCode);
            var listRela = _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.CardCode == cardInherit.CardCode);
            if (listAttach.Count() > 0)
            {
                foreach (var item in listAttach)
                {
                    var attach = new CardAttachment
                    {
                        CardCode = data.CardCode,
                        FileCode = "ATTACHMENT" + DateTime.Now.ToString("ddMMyyyyHHmmss"),
                        MemberId = ESEIM.AppContext.UserName,
                        FileName = item.FileName,
                        FileUrl = item.FileUrl,
                        CreatedTime = DateTime.Now,
                    };
                    _context.CardAttachments.Add(attach);
                }
            }

            if (listRela.Count() > 0)
            {
                foreach (var item in listRela)
                {
                    var rela = new JcObjectIdRelative
                    {
                        CardCode = data.CardCode,
                        ObjTypeCode = item.ObjTypeCode,
                        ObjID = item.ObjID,
                        Relative = item.Relative,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now,
                        Weight = item.Weight.HasValue ? item.Weight.Value : 0
                    };
                    _context.JcObjectIdRelatives.Add(rela);
                }
            }
        }
        [HttpGet]
        public async Task<JsonResult> GetAddress(string lat, string lon)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                msg.Object = await _googleAPI.GetAddressForCoordinates(Convert.ToDouble(lat), Convert.ToDouble(lon));
                //if (result.status == "OK")
                //{
                //    msg.Object = result.results[0].formatted_address;
                //}
                //else
                //{
                //    msg.Error = true;
                //    // msg.Title = "Key đã vượt mức giới hạn, vui lòng liên hệ administrator!";
                //    msg.Title = _stringLocalizer["CJ_MSG_KEY_EXPIRED_PLS_CONTACT_ADMIN"];
                //    return Json(msg);
                //}
            }
            catch (Exception ex)
            {
                msg.Error = true;
                //msg.Title = "Có lỗi khi lấy địa chỉ!";
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetCardInList(string listCode)
        {
            var data = _context.WORKOSCards.Where(x => !x.IsDeleted && x.ListCode == listCode);
            return Json(data);
        }

        [HttpGet]
        public bool HideCost()
        {
            var isNotVatco = false;
            var host = HttpContext.Request.Host.Value.ToString();
            if (!host.Contains("dieuhanh.vatco"))
            {
                isNotVatco = true;
            }
            return isNotVatco;
        }

        public class DepartmentGroupAssignee
        {
            public string Department { get; set; }
            public string Group { get; set; }
            public string CardCode { get; set; }
        }

        [NonAction]
        public Tuple<string, string> GetDepartmentGroupAssign(string cardCode, List<DepartmentGroupAssignee> assignees)
        {
            var departmentAssign = "";
            var groupAssign = "";
            var data = assignees.Where(x => x.CardCode == cardCode);
            if (data.Any())
            {
                departmentAssign = string.Join(",", data.DistinctBy(x => x.Department).Select(x => x.Department));
                groupAssign = string.Join(",", data.DistinctBy(x => x.Group).Select(x => x.Group));
            }
            return new Tuple<string, string>(departmentAssign, groupAssign);
        }

        [NonAction]
        public Tuple<string, string> GetWfActName(string cardCode, List<WfActObjProcess> processes)
        {
            var wfName = "";
            var actName = "";
            //var wfInst = _context.WorkflowInstances.FirstOrDefault(x => !x.IsDeleted.Value
            //    && x.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard) && x.ObjectInst == cardCode);
            var process = processes.FirstOrDefault(x => x.ObjectInst == cardCode);
            if (process != null)
            {
                //var wf = _context.WorkFlows.FirstOrDefault(x => !x.IsDeleted.Value && x.WfCode == wfInst.WorkflowCode);
                //if (wf != null)
                wfName = process.WfInstName;

                //var acts = (from a in _context.WfActivityObjectProccessings.Where(x => !x.IsDeleted && x.ObjectInst == cardCode
                //           && x.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard))
                //            join b in _context.ActivityInstances.Where(x => !x.IsDeleted && x.WorkflowCode == wfInst.WfInstCode) on a.ActInstCode equals b.ActivityInstCode
                //            select new
                //            {
                //                a.ObjectType,
                //                a.ObjectInst,
                //                b.Title
                //            });
                actName = string.Join(",", processes.Select(x => x.Title));
            }
            return new Tuple<string, string>(wfName, actName);
        }

        [HttpPost]
        public JsonResult GetLogStatusCard(string cardCode)
        {
            var lstStatus = new List<JsonStatusCard>();
            var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode == cardCode);
            if (card != null)
            {
                if (!string.IsNullOrEmpty(card.JsonStatusLog))
                {
                    lstStatus = JsonConvert.DeserializeObject<List<JsonStatusCard>>(card.JsonStatusLog);
                }
            }
            var data = from a in lstStatus
                       join b in _context.CommonSettings.Where(x => !x.IsDeleted) on a.Status equals b.CodeSet
                       join c in _context.Users on a.CreatedBy equals c.UserName
                       select new
                       {
                           Status = b.ValueSet,
                           CreatedBy = c.GivenName,
                           CreatedTime = a.CreatedTime.ToString("HH:mm dd/MM/yyyy")
                       };
            return Json(data);
        }
        public class JsonStatusCard
        {
            public string Status { get; set; }
            public string CreatedBy { get; set; }
            public bool Lock { get; set; }
            public DateTime CreatedTime { get; set; }
        }
        public class PramSuggest
        {
            public string objectCode { get; set; }
            public string boardCode { get; set; }
            public string ListCode { get; set; }
        }
        public class BufferData
        {
            public CardBuffer CardJob { get; set; }
            public JcRelaCard JcRelative { get; set; }
            public CardLinkBuffer CardLink { get; set; }
            //public CardGroupOrMemberModel Assign { get; set; }
            public ProductBuffer ProductBuffer { get; set; }
            public ServiceBuffer ServiceBuffer { get; set; }
            public AddressBuffer AddressBuffer { get; set; }
            public TimeSpanActivity TimeSpanActivity { get; set; }
        }
        public class CardBuffer
        {
            public string CardCode { get; set; }
            public string CardName { get; set; }
            public string Description { get; set; }
            public string WorkType { get; set; }
            public string Status { get; set; }
            public string CardLevel { get; set; }
            public string Deadline { get; set; }
            public string BeginTime { get; set; }
            public string EndTime { get; set; }
            public string WeightNum { get; set; }
            public decimal Completed { get; set; }
            public string Inherit { get; set; }
            public string ListCode { get; set; }
            public decimal Cost { get; set; }
            public string Currency { get; set; }

        }
        public class JcRelaCard
        {
            public List<string> ListDelRelative { get; set; }
            public List<ObjectRela> ListRelative { get; set; }
        }
        public class CardLinkBuffer
        {
            public CardLinkBuffer()
            {
                ListCardLink = new List<CardLinkBufferData>();
            }
            public List<int> ListCardLinkDel { get; set; }
            public List<CardLinkBufferData> ListCardLink { get; set; }
        }
        public class ObjectRela
        {
            public int ID { get; set; }
            public string ObjName { get; set; }
            public string ObjTypeName { get; set; }
            public string ObjTypeCode { get; set; }
            public string ObjID { get; set; }
            public string RelativeCode { get; set; }
            public string RelativeName { get; set; }
            public string Weight { get; set; }
            public string IdObjTemp { get; set; }
        }
        public class CardLinkBufferData
        {
            public int Id { get; set; }
            public string Code { get; set; }
            public string Name { get; set; }
            public string Status { get; set; }
            public string EndDate { get; set; }
        }
        public class ProductBuffer
        {
            public List<int> ListDelProduct { get; set; }
            public List<ProductBufferData> ListProduct { get; set; }
        }
        public class ServiceBuffer
        {
            public List<int> ListDelService { get; set; }
            public List<ServiceBufferData> ListService { get; set; }
        }
        public class AddressBuffer
        {
            public List<int> ListDelAddress { get; set; }
            public List<AddressBufferData> ListAddress { get; set; }
        }
        public class ProductBufferData
        {
            public int ID { get; set; }
            public int Quantity { get; set; }
            public DateTime CreatedTime { get; set; }
            public string CreatedBy { get; set; }
            public string ProductCode { get; set; }
            public string ProductName { get; set; }
            public string JcAct { get; set; }
        }
        public class ServiceBufferData
        {
            public int ID { get; set; }
            public int Quantity { get; set; }
            public DateTime CreatedTime { get; set; }
            public string CreatedBy { get; set; }
            public string ServiceCode { get; set; }
            public string ServiceName { get; set; }
            public string JcAct { get; set; }
        }
        public class AddressBufferData
        {
            public int Id { get; set; }
            public string LocationGps { get; set; }
            public string LocationText { get; set; }
            public string CreatedBy { get; set; }
            public DateTime CreatedTime { get; set; }
        }
        public class ItemWorkCheck
        {
            public List<CheckListItemBuffer> ItemCheck { get; set; }
            public List<ViewItem> ItemWork { get; set; }
            public decimal CompleteOld { get; set; }
            public TimeSpanActivity TimeSpanActivity { get; set; }
        }
        public class CheckListItemBuffer
        {
            public int Id { get; set; }
            public string CardCode { get; set; }
            public string ChkListCode { get; set; }
            public string CheckTitle { get; set; }
            public decimal WeightNum { get; set; }
            public decimal Completed { get; set; }
            public string CreatedBy { get; set; }
            public DateTime CreatedTime { get; set; }
            public bool CheckItem { get; set; }
            public string TitleSubItemChk { get; set; }
            public List<UserAssignBufeer> ListUserItemChk { get; set; }
            public List<SubItemBuffer> ListSubItem { get; set; }
            public string Constraint { get; set; }
        }
        public class SubItemBuffer
        {
            public int Id { get; set; }
            public string Title { get; set; }
            public decimal WeightNum { get; set; }
            public decimal Completed { get; set; }
            public bool Approve { get; set; }
            public List<UserAssignBufeer> ListUserSubItem { get; set; }
            public string Approver { get; set; }
            public DateTime? ApprovedTime { get; set; }
        }
        public class UserAssignBufeer
        {
            public int ID { get; set; }
            public string UserId { get; set; }
            public string GivenName { get; set; }
            public decimal EstimateTime { get; set; }
            public string Status { get; set; }
            public string Unit { get; set; }
            public string CreatedBy { get; set; }
            public DateTime CreatedTime { get; set; }
        }
        public class CommentBuffer
        {
            public List<int> ListDelComment { get; set; }
            public List<CommentBufferData> ListComment { get; set; }
        }
        public class CommentBufferData
        {
            public int Id { get; set; }
            public string Picture { get; set; }
            public string MemberId { get; set; }
            public string CmtContent { get; set; }
            public DateTime? CreatedTime { get; set; }
            public DateTime? UpdatedTime { get; set; }
            public string UpdatedBy { get; set; }
        }
        public class TimeSpanActivity
        {
            public DateTime? TimeStart { get; set; }
        }

        [HttpPost]
        public object GetSuggesstion([FromBody] PramSuggest prams)
        {
            var userName = ESEIM.AppContext.UserName;
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == userName);
            if (!string.IsNullOrEmpty(prams.boardCode))
            {
                var listCode = _context.WORKOSLists.FirstOrDefault(x => x.BoardCode == prams.boardCode && !x.IsDeleted);
                if (prams.objectCode == "")
                {
                    var max = _context.WORKOSCards.Where(x => x.ListCode == listCode.ListCode && !x.IsDeleted && x.CreatedBy == userName);
                    if (max.Count() > 0)
                    {
                        var maxId = max.Max(x => x.CardID);
                        var lastCard = _context.WORKOSCards.FirstOrDefault(x => x.CardID == maxId);

                        var listRela = _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.CardCode == lastCard.CardCode);
                        var assign = _context.JobCardAssignees.Where(x => x.CardCode == lastCard.CardCode && !x.IsDeleted).ToList();
                        var listMember = assign.Where(x => x.UserId != null);
                        var listAttach = _context.CardAttachments.Where(x => x.CardCode == lastCard.CardCode && !x.Flag);
                        //Insert card and attr
                        var lstJsonStatus = new List<JsonStatusCard>();
                        var jsonStatus = new JsonStatusCard
                        {
                            Status = "CREATED",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            Lock = false
                        };
                        lstJsonStatus.Add(jsonStatus);

                        var lockShare = new LockShare
                        {
                            User = ESEIM.AppContext.UserName,
                            StartTime = DateTime.Now
                        };

                        var card = new WORKOSCard
                        {
                            CardName = "",
                            CardCode = "" + (_context.WORKOSCards.Count() > 0 ? _context.WORKOSCards.Max(x => x.CardID) + 1 : 1),
                            ListCode = listCode.ListCode,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedDate = DateTime.Now,
                            Currency = "VND",
                            Status = "CREATED",
                            BeginTime = DateTime.Now,
                            Deadline = DateTime.Now,
                            Description = "",
                            JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus),
                            LockShare = JsonConvert.SerializeObject(lockShare)
                        };
                        _context.WORKOSCards.Add(card);

                        var comment = new CardCommentList()
                        {
                            CardCode = card.CardCode,
                            CmtId = "Comment" + Guid.NewGuid().ToString(),
                            CmtContent = "Đã tạo công việc",
                            MemberId = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now
                        };
                        _context.CardCommentLists.Add(comment);

                        //Add department of member create card
                        var json = new List<JobCardAssignee>();
                        var addLeader = new JobCardAssignee
                        {
                            CardCode = card.CardCode,
                            UserId = ESEIM.AppContext.UserId,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            Role = "ROLE_LEADER",
                            DepartmentCode = user != null ? !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "" : "",
                            GroupCode = "",
                            Item = "",
                            Approve = true,
                            ApproveTime = DateTime.Now,
                            Status = "ASSIGN_STATUS_WORK",
                            Branch = !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : ""
                        };
                        _context.JobCardAssignees.Add(addLeader);
                        json.Add(addLeader);

                        if (listMember.Count() > 0)
                        {
                            foreach (var item in listMember)
                            {
                                if (item.UserId != ESEIM.AppContext.UserId)
                                {
                                    card.LstUser += item.UserId + ",";
                                    var assignee = new JobCardAssignee
                                    {
                                        CardCode = card.CardCode,
                                        UserId = item.UserId,
                                        DepartmentCode = item.DepartmentCode,
                                        GroupCode = item.GroupCode,
                                        Role = item.Role,
                                        CreatedBy = ESEIM.AppContext.UserName,
                                        CreatedTime = DateTime.Now,
                                        Item = item.Item,
                                        Approve = true,
                                        ApproveTime = DateTime.Now,
                                        Status = item.Status,
                                        Branch = item.Branch
                                    };
                                    _context.JobCardAssignees.Add(assignee);
                                    json.Add(assignee);
                                }
                            }
                        }

                        card.LstUser += ESEIM.AppContext.UserId + ",";
                        card.JsonAssign = JsonConvert.SerializeObject(json);
                        if (listRela.Count() > 0)
                        {
                            foreach (var item in listRela)
                            {
                                var rela = new JcObjectIdRelative
                                {
                                    CardCode = card.CardCode,
                                    ObjTypeCode = item.ObjTypeCode,
                                    ObjID = item.ObjID,
                                    Relative = item.Relative,
                                    CreatedBy = userName,
                                    CreatedTime = DateTime.Now,
                                    Weight = item.Weight.HasValue ? item.Weight.Value : 0
                                };
                                _context.JcObjectIdRelatives.Add(rela);
                            }
                        }
                        if (listAttach.Count() > 0)
                        {
                            foreach (var item in listAttach)
                            {
                                var attach = new CardAttachment
                                {
                                    CardCode = card.CardCode,
                                    FileCode = "ATTACHMENT" + DateTime.Now.ToString("ddMMyyyyHHmmss"),
                                    MemberId = userName,
                                    FileName = item.FileName,
                                    FileUrl = item.FileUrl,
                                    CreatedTime = DateTime.Now,
                                    ListPermissionViewFile = item.ListPermissionViewFile,
                                    IsEdms = item.IsEdms,
                                    IdMapping = item.IdMapping
                                };
                                _context.CardAttachments.Add(attach);
                            }

                        }

                        _cardService.UpdatePercentParentCard(card.CardCode);
                        _context.SaveChanges();
                        return new
                        {
                            BoardCode = prams.boardCode,
                            Card = card,
                            ListCode = listCode.ListCode,
                        };
                    }
                    else
                    {
                        var lstJsonStatus = new List<JsonStatusCard>();
                        var jsonStatus = new JsonStatusCard
                        {
                            Status = "CREATED",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            Lock = false
                        };
                        lstJsonStatus.Add(jsonStatus);

                        var lockShare = new LockShare
                        {
                            User = ESEIM.AppContext.UserName,
                            StartTime = DateTime.Now
                        };
                        var card = new WORKOSCard
                        {
                            CardName = "",
                            CardCode = "" + (_context.WORKOSCards.Count() > 0 ? _context.WORKOSCards.Max(x => x.CardID) + 1 : 1),
                            ListCode = listCode.ListCode,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedDate = DateTime.Now,
                            Currency = "VND",
                            Status = "CREATED",
                            BeginTime = DateTime.Now,
                            Deadline = DateTime.Now,
                            Description = "",
                            JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus),
                            LockShare = JsonConvert.SerializeObject(lockShare)
                        };
                        _context.WORKOSCards.Add(card);
                        var comment = new CardCommentList()
                        {
                            CardCode = card.CardCode,
                            CmtId = "Comment" + Guid.NewGuid().ToString(),
                            CmtContent = "Đã tạo công việc",
                            MemberId = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now
                        };
                        _context.CardCommentLists.Add(comment);
                        var json = new List<JobCardAssignee>();
                        var addLeader = new JobCardAssignee
                        {
                            CardCode = card.CardCode,
                            UserId = ESEIM.AppContext.UserId,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            Role = "ROLE_LEADER",
                            DepartmentCode = user != null ? !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "" : "",
                            GroupCode = "",
                            Item = "",
                            Approve = true,
                            ApproveTime = DateTime.Now,
                            Status = "ASSIGN_STATUS_WORK",
                            Branch = !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : ""
                        };
                        _context.JobCardAssignees.Add(addLeader);
                        json.Add(addLeader);
                        card.LstUser += ESEIM.AppContext.UserId + ",";
                        card.JsonAssign = JsonConvert.SerializeObject(json);
                        _cardService.UpdatePercentParentCard(card.CardCode);
                        _context.SaveChanges();
                        return new
                        {
                            BoardCode = prams.boardCode,
                            Card = card,
                            ListCode = listCode.ListCode,
                        };
                    }
                }
                else
                {
                    var max = (from a in _context.WORKOSCards
                               join b in _context.JcObjectIdRelatives on a.CardCode equals b.CardCode
                               where !a.IsDeleted && !b.IsDeleted && b.ObjID == prams.objectCode && a.CreatedBy == userName && a.ListCode == listCode.ListCode
                               select a);
                    if (max.Count() > 0)
                    {
                        var maxId = max.Max(x => x.CardID);
                        var lastCard = _context.WORKOSCards.FirstOrDefault(x => x.CardID == maxId);

                        var listRela = _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.CardCode == lastCard.CardCode);
                        var assign = _context.JobCardAssignees.Where(x => x.CardCode == lastCard.CardCode && !x.IsDeleted);
                        var listMember = assign.Where(x => x.UserId != null);
                        var listAttach = _context.CardAttachments.Where(x => x.CardCode == lastCard.CardCode && !x.Flag);
                        //Insert card and attr

                        var lstJsonStatus = new List<JsonStatusCard>();
                        var jsonStatus = new JsonStatusCard
                        {
                            Status = "CREATED",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            Lock = false
                        };
                        lstJsonStatus.Add(jsonStatus);
                        var lockShare = new LockShare
                        {
                            User = ESEIM.AppContext.UserName,
                            StartTime = DateTime.Now
                        };
                        var card = new WORKOSCard
                        {
                            CardName = "",
                            CardCode = "" + (_context.WORKOSCards.Count() > 0 ? _context.WORKOSCards.Max(x => x.CardID) + 1 : 1),
                            ListCode = listCode.ListCode,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedDate = DateTime.Now,
                            Currency = "VND",
                            Status = "CREATED",
                            BeginTime = DateTime.Now,
                            Deadline = DateTime.Now,
                            Description = "",
                            JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus),
                            LockShare = JsonConvert.SerializeObject(lockShare)
                        };
                        _context.WORKOSCards.Add(card);
                        var comment = new CardCommentList()
                        {
                            CardCode = card.CardCode,
                            CmtId = "Comment" + Guid.NewGuid().ToString(),
                            CmtContent = "Đã tạo công việc",
                            MemberId = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now
                        };
                        _context.CardCommentLists.Add(comment);

                        //Add department of member create card
                        var json = new List<JobCardAssignee>();
                        var assignee = new JobCardAssignee
                        {
                            CardCode = card.CardCode,
                            DepartmentCode = !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "",
                            CreatedBy = userName,
                            CreatedTime = DateTime.Now,
                            Role = "ROLE_LEADER",
                            GroupCode = "",
                            Item = "",
                            UserId = ESEIM.AppContext.UserId,
                            Approve = true,
                            ApproveTime = DateTime.Now,
                            Status = "ASSIGN_STATUS_WORK",
                            Branch = !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : ""
                        };
                        _context.JobCardAssignees.Add(assignee);
                        json.Add(assignee);
                        if (listMember.Count() > 0)
                        {
                            foreach (var item in listMember)
                            {
                                if (item.UserId != ESEIM.AppContext.UserId)
                                {
                                    card.LstUser += item.UserId + ",";
                                    var jobAssign = new JobCardAssignee
                                    {
                                        CardCode = card.CardCode,
                                        DepartmentCode = item.DepartmentCode,
                                        CreatedBy = ESEIM.AppContext.UserName,
                                        CreatedTime = DateTime.Now,
                                        Role = "ROLE_LEADER",
                                        GroupCode = item.GroupCode,
                                        Item = item.Item,
                                        UserId = item.UserId,
                                        Approve = true,
                                        ApproveTime = DateTime.Now,
                                        Status = item.Status,
                                        Branch = item.Branch
                                    };
                                    _context.JobCardAssignees.Add(jobAssign);
                                    json.Add(jobAssign);
                                }
                            }
                        }
                        if (listRela.Count() > 0)
                        {
                            foreach (var item in listRela)
                            {
                                var rela = new JcObjectIdRelative
                                {
                                    CardCode = card.CardCode,
                                    ObjTypeCode = item.ObjTypeCode,
                                    ObjID = item.ObjID,
                                    Relative = item.Relative,
                                    CreatedBy = userName,
                                    CreatedTime = DateTime.Now,
                                    Weight = item.Weight.HasValue ? item.Weight.Value : 0
                                };
                                _context.JcObjectIdRelatives.Add(rela);
                            }
                        }
                        //Auto add project to card
                        var relaAuto = new JcObjectIdRelative
                        {
                            CardCode = card.CardCode,
                            ObjTypeCode = "PROJECT",
                            ObjID = prams.objectCode,
                            Relative = "MAIN",
                            CreatedBy = userName,
                            CreatedTime = DateTime.Now,
                            Weight = 0
                        };
                        _context.JcObjectIdRelatives.Add(relaAuto);

                        if (listAttach.Count() > 0)
                        {
                            foreach (var item in listAttach)
                            {
                                var attach = new CardAttachment
                                {
                                    CardCode = card.CardCode,
                                    FileCode = "ATTACHMENT" + DateTime.Now.ToString("ddMMyyyyHHmmss"),
                                    MemberId = userName,
                                    FileName = item.FileName,
                                    FileUrl = item.FileUrl,
                                    CreatedTime = DateTime.Now,
                                    ListPermissionViewFile = item.ListPermissionViewFile,
                                    IsEdms = item.IsEdms,
                                    IdMapping = item.IdMapping
                                };
                                _context.CardAttachments.Add(attach);
                            }

                        }
                        card.LstUser += ESEIM.AppContext.UserId + ",";
                        card.JsonAssign = JsonConvert.SerializeObject(json);
                        _cardService.UpdatePercentParentCard(card.CardCode);
                        _context.SaveChanges();
                        return new
                        {
                            BoardCode = prams.boardCode,
                            Card = card,
                            ListCode = listCode.ListCode,
                        };
                    }
                    else
                    {
                        var lstJsonStatus = new List<JsonStatusCard>();
                        var jsonStatus = new JsonStatusCard
                        {
                            Status = "CREATED",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            Lock = false
                        };
                        lstJsonStatus.Add(jsonStatus);

                        var lockShare = new LockShare
                        {
                            User = ESEIM.AppContext.UserName,
                            StartTime = DateTime.Now
                        };

                        var card = new WORKOSCard
                        {
                            CardName = "",
                            CardCode = "" + (_context.WORKOSCards.Count() > 0 ? _context.WORKOSCards.Max(x => x.CardID) + 1 : 1),
                            ListCode = listCode.ListCode,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedDate = DateTime.Now,
                            Currency = "VND",
                            Status = "CREATED",
                            BeginTime = DateTime.Now,
                            Deadline = DateTime.Now,
                            Description = "",
                            JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus),
                            LockShare = JsonConvert.SerializeObject(lockShare)
                        };
                        _context.WORKOSCards.Add(card);

                        //Auto add project to card
                        var relaAuto = new JcObjectIdRelative
                        {
                            CardCode = card.CardCode,
                            ObjTypeCode = "PROJECT",
                            ObjID = prams.objectCode,
                            Relative = "MAIN",
                            CreatedBy = userName,
                            CreatedTime = DateTime.Now,
                            Weight = 0
                        };
                        _context.JcObjectIdRelatives.Add(relaAuto);

                        var comment = new CardCommentList()
                        {
                            CardCode = card.CardCode,
                            CmtId = "Comment" + Guid.NewGuid().ToString(),
                            CmtContent = "Đã tạo công việc",
                            MemberId = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now
                        };
                        _context.CardCommentLists.Add(comment);

                        var json = new List<JobCardAssignee>();
                        var addLeader = new JobCardAssignee
                        {
                            CardCode = card.CardCode,
                            UserId = ESEIM.AppContext.UserId,
                            CreatedBy = userName,
                            CreatedTime = DateTime.Now,
                            Role = "ROLE_LEADER",
                            GroupCode = "",
                            DepartmentCode = !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "",
                            Approve = true,
                            ApproveTime = DateTime.Now,
                            Item = "",
                            Status = "ASSIGN_STATUS_WORK",
                            Branch = !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : ""
                        };
                        _context.JobCardAssignees.Add(addLeader);
                        json.Add(addLeader);
                        card.LstUser += ESEIM.AppContext.UserId + ",";
                        card.JsonAssign = JsonConvert.SerializeObject(json);
                        _cardService.UpdatePercentParentCard(card.CardCode);
                        _context.SaveChanges();
                        return new
                        {
                            BoardCode = prams.boardCode,
                            Card = card,
                            ListCode = listCode.ListCode,
                        };
                    }
                }
            }
            else
            {
                if (prams.objectCode == "")
                {
                    var max = _context.WORKOSCards.Where(x => x.IsDeleted == false && x.CreatedBy == userName);
                    if (max.Count() > 0)
                    {
                        var maxId = max.Max(x => x.CardID);
                        var lastCard = _context.WORKOSCards.FirstOrDefault(x => x.CardID == maxId);

                        var listCode = _context.WORKOSLists.FirstOrDefault(x => x.ListCode == lastCard.ListCode && !x.IsDeleted);
                        var board = _context.WORKOSBoards.FirstOrDefault(x => x.BoardCode == listCode.BoardCode && !x.IsDeleted);
                        var listRela = _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.CardCode == lastCard.CardCode);
                        var assign = _context.JobCardAssignees.Where(x => x.CardCode == lastCard.CardCode && !x.IsDeleted);
                        var listMember = assign.Where(x => x.UserId != null);
                        var listAttach = _context.CardAttachments.Where(x => x.CardCode == lastCard.CardCode && !x.Flag);
                        //Insert card and attr

                        var lstJsonStatus = new List<JsonStatusCard>();
                        var jsonStatus = new JsonStatusCard
                        {
                            Status = "CREATED",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            Lock = false
                        };
                        lstJsonStatus.Add(jsonStatus);
                        var lockShare = new LockShare
                        {
                            User = ESEIM.AppContext.UserName,
                            StartTime = DateTime.Now
                        };
                        var card = new WORKOSCard
                        {
                            CardName = "",
                            CardCode = "" + (_context.WORKOSCards.Count() > 0 ? _context.WORKOSCards.Max(x => x.CardID) + 1 : 1),
                            ListCode = listCode.ListCode,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedDate = DateTime.Now,
                            Currency = "VND",
                            Status = "CREATED",
                            BeginTime = DateTime.Now,
                            Deadline = DateTime.Now,
                            Description = "",
                            JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus),
                            LockShare = JsonConvert.SerializeObject(lockShare)
                        };
                        _context.WORKOSCards.Add(card);
                        var comment = new CardCommentList()
                        {
                            CardCode = card.CardCode,
                            CmtId = "Comment" + Guid.NewGuid().ToString(),
                            CmtContent = "Đã tạo công việc",
                            MemberId = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now
                        };
                        _context.CardCommentLists.Add(comment);

                        var json = new List<JobCardAssignee>();
                        var assignee = new JobCardAssignee
                        {
                            CardCode = card.CardCode,
                            DepartmentCode = !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "",
                            CreatedBy = userName,
                            CreatedTime = DateTime.Now,
                            Role = "ROLE_LEADER",
                            GroupCode = "",
                            Item = "",
                            UserId = ESEIM.AppContext.UserId,
                            Approve = true,
                            ApproveTime = DateTime.Now,
                            Status = "ASSIGN_STATUS_WORK",
                            Branch = !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : ""
                        };
                        _context.JobCardAssignees.Add(assignee);
                        json.Add(assignee);

                        card.LstUser += ESEIM.AppContext.UserId + ",";
                        if (listMember.Count() > 0)
                        {
                            foreach (var item in listMember)
                            {
                                card.LstUser += item.UserId + ",";
                                if (item.UserId != ESEIM.AppContext.UserId)
                                {
                                    var jobAssign = new JobCardAssignee
                                    {
                                        CardCode = card.CardCode,
                                        UserId = item.UserId,
                                        CreatedBy = userName,
                                        CreatedTime = DateTime.Now,
                                        Role = item.Role,
                                        DepartmentCode = item.DepartmentCode,
                                        GroupCode = item.GroupCode,
                                        Item = item.Item,
                                        Approve = item.Approve,
                                        ApproveTime = DateTime.Now,
                                        Status = item.Status,
                                        Branch = item.Branch
                                    };
                                    _context.JobCardAssignees.Add(jobAssign);
                                    json.Add(jobAssign);
                                }
                            }
                        }
                        if (listRela.Count() > 0)
                        {
                            foreach (var item in listRela)
                            {
                                var rela = new JcObjectIdRelative
                                {
                                    CardCode = card.CardCode,
                                    ObjTypeCode = item.ObjTypeCode,
                                    ObjID = item.ObjID,
                                    Relative = item.Relative,
                                    CreatedBy = userName,
                                    CreatedTime = DateTime.Now,
                                    Weight = item.Weight.HasValue ? item.Weight.Value : 0
                                };
                                _context.JcObjectIdRelatives.Add(rela);
                            }
                        }
                        if (listAttach.Count() > 0)
                        {
                            foreach (var item in listAttach)
                            {
                                var attach = new CardAttachment
                                {
                                    CardCode = card.CardCode,
                                    FileCode = "ATTACHMENT" + DateTime.Now.ToString("ddMMyyyyHHmmss"),
                                    MemberId = userName,
                                    FileName = item.FileName,
                                    FileUrl = item.FileUrl,
                                    CreatedTime = DateTime.Now,
                                    ListPermissionViewFile = item.ListPermissionViewFile,
                                    IsEdms = item.IsEdms,
                                    IdMapping = item.IdMapping
                                };
                                _context.CardAttachments.Add(attach);
                            }

                        }
                        card.JsonAssign = JsonConvert.SerializeObject(json);
                        _cardService.UpdatePercentParentCard(card.CardCode);
                        _context.SaveChanges();
                        return new
                        {
                            BoardCode = board.BoardCode,
                            Card = card,
                            ListCode = listCode.ListCode,
                        };
                    }
                    else
                    {
                        var boards = _context.WORKOSBoards.Where(x => !x.IsDeleted);
                        if (boards.Any())
                        {
                            var board = boards.FirstOrDefault();
                            var list = _context.WORKOSLists.FirstOrDefault(x => x.BoardCode == board.BoardCode && !x.IsDeleted);

                            var lstJsonStatus = new List<JsonStatusCard>();
                            var jsonStatus = new JsonStatusCard
                            {
                                Status = "CREATED",
                                CreatedBy = ESEIM.AppContext.UserName,
                                CreatedTime = DateTime.Now,
                                Lock = false
                            };
                            lstJsonStatus.Add(jsonStatus);

                            var lockShare = new LockShare
                            {
                                User = ESEIM.AppContext.UserName,
                                StartTime = DateTime.Now
                            };

                            var card = new WORKOSCard
                            {
                                CardName = "",
                                CardCode = "" + (_context.WORKOSCards.Count() > 0 ? _context.WORKOSCards.Max(x => x.CardID) + 1 : 1),
                                ListCode = list.ListCode,
                                CreatedBy = ESEIM.AppContext.UserName,
                                CreatedDate = DateTime.Now,
                                Currency = "VND",
                                Status = "CREATED",
                                BeginTime = DateTime.Now,
                                Deadline = DateTime.Now,
                                Description = "",
                                JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus),
                                LockShare = JsonConvert.SerializeObject(lockShare)
                            };
                            _context.WORKOSCards.Add(card);
                            var comment = new CardCommentList()
                            {
                                CardCode = card.CardCode,
                                CmtId = "Comment" + Guid.NewGuid().ToString(),
                                CmtContent = "Đã tạo công việc",
                                MemberId = ESEIM.AppContext.UserName,
                                CreatedTime = DateTime.Now
                            };
                            _context.CardCommentLists.Add(comment);
                            var json = new List<JobCardAssignee>();
                            var assignee = new JobCardAssignee
                            {
                                CardCode = card.CardCode,
                                DepartmentCode = !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "",
                                CreatedBy = userName,
                                CreatedTime = DateTime.Now,
                                Role = "ROLE_LEADER",
                                GroupCode = "",
                                Item = "",
                                UserId = ESEIM.AppContext.UserId,
                                Approve = true,
                                ApproveTime = DateTime.Now,
                                Status = "ASSIGN_STATUS_WORK",
                                Branch = !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : ""
                            };
                            _context.JobCardAssignees.Add(assignee);
                            json.Add(assignee);
                            card.LstUser += ESEIM.AppContext.UserId + ",";
                            card.JsonAssign = JsonConvert.SerializeObject(json);
                            _cardService.UpdatePercentParentCard(card.CardCode);
                            _context.SaveChanges();
                            return new
                            {
                                BoardCode = board.BoardCode,
                                Card = card,
                                ListCode = list.ListCode,
                            };
                        }
                        else
                        {
                            return Json("");
                        }
                    }
                }
                else
                {
                    var max = (from a in _context.WORKOSCards
                               join b in _context.JcObjectIdRelatives on a.CardCode equals b.CardCode
                               where !a.IsDeleted && !b.IsDeleted && b.ObjID == prams.objectCode && a.CreatedBy == userName
                               select a);
                    if (max.Count() > 0)
                    {
                        var maxId = max.Max(x => x.CardID);
                        var lastCard = _context.WORKOSCards.FirstOrDefault(x => x.CardID == maxId);

                        var list = _context.WORKOSLists.FirstOrDefault(x => x.ListCode == lastCard.ListCode && !x.IsDeleted);
                        var board = _context.WORKOSBoards.FirstOrDefault(x => x.BoardCode == list.BoardCode && !x.IsDeleted);
                        var listRela = _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.CardCode == lastCard.CardCode);
                        var assign = _context.JobCardAssignees.Where(x => x.CardCode == lastCard.CardCode && !x.IsDeleted);
                        var listMember = assign.Where(x => x.UserId != null);
                        var listAttach = _context.CardAttachments.Where(x => x.CardCode == lastCard.CardCode && !x.Flag);
                        //Insert card and attr

                        var lstJsonStatus = new List<JsonStatusCard>();
                        var jsonStatus = new JsonStatusCard
                        {
                            Status = "CREATED",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            Lock = false
                        };
                        lstJsonStatus.Add(jsonStatus);
                        var lockShare = new LockShare
                        {
                            User = ESEIM.AppContext.UserName,
                            StartTime = DateTime.Now
                        };
                        var card = new WORKOSCard
                        {
                            CardName = "",
                            CardCode = "" + (_context.WORKOSCards.Count() > 0 ? _context.WORKOSCards.Max(x => x.CardID) + 1 : 1),
                            ListCode = lastCard.ListCode,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedDate = DateTime.Now,
                            Currency = "VND",
                            Status = "CREATED",
                            BeginTime = DateTime.Now,
                            Deadline = DateTime.Now,
                            Description = "",
                            JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus),
                            LockShare = JsonConvert.SerializeObject(lockShare)
                        };
                        _context.WORKOSCards.Add(card);
                        var comment = new CardCommentList()
                        {
                            CardCode = card.CardCode,
                            CmtId = "Comment" + Guid.NewGuid().ToString(),
                            CmtContent = "Đã tạo công việc",
                            MemberId = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now
                        };
                        _context.CardCommentLists.Add(comment);

                        var json = new List<JobCardAssignee>();

                        var assignee = new JobCardAssignee
                        {
                            CardCode = card.CardCode,
                            DepartmentCode = !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "",
                            CreatedBy = userName,
                            CreatedTime = DateTime.Now,
                            Role = "ROLE_LEADER",
                            GroupCode = "",
                            Item = "",
                            UserId = ESEIM.AppContext.UserId,
                            Approve = true,
                            ApproveTime = DateTime.Now,
                            Status = "ASSIGN_STATUS_WORK",
                            Branch = !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : ""
                        };
                        _context.JobCardAssignees.Add(assignee);
                        json.Add(assignee);

                        card.LstUser += ESEIM.AppContext.UserId + ",";
                        if (listMember.Count() > 0)
                        {
                            foreach (var item in listMember)
                            {
                                card.LstUser += item.UserId + ",";
                                if (item.UserId != ESEIM.AppContext.UserId)
                                {
                                    var jobAssign = new JobCardAssignee
                                    {
                                        CardCode = card.CardCode,
                                        UserId = item.UserId,
                                        CreatedBy = userName,
                                        CreatedTime = DateTime.Now,
                                        Role = item.Role,
                                        DepartmentCode = item.DepartmentCode,
                                        GroupCode = item.GroupCode,
                                        Item = item.Item,
                                        Approve = true,
                                        ApproveTime = DateTime.Now,
                                        Status = item.Status,
                                        Branch = item.Branch
                                    };
                                    _context.JobCardAssignees.Add(jobAssign);
                                    json.Add(jobAssign);
                                }
                            }
                        }
                        card.JsonAssign = JsonConvert.SerializeObject(json);
                        if (listRela.Count() > 0)
                        {
                            foreach (var item in listRela)
                            {
                                var rela = new JcObjectIdRelative
                                {
                                    CardCode = card.CardCode,
                                    ObjTypeCode = item.ObjTypeCode,
                                    ObjID = item.ObjID,
                                    Relative = item.Relative,
                                    CreatedBy = userName,
                                    CreatedTime = DateTime.Now,
                                    Weight = item.Weight.HasValue ? item.Weight.Value : 0
                                };
                                _context.JcObjectIdRelatives.Add(rela);
                            }
                        }
                        if (listAttach.Count() > 0)
                        {
                            foreach (var item in listAttach)
                            {
                                var attach = new CardAttachment
                                {
                                    CardCode = card.CardCode,
                                    FileCode = "ATTACHMENT" + DateTime.Now.ToString("ddMMyyyyHHmmss"),
                                    MemberId = userName,
                                    FileName = item.FileName,
                                    FileUrl = item.FileUrl,
                                    CreatedTime = DateTime.Now,
                                    ListPermissionViewFile = item.ListPermissionViewFile,
                                    IsEdms = item.IsEdms,
                                    IdMapping = item.IdMapping
                                };
                                _context.CardAttachments.Add(attach);
                            }

                        }
                        _cardService.UpdatePercentParentCard(card.CardCode);
                        _context.SaveChanges();
                        return new
                        {
                            BoardCode = board.BoardCode,
                            Card = card,
                            ListCode = lastCard.ListCode,
                        };
                    }
                    else
                    {
                        var boards = _context.WORKOSBoards.Where(x => !x.IsDeleted);
                        if (boards.Any())
                        {
                            var board = boards.FirstOrDefault();
                            var list = _context.WORKOSLists.FirstOrDefault(x => x.BoardCode == board.BoardCode && !x.IsDeleted);

                            var lstJsonStatus = new List<JsonStatusCard>();
                            var jsonStatus = new JsonStatusCard
                            {
                                Status = "CREATED",
                                CreatedBy = ESEIM.AppContext.UserName,
                                CreatedTime = DateTime.Now,
                                Lock = false
                            };
                            lstJsonStatus.Add(jsonStatus);
                            var lockShare = new LockShare
                            {
                                User = ESEIM.AppContext.UserName,
                                StartTime = DateTime.Now
                            };
                            var card = new WORKOSCard
                            {
                                CardName = "",
                                CardCode = "" + (_context.WORKOSCards.Count() > 0 ? _context.WORKOSCards.Max(x => x.CardID) + 1 : 1),
                                ListCode = list.ListCode,
                                CreatedBy = ESEIM.AppContext.UserName,
                                CreatedDate = DateTime.Now,
                                Currency = "VND",
                                Status = "CREATED",
                                BeginTime = DateTime.Now,
                                Deadline = DateTime.Now,
                                Description = "",
                                JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus),
                                LockShare = JsonConvert.SerializeObject(lockShare)
                            };
                            _context.WORKOSCards.Add(card);
                            var comment = new CardCommentList()
                            {
                                CardCode = card.CardCode,
                                CmtId = "Comment" + Guid.NewGuid().ToString(),
                                CmtContent = "Đã tạo công việc",
                                MemberId = ESEIM.AppContext.UserName,
                                CreatedTime = DateTime.Now
                            };
                            _context.CardCommentLists.Add(comment);
                            var json = new List<JobCardAssignee>();
                            var assignee = new JobCardAssignee
                            {
                                CardCode = card.CardCode,
                                DepartmentCode = !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "",
                                CreatedBy = userName,
                                CreatedTime = DateTime.Now,
                                Role = "ROLE_LEADER",
                                GroupCode = "",
                                Item = "",
                                UserId = ESEIM.AppContext.UserId,
                                Approve = true,
                                ApproveTime = DateTime.Now,
                                Status = "ASSIGN_STATUS_WORK",
                                Branch = !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : ""
                            };
                            _context.JobCardAssignees.Add(assignee);
                            json.Add(assignee);
                            card.LstUser += ESEIM.AppContext.UserId + ",";
                            card.JsonAssign = JsonConvert.SerializeObject(json);
                            _cardService.UpdatePercentParentCard(card.CardCode);
                            _context.SaveChanges();
                            return new
                            {
                                BoardCode = board.BoardCode,
                                Card = card,
                                ListCode = list.ListCode,
                            };
                        }
                        else
                        {
                            return Json("");
                        }
                    }
                }
            }
        }

        [HttpPost]
        public JsonResult GetInherit(string cardCode)
        {
            var data = _context.JcObjectIdRelatives.Where(x => x.CardCode == cardCode && !x.IsDeleted);
            var listCard = new List<ObjTemp>();
            foreach (var item in data)
            {
                var query = (from a in _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.ObjID == item.ObjID)
                             join b in _context.WORKOSCards.Where(x => !x.IsDeleted) on a.CardCode equals b.CardCode
                             select new ObjTemp
                             {
                                 Code = b.CardCode,
                                 Name = b.CardName
                             }).DistinctBy(x => x.Code).ToList();
                listCard.AddRange(query);
            }
            return Json(listCard);
        }

        [HttpPost]
        public JsonResult UpdateInherit(string cardCode, string inherit)
        {
            var msg = new JMessage();
            try
            {
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == cardCode && !x.IsDeleted);
                if (string.IsNullOrEmpty(data.Inherit))
                {
                    //log content
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = cardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Chọn việc kế thừa " + (_context.WORKOSCards.FirstOrDefault(x => x.CardCode == inherit && !x.IsDeleted) != null ? _context.WORKOSCards.FirstOrDefault(x => x.CardCode == inherit && !x.IsDeleted).CardName : "")
                    };
                    _context.CardUserActivities.Add(activity);
                }
                else
                {
                    //log content
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = cardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Việc kế thừa từ " + (_context.WORKOSCards.FirstOrDefault(x => x.CardCode == cardCode && !x.IsDeleted) != null ? _context.WORKOSCards.FirstOrDefault(x => x.CardCode == data.Inherit && !x.IsDeleted).CardName : "")
                        + " sang " + (_context.WORKOSCards.FirstOrDefault(x => x.CardCode == inherit && !x.IsDeleted) != null ? _context.WORKOSCards.FirstOrDefault(x => x.CardCode == inherit && !x.IsDeleted).CardName : "")
                    };
                    _context.CardUserActivities.Add(activity);
                }
                data.Inherit = inherit;
                var listRelaDes = _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.CardCode == data.CardCode);
                var assignDes = _context.JobCardAssignees.Where(x => x.CardCode == data.CardCode && !x.IsDeleted);
                var listMemberDes = assignDes.Where(x => x.UserId != null);
                var listAttachDes = _context.CardAttachments.Where(x => x.CardCode == data.CardCode);
                if (listRelaDes.Count() > 0)
                {
                    _context.JcObjectIdRelatives.RemoveRange(listRelaDes);
                }
                if (assignDes.Count() > 0)
                {
                    _context.JobCardAssignees.RemoveRange(assignDes);
                }
                if (listAttachDes.Count() > 0)
                {
                    _context.CardAttachments.RemoveRange(listAttachDes);
                }

                var cardInherit = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == inherit && !x.IsDeleted);
                var listRela = _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.CardCode == cardInherit.CardCode);
                var assign = _context.JobCardAssignees.Where(x => x.CardCode == cardInherit.CardCode && !x.IsDeleted);
                var listMember = assign.Where(x => x.UserId != null);
                var listAttach = _context.CardAttachments.Where(x => x.CardCode == cardInherit.CardCode);

                var listCode = _context.WORKOSLists.FirstOrDefault(x => x.ListCode == cardInherit.ListCode && !x.IsDeleted);
                var boardCode = _context.WORKOSBoards.FirstOrDefault(x => x.BoardCode == listCode.BoardCode && !x.IsDeleted);
                if (listRela.Count() > 0)
                {
                    foreach (var item in listRela)
                    {
                        var rela = new JcObjectIdRelative
                        {
                            CardCode = data.CardCode,
                            ObjTypeCode = item.ObjTypeCode,
                            ObjID = item.ObjID,
                            Relative = item.Relative,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                        };
                        _context.JcObjectIdRelatives.Add(rela);
                    }
                }
                if (listMember.Count() > 0)
                {
                    var json = new List<JobCardAssignee>();
                    foreach (var item in listMember)
                    {
                        var cardMapping = new JobCardAssignee
                        {
                            CardCode = data.CardCode,
                            UserId = item.UserId,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            Role = item.Role,
                            DepartmentCode = item.DepartmentCode,
                            GroupCode = item.GroupCode,
                            Item = item.Item,
                            Approve = true,
                            ApproveTime = DateTime.Now
                        };
                        _context.JobCardAssignees.Add(cardMapping);
                        json.Add(cardMapping);
                    }
                    data.JsonAssign = JsonConvert.SerializeObject(json);
                }
                if (listAttach.Count() > 0)
                {
                    foreach (var item in listAttach)
                    {
                        var attach = new CardAttachment
                        {
                            CardCode = data.CardCode,
                            FileCode = item.FileCode,
                            MemberId = ESEIM.AppContext.UserName,
                            FileName = item.FileName,
                            FileUrl = item.FileUrl,
                            CreatedTime = DateTime.Now,
                        };
                        _context.CardAttachments.Add(attach);
                    }

                }

                _context.SaveChanges();
                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);

        }

        [HttpPost]
        public JsonResult ScopeCardProject()
        {
            var data = (from a in _context.WORKOSCards.Where(x => !x.IsDeleted && x.Status != "TRASH" && x.Status != "CANCLED")
                        join b in _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.ObjTypeCode == "PROJECT") on a.CardCode equals b.CardCode
                        select new
                        {
                            a.CardID,
                            a.CardCode,
                            a.CardName
                        }).DistinctBy(x => x.CardCode);
            return Json(data);
        }

        [HttpPost]
        public JsonResult UpdateListCard(string cardCode, string listCode)
        {
            var msg = new JMessage();
            if (listCode == "")
            {
                msg.Error = true;
                msg.Title = _stringLocalizer["CJ_MSG_PLS_SELECT_LIST"];
            }

            if (listCode != "")
            {
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == cardCode && !x.IsDeleted);
                data.ListCode = listCode;
                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                _context.SaveChanges();
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult CopyCard(string cardCode)
        {
            var msg = new JMessage();
            var session = HttpContext.GetSessionUser();
            try
            {
                var cardSrcCopy = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == cardCode && !x.IsDeleted);

                var lockShare = new CardSessionUser
                {
                    User = ESEIM.AppContext.UserName,
                    TimeStamp = DateTime.Now,
                    NewDataUpdate = false
                };
                var lstShare = new List<CardSessionUser>();
                lstShare.Add(lockShare);
                var changeTime = DateTime.Now - cardSrcCopy.BeginTime;
                var cardDesCopy = new WORKOSCard
                {
                    CardName = "Copy_" + cardSrcCopy.CardName,
                    CardCode = "" + (_context.WORKOSCards.Count() > 0 ? _context.WORKOSCards.Max(x => x.CardID) + 1 : 1),
                    ListCode = cardSrcCopy.ListCode,
                    CreatedBy = ESEIM.AppContext.UserName,
                    CreatedDate = DateTime.Now,
                    Status = "CREATED",
                    BeginTime = DateTime.Now,
                    Deadline = cardSrcCopy.Deadline + changeTime,
                    EndTime = cardSrcCopy.EndTime + changeTime,
                    Description = cardSrcCopy.Description,
                    WorkflowCode = cardSrcCopy.WorkflowCode,
                    Cost = cardSrcCopy.Cost,
                    Currency = cardSrcCopy.Currency,
                    JsonStatusLog = cardSrcCopy.JsonStatusLog,
                    LockShare = JsonConvert.SerializeObject(lstShare)
                };
                _context.WORKOSCards.Add(cardDesCopy);
                var comment = new CardCommentList()
                {
                    CardCode = cardDesCopy.CardCode,
                    CmtId = "Comment" + Guid.NewGuid().ToString(),
                    CmtContent = "Đã tạo công việc",
                    MemberId = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now
                };
                _context.CardCommentLists.Add(comment);

                var getList = _context.WORKOSLists.FirstOrDefault(x => x.ListCode == cardSrcCopy.ListCode && !x.IsDeleted);
                var getBoard = _context.WORKOSBoards.FirstOrDefault(x => x.BoardCode == getList.BoardCode && !x.IsDeleted);
                //Member assign
                var json = new List<JobCardAssignee>();
                var assignee = new JobCardAssignee
                {
                    CardCode = cardDesCopy.CardCode,
                    DepartmentCode = "",
                    CreatedBy = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now,
                    Role = "ROLE_LEADER",
                    GroupCode = "",
                    Item = "",
                    UserId = ESEIM.AppContext.UserId,
                    Approve = true,
                    ApproveTime = DateTime.Now,
                    Status = "ASSIGN_STATUS_WORK",
                    Branch = !string.IsNullOrEmpty(session.BranchId) ? session.BranchId : ""
                };
                _context.JobCardAssignees.Add(assignee);
                json.Add(assignee);

                var assign = _context.JobCardAssignees.Where(x => x.CardCode == cardSrcCopy.CardCode && !x.IsDeleted);
                foreach (var item in assign)
                {
                    if (item.UserId != assignee.UserId)
                    {
                        var jobAssign = new JobCardAssignee
                        {
                            CardCode = cardDesCopy.CardCode,
                            GroupCode = item.GroupCode,
                            DepartmentCode = item.DepartmentCode,
                            Item = item.Item,
                            Role = item.Role,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            UserId = item.UserId,
                            Approve = true,
                            ApproveTime = DateTime.Now,
                            Status = item.Status,
                            Branch = item.Branch
                        };
                        _context.JobCardAssignees.Add(jobAssign);
                        json.Add(jobAssign);
                    }
                }
                cardDesCopy.JsonAssign = JsonConvert.SerializeObject(json);
                cardDesCopy.LstUser = cardSrcCopy.LstUser;
                //Object relative
                var listRela = _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.CardCode == cardSrcCopy.CardCode);
                foreach (var item in listRela)
                {
                    var rela = new JcObjectIdRelative
                    {
                        CardCode = cardDesCopy.CardCode,
                        ObjTypeCode = item.ObjTypeCode,
                        ObjID = item.ObjID,
                        Relative = item.Relative,
                        Weight = item.Weight.HasValue ? item.Weight.Value : 0,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now,
                    };
                    _context.JcObjectIdRelatives.Add(rela);
                }
                //File attachment in card
                CopyFileCard(cardSrcCopy, cardDesCopy.CardCode);
                //Location work
                var location = _context.WORKOSAddressCards.Where(x => x.CardCode == cardSrcCopy.CardCode && !x.IsDeleted);
                foreach (var item in location)
                {
                    var locationCard = new WORKOSAddressCard
                    {
                        CardCode = cardDesCopy.CardCode,
                        LocationGps = item.LocationGps,
                        LocationText = item.LocationText,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now
                    };
                    _context.WORKOSAddressCards.Add(locationCard);
                }
                //Product
                var products = _context.JcProducts.Where(x => x.CardCode == cardSrcCopy.CardCode && !x.IsDeleted);
                foreach (var item in products)
                {
                    var product = new JcProduct
                    {
                        CardCode = cardDesCopy.CardCode,
                        ProductCode = item.ProductCode,
                        Quantity = item.Quantity,
                        JcAct = item.JcAct,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now
                    };
                    _context.JcProducts.Add(product);
                }
                //Service
                var services = _context.JcServices.Where(x => x.CardCode == cardSrcCopy.CardCode && !x.IsDeleted);
                foreach (var item in services)
                {
                    var service = new JcService
                    {
                        CardCode = cardDesCopy.CardCode,
                        ServiceCode = item.ServiceCode,
                        Quantity = item.Quantity,
                        JcAct = item.JcAct,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now
                    };
                    _context.JcServices.Add(service);

                }
                //Card item check
                var cardItemChecks = _context.CardItemChecks.Where(x => x.CardCode == cardSrcCopy.CardCode && !x.Flag).OrderBy(x => x.CreatedTime);
                foreach (var item in cardItemChecks)
                {
                    var code = "CHECK_LIST_" + (Guid.NewGuid().ToString());
                    var cardItem = new CardItemCheck
                    {
                        CardCode = cardDesCopy.CardCode,
                        CheckTitle = item.CheckTitle,
                        ChkListCode = code,
                        Percent = item.Percent,
                        Completed = item.Completed,
                        WeightNum = item.WeightNum,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now
                    };
                    _context.CardItemChecks.Add(cardItem);

                    //subitem
                    var subItems = _context.CardSubitemChecks.Where(x => x.ChkListCode == item.ChkListCode && !x.Flag).OrderBy(x => x.Id);
                    var maxId = _context.CardSubitemChecks.Max(x => x.Id);
                    foreach (var i in subItems)
                    {
                        maxId = maxId + 1;
                        var subItem = new CardSubitemCheck()
                        {
                            ChkListCode = code,
                            Title = i.Title,
                            Approver = ESEIM.AppContext.UserName,
                            Approve = false
                        };
                        _context.CardSubitemChecks.Add(subItem);
                        //Work sub item activity
                        var subItemActivitys = _context.WorkItemAssignStaffs.Where(x => x.CardCode.Equals(cardSrcCopy.CardCode) && !x.IsDeleted && x.CheckListCode.Equals(i.ChkListCode) && x.CheckItem.Equals(i.Id.ToString()));
                        foreach (var subAct in subItemActivitys)
                        {
                            var jobCardUser = new WorkItemAssignStaff
                            {
                                CardCode = cardDesCopy.CardCode,
                                UserId = subAct.UserId,
                                CheckItem = maxId.ToString(),
                                CheckListCode = subItem.ChkListCode,
                                CreatedBy = ESEIM.AppContext.UserName,
                                CreatedTime = DateTime.Now
                            };
                            _context.WorkItemAssignStaffs.Add(jobCardUser);
                        }
                    }
                    //WorkItem activity
                    var data = _context.WorkItemAssignStaffs.Where(x => x.CardCode.Equals(cardSrcCopy.CardCode) && !x.IsDeleted && x.CheckListCode.Equals(item.ChkListCode) && x.CheckItem == "");
                    foreach (var k in data)
                    {
                        var jobCardUser = new WorkItemAssignStaff
                        {
                            CardCode = cardDesCopy.CardCode,
                            UserId = k.UserId,
                            CheckItem = "",
                            CheckListCode = cardItem.ChkListCode,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now
                        };
                        _context.WorkItemAssignStaffs.Add(jobCardUser);
                    }
                }
                _context.SaveChanges();
                msg.Object = cardDesCopy;
                msg.Title = _stringLocalizer["CJ_MSG_COPY_CARD_SUCCESS"];
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [NonAction]
        public void CopyFileCard(WORKOSCard card, string cardDesCode)
        {
            try
            {
                var listFileByUser = _context.FilesShareObjectUsers.Where(x => !x.IsDeleted && x.UserShares.Any(p => p.Code.Equals(User.Identity.Name)))
                                                                      .Select(p => new
                                                                      {
                                                                          p.FileID,
                                                                          p.ListUserShare,
                                                                          p.UserShares
                                                                      }).ToList();
                var query1 = (from a in _context.EDMSRepoCatFiles.Where(x => x.ObjectCode == card.CardCode && x.ObjectType == EnumHelper<CardEnum>.GetDisplayValue(CardEnum.CardJob))
                              join b in _context.EDMSFiles.Where(x => !x.IsDeleted && (x.IsFileMaster == null || x.IsFileMaster == true)) on a.FileCode equals b.FileCode
                              join f in _context.EDMSRepositorys on a.ReposCode equals f.ReposCode into f1
                              from f in f1.DefaultIfEmpty()
                              join g in listFileByUser on b.FileCode equals g.FileID into g1
                              from g in g1.DefaultIfEmpty()
                              select new
                              {
                                  Id = a.Id,
                                  FileCode = b.FileCode,
                                  FileName = b.FileName,
                                  a.CatCode,
                                  FileTypePhysic = b.FileTypePhysic,
                                  Desc = b.Desc,
                                  CreatedTime = b.CreatedTime.Value,
                                  CloudFileId = b.CloudFileId,
                                  ReposName = f != null ? f.ReposName : "",
                                  ReposCode = f != null ? f.ReposCode : "",
                                  FileID = b.FileID,
                                  SizeOfFile = b.FileSize.HasValue ? b.FileSize.Value : 0,
                                  Type = "NO_SHARE",
                                  ListUserShare = g.ListUserShare,
                                  FolderId = a.FolderId,
                                  MimeType = b.MimeType,
                                  FileSize = b.FileSize,
                                  Path = a.Path
                              }).ToList();
                var query2 = (from a in _context.FilesShareObjectUsers.Where(x => !x.IsDeleted)
                              join c in _context.EDMSRepoCatFiles on a.FileID equals c.FileCode
                              join b in _context.EDMSFiles on c.FileCode equals b.FileCode
                              join f in _context.EDMSRepositorys on c.ReposCode equals f.ReposCode into f1
                              from f in f1.DefaultIfEmpty()
                              let rela = JsonConvert.DeserializeObject<ObjRelative>(a.ObjectRelative)
                              where rela != null && !string.IsNullOrEmpty(rela.ObjectInstance) && !string.IsNullOrEmpty(rela.ObjectType)
                              && rela.ObjectInstance.Equals(card.CardCode) && rela.ObjectType.Equals("JOBCARD")
                              select new
                              {
                                  Id = c.Id,
                                  FileCode = b.FileCode,
                                  FileName = b.FileName,
                                  c.CatCode,
                                  FileTypePhysic = b.FileTypePhysic,
                                  Desc = b.Desc,
                                  CreatedTime = b.CreatedTime.Value,
                                  CloudFileId = b.CloudFileId,
                                  ReposName = f != null ? f.ReposName : "",
                                  ReposCode = f != null ? f.ReposCode : "",
                                  FileID = b.FileID,
                                  SizeOfFile = b.FileSize.HasValue ? b.FileSize.Value : 0,
                                  Type = "SHARE",
                                  ListUserShare = a.ListUserShare,
                                  FolderId = c.FolderId,
                                  MimeType = b.MimeType,
                                  FileSize = b.FileSize,
                                  Path = c.Path
                              }).ToList();
                var query = query1.Union(query2);
                var files = query.DistinctBy(x => x.FileCode);
                foreach (var item in files)
                {
                    var fileNew = string.Concat(Path.GetFileNameWithoutExtension(item.FileName), "_", Guid.NewGuid().ToString().Substring(0, 8), Path.GetExtension(item.FileName));
                    var byteData = DownloadFileFromServer(item.Id);
                    var urlUpload = UploadFileToServer(byteData, item.ReposCode, item.CatCode, fileNew, item.MimeType);

                    var edmsReposCatFile = new EDMSRepoCatFile
                    {
                        FileCode = string.Concat("Card_", Guid.NewGuid().ToString()),
                        ReposCode = item.ReposCode,
                        CatCode = item.CatCode,
                        ObjectCode = cardDesCode,
                        ObjectType = EnumHelper<CardEnum>.GetDisplayValue(CardEnum.CardJob),
                        Path = item.Path,
                        FolderId = item.FolderId
                    };
                    _context.EDMSRepoCatFiles.Add(edmsReposCatFile);

                    var edms = new EDMSFile
                    {
                        FileCode = edmsReposCatFile.FileCode,
                        FileName = item.FileName,
                        Desc = "",
                        ReposCode = item.ReposCode,
                        Tags = "",
                        FileSize = item.FileSize,
                        FileTypePhysic = item.FileTypePhysic,
                        NumberDocument = "",
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now,
                        Url = urlUpload.Object.ToString(),
                        MimeType = item.MimeType,
                        CloudFileId = item.CloudFileId,
                    };
                    _context.EDMSFiles.Add(edms);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);
            }
        }

        [HttpGet]
        public object UserCreatedCard(string cardCode)
        {
            var currentUser = ESEIM.AppContext.UserName;
            var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == cardCode && !x.IsDeleted);
            var cardMapping = (from a in _context.JobCardAssignees.Where(x => !x.IsDeleted)
                               join b in _context.Users on a.UserId equals b.Id
                               where a.CardCode == data.CardCode && a.Role == "ROLE_LEADER_ACCEPTED"
                               select new
                               {
                                   b.UserName
                               }).DistinctBy(x => x.UserName);
            var check = false;
            if (currentUser == data.CreatedBy)
            {
                check = true;
            }
            else
            {
                foreach (var item in cardMapping)
                {
                    if (currentUser != item.UserName)
                    {
                        check = false;
                    }
                    else
                    {
                        check = true;
                        break;
                    }
                }
            }

            return check;
        }
        #endregion

        #region Member
        public class CardGroupOrMemberModel
        {
            public string CardCode { get; set; }
            public List<WORKOSTeamOrGroupCustom> ListObj { get; set; }
            public List<int> ListDeletedObj { get; set; }
            public List<CardMemberCustom> ListMember { get; set; }
            public List<int> ListDeleteMember { get; set; }
        }
        public class ListPageUserCard
        {
            public string Id { get; set; }
            public string Code { get; set; }
            public string Name { get; set; }
            public DateTime CreatedTime { get; set; }
            public int CountWork { get; set; }
            public bool IsCheck { get; set; }
        }
        [HttpGet]
        public object GetListPageUser(int page, int length, string name)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (page - 1) * length;
            var count = _context.Users.Where(x => (string.IsNullOrEmpty(name) || x.GivenName.ToLower().Contains(name.ToLower())) && x.Active == true
                && x.UserName != "admin" && (session.IsAllData || session.ListUser.Any(p => p.Equals(x.Id)))).Count();
            var data = _context.Users.Where(x => (string.IsNullOrEmpty(name) || (x.GivenName.ToLower().Contains(name.ToLower()))) &&
              (x.Active == true) && x.UserName != "admin" && (session.IsAllData || session.ListUser.Any(p => p.Equals(x.Id))))
              .OrderByDescending(x => x.CreatedDate).Skip(intBeginFor).Take(length)
              .Select(x => new
              {
                  x.Id,
                  Code = x.Id,
                  Name = x.GivenName,
                  CreatedTime = x.CreatedDate,
                  CountWork = (from a in _context.WORKOSCards.Where(k => k.Status != "TRASH" && !string.IsNullOrEmpty(k.Status) && !k.IsDeleted)
                               join b in _context.JobCardAssignees.Where(k => !k.IsDeleted) on a.CardCode equals b.CardCode
                               join c in _context.Users on a.CreatedBy equals c.UserName
                               let lt = a.LstUser.Split(",", StringSplitOptions.None)
                               where b.UserId.Equals(x.Id)
                               && (string.IsNullOrEmpty(session.BranchId) || session.BranchId.Equals(c.BranchId))
                               && (session.IsAllData
                                || (session.IsUser && ((!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
                                || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId)
                                || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))
                               select new
                               {
                                   a.CardCode
                               }).AsNoTracking().Distinct().Count(),
                  IsCheck = false
              });
            return (new
            {
                Tab = "Nhân viên",
                Icon = "fas fa-user",
                Total = count,
                ListData = data,
            });
        }

        [HttpPost]
        public JsonResult GetCardWithUser([FromBody] AdvanceSearchObj data)
        {
            return Json(GetCardDataInUser(data));
        }

        [NonAction]
        public object GetCardDataInUser(AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var list = (from a in _context.WORKOSLists.Where(x => !x.IsDeleted)
                        join b in _context.WORKOSCards.Where(x => !x.IsDeleted && x.Status != "TRASH") on a.ListCode equals b.ListCode
                        select new
                        {
                            a.ListID,
                            a.ListCode,
                            a.ListName,
                            a.Completed,
                            a.WeightNum,
                            a.Status,
                            a.BeginTime,
                            a.Deadline,
                            a.Background,
                            a.Order
                        }).DistinctBy(x => x.ListCode);
            var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
            {
                x.ListID,
                x.ListCode,
                x.ListName,
                x.Completed,
                x.WeightNum,
                x.Status,
                x.BeginTime,
                x.Deadline,
                x.Background,
                x.Order,
                ListCard = ListCardInOutUser(data, x.ListCode, user.BranchId, user.DepartmentId)
            });
            return new
            {
                Data = listPaging,
                Total = list.Count(),
            };
        }

        [NonAction]
        public object GetCardDataOutUser(AdvanceSearchObj data)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            int intBeginFor = (data.Page - 1) * data.Length;
            var fromDate = string.IsNullOrEmpty(data.FromDate) ? (DateTime?)null : DateTime.ParseExact(data.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(data.ToDate) ? (DateTime?)null : DateTime.ParseExact(data.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //danh sách card mới,thẻ mới
            if (fromDate == null && toDate == null && string.IsNullOrEmpty(data.CardName) && string.IsNullOrEmpty(data.Status) && string.IsNullOrEmpty(data.BranchId))
            {
                var query = (from a in _context.WORKOSCards
                             let lt = a.LstUser.Split(",", StringSplitOptions.None)
                             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
                             from g2 in g1.DefaultIfEmpty()
                             where a.CreatedDate.Date == DateTime.Today && a.IsDeleted == false
                             //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
                             && (session.IsAllData
                            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
                            || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))

                             group a by a.ListCode into g
                             select new
                             {
                                 ListCode = g.Key,
                             }).AsNoTracking();
                var list = (from a in _context.WORKOSLists
                            from b in query
                            where ((a.ListCode == b.ListCode) || (a.CreatedDate.Date == DateTime.Today) && a.IsDeleted == false)
                            select a).Distinct().AsNoTracking();
                var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
                {
                    x.ListID,
                    x.ListCode,
                    x.ListName,
                    x.Completed,
                    x.WeightNum,
                    x.Status,
                    x.BeginTime,
                    x.Deadline,
                    x.Background,
                    x.Order,
                    ListCard = _context.WORKOSCards.Where(y => y.ListCode == x.ListCode && y.CreatedDate.Date == DateTime.Today && y.IsDeleted == false).Select(y => new
                    {
                        y.CardID,
                        y.CardCode,
                        y.CardName,
                        y.Deadline,
                        y.Quantitative,
                        y.Unit,
                        y.Currency,
                        CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                        BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
                        EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
                        Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                        CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                        CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                        y.Cost,
                        y.Completed,

                    }).Distinct()
                });
                return new
                {
                    Data = listPaging,
                    Total = list.Count(),
                };
            }
            else
            {
                var query = (from a in _context.WORKOSCards
                             let lt = a.LstUser.Split(",", StringSplitOptions.None)
                             join g in _context.CardMappings on a.CardCode equals g.CardCode into g1
                             from g2 in g1.DefaultIfEmpty()
                             join b in _context.Users.Where(x => x.Active) on a.CreatedBy equals b.UserName
                             where (fromDate == null || a.BeginTime >= fromDate) &&
                             (toDate == null || (a.EndTime.HasValue ? a.EndTime.Value.Date : DateTime.Now.Date) <= toDate) &&
                             (string.IsNullOrEmpty(data.CardName) || a.CardName.ToUpper().Contains(data.CardName.ToUpper())) &&
                             ((string.IsNullOrEmpty(data.Status) && a.Status != "TRASH") || (!string.IsNullOrEmpty(a.Status) && a.Status.Equals(data.Status))) &&
                             (string.IsNullOrEmpty(data.BranchId) || b.BranchId.Equals(data.BranchId)) &&
                             a.IsDeleted == false
                             //(session.IsAllData || g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName)
                             && (session.IsAllData
                            || (session.IsUser && (g2.GroupUserCode == user.DepartmentId || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName))
                            || (session.IsBranch && (!string.IsNullOrEmpty(a.LstUser) && lt.Any(k => k == session.UserId) || a.CreatedBy == session.UserName || session.ListUserOfBranch.Count() > 0 && session.ListUserOfBranch.Any(k => k == a.CreatedBy))))

                             group a by a.ListCode into g
                             select new
                             {
                                 ListCode = g.Key,
                                 ListCard = g.Select(y => new
                                 {
                                     y.CardID,
                                     y.CardCode,
                                     y.CardName,
                                     y.Deadline,
                                     y.Quantitative,
                                     y.Unit,
                                     y.Currency,
                                     y.Status,
                                     BeginTime = y.BeginTime.ToString("dd/MM/yyyy"),
                                     EndTime = y.EndTime.HasValue ? y.EndTime.Value.ToString("dd/MM/yyyy") : "",
                                     y.Cost,
                                     y.Completed,

                                 }).Distinct()
                             }).AsNoTracking();
                var list = (from a in query
                            join b in _context.WORKOSLists on a.ListCode equals b.ListCode
                            where b.IsDeleted == false
                            select new { a, b });
                var listPaging = list.Skip(intBeginFor).Take(data.Length).Select(x => new
                {
                    x.b.ListID,
                    x.b.ListCode,
                    x.b.ListName,
                    x.b.Completed,
                    x.b.WeightNum,
                    x.b.Status,
                    x.b.BeginTime,
                    x.b.Deadline,
                    x.b.Background,
                    x.b.Order,
                    ListCard = x.a.ListCard.Select(y => new
                    {
                        y.CardID,
                        y.CardCode,
                        y.CardName,
                        y.Deadline,
                        y.Quantitative,
                        y.Unit,
                        y.Currency,
                        CurrencyValue = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Currency).ValueSet ?? "",
                        y.BeginTime,
                        y.EndTime,
                        Status = _context.CommonSettings.FirstOrDefault(z => z.CodeSet == y.Status).ValueSet ?? "",
                        CountCheckListDone = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Completed == 100 && z.Flag == false).Count(),
                        CountCheckList = _context.CardItemChecks.Where(z => z.CardCode == y.CardCode && z.Flag == false).Count(),
                        y.Cost,
                        y.Completed,

                    })
                });
                return new
                {
                    Data = listPaging,
                    Total = list.Count(),
                };
            }
        }

        [NonAction]
        private List<ListAndCard> ListCardInOutUser(AdvanceSearchObj dataSearch, string listCode, string branch, string department)
        {
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var session = HttpContext.GetSessionUser();
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            var listObject = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            if (dataSearch.ListObjCode.Any())
            {
                listObject = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }

            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName",
                "@ListUserOfBranch", "@UserId", "@BranchId", "@Status", "@Object", "@ListCode", "@CardName", "@ListObjCode", "@boardCode" };
            object[] val = new object[] {dataSearch.CurrentPageList, 10,fromDatePara, toDatePara , session.IsAllData, session.IsUser, session.IsBranch,
                !string.IsNullOrEmpty(department) ? department : "", session.UserName, listUserOfBranch, session.UserId, !string.IsNullOrEmpty(branch) ? branch : "",
                 dataSearch.Status, dataSearch.Object, listCode, dataSearch.CardName, listObject, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_LIST_AND_CARD_USER", param, val);
            var query = CommonUtil.ConvertDataTable<ListAndCard>(rs);
            return query;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardUser(AdvanceSearchObj dataSearch)
        {
            var query = new List<GridCardJtable>();
            if (dataSearch.ListObjCode.Any())
            {
                query = GetGirdCardInUser(dataSearch);
            }
            else
            {
                query = GetGirdCardOutUser(dataSearch);
            }
            return query;
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardInUser(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }

            if (string.IsNullOrEmpty(dataSearch.CardName) && string.IsNullOrEmpty(dataSearch.FromDate)
                && string.IsNullOrEmpty(dataSearch.ToDate) && string.IsNullOrEmpty(dataSearch.Status)
                && string.IsNullOrEmpty(dataSearch.WorkflowInstCode))
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                "@UserId", "@listObjCode", "@Branch"};
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length, session.IsAllData, session.IsUser, session.IsBranch,
                !string.IsNullOrEmpty(session.DepartmentCode) ? session.DepartmentCode : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                !string.IsNullOrEmpty(session.BranchId) ? session.BranchId : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_USER_NO_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }
            else
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@IsAllData", "@IsUser", "@IsBranch", "@DepartmentId", "@UserName", "@ListUserOfBranch",
                    "@UserId", "@listObjCode", "@Branch", "@CardName", "@FromDate", "@ToDate", "@Status", "@WorkflowInstCode"};
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length, session.IsAllData, session.IsUser, session.IsBranch,
                    !string.IsNullOrEmpty(session.DepartmentCode) ? session.DepartmentCode : "", session.UserName, listUserOfBranch, session.UserId, listObjCode,
                    !string.IsNullOrEmpty(session.BranchId) ? session.BranchId : "", dataSearch.CardName, fromDatePara, toDatePara,
                    dataSearch.Status, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_IN_USER_WITH_CONDITION", param, val);
                var query = CommonUtil.ConvertDataTable<GridCardJtable>(rs);
                return query;
            }
        }

        [NonAction]
        public List<GridCardJtable> GetGirdCardOutUser(AdvanceSearchObj dataSearch)
        {
            return new List<GridCardJtable>();
        }

        [HttpPost]
        public object GetListUser()
        {
            var query = from a in _context.Users
                        join b in _context.AdDepartments.Where(x => !x.IsDeleted && x.IsEnabled) on a.DepartmentId equals b.DepartmentCode
                        select new
                        {
                            UserId = a.Id,
                            UserName = a.UserName,
                            GivenName = a.GivenName,
                            Type = 0,
                            DepartmentId = b.DepartmentId,
                            RoleSys = (from m in _context.UserRoles.Where(x => x.UserId.Equals(a.Id))
                                       join n in _context.Roles on m.RoleId equals n.Id
                                       select n).FirstOrDefault() != null ? (from m in _context.UserRoles.Where(x => x.UserId.Equals(a.Id))
                                                                             join n in _context.Roles on m.RoleId equals n.Id
                                                                             select n).FirstOrDefault().Title : "Nhân viên",
                            Priority = 0,
                            DepartmentName = b.Title,
                            Branch = a.BranchId
                        };
            return query;
        }

        [HttpPost]
        public object GetListUserOfBranch(string branch)
        {
            var query = from a in _context.AdUserDepartments.Where(x => !x.IsDeleted && x.IsMain)
                        join b in _context.Users.Where(x => x.BranchId == branch) on a.UserId equals b.Id
                        join c in _context.Roles.Where(x => x.Status) on a.RoleId equals c.Id
                        join d in _context.AdDepartments.Where(x => !x.IsDeleted && x.IsEnabled) on b.DepartmentId equals d.DepartmentCode
                        select new
                        {
                            UserId = b.Id,
                            b.GivenName,
                            b.UserName,
                            RoleSys = c.Title,
                            Branch = a.Branch,
                            DepartmentName = d.Title
                        };
            return query;
        }
        #endregion

        #region CheckList
        [HttpPost]
        public JsonResult AddCheckList([FromBody] CardItemCheck obj)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                CardItemCheck data = null;
                var getSumWeightNum = _context.CardItemChecks.Where(x => x.CardCode == obj.CardCode && x.Flag == false).Sum(x => x.WeightNum);
                if ((getSumWeightNum + obj.WeightNum) > 100)
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_MAXIMUM_WEIGHT"] + " " + (100 - getSumWeightNum) + " % !";
                }
                else
                {
                    var hasWf = _context.WfActivityObjectProccessings.FirstOrDefault(x => !x.IsDeleted
                                && x.ObjectType.Equals(EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard))
                                && x.ObjectInst.Equals(obj.CardCode));

                    if (hasWf == null)
                    {
                        data = new CardItemCheck()
                        {
                            CardCode = obj.CardCode,
                            CheckTitle = obj.CheckTitle,
                            WeightNum = obj.WeightNum,
                            ChkListCode = obj.ChkListCode,
                            WfInstCode = "",
                            ActInstCode = "",
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now
                        };
                        _context.CardItemChecks.Add(data);
                    }
                    else
                    {
                        if (!string.IsNullOrEmpty(hasWf.WfInstCode))
                        {
                            var wfInst = _context.WorkflowInstances.FirstOrDefault(x => !x.IsDeleted.Value
                                && x.WfInstCode.Equals(hasWf.WfInstCode));
                            if (wfInst != null)
                            {
                                var lstAssign = new List<AssignTemp>();
                                var acts = _context.ActivityInstances.Where(x => !x.IsDeleted && x.WorkflowCode.Equals(wfInst.WfInstCode));
                                foreach (var item in acts)
                                {
                                    var assigns = _context.ExcuterControlRoleInsts.Where(x => !x.IsDeleted
                                        && x.ActivityCodeInst.Equals(item.ActivityInstCode)).Select(x => new AssignTemp
                                        {
                                            UserId = x.UserId,
                                            ActInstCode = x.ActivityCodeInst
                                        }).ToList();
                                    lstAssign.AddRange(assigns);
                                }

                                data = new CardItemCheck()
                                {
                                    CardCode = obj.CardCode,
                                    CheckTitle = obj.CheckTitle,
                                    WeightNum = obj.WeightNum,
                                    ChkListCode = obj.ChkListCode,
                                    WfInstCode = wfInst.WfInstCode,
                                    ActInstCode = string.Join(",", lstAssign.Where(x => x.UserId.Equals(ESEIM.AppContext.UserId)).Select(x => x.ActInstCode)),
                                    CreatedBy = ESEIM.AppContext.UserName,
                                    CreatedTime = DateTime.Now
                                };
                                _context.CardItemChecks.Add(data);
                            }
                        }
                    }
                    msg.Object = _cardService.UpdatePercentParentItem(obj.CardCode);
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "ADD",
                        IdObject = "ITEMCHECK",
                        IsCheck = true,
                        CardCode = obj.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = string.Concat(obj.CheckTitle?.Take(20) ?? "")
                    };
                    _context.CardUserActivities.Add(activity);
                    UpdateChangeCard(obj.CardCode);
                    _context.SaveChanges();
                    if (data != null)
                    {
                        msg.ID = data.Id;
                    }
                    msg.Title = _sharedResources["COM_ADD_SUCCESS"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_ADD_FAILED"), _stringLocalize["")); //"Có lỗi xảy ra khi thêm!";
            }
            return Json(msg);
        }
        [HttpPost]
        public JsonResult GetMaxWeightNumCheckList(string CardCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var getSumWeightNum = _context.CardItemChecks.Where(x => x.CardCode == CardCode && x.Flag == false).Sum(x => x.WeightNum);
                if (getSumWeightNum > 100)
                {
                    msg.Error = true;
                    //msg.Title = "Trọng số hiện tại đã vượt qua 100%!";
                    msg.Title = _stringLocalizer["CJ_MSG_WEIGHT_OVER_HUNDRED_PERCENT"];
                }
                else
                {
                    var maxWeightNum = 100 - getSumWeightNum;
                    msg.Object = maxWeightNum;
                }
            }
            catch (Exception)
            {
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }
        [HttpPost]
        public JsonResult GetCheckLists(string CardCode)
        {
            var data = (from x in _context.CardItemChecks.Where(x => !x.Flag && x.CardCode == CardCode)
                        select new ItemRollback
                        {
                            Id = x.Id,
                            ChkListCode = x.ChkListCode,
                            CheckTitle = x.CheckTitle,
                            Completed = x.Completed,
                            WeightNum = x.WeightNum,
                            checkItem = false,
                            TitleSubItemChk = "",
                            CreatedBy = x.CreatedBy,
                            CreatedTime = x.CreatedTime,
                            Constraint = x.Constraint,
                            Note = x.Note,
                            ListObject = "",
                            ListUserItemChk = (from a in _context.WorkItemAssignStaffs
                                               join b in _context.Users on a.UserId equals b.Id
                                               where a.CheckListCode == x.ChkListCode && a.IsDeleted == false && (string.IsNullOrEmpty(a.CheckItem))
                                               select new UserAssignItemRollBack
                                               {
                                                   ID = a.ID,
                                                   UserId = b.Id,
                                                   UserName = b.UserName,
                                                   GivenName = b.GivenName,
                                                   EstimateTime = a.EstimateTime,
                                                   Status = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == a.Unit && !y.IsDeleted).ValueSet,
                                                   Unit = a.Unit,
                                                   CreatedBy = a.CreatedBy,
                                                   CreatedTime = a.CreatedTime
                                               }).ToList(),
                            ListSubItem = _context.CardSubitemChecks.Where(y => y.ChkListCode == x.ChkListCode && y.Flag == false)
                       .Select(y => new SubItemRollBack
                       {
                           Id = y.Id,
                           Title = y.Title,
                           Approve = y.Approve,
                           ApprovedTime = y.ApprovedTime,
                           Completed = y.Completed,
                           Approver = y.Approver,
                           WeightNum = y.WeightNum,
                           ListUserSubItem = (from a in _context.WorkItemAssignStaffs
                                              join b in _context.Users on a.UserId equals b.Id
                                              where a.CheckItem == y.Id.ToString() && a.IsDeleted == false
                                              select new UserAssignItemRollBack
                                              {
                                                  ID = a.ID,
                                                  UserId = b.Id,
                                                  UserName = b.UserName,
                                                  GivenName = b.GivenName,
                                                  EstimateTime = a.EstimateTime,
                                                  CreatedBy = a.CreatedBy,
                                                  CreatedTime = a.CreatedTime,
                                                  Status = _context.CommonSettings.FirstOrDefault(k => k.CodeSet == a.Unit && !k.IsDeleted).ValueSet,
                                                  Unit = a.Unit
                                              }).ToList(),
                       }).OrderBy(n => n.Id).ToList()
                        }).DistinctBy(x => x.ChkListCode).OrderByDescending(x => x.CreatedTime).ToList();


            var jcIds = _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.CardCode.Equals(CardCode));
            foreach (var item in data)
            {
                var jcObjs = jcIds.Where(x => x.ItemCode.Equals(item.ChkListCode));
                var listObjName = new List<string>();
                foreach (var jc in jcObjs)
                {
                    listObjName.Add(GetObjectRelative(jc.ObjID, jc.ObjTypeCode));
                }
                item.ListObject = string.Join(", ", listObjName.Select(x => x));
            }

            return Json(data);
        }

        [NonAction]
        public string GetObjectRelative(string objCode, string objType)
        {
            var data = _context.JcObjectTypes.FirstOrDefault(x => !x.IsDeleted && x.ObjTypeCode == objType);
            if (data != null)
            {
                List<ObjTempRela> listTemp = new List<ObjTempRela>();

                using (var command = _context.Database.GetDbConnection().CreateCommand())
                {
                    _context.Database.OpenConnection();
                    command.CommandText = data.ScriptSQL;
                    using (var result = command.ExecuteReader())
                    {
                        while (result.Read())
                        {
                            if (result != null)
                            {
                                if (data.ObjTypeCode == "CONTRACT_PO")
                                {
                                    if (!result.IsDBNull(4) && !result.IsDBNull(3))
                                    {
                                        var objTemp = new ObjTempRela
                                        {
                                            ID = result.GetInt32(0),
                                            Code = result.GetString(4),
                                            Name = result.GetString(3)
                                        };
                                        if (objTemp != null)
                                        {
                                            listTemp.Add(objTemp);
                                        }
                                    }
                                }

                                else if (data.ObjTypeCode == "NOT_WORK")
                                {
                                    if (!result.IsDBNull(1) && !result.IsDBNull(8))
                                    {
                                        var user = _context.Users.FirstOrDefault(x => x.Id.Equals(result.GetString(8)));
                                        var objTemp = new ObjTempRela
                                        {
                                            ID = result.GetInt32(0),
                                            Code = result.GetString(1),
                                            Name = user != null ? user.GivenName + " báo nghỉ" : ""
                                        };
                                        if (objTemp != null)
                                        {
                                            listTemp.Add(objTemp);
                                        }
                                    }
                                }

                                else
                                {
                                    if (!result.IsDBNull(1) && !result.IsDBNull(2))
                                    {
                                        var objTemp = new ObjTempRela
                                        {
                                            ID = result.GetInt32(0),
                                            Code = result.GetString(1),
                                            Name = result.GetString(2)
                                        };
                                        if (objTemp != null)
                                        {
                                            listTemp.Add(objTemp);
                                        }
                                    }
                                }

                            }

                        }
                    }
                    _context.Database.CloseConnection();
                }
                var name = listTemp.FirstOrDefault(x => x.Code == objCode) != null ? listTemp.FirstOrDefault(x => x.Code == objCode).Name : "";
                return name;
            }
            else
            {
                return "";
            }
        }

        [HttpPost]
        public string GetActTitle(string acts)
        {
            var actCode = acts.Split(",", StringSplitOptions.None);
            var data = from a in actCode
                       join b in _context.ActivityInstances.Where(x => !x.IsDeleted) on a equals b.ActivityInstCode
                       select new
                       {
                           Title = b.Title
                       };
            return string.Join(", ", data.Select(x => x.Title));
        }

        [HttpPost]
        public JsonResult GetListItemActivity(string itemCode)
        {
            var data = (from a in _context.SessionWorkResults
                        join c in _context.SessionWorkResults on a.WorkSession equals c.WorkSession
                        join d in _context.SessionWorks on c.WorkSession equals d.Session
                        join e in _context.CardItemChecks on d.Item equals e.ChkListCode
                        where a.ItemWorkList.Equals(itemCode) && c.IsDeleted == false
                        select new
                        {
                            Id = c.Id,
                            StartTime = c.StartTime,
                            EndTime = c.EndTime,
                            ProgressFromLeader = c.ProgressFromLeader,
                            ProgressFromStaff = c.ProgressFromStaff,
                            CheckTitle = e.CheckTitle,
                            ShiftCode = c.ShiftCode,
                            TimeCheckIn = _context.ShiftLogs.FirstOrDefault(z => z.ShiftCode == c.ShiftCode).ChkinTime.Value.ToString("HH:mm dd/MM/yyyy"),
                            TimeCheckOut = _context.ShiftLogs.FirstOrDefault(z => z.ShiftCode == c.ShiftCode).ChkoutTime.HasValue ? _context.ShiftLogs.FirstOrDefault(z => z.ShiftCode == c.ShiftCode).ChkoutTime.Value.ToString("HH:mm dd/MM/yyyy") : "",
                            CreatedBy = c.CreatedBy,
                            UserAssessor = !string.IsNullOrEmpty(c.UserAssessor) ? (_context.Users.FirstOrDefault(x => x.Active && x.UserName.Equals(c.UserAssessor)) != null ? _context.Users.FirstOrDefault(x => x.Active && x.UserName.Equals(c.UserAssessor)).GivenName : "") : "",
                            CreatedTime = a.CreatedTime.ToString("dd/MM/yyyy HH:mm"),
                            TimeOrder = a.CreatedTime,
                            UserName = _context.Users.FirstOrDefault(x => x.Active && x.UserName.Equals(c.CreatedBy)) != null ? _context.Users.FirstOrDefault(x => x.Active && x.UserName.Equals(c.CreatedBy)).GivenName : ""
                        }).OrderByDescending(x => x.TimeOrder).DistinctBy(y => y.Id);
            return Json(data);
        }

        [HttpPost]
        public JsonResult UpdateCheckList([FromBody] CardItemCheck obj)
        {
            var msg = new JMessage();
            try
            {
                var data = _context.CardItemChecks.FirstOrDefault(x => !x.Flag && x.ChkListCode == obj.ChkListCode);
                var getSumWeightNum = _context.CardItemChecks.Where(x => x.CardCode == obj.CardCode && x.Flag == false).Sum(x => x.WeightNum);
                if ((getSumWeightNum - data.WeightNum + obj.WeightNum) > 100)
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_MAXIMUM_WEIGHT"] + " " + (100 - getSumWeightNum - data.WeightNum) + " % !";
                }
                else
                {
                    if (data != null)
                    {
                        data.CheckTitle = obj.CheckTitle;
                        data.WeightNum = obj.WeightNum;
                        if (!string.IsNullOrEmpty(obj.Note))
                            data.Note = obj.Note;
                        _context.CardItemChecks.Update(data);
                        msg.Object = _cardService.UpdatePercentParentItem(data.CardCode);
                        UpdateChangeCard(data.CardCode);
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "UPDATE",
                            IdObject = "ITEMCHECK",
                            IsCheck = true,
                            CardCode = obj.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = "Đầu mục việc " + string.Concat(data.CheckTitle?.Take(20) ?? "")
                        };
                        _context.CardUserActivities.Add(activity);
                        _context.SaveChanges();
                        msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                    }
                }
            }
            catch (Exception ex)
            {
                msg.Title = _sharedResources["COM_MSG_ERR"];
                msg.Error = true;
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult AddCheckItem([FromBody] CardSubitemCheck obj)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                //var getSumWeightNum = _context.CardSubitemChecks.Where(x => x.ChkListCode == CheckCode && x.Flag == false).Sum(x => x.WeightNum);
                //if ((getSumWeightNum + WeightNum) > 100)
                //{
                //    msg.Error = true;
                //    msg.Title = "Trọng số tối đa cho phép " + (100 - getSumWeightNum) + "%!";
                //}
                //else
                //{
                //var subItemCheck = _context.CardSubitemChecks.Where(x => x.ChkListCode == CheckCode && x.Flag == false);
                var data = new CardSubitemCheck()
                {
                    ChkListCode = obj.ChkListCode,
                    Title = obj.Title,
                    Approver = ESEIM.AppContext.UserName,
                    Approve = false
                };
                var itemCheck = _context.CardItemChecks.FirstOrDefault(x => x.ChkListCode == obj.ChkListCode);
                _context.CardSubitemChecks.Add(data);
                msg.Object = _cardService.UpdatePercentParentSubItem(data.ChkListCode);

                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    Action = "ADD",
                    IdObject = "SUBITEM",
                    IsCheck = true,
                    CardCode = itemCheck.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = string.Concat(obj.Title?.Take(20) ?? "")
                };
                _context.CardUserActivities.Add(activity);
                UpdateChangeCard(itemCheck.CardCode);
                _context.SaveChanges();
                //msg.Title = String.Format(_stringLocalize["COM_MSG_ADD_SUCCESS"), _stringLocalize[""));//"Thêm thành công!";
                msg.Title = _sharedResources["COM_ADD_SUCCESS"];
                msg.ID = data.Id;
                //}
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_ADD_FAILED"), _stringLocalize["")); //"Có lỗi xảy ra khi thêm!";
            }
            return Json(msg);
        }
        [HttpPost]
        public JsonResult GetCheckItem(string CheckCode)
        {
            //var data = _context.CardSubitemChecks.Where(x => x.ChkListCode.Equals(CheckCode) && x.Flag == false).ToList();
            var data = _context.CardSubitemChecks.Where(x => x.ChkListCode.Equals(CheckCode) && x.Flag == false).Select(x => new
            {
                x.Id,
                x.Title,
                x.WeightNum,
                x.Approve,
                DisableApprove = false,
                ListUserSubItem = (from a in _context.WorkItemAssignStaffs
                                   join b in _context.Users on a.UserId equals b.Id
                                   where a.CheckItem.Equals(x.Id.ToString()) && !a.IsDeleted
                                   select new
                                   {
                                       a.UserId,
                                       b.GivenName
                                   }),

            });
            return Json(data);
        }
        [HttpPost]
        public JsonResult DeleteCheckItem(int Id)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var data = _context.CardSubitemChecks.FirstOrDefault(x => x.Id == Id);
                var itemCheck = _context.CardItemChecks.FirstOrDefault(x => x.ChkListCode == data.ChkListCode);
                var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(itemCheck.CardCode));

                var session = HttpContext.GetSessionUser();
                if (card.CreatedBy == session.UserName || itemCheck.CreatedBy == session.UserName || session.IsAllData)
                {
                    data.Flag = true;
                    _context.CardSubitemChecks.Update(data);
                    //_context.CardSubitemChecks.Load();
                    msg.Object = _cardService.UpdatePercentParentSubItem(data.ChkListCode);
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "DELETE",
                        IdObject = "SUBITEM",
                        IsCheck = true,
                        CardCode = itemCheck.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = string.Concat(data.Title?.Take(20) ?? "")
                    };
                    _context.CardUserActivities.Add(activity);
                    UpdateChangeCard(itemCheck.CardCode);
                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_DELETE_SUCCESS"];
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_CANNOT_DELETE"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                //msg.Title = String.Format(_stringLocalize["COM_MSG_DELETE_FAIL"), _stringLocalize[""));// "Có lỗi xảy ra!";
            }
            return Json(msg);
        }
        [HttpPost]
        public JsonResult ChangeCheckTitle([FromBody] CardItemCheck obj)
        {
            var msg = new JMessage() { Error = true };
            try
            {
                var data = _context.CardItemChecks.FirstOrDefault(x => x.ChkListCode.Equals(obj.ChkListCode));
                if (data.CheckTitle.Equals(obj.CheckTitle))
                {
                    return null;
                }
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    Action = "UPDATE",
                    IdObject = "ITEMCHECK",
                    IsCheck = true,
                    CardCode = obj.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = "Tiêu đề từ " + string.Concat(data.CheckTitle?.Take(20) ?? "") + "... sang " + string.Concat(obj.CheckTitle?.Take(20) ?? "") + "..."
                };
                _context.CardUserActivities.Add(activity);
                data.CheckTitle = obj.CheckTitle;
                _context.CardItemChecks.Update(data);
                UpdateChangeCard(data.CardCode);
                _context.SaveChanges();

                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_SUCCESS"), _stringLocalize[""));// "Cập nhật thành công!";
                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                msg.Error = false;
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_FAILED"), _stringLocalize[""));// "Có lỗi xảy ra!";
                return Json(msg);
            }
        }
        [HttpPost]
        public JsonResult ChangeItemStatus(int Id)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var data = _context.CardSubitemChecks.FirstOrDefault(x => x.Id == Id);
                var itemCheck = _context.CardItemChecks.FirstOrDefault(x => x.ChkListCode == data.ChkListCode);
                if (data.Approve != true)
                {
                    data.Approve = true;
                    data.Approver = ESEIM.AppContext.UserName;
                    data.ApprovedTime = DateTime.Now;
                    data.Completed = 100;
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "SUBITEM",
                        IsCheck = true,
                        CardCode = itemCheck.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Tích chọn hoàn thành đầu mục việc con " + string.Concat(data.Title?.Take(20) ?? "") + "..."
                    };
                    _context.CardUserActivities.Add(activity);
                }
                else
                {
                    data.Approve = false;
                    data.Approver = null;
                    data.ApprovedTime = null;
                    data.Completed = 0;
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "SUBITEM",
                        IsCheck = true,
                        CardCode = itemCheck.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Bỏ tích chọn hoàn thành đầu mục việc con " + string.Concat(data.Title?.Take(20) ?? "") + "..."
                    };
                    _context.CardUserActivities.Add(activity);
                }
                _context.CardSubitemChecks.Update(data);
                //_context.CardSubitemChecks.Load();
                msg.Object = _cardService.UpdatePercentParentSubItem(data.ChkListCode);
                //UpdateChangeCard(itemCheck.CardCode);
                _context.SaveChanges();
                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_FAILED"), _stringLocalize["")); // "Có lỗi xảy ra!";
            }
            return Json(msg);
        }
        [HttpPost]
        public JsonResult ChangeItemTitle([FromBody] CardSubitemCheck obj)
        {
            var msg = new JMessage() { Error = true };
            try
            {
                var data = _context.CardSubitemChecks.FirstOrDefault(x => x.Id == obj.Id);
                if (data.Title.Equals(obj.Title))
                {
                    return null;
                }
                else if (obj.Title.Length > 50)
                {
                    msg.Error = true;
                    msg.Title = "Vui lòng nhập tiêu đề nhỏ hơn 50 ký tự";
                    return Json(msg);
                }

                var itemCheck = _context.CardItemChecks.FirstOrDefault(x => x.ChkListCode == data.ChkListCode);
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    Action = "UPDATE",
                    IdObject = "SUBITEM",
                    IsCheck = true,
                    CardCode = itemCheck.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = "Tiêu đề từ " + string.Concat(data.Title?.Take(20) ?? "") + "... sang " + string.Concat(obj.Title?.Take(20) ?? "")
                };
                _context.CardUserActivities.Add(activity);

                data.Title = obj.Title;
                _context.CardSubitemChecks.Update(data);
                UpdateChangeCard(itemCheck.CardCode);

                _context.SaveChanges();
                msg.Error = false;
                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                return Json(msg);
            }
        }
        [HttpPost]
        public JsonResult DeleteCheckList(string CheckCode)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            var userName = ESEIM.AppContext.UserName;
            try
            {
                //deleted item
                var session = HttpContext.GetSessionUser();
                var data = _context.CardItemChecks.FirstOrDefault(x => x.ChkListCode.Equals(CheckCode));
                var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(data.CardCode));
                if (card.CreatedBy == userName || data.CreatedBy == userName || session.IsAllData)
                {
                    var checkWorkItem = _context.SessionWorks.FirstOrDefault(x => !x.IsDeleted && x.Item == data.ChkListCode);
                    if (checkWorkItem == null)
                    {
                        data.Flag = true;
                        data.DeletedBy = userName;
                        data.DeletedTime = DateTime.Now;
                        _context.CardItemChecks.Update(data);
                        //_context.CardItemChecks.Load();

                        //Remove constraint
                        var itemChks = _context.CardItemChecks.Where(x => !x.Flag && x.CardCode.Equals(data.CardCode)
                                && x.ChkListCode != data.ChkListCode);
                        foreach (var item in itemChks)
                        {
                            if (!string.IsNullOrEmpty(item.Constraint))
                            {
                                var arrConstraint = item.Constraint.Split(",", StringSplitOptions.None).ToList();
                                foreach (var constraint in arrConstraint)
                                {
                                    if (constraint.Equals(data.ChkListCode))
                                    {
                                        arrConstraint.Remove(constraint);
                                        break;
                                    }
                                }
                                item.Constraint = string.Join(",", arrConstraint.Select(x => x));
                            }
                        }

                        //deleted subitem
                        var listSubItem = _context.CardSubitemChecks.Where(x => x.ChkListCode == data.ChkListCode).AsNoTracking().ToList();
                        listSubItem.ForEach(x => x.Flag = false);
                        _context.CardSubitemChecks.UpdateRange(listSubItem);

                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "DELETE",
                            IdObject = "ITEMCHECK",
                            IsCheck = true,
                            CardCode = data.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = string.Concat(data.CheckTitle?.Take(20) ?? "") + "..."
                        };
                        _context.CardUserActivities.Add(activity);

                        msg.Object = _cardService.UpdatePercentParentItem(data.CardCode);
                        UpdateChangeCard(data.CardCode);
                        _context.SaveChanges();
                        //msg.Title = String.Format(_stringLocalize["COM_MSG_DELETE_SUCCESS"), _stringLocalize[""));// "Xóa thành công";
                        msg.Title = _sharedResources["COM_DELETE_SUCCESS"];
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["CJ_MSG_DEL_ITEM_CHECK_PROGRESS"];
                    }
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_CANNOT_DELETE"];
                }
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_DELETE_FAIL"), _stringLocalize[""));//"Có lỗi khi xóa!";
            }
            return Json(msg);
        }

        //Constraint item check
        [HttpPost]
        public JsonResult GetItemConstraint(string itemCode, string cardCode)
        {
            var data = _context.CardItemChecks.Where(x => !x.Flag && x.ChkListCode != itemCode && x.CardCode.Equals(cardCode))
                .Select(x => new { Code = x.ChkListCode, Name = x.CheckTitle });
            return Json(data);
        }

        [HttpPost]
        public JsonResult GetAllConstraint(string itemCode)
        {
            var data = _context.CardItemChecks.FirstOrDefault(x => x.ChkListCode.Equals(itemCode) && !x.Flag);
            var listConstraint = new List<ViewConstraint>();
            if (data != null)
            {
                if (!string.IsNullOrEmpty(data.Constraint))
                {
                    var constraintArr = data.Constraint.Split(",");
                    listConstraint = (from a in _context.CardItemChecks.Where(x => !x.Flag)
                                      join b in constraintArr on a.ChkListCode equals b
                                      select new ViewConstraint
                                      {
                                          ChkListCode = a.ChkListCode,
                                          Title = a.CheckTitle
                                      }).ToList();
                }
            }
            return Json(listConstraint);
        }

        [HttpPost]
        public JsonResult AddConstraint(string itemCode, string constraint)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var data = _context.CardItemChecks.FirstOrDefault(x => !x.Flag && x.ChkListCode.Equals(itemCode));
                if (data != null)
                {
                    if (string.IsNullOrEmpty(data.Constraint))
                    {
                        data.Constraint = constraint + ",";
                        _context.CardItemChecks.Update(data);
                        UpdateChangeCard(data.CardCode);
                        _context.SaveChanges();
                        msg.Title = _sharedResources["COM_ADD_SUCCESS"];
                    }
                    else
                    {
                        var constraints = data.Constraint.Split(",");
                        var isExist = false;
                        foreach (var item in constraints)
                        {
                            if (item.Equals(constraint))
                            {
                                isExist = true;
                                break;
                            }
                        }
                        if (!isExist)
                        {
                            data.Constraint += constraint + ",";
                            _context.CardItemChecks.Update(data);
                            UpdateChangeCard(data.CardCode);
                            _context.SaveChanges();
                            msg.Title = _sharedResources["COM_ADD_SUCCESS"];
                        }
                        else
                        {
                            msg.Error = true;
                            msg.Title = "Đầu mục việc đã tồn tại";
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult DeleteConstraint(string itemCode, string constraint)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var data = _context.CardItemChecks.FirstOrDefault(x => !x.Flag && x.ChkListCode.Equals(itemCode));
                if (data != null)
                {
                    if (!string.IsNullOrEmpty(data.Constraint))
                    {
                        var listItem = data.Constraint.Split(",");
                        var list = new List<string>(listItem);
                        foreach (var item in list)
                        {
                            if (item.Equals(constraint))
                            {
                                list.Remove(item);
                                break;
                            }
                        }
                        data.Constraint = list != null ? string.Join(",", list) : null;
                        _context.CardItemChecks.Update(data);
                        UpdateChangeCard(data.CardCode);
                        _context.SaveChanges();
                        msg.Title = _sharedResources["COM_DELETE_SUCCESS"];
                    }
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public bool CheckConstraintSuccess(string itemCode)
        {
            var checkSuccess = true;
            var itemCheck = _context.CardItemChecks.FirstOrDefault(x => !x.Flag && x.ChkListCode.Equals(itemCode));
            if (itemCheck != null)
            {
                if (!string.IsNullOrEmpty(itemCheck.Constraint))
                {
                    var constraintArr = itemCheck.Constraint.Split(",");
                    foreach (var item in constraintArr)
                    {
                        var query = (from b in _context.SessionWorkResults.Where(x => !x.IsDeleted)
                                     join c in _context.SessionWorkResults.Where(x => !x.IsDeleted) on b.WorkSession equals c.WorkSession
                                     select new
                                     {
                                         b.ItemWorkList,
                                         b.CreatedBy,
                                         c.ProgressFromLeader,
                                         b.CreatedTime
                                     }).OrderByDescending(x => x.CreatedTime);
                        if (query.Any())
                        {
                            var progress = query.FirstOrDefault();
                            if (progress.ProgressFromLeader != 100)
                            {
                                checkSuccess = false;
                                break;
                            }
                        }
                        else
                        {
                            checkSuccess = false;
                            break;
                        }
                    }
                }
            }
            return checkSuccess;
        }

        [HttpPost]
        public bool CheckItemSuccess(string itemCode, string cardCode)
        {
            var isSuccess = true;
            var cardCheck = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode == cardCode);
            var itemCheck = _context.CardItemChecks.FirstOrDefault(x => !x.Flag && x.ChkListCode.Equals(itemCode));
            if (itemCheck != null && cardCheck != null)
            {
                if (itemCheck.Completed != 100)
                    isSuccess = false;
                //if (isSuccess)
                //{
                //    var progressItem = (from a in _context.SessionWorkResults.Where(x => x.ItemWorkList.Equals(itemCode))
                //                        join c in _context.SessionWorkResults.Where(x => !x.IsDeleted) on a.WorkSession equals c.WorkSession
                //                        select new
                //                        {
                //                            a.ItemWorkList,
                //                            a.CreatedBy,
                //                            c.ProgressFromLeader,
                //                            a.CreatedTime
                //                        }).OrderByDescending(x => x.CreatedTime).GroupBy(x => new { x.ItemWorkList, x.CreatedBy });
                //    if (progressItem.Any())
                //    {
                //        foreach (var item in progressItem)
                //        {
                //            var progress = item.FirstOrDefault().ProgressFromLeader;
                //            if (progress != 100)
                //            {
                //                isSuccess = false;
                //            }
                //        }
                //    }
                //    else
                //    {
                //        isSuccess = false;
                //    }
                //}
            }
            else
            {
                isSuccess = false;
            }
            return isSuccess;
        }

        [HttpPost]
        public JsonResult DeleteItemWork(int id)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var sessionResult = _context.SessionWorkResults.FirstOrDefault(x => x.Id == id && !x.IsDeleted);
                if (sessionResult != null)
                {
                    if (string.IsNullOrEmpty(sessionResult.UserAssessor))
                    {
                        var sessionItem = _context.SessionWorkResults.FirstOrDefault(x => !x.IsDeleted && x.WorkSession.Equals(sessionResult.WorkSession));
                        sessionResult.IsDeleted = true;
                        sessionResult.DeletedBy = ESEIM.AppContext.UserName;
                        sessionResult.DeletedTime = DateTime.Now;
                        _context.SessionWorkResults.Update(sessionResult);

                        sessionItem.IsDeleted = true;
                        sessionItem.DeletedBy = ESEIM.AppContext.UserName;
                        sessionItem.DeletedTime = DateTime.Now;
                        _context.SessionWorkResults.Update(sessionItem);

                        var sessionItemCheckItem = _context.SessionWorks.Where(x => !x.IsDeleted && x.Session.Equals(sessionResult.WorkSession));
                        foreach (var item in sessionItemCheckItem)
                        {
                            item.IsDeleted = true;
                            item.DeletedBy = ESEIM.AppContext.UserName;
                            item.DeletedTime = DateTime.Now;
                            _context.SessionWorks.Update(item);
                        }
                        _context.SaveChanges();
                        msg.Title = _sharedResources["COM_DELETE_SUCCESS"];
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["CJ_MSG_PROGRESS_APPROVE_NOT_DEL"];
                    }
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _sharedResources["COM_MSG_NOT_FOUND_DATA"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpGet]
        public JsonResult GetContentCms(string cardCode)
        {
            var content = "";
            var title = "";
            var objRs = new
            {
                Content = "",
                Title = "",
                //ListFile = new List<object>()
            };

            try
            {
                var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == cardCode);
                if (data != null)
                {
                    content = data.Description;
                    title = data.CardName;
                    return Json(new
                    {
                        Content = content,
                        Title = title,
                        //ListFile = new List<object>(),
                    });
                }
            }
            catch (Exception ex)
            {

            }

            return Json(objRs);
        }
        #region Coaching
        [HttpPost]
        public JsonResult GetListCoachingType()
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                msg.Object = _context.EduExtraFieldGroups.Where(p => !p.Group.Equals("CATEGORY")).Select(x => new { Type = x.Group, Id = x.Id, Name = x.Name });
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetListCoachingId(string coachingType, int? coachingTypeId)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                switch (coachingType)
                {
                    case "CATEGORY":
                        msg.Object = _context.EduCategorys.Where(x => x.Published == true && x.ExtraFieldsGroup.Equals(coachingTypeId)).Select(x => new { Type = coachingType, x.Id, x.Name });
                        break;

                    case "LECTURE":
                        var data = _context.EduCategorys.Where(x => x.Published == true).Select(x => new EduCategory { Id = x.Id, Name = x.Name, Published = x.Published, Parent = x.Parent }).ToList();
                        var dataSection = _context.EduCategorys.Where(x => x.ExtraFieldsGroup == 3).Select(x => new EduCategory { Id = x.Id, Name = x.Name, Parent = x.Parent }).ToList();
                        foreach (var item in dataSection)
                        {
                            item.Path = string.Format("{0} - {1}", GetHierarchy(data, item, "").Trim(' ', '-', ' '), item.Name);
                        }

                        msg.Object = from a in _context.EduLectures.Where(x => x.published == true).Select(x => new { Type = coachingType, Id = x.id, Name = x.title, CatId = x.cat_id })
                                     join b in dataSection on a.CatId equals b.Id
                                     select new
                                     {
                                         a.Id,
                                         a.Type,
                                         a.Name,
                                         b.Path
                                     };
                        break;

                    case "EXERCISE":
                        msg.Object = _context.QuizPools.Where(x => !x.IsDeleted).Select(x => new { Type = coachingType, Id = x.Id, Name = x.Title });
                        break;

                    case "EXAMINATION":
                        msg.Object = _context.EduExaminations.Where(x => !x.IsDeleted).Select(x => new { Type = coachingType, Id = x.Id, Name = x.Title });
                        break;
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [NonAction]
        private string GetHierarchy(List<EduCategory> listData, EduCategory obj, string hierarchy)
        {
            if (obj.Parent != null)
            {
                //hierarchy = obj.Name + (!string.IsNullOrEmpty(hierarchy) ? ("-" + hierarchy) : "");
                var packParent = listData.FirstOrDefault(x => x.Published == true && x.Id.Equals(obj.Parent));
                if (packParent != null)
                {
                    hierarchy = packParent.Name + " - " + hierarchy;
                    if (packParent.Parent != null)
                    {
                        var record = listData.FirstOrDefault(x => x.Published == true && x.Id.Equals(packParent.Parent));
                        hierarchy = GetHierarchy(listData, record, hierarchy);
                    }
                }
            }
            else
            {
                hierarchy = obj.Name + (!string.IsNullOrEmpty(hierarchy) ? (" - " + hierarchy) : "");
            }

            return hierarchy;
        }

        [HttpPost]
        public JsonResult GetListCoachingDetail(string cardCode, string itemCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var listCategory = from a in _context.EduCategorys.Where(x => x.Published == true)
                                   join b in _context.EduExtraFieldGroups on a.ExtraFieldsGroup equals b.Id
                                   select new
                                   {
                                       Type = b.Group,
                                       TypeName = b.Name,
                                       Id = a.Id,
                                       Name = a.Name,
                                       Content = a.Description
                                   };
                var listLecture = _context.EduLectures.Where(x => x.published == true).Select(x => new { Type = "LECTURE", TypeName = "Bài giảng", Id = x.id, Name = x.title, Content = x.full_text });
                var listExercise = _context.QuizPools.Where(x => !x.IsDeleted).Select(x => new { Type = "EXERCISE", TypeName = "Bài tập", Id = x.Id, Name = x.Title, Content = x.Content });
                var listExamination = _context.EduExaminations.Where(x => !x.IsDeleted).Select(x => new { Type = "EXAMINATION", TypeName = "Bài thi", Id = x.Id, Name = x.Title, Content = "" });

                var listData = listCategory.Union(listLecture).Union(listExercise).Union(listExamination);
                msg.Object = from a in _context.EmployeeCoachings.Where(x => !x.IsDeleted && x.CardCode.Equals(cardCode) && x.ItemCode.Equals(itemCode))
                             join b in listData on new { a.CoachType, CoachId = a.CoachId.ToString() } equals new { CoachType = b.Type, CoachId = b.Id.ToString() }
                             select new
                             {
                                 a.Id,
                                 CoachingTypeName = b.TypeName,
                                 CoachingDetailName = b.Name,
                                 Content = b.Content
                             };
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult InsertCoaching([FromBody] EmployeeCoaching data)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var check = _context.EmployeeCoachings.Any(x => !x.IsDeleted && x.CoachId.Equals(data.CoachId) && x.CoachType.Equals(data.CoachType) && x.CardCode.Equals(data.CardCode) && x.ItemCode.Equals(data.ItemCode));
                if (check)
                {
                    msg.Error = true;
                    msg.Title = "Dữ liệu đã tồn tại";
                    return Json(msg);
                }

                data.CreatedBy = User.Identity.Name;
                data.CreatedTime = DateTime.Now;

                _context.EmployeeCoachings.Add(data);
                _context.SaveChanges();

                msg.Title = "Thêm mới thành công";
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult DeleteCoaching(int id)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var data = _context.EmployeeCoachings.FirstOrDefault(x => !x.IsDeleted && x.Id.Equals(id));
                if (data == null)
                {
                    msg.Error = true;
                    msg.Title = "Dữ liệu không tồn tại";
                    return Json(msg);
                }
                else
                {
                    data.DeletedBy = User.Identity.Name;
                    data.DeletedTime = DateTime.Now;
                    data.IsDeleted = true;

                    _context.EmployeeCoachings.Update(data);
                    _context.SaveChanges();
                    msg.Title = "Xóa thành công";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }
        #endregion

        public class AssignTemp
        {
            public string UserId { get; set; }
            public string ActInstCode { get; set; }
        }
        public class ViewTitleAct
        {
            public string Title { get; set; }
        }
        public class ViewConstraint
        {
            public string ChkListCode { get; set; }
            public string Title { get; set; }
        }
        public class UserTemp
        {
            public string UserId { get; set; }
            public string GivenName { get; set; }
        }
        #endregion

        #region Comment
        [HttpPost]
        public JsonResult AddComment([FromBody] CardCommentList obj)
        {
            var msg = new JMessage() { Error = false };
            try
            {
                string code = "COMMENT_" + Guid.NewGuid().ToString();
                CardCommentList data = new CardCommentList()
                {
                    CardCode = obj.CardCode,
                    CmtId = code,
                    CmtContent = obj.CmtContent,
                    MemberId = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now
                };

                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    IdObject = "CMT",
                    Action = "ADD",
                    IsCheck = true,
                    CardCode = data.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = string.Concat(obj.CmtContent?.Take(20) ?? "") + "..."
                };
                _context.CardUserActivities.Add(activity);

                _context.CardCommentLists.Add(data);

                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(obj.CardCode));
                if (card != null)
                {
                    var lstSession = new List<CardSessionUser>();
                    if (!string.IsNullOrEmpty(card.LockShare))
                    {
                        lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                        var isExist = false;
                        foreach (var item in lstSession)
                        {
                            if (item.User == ESEIM.AppContext.UserName)
                            {
                                item.NewDataUpdate = false;
                                isExist = true;
                            }
                            else
                            {
                                item.NewDataUpdate = true;
                            }

                            item.TimeStamp = DateTime.Now;
                        }
                        if (!isExist)
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                    }
                    else
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }
                    card.LockShare = JsonConvert.SerializeObject(lstSession);
                }

                _context.SaveChanges();

                msg.Error = false;
                msg.Title = String.Format(_sharedResources["COM_ADD_SUCCESS"], _stringLocalizer["CJ_MSG_COMMENT"]);
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                return Json(msg);
            }
        }
        [HttpPost]
        public JsonResult GetComments(string CardCode)
        {
            var query = (from a in _context.CardCommentLists.Where(x => !x.Flag)
                         join b in _context.Users on a.MemberId equals b.UserName
                         where a.CardCode == CardCode
                         select new RollbackComment
                         {
                             Id = a.Id,
                             GivenName = b.GivenName,
                             Picture = b.Picture,
                             MemberId = a.MemberId,
                             CmtContent = a.CmtContent,
                             CreatedTime = a.CreatedTime,
                             UpdatedTime = a.UpdatedTime,
                             CardCode = a.CardCode,
                             UpdatedBy = a.UpdatedBy != null ? _context.Users.FirstOrDefault(x => x.UserName == a.UpdatedBy).GivenName : ""
                         }).OrderByDescending(x => x.CreatedTime).ToList();
            return Json(query);
        }
        [HttpPost]
        public JsonResult DeleteComment(int id)
        {
            var msg = new JMessage() { Error = true };
            var currentUser = ESEIM.AppContext.UserName;
            try
            {
                var data = _context.CardCommentLists.FirstOrDefault(x => x.Id.Equals(id));
                if (currentUser == data.MemberId)
                {
                    data.Flag = true;
                    _context.CardCommentLists.Update(data);
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        IdObject = "CMT",
                        Action = "DELETE",
                        IsCheck = true,
                        CardCode = data.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = string.Concat(data.CmtContent?.Take(20) ?? "") + "..."
                    };
                    _context.CardUserActivities.Add(activity);

                    var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(data.CardCode));
                    if (card != null)
                    {
                        var lstSession = new List<CardSessionUser>();
                        if (!string.IsNullOrEmpty(card.LockShare))
                        {
                            lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                            var isExist = false;
                            foreach (var item in lstSession)
                            {
                                if (item.User == ESEIM.AppContext.UserName)
                                {
                                    item.NewDataUpdate = false;
                                    isExist = true;
                                }
                                else
                                {
                                    item.NewDataUpdate = true;
                                }

                                item.TimeStamp = DateTime.Now;
                            }
                            if (!isExist)
                            {
                                var cardSession = new CardSessionUser
                                {
                                    User = ESEIM.AppContext.UserName,
                                    TimeStamp = DateTime.Now,
                                    NewDataUpdate = false
                                };
                                lstSession.Add(cardSession);
                            }
                        }
                        else
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                        card.LockShare = JsonConvert.SerializeObject(lstSession);
                    }

                    _context.SaveChanges();

                    msg.Error = false;
                    //msg.Title = String.Format(_stringLocalize["COM_MSG_DELETE_SUCCESS"), _stringLocalize[""));//"Xóa thành công";
                    msg.Title = _sharedResources["COM_DELETE_SUCCESS"];
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_CANNOT_DELETE"];
                }

                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_DELETE_FAIL"), _stringLocalize[""));// "Có lỗi khi xóa!";
                return Json(msg);
            }
        }

        [HttpPost]
        public JsonResult UpdateComment([FromBody] CardCommentList obj)
        {
            var msg = new JMessage() { Error = true };
            if (string.IsNullOrEmpty(obj.CmtContent))
            {
                msg.Title = _stringLocalizer["CJ_CURD_MSG_ADD_CONTENT"];// "Nhập nội dung!";
                return Json(msg);
            }
            //else
            //{
            //    if (obj.CmtContent.Length > 255)
            //    {
            //        //msg.Title = "255 ký tự!";
            //        msg.Title = _stringLocalizer["CJ_MSG_LIMIT_CHARACTER"];
            //        return Json(msg);
            //    }
            //}
            try
            {
                var currentUser = ESEIM.AppContext.UserName;
                var data = _context.CardCommentLists.First(x => x.Id.Equals(obj.Id));
                if (data.CmtContent.Equals(obj.CmtContent))
                {
                    msg.Error = false;
                    msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                    return Json(msg);
                }
                if (data.MemberId == currentUser)
                {
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        IdObject = "CMT",
                        Action = "UPDATE",
                        IsCheck = true,
                        CardCode = data.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Bình luận từ " + string.Concat(data.CmtContent?.Take(20) ?? "") + "... sang " + string.Concat(obj.CmtContent?.Take(20) ?? "") + "..."
                    };
                    _context.CardUserActivities.Add(activity);

                    data.CmtContent = obj.CmtContent;
                    data.UpdatedBy = ESEIM.AppContext.UserName;
                    data.UpdatedTime = DateTime.Now;

                    var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(obj.CardCode));
                    if (card != null)
                    {
                        var lstSession = new List<CardSessionUser>();
                        if (!string.IsNullOrEmpty(card.LockShare))
                        {
                            lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                            var isExist = false;
                            foreach (var item in lstSession)
                            {
                                if (item.User == ESEIM.AppContext.UserName)
                                {
                                    item.NewDataUpdate = false;
                                    isExist = true;
                                }
                                else
                                {
                                    item.NewDataUpdate = true;
                                }

                                item.TimeStamp = DateTime.Now;
                            }
                            if (!isExist)
                            {
                                var cardSession = new CardSessionUser
                                {
                                    User = ESEIM.AppContext.UserName,
                                    TimeStamp = DateTime.Now,
                                    NewDataUpdate = false
                                };
                                lstSession.Add(cardSession);
                            }
                        }
                        else
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                        card.LockShare = JsonConvert.SerializeObject(lstSession);
                    }

                    _context.SaveChanges();

                    msg.Error = false;
                    //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_SUCCESS"), _stringLocalize[""));// "Cập nhật thành công";
                    msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_CANNOT_UPDATE_CMT"];
                }
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_FAILED"), _stringLocalize[""));// "Có lỗi khi cập nhật!";
                return Json(msg);
            }
        }
        #endregion

        #region Attachment
        [HttpPost]
        public JsonResult AddAttachment([FromBody] CardAttachment data)
        {
            var msg = new JMessage() { Error = true };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == data.CardCode && !x.IsDeleted);
                string code = "ATTACHMENT_" + data.CardCode + (_context.CardAttachments.Count() > 0 ? _context.CardAttachments.Last().Id + 1 : 0);
                data.FileCode = code;
                data.CreatedTime = DateTime.Now;
                data.MemberId = ESEIM.AppContext.UserName;
                data.ListPermissionViewFile = card.LstUser;

                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    IdObject = "FILE",
                    Action = "ADD",
                    IsCheck = true,
                    CardCode = data.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = data.FileName
                };

                _context.CardUserActivities.Add(activity);
                _context.CardAttachments.Add(data);
                _context.SaveChanges();

                msg.Title = String.Format(_sharedResources["COM_MSG_ADD_SUCCESS"], _stringLocalizer["CJ_CURD_TAB_ADD_ATTACHMENT"]); //"Thêm thành công";
                msg.Error = false;
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_MSG_ADD_FAILED"), _stringLocalize["CJ_CURD_TAB_ADD_ATTACHMENT"));//"Có lỗi xảy ra!";
                return Json(msg);
            }
        }
        [HttpPost]
        public JsonResult GetAttachment(string CardCode)
        {
            var data = ((from a in _context.CardAttachments.Where(x => x.CardCode.Equals(CardCode) && x.Flag == false)
                         select new LstAttachment
                         {
                             Id = a.Id,
                             FileName = a.FileName,
                             FileUrl = a.FileUrl,
                             MemberId = a.MemberId,
                             FileCode = a.FileCode,
                             CreatedTime = a.CreatedTime.Value,
                             Type = 1,
                             Icon = "",
                             Color = ""
                         }).Union(
                from a in _context.FilesShareObjectUsers.Where(x => !x.IsDeleted
                     && JsonConvert.DeserializeObject<ObjRelative>(x.ObjectRelative).ObjectType.Equals("JOBCARD")
                     && JsonConvert.DeserializeObject<ObjRelative>(x.ObjectRelative).ObjectInstance.Equals(CardCode))
                select new LstAttachment
                {
                    Id = a.ID,
                    FileName = a.FileName,
                    FileUrl = a.FileUrl,
                    MemberId = a.CreatedBy,
                    FileCode = a.FileID,
                    CreatedTime = a.CreatedTime,
                    Type = 2,
                    Icon = "",
                    Color = ""
                })).ToList();
            foreach (var item in data)
            {
                var extension = Path.GetExtension(item.FileUrl);
                if (extension.Equals(".doc") || extension.Equals(".docx"))
                {
                    item.Icon = "fa fa-file-word-o";
                    item.Color = "rgb(13,118,206);font-size: 15px;";
                }
                else if (extension.Equals(".xls") || extension.Equals(".xlsx"))
                {
                    item.Icon = "fa fa-file-excel-o";
                    item.Color = "rgb(106,170,89);font-size: 15px;";
                }
                else if (extension.Equals(".pdf"))
                {
                    item.Icon = "fa fa-file-pdf-o";
                    item.Color = "rgb(226,165,139);font-size: 15px;";
                }
                //'.JPG', '.PNG', '.TIF', '.TIFF'
                else if (extension.ToUpper().Equals(".JPG") || extension.ToUpper().Equals(".PNG")
                    || extension.ToUpper().Equals(".TIF") || extension.ToUpper().Equals(".TIFF"))
                {
                    item.Icon = "fa fa-picture-o";
                    item.Color = "rgb(42,42,42);font-size: 15px;";
                }
                else
                {
                    item.Icon = "fa fa-file-o";
                    item.Color = "rgb(42,42,42);font-size: 15px;";
                }
            }
            return Json(data);
        }
        [HttpPost]
        public object GetFilePath(string filePath, string cardCode)
        {
            var msg = new JMessage();

            var extension = Path.GetExtension(filePath);
            var attachment = _context.CardAttachments.FirstOrDefault(x => x.FileUrl == filePath && x.CardCode == cardCode);
            var session = HttpContext.GetSessionUser();
            var listUserEdit = new List<string>();
            if (string.IsNullOrEmpty(attachment.ListUserView))
            {
                listUserEdit.Add(session.FullName);
                attachment.ListUserView = JsonConvert.SerializeObject(listUserEdit);
            }
            //else
            //{
            //    var checkExits = JsonConvert.DeserializeObject<List<string>>(attachment.ListUserView);
            //    msg.ID = -1;
            //    msg.Error = true;
            //    msg.Title = string.Format("Tệp đang được chỉnh sửa bởi {0}", string.Join(",", checkExits));
            //    if (!checkExits.Any(x => x.Equals(session.FullName)))
            //    {
            //        checkExits.Add(session.FullName);
            //        attachment.ListUserView = JsonConvert.SerializeObject(checkExits);
            //    }
            //}

            var asean = new AseanDocument();
            asean.File_Code = attachment.FileCode;
            asean.Mode = 2;
            asean.File_Path = "";
            asean.FirstPage = "/Admin/CardJob";
            if (extension.ToUpper() == ".DOCX" || extension.ToUpper() == ".DOC")
            {
                DocmanController.pathFile = filePath;
                DocmanController.cardCode = cardCode;
                DocmanController.docmodel = asean;
            }
            if (extension.ToUpper() == ".XLSX" || extension.ToUpper() == ".XLS")
            {
                ExcelController.pathFile = filePath;
                ExcelController.cardCode = cardCode;
                ExcelController.docmodel = asean;
            }
            if (extension.ToUpper() == ".PDF")
            {
                PDFController.pathFile = filePath;
            }
            attachment.IsEdit = true;
            attachment.UpdatedTime = DateTime.Now;
            _context.SaveChanges();

            return msg;
        }
        [HttpPost]
        [RequestFormLimits(MultipartBodyLengthLimit = long.MaxValue)]
        [RequestSizeLimit(long.MaxValue)]
        public object UploadFile(IndexCardAttach obj, IFormFile fileUpload)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var moduleObj = (EDMSCatRepoSetting)_upload.GetPathByModule(module_name).Object;
                var cardJobCategory = _context.EDMSCategorys.FirstOrDefault(x => x.CatCode == moduleObj.CatCode);
                var upload = _upload.UploadFile(fileUpload, /*Path.Combine(_hostingEnvironment.WebRootPath, "uploads\\repository\\CARDJOB")*/ cardJobCategory.PathServerPhysic);
                if (upload.Error)
                {
                    msg.Error = true;
                    msg.Title = upload.Title;
                }
                else
                {
                    var mimeType = fileUpload.ContentType;
                    var extension = Path.GetExtension(fileUpload.FileName);
                    string code = "ATTACHMENT_" + obj.CardCode + "_" + (_context.CardAttachments.Count() > 0 ? _context.CardAttachments.Last().Id + 1 : 0);
                    msg.Object = upload.Object;
                    if (Array.IndexOf(LuceneExtension.fileMimetypes, mimeType) >= 0 && (Array.IndexOf(LuceneExtension.fileExt, extension.ToUpper()) >= 0))
                    {
                        moduleObj = (EDMSCatRepoSetting)_upload.GetPathByModule("DB_LUCENE_INDEX").Object;
                        var luceneCategory = _context.EDMSCategorys.FirstOrDefault(x => x.CatCode == moduleObj.CatCode);
                        LuceneExtension.IndexFile(code, fileUpload, /*string.Concat(_hostingEnvironment.WebRootPath, "\\uploads\\luceneIndex")*/ luceneCategory.PathServerPhysic);
                    }
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                //msg.Title = String.Format(_stringLocalize["COM_ERR_UPLOAD_FILE")); //"Có lỗi xảy ra khi upload file!"; 
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult DeleteAttachment([FromBody] DelAttachment obj)
        {
            var msg = new JMessage() { Error = true };
            var currentUser = ESEIM.AppContext.UserName;
            try
            {
                if (obj.Type == 1)
                {
                    var data = _context.CardAttachments.FirstOrDefault(x => x.FileCode.Equals(obj.FileCode));
                    if (data.MemberId == currentUser)
                    {
                        _context.CardAttachments.Remove(data);
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            IdObject = "FILE",
                            Action = "DELETE",
                            IsCheck = true,
                            CardCode = data.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = data.FileName
                        };

                        _context.CardUserActivities.Add(activity);
                        _context.SaveChanges();

                        msg.Error = false;
                        msg.Title = _sharedResources["COM_DELETE_SUCCESS"];
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["CJ_MSG_CANNOT_DELETE"];
                    }
                }
                else if (obj.Type == 2)
                {
                    var data = _context.FilesShareObjectUsers.FirstOrDefault(x => !x.IsDeleted && x.FileID.Equals(obj.FileCode)
                    && JsonConvert.DeserializeObject<ObjRelative>(x.ObjectRelative).ObjectType.Equals("JOBCARD")
                    && JsonConvert.DeserializeObject<ObjRelative>(x.ObjectRelative).ObjectInstance.Equals(obj.CardCode));
                    if (data != null)
                    {
                        if (data.CreatedBy == ESEIM.AppContext.UserName)
                        {
                            data.IsDeleted = true;
                            data.DeletedBy = ESEIM.AppContext.UserName;
                            data.DeletedTime = DateTime.Now;
                            _context.FilesShareObjectUsers.Update(data);

                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                IdObject = "FILE",
                                Action = "DELETE",
                                IsCheck = true,
                                CardCode = obj.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = data.FileName
                            };
                            _context.CardUserActivities.Add(activity);
                            _context.SaveChanges();
                            msg.Error = false;
                            msg.Title = _sharedResources["COM_DELETE_SUCCESS"];
                        }
                        else
                        {
                            msg.Error = true;
                            msg.Title = _stringLocalizer["CJ_MSG_CANNOT_DELETE"];
                        }
                    }
                }
                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                return Json(msg);
            }
        }

        [HttpPost]
        public JsonResult GetListUserFile(int Id)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var query = _context.CardAttachments.FirstOrDefault(x => x.Id == Id && !x.Flag);
                if (query != null)
                {
                    var listPermission = !string.IsNullOrEmpty(query.ListPermissionViewFile) ? query.ListPermissionViewFile.Split(",", StringSplitOptions.None) : new string[0];
                    msg.Object = (from a in _context.Users
                                  join b in listPermission on a.Id equals b
                                  select new
                                  {
                                      a.Id,
                                      a.UserName,
                                      a.GivenName
                                  }).DistinctBy(x => x.UserName);
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateListPermissionViewFile(int Id, string ListPermissionViewFile)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var data = _context.CardAttachments.FirstOrDefault(x => x.Id == Id && !x.Flag);
                if (data != null)
                {
                    data.ListPermissionViewFile = ListPermissionViewFile;
                    _context.CardAttachments.Update(data);
                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _sharedResources["COM_MSG_ERR"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public object CheckFileItem(string itemCode)
        {
            var isExist = false;
            var data = _context.CardAttachments.FirstOrDefault(x => x.ChkListCode.Equals(itemCode));
            if (data != null)
            {
                isExist = true;
            }
            else
            {
                isExist = false;
            }
            return isExist;
        }

        [HttpGet]
        public object IsFileEdms(string fileCode, string url)
        {
            var data = (from a in _context.EDMSRepoCatFiles.Where(x => x.FileCode.Equals(fileCode))
                        join b in _context.EDMSRepositorys on a.ReposCode equals b.ReposCode into b2
                        from b in b2.DefaultIfEmpty()
                        join c in _context.EDMSFiles on a.FileCode equals c.FileCode into c2
                        from c in c2.DefaultIfEmpty()
                        where c.Url.Equals(url)
                        select new
                        {
                            a.Id,
                            Server = (b != null ? b.Server : null),
                            Type = (b != null ? b.Type : null),
                            Url = (c != null ? c.Url : null),
                            FileId = (c != null ? c.CloudFileId : null),
                            FileTypePhysic = c.FileTypePhysic,
                            c.FileName,
                            c.MimeType,
                            b.Account,
                            b.PassWord,
                            c.FileCode,
                            c.IsEdit,
                            c.IsFileMaster,
                            c.FileParentId,
                            c.FileID,
                            c.ListUserView
                        }).FirstOrDefault();
            if (data != null)
            {
                return true;
            }
            else
            {
                return false;
            }
        }

        [HttpGet]
        public IActionResult Download(string fileCode, string url)
        {
            try
            {
                var data = (from a in _context.EDMSRepoCatFiles.Where(x => x.FileCode.Equals(fileCode))
                            join b in _context.EDMSRepositorys on a.ReposCode equals b.ReposCode into b2
                            from b in b2.DefaultIfEmpty()
                            join c in _context.EDMSFiles on a.FileCode equals c.FileCode into c2
                            from c in c2.DefaultIfEmpty()
                            where c.Url.Equals(url)
                            select new
                            {
                                a.Id,
                                Server = (b != null ? b.Server : null),
                                Token = (b != null ? b.Token : null),
                                Type = (b != null ? b.Type : null),
                                Url = (c != null ? c.Url : null),
                                FileId = (c != null ? c.CloudFileId : null),
                                FileTypePhysic = c.FileTypePhysic,
                                c.FileName,
                                c.MimeType,
                                b.Account,
                                b.PassWord,
                                c.FileCode,
                                c.IsEdit,
                                c.IsFileMaster,
                                c.FileParentId,
                                c.FileID,
                                c.ListUserView
                            }).FirstOrDefault();
                if (data != null)
                {
                    if (data.Type == "SERVER")
                    {
                        if (!string.IsNullOrEmpty(data.Server))
                        {
                            string ftphost = data.Server;
                            string ftpfilepath = data.Url;
                            var urlEnd = System.Web.HttpUtility.UrlPathEncode("ftp://" + ftphost + ftpfilepath);
                            using (WebClient request = new WebClient())
                            {
                                request.Credentials = new NetworkCredential(data.Account, data.PassWord);
                                byte[] fileData = request.DownloadData(urlEnd);
                                return File(fileData, data.MimeType, string.Concat(data.FileName, data.FileTypePhysic));
                            }
                        }
                    }
                    else
                    {
                        var apiTokenService = _context.TokenManagers.FirstOrDefault(x => x.AccountCode == data.Token);
                        var json = apiTokenService.CredentialsJson;
                        var user = apiTokenService.Email;
                        var token = apiTokenService.RefreshToken;
                        var fileData = FileExtensions.DownloadFileGoogle(json, token, data.FileId, user);
                        return File(fileData, data.MimeType, string.Concat(data.FileName, data.FileTypePhysic));
                    }
                }
            }
            catch (Exception ex)
            {

            }
            return null;
        }

        [HttpPost]
        public object JtableFileWithRepository([FromBody] JtableDirectoryModel jTablePara)
        {
            int intBeginFor = (jTablePara.CurrentPage - 1) * jTablePara.Length;
            var query = from a in _context.CardAttachments.Where(x => x.MemberId.Equals(ESEIM.AppContext.UserName) && !x.Flag)
                        select new
                        {
                            Id = a.Id,
                            FileName = a.FileName,
                            FileCode = a.FileCode,
                            FileUrl = a.FileUrl
                        };
            var count = query.Count();
            var data = query.OrderUsingSortExpression(jTablePara.QueryOrderBy).Skip(intBeginFor).Take(jTablePara.Length).AsNoTracking().ToList();
            var jdata = JTableHelper.JObjectTable(data, jTablePara.Draw, count, "Id", "FileName", "FileCode", "FileUrl");
            return Json(jdata);
        }

        [HttpPost]
        public JsonResult GetFileEDMS(string url, string size, string timeModify, string cardCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var data = _context.EDMSFiles.FirstOrDefault(x => !x.IsDeleted && x.Url.Equals(url)
             && (x.EditedFileTime.HasValue ? (x.EditedFileTime.Value.ToString("MM/dd/yyyy HH:mm") + ":00").Equals(timeModify) : (x.CreatedTime.Value.ToString("MM/dd/yyyy HH:mm") + ":00").Equals(timeModify)));

                if (data != null)
                {
                    var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(cardCode) && !x.IsDeleted);
                    string code = "ATTACHMENT_" + cardCode + "_" + (_context.CardAttachments.Count() > 0 ? _context.CardAttachments.Last().Id + 1 : 0);

                    int id = 0;
                    var idMapping = _context.EDMSRepoCatFiles.FirstOrDefault(x => x.FileCode.Equals(data.FileCode));
                    if (idMapping != null)
                    {
                        id = idMapping.Id;
                    }

                    var attachment = new CardAttachment
                    {
                        FileCode = code,
                        CreatedTime = DateTime.Now,
                        MemberId = ESEIM.AppContext.UserName,
                        ListPermissionViewFile = card.LstUser,
                        CardCode = cardCode,
                        FileName = data.FileName,
                        FileUrl = data.Url,
                        IsEdms = true,
                        IdMapping = id
                    };
                    _context.CardAttachments.Add(attachment);

                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        IdObject = "FILE",
                        Action = "ADD",
                        IsCheck = true,
                        CardCode = cardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = data.FileName
                    };

                    _context.CardUserActivities.Add(activity);

                    _context.SaveChanges();
                    msg.Title = String.Format(_sharedResources["COM_MSG_ADD_SUCCESS"], _stringLocalizer["CJ_CURD_TAB_ADD_ATTACHMENT"]);
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không có thông tin tệp tin đã chọn";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpGet]
        public object GetItemFile(int Id, bool? IsEdit, int mode, int idAttachment)
        {
            var msg = new JMessage() { Error = false };
            try
            {
                var data = (from a in _context.EDMSRepoCatFiles.Where(x => x.Id == Id)
                            join b in _context.EDMSRepositorys on a.ReposCode equals b.ReposCode into b2
                            from b in b2.DefaultIfEmpty()
                            join c in _context.EDMSFiles on a.FileCode equals c.FileCode into c2
                            from c in c2.DefaultIfEmpty()
                            select new
                            {
                                a.Id,
                                Server = (b != null ? b.Server : null),
                                Token = (b != null ? b.Token : null),
                                Type = (b != null ? b.Type : null),
                                Url = (c != null ? c.Url : null),
                                FileId = (c != null ? c.CloudFileId : null),
                                FileTypePhysic = c.FileTypePhysic,
                                c.FileName,
                                c.MimeType,
                                b.Account,
                                b.PassWord,
                                c.FileCode,
                                c.IsEdit,
                                c.IsFileMaster,
                                c.FileParentId,
                                c.FileID,
                                c.ListUserView
                            }).FirstOrDefault();

                var aseanDoc = new AseanDocument();
                if (data != null)
                {
                    var attachment = _context.CardAttachments.FirstOrDefault(x => !x.Flag && x.Id == idAttachment);

                    var edmsFile = _context.EDMSFiles.FirstOrDefault(x => x.FileID.Equals(data.FileID));
                    var session = HttpContext.GetSessionUser();
                    var listUserEdit = new List<string>();
                    var fileTempName = data.FileName + Path.GetExtension(data.FileName);

                    if (!string.IsNullOrEmpty(data.Server))
                    {
                        string ftphost = data.Server;
                        string ftpfilepath = data.Url;
                        var urlEnd = System.Web.HttpUtility.UrlPathEncode("ftp://" + ftphost + ftpfilepath);
                        using (WebClient request = new WebClient())
                        {
                            request.Credentials = new NetworkCredential(data.Account, data.PassWord);
                            byte[] fileData = request.DownloadData(urlEnd);
                            JMessage msg1 = _upload.UploadFileByBytes(fileData, fileTempName, _hostingEnvironment.WebRootPath, "uploads\\files");
                            string path = msg1.Object.ToString();
                            string pathConvert = "/" + path.Replace("\\", "/");
                            attachment.FileUrl = pathConvert;
                            attachment.UpdatedTime = DateTime.Now;
                            attachment.IsEdms = false;
                            _context.CardAttachments.Update(attachment);

                            var extension = Path.GetExtension(path);
                            aseanDoc.File_Code = attachment.FileCode;
                            aseanDoc.Mode = mode;
                            aseanDoc.FirstPage = "/Admin/EDMSRepository";

                            if (extension.Equals(".doc") || extension.Equals(".docx"))
                            {
                                DocmanController.docmodel = aseanDoc;
                                DocmanController.pathFile = pathConvert;
                                DocmanController.cardCode = attachment.CardCode;
                            }
                            else if (extension.Equals(".xls") || extension.Equals(".xlsx"))
                            {
                                ExcelController.pathFileFTP = "";
                                ExcelController.docmodel = aseanDoc;
                                ExcelController.fileCode = attachment.FileCode;
                                ExcelController.pathFile = pathConvert;
                                ExcelController.cardCode = attachment.CardCode;
                            }
                            else if (extension.Equals(".pdf"))
                            {
                                PDFController.docmodel = aseanDoc;
                                PDFController.pathFile = pathConvert;
                            }
                        }
                    }
                    else
                    {
                        var apiTokenService = _context.TokenManagers.FirstOrDefault(x => x.AccountCode == data.Token);
                        var json = apiTokenService.CredentialsJson;
                        var user = apiTokenService.Email;
                        var token = apiTokenService.RefreshToken;
                        byte[] fileData = FileExtensions.DownloadFileGoogle(json, token, data.FileId, user);
                        JMessage msg1 = _upload.UploadFileByBytes(fileData, fileTempName, _hostingEnvironment.WebRootPath, "uploads\\files");
                        string path = msg1.Object.ToString();

                        attachment.FileUrl = path;
                        attachment.UpdatedTime = DateTime.Now;
                        attachment.IsEdms = false;
                        _context.CardAttachments.Update(attachment);

                        aseanDoc.File_Code = attachment.FileCode;
                        aseanDoc.File_Name = data.FileName;
                        aseanDoc.File_Type = data.FileTypePhysic;
                        aseanDoc.File_Path = path;
                        aseanDoc.IsEdit = data.IsEdit;
                        aseanDoc.IsFileMaster = data.IsFileMaster;
                        aseanDoc.FileParentId = data.FileParentId;
                        aseanDoc.Mode = mode;
                        var extension = Path.GetExtension(path);

                        if (extension.Equals(".doc") || extension.Equals(".docx"))
                        {
                            DocmanController.docmodel = aseanDoc;
                        }
                        else if (extension.Equals(".xls") || extension.Equals(".xlsx"))
                        {
                            ExcelController.docmodel = aseanDoc;
                        }
                        else if (extension.Equals(".pdf"))
                        {
                            PDFController.docmodel = aseanDoc;
                        }
                        //var apiTokenService = _context.TokenManagers.FirstOrDefault(x => x.UserId == data.Token);
                        //var json = apiTokenService.CredentialsJson;
                        //var user = apiTokenService.Description;
                        //var token = apiTokenService.TokenJson;
                        //var link = FileExtensions.OpenFileGoogle(json, token, data.FileId, user);
                        //msg.Object = new
                        //{
                        //    Type = "DRIVER",
                        //    Link = link,
                        //};
                    }
                    _context.SaveChanges();
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _stringLocalizer["EDMSR_MSG_FILE_NOT_EXIST"];
                return Json(msg);
            }
            return Json(msg);
        }

        [HttpPost]
        public void ViewFileOnline([FromBody] ViewFileObj obj)
        {
            try
            {
                DocmanController.pathFile = string.Empty;
                DocmanController.pathFileFTP = string.Empty;

                ExcelController.pathFile = string.Empty;
                ExcelController.pathFileFTP = string.Empty;

                PDFController.pathFile = string.Empty;
                PDFController.pathFileFTP = string.Empty;

                var aseanDoc = new AseanDocument();
                var edms = (from a in _context.EDMSRepoCatFiles.Where(x => x.FileCode.Equals(obj.FileCode))
                            join b in _context.EDMSRepositorys on a.ReposCode equals b.ReposCode into b2
                            from b in b2.DefaultIfEmpty()
                            join c in _context.EDMSFiles on a.FileCode equals c.FileCode into c2
                            from c in c2.DefaultIfEmpty()
                            where c.Url.Equals(obj.Url)
                            select new
                            {
                                a.Id,
                                Server = (b != null ? b.Server : null),
                                Type = (b != null ? b.Type : null),
                                Url = (c != null ? c.Url : null),
                                FileId = (c != null ? c.CloudFileId : null),
                                FileTypePhysic = c.FileTypePhysic,
                                c.FileName,
                                c.MimeType,
                                b.Account,
                                b.PassWord,
                                c.FileCode,
                                c.IsEdit,
                                c.IsFileMaster,
                                c.FileParentId,
                                c.FileID,
                                c.ListUserView
                            }).FirstOrDefault();
                if (edms == null)
                {
                    var extension = Path.GetExtension(obj.Url).ToLower();
                    aseanDoc.File_Code = obj.FileCode;
                    aseanDoc.Mode = 2;
                    aseanDoc.FirstPage = "/Admin/CardJob";

                    if (extension.Equals(".doc") || extension.Equals(".docx") || extension.Equals(".rtf"))
                    {
                        DocmanController.docmodel = aseanDoc;
                        DocmanController.pathFile = obj.Url;
                        DocmanController.cardCode = obj.CardCode;
                    }
                    else if (extension.Equals(".xls") || extension.Equals(".xlsx"))
                    {
                        ExcelController.pathFileFTP = "";
                        ExcelController.docmodel = aseanDoc;
                        ExcelController.fileCode = obj.FileCode;
                        ExcelController.pathFile = obj.Url;
                        ExcelController.cardCode = obj.CardCode;
                    }
                    else if (extension.Equals(".pdf"))
                    {
                        PDFController.docmodel = aseanDoc;
                        PDFController.pathFile = obj.Url;
                    }
                }
                else
                {
                    if (!string.IsNullOrEmpty(edms.Server))
                    {
                        string ftphost = edms.Server;
                        string ftpfilepath = edms.Url;
                        var urlEnd = System.Web.HttpUtility.UrlPathEncode("ftp://" + ftphost + ftpfilepath);
                        var fileTempName = edms.FileName + Path.GetExtension(edms.FileName);
                        using (WebClient request = new WebClient())
                        {
                            request.Credentials = new NetworkCredential(edms.Account, edms.PassWord);
                            byte[] fileData = request.DownloadData(urlEnd);
                            JMessage msg1 = _upload.UploadFileByBytes(fileData, fileTempName, _hostingEnvironment.WebRootPath, "uploads\\files");
                            string path = msg1.Object.ToString();
                            string pathConvert = "/" + path.Replace("\\", "/");

                            var extension = Path.GetExtension(path);
                            aseanDoc.Mode = 2;
                            aseanDoc.FirstPage = "/Admin/CardJob";

                            if (extension.Equals(".doc") || extension.Equals(".docx"))
                            {
                                DocmanController.docmodel = aseanDoc;
                                DocmanController.pathFile = pathConvert;
                                DocmanController.cardCode = obj.CardCode;
                            }
                            else if (extension.Equals(".xls") || extension.Equals(".xlsx"))
                            {
                                ExcelController.pathFileFTP = "";
                                ExcelController.docmodel = aseanDoc;
                                ExcelController.fileCode = obj.FileCode;
                                ExcelController.pathFile = pathConvert;
                                ExcelController.cardCode = obj.CardCode;
                            }
                            else if (extension.Equals(".pdf"))
                            {
                                PDFController.docmodel = aseanDoc;
                                PDFController.pathFile = pathConvert;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {

            }
        }

        public class JtableDirectoryModel : JTableModel
        {
            public string ReposCode { get; set; }
            public string Folder { get; set; }
            public string ParentId { get; set; }
            public string CatCode { get; set; }
            public string FileName { get; set; }
        }

        public class IndexCardAttach
        {
            public string CardCode { get; set; }
        }

        public class ViewFileObj
        {
            public string FileCode { get; set; }
            public string Url { get; set; }
            public string CardCode { get; set; }
        }
        public class DelAttachment
        {
            public int Type { get; set; }
            public string FileCode { get; set; }
            public string CardCode { get; set; }
        }

        public class LstAttachment
        {
            public int Id { get; set; }
            public string FileName { get; set; }
            public string FileUrl { get; set; }
            public string MemberId { get; set; }
            public string FileCode { get; set; }
            public string Icon { get; set; }
            public string Color { get; set; }
            public DateTime CreatedTime { get; set; }
            public int Type { get; set; }
        }

        #endregion

        #region Obj Dependency
        public class Properties
        {
            public string Code { get; set; }
            public string Name { get; set; }
        }

        [HttpPost]
        public JsonResult GetObjDependency()
        {
            var list = new List<Properties>();
            var project = new Properties
            {
                Code = EnumHelper<ProjectEnum>.GetDisplayValue(ProjectEnum.Project),
                Name = ProjectEnum.Project.DescriptionAttr()
            };
            list.Add(project);

            var contract = new Properties
            {
                Code = EnumHelper<ContractEnum>.GetDisplayValue(ContractEnum.Contract),
                Name = ContractEnum.Contract.DescriptionAttr()
            };
            list.Add(contract);

            var Customer = new Properties
            {
                Code = EnumHelper<CustomerEnum>.GetDisplayValue(CustomerEnum.Customer),
                Name = CustomerEnum.Customer.DescriptionAttr()
            };
            list.Add(Customer);

            var Supplier = new Properties
            {
                Code = EnumHelper<SupplierEnum>.GetDisplayValue(SupplierEnum.Supplier),
                Name = SupplierEnum.Supplier.DescriptionAttr()
            };
            list.Add(Supplier);
            return Json(list);
        }

        [HttpPost]
        public JsonResult GetObjTypeJC()
        {
            var data = _context.JcObjectTypes.Where(x => !x.IsDeleted && x.ObjTypeCode != "CARD_JOB").Select(x => new { Code = x.ObjTypeCode, Name = x.ObjTypeName });
            return Json(data);
        }
        [AllowAnonymous]
        [HttpPost]
        public JsonResult GetObjFromObjType(string code)
        {
            List<ObjTemp> listTemp = new List<ObjTemp>();
            listTemp = GetListObjTemp(code);
            return Json(listTemp);
        }

        [HttpPost]
        public JsonResult InsertJcObjectIdRelative([FromBody] dynamic data)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var session = HttpContext.GetSessionUser();
                string cardCode = data.CardCode.Value;

                var checkCreated = _context.WORKOSCards.Any(x => !x.IsDeleted && x.CardCode.Equals(cardCode) && x.CreatedBy.Equals(session.UserName));
                if (checkCreated || session.IsAllData)
                {
                    if (data.ListDeletedDependency.Count > 0)
                    {
                        for (int i = 0; i < data.ListDeletedDependency.Count; i++)
                        {
                            int idDeleted = data.ListDeletedDependency[i].Value != null ? Convert.ToInt32(data.ListDeletedDependency[i].Value) : 0;
                            if (idDeleted > 0)
                            {
                                var currentData = _context.JcObjectIdRelatives.FirstOrDefault(x => x.ID == idDeleted);
                                if (currentData != null)
                                {
                                    currentData.IsDeleted = true;
                                    currentData.DeletedBy = ESEIM.AppContext.UserName;
                                    currentData.DeletedTime = DateTime.Now;
                                    _context.JcObjectIdRelatives.Update(currentData);
                                }
                            }
                        }
                    }
                    if (data.ListDependency.Count > 0)
                    {
                        for (int i = 0; i < data.ListDependency.Count; i++)
                        {
                            int id = data.ListDependency[i].ID.Value != null ? Convert.ToInt32(data.ListDependency[i].ID.Value) : 0;
                            if (id < 0)
                            {
                                string code = data.ListDependency[i].ObjCode.Value;
                                var check = _context.JcObjectIdRelatives.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode)
                                            && x.ObjID.Equals(code));
                                if (check == null)
                                {
                                    var objRelative = new JcObjectIdRelative();
                                    decimal Weight = data.ListDependency[i].Weight.Value != null ? Convert.ToDecimal(data.ListDependency[i].Weight.Value) : 0;
                                    objRelative.Weight = Weight;
                                    objRelative.CardCode = cardCode;
                                    objRelative.ObjTypeCode = data.ListDependency[i].ObjTypeCode.Value;
                                    objRelative.ObjID = data.ListDependency[i].ObjCode.Value;
                                    objRelative.Relative = data.ListDependency[i].Relative.Value;
                                    objRelative.ItemCode = data.ListDependency[i].ItemCode.Value;
                                    objRelative.CreatedBy = ESEIM.AppContext.UserName;
                                    objRelative.CreatedTime = DateTime.Now;
                                    _context.JcObjectIdRelatives.Add(objRelative);
                                }
                            }
                        }
                    }

                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "ADD",
                        IdObject = "CARD_OBJ_RELATIVE",
                        IsCheck = true,
                        CardCode = cardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = ""
                    };
                    _context.CardUserActivities.Add(activity);
                    UpdateChangeCard(cardCode);

                    _context.SaveChanges();
                    //msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_SUCCESS"), _stringLocalize[""));//"Cập nhật thành công";
                    msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Bạn không có quyền thêm mới";
                }

                return Json(msg);
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                // msg.Title = String.Format(_stringLocalize["COM_MSG_UPDATE_FAILED"), _stringLocalize[""));//"Có lỗi xảy ra!";
                return Json(msg);
            }
        }

        public class CheckWeightNumberModel
        {
            public string ObjTypeCode { get; set; }
            public string ObjID { get; set; }
            public decimal WeightNum { get; set; }
        };
        [HttpPost]
        public JsonResult CheckWeightNumber([FromBody] CheckWeightNumberModel obj)
        {
            var msg = new JMessage();

            var getSumWeightNum = _context.JcObjectIdRelatives.Where(x => x.ObjTypeCode == obj.ObjTypeCode && !x.IsDeleted && x.ObjID == obj.ObjID).Sum(x => x.Weight);
            if ((getSumWeightNum + obj.WeightNum) > 100)
            {
                msg.Error = true;
                msg.Title = _stringLocalizer["CJ_MSG_MAXIMUM_WEIGHT"] + " " + (100 - getSumWeightNum) + " % !";
            }
            else
            {
                msg.Error = false;
            }
            return Json(msg);
        }
        [HttpPost]
        public JsonResult DeleteJcObjectIdRelative(int ids)
        {
            var msg = new JMessage();

            var data = _context.JcObjectIdRelatives.FirstOrDefault(x => x.ID == ids && !x.IsDeleted);
            if (data != null)
            {
                data.IsDeleted = true;
                data.DeletedBy = ESEIM.AppContext.UserName;
                data.DeletedTime = DateTime.Now;
                _context.JcObjectIdRelatives.Update(data);
                msg.Title = _sharedResources["COM_DELETE_SUCCESS"];
            }
            else
            {
                msg.Error = true;
                msg.Title = _stringLocalizer["CJ_MSG_NOT_FIND_OBJECT_DELETE"];
            }
            _context.SaveChanges();
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetObjectTypeRelative(string CardCode)
        {
            List<ObjTemp> list = new List<ObjTemp>();
            list = GetListObjTemp(CardCode);
            var data = from a in _context.WORKOSCards
                       join b in _context.JcObjectIdRelatives on a.CardCode equals b.CardCode into b1
                       from b2 in b1.DefaultIfEmpty()
                       where !a.IsDeleted && !b2.IsDeleted
                       select new
                       {
                           ID = b2.ID,
                           ObjID = b2.ObjID != null ? b2.ObjID : ""
                       };
            var data1 = from a in data
                        join b in list on a.ObjID equals b.Code
                        select new
                        {
                            a.ObjID,
                            b.Name
                        };
            return Json(data1);
        }

        [NonAction]
        public List<ObjTemp> GetListObjTemp(string code)
        {
            var query = _context.JcObjectTypes.FirstOrDefault(x => x.ObjTypeCode.Equals(code) && !x.IsDeleted);
            List<ObjTemp> listTemp = new List<ObjTemp>();
            using (var command = _context.Database.GetDbConnection().CreateCommand())
            {
                command.CommandText = query.ScriptSQL;
                _context.Database.OpenConnection();
                using (var result = command.ExecuteReader())
                {
                    while (result.Read())
                    {
                        if (result != null)
                        {
                            if (code == "CONTRACT_PO")
                            {
                                if (!result.IsDBNull(3) && !result.IsDBNull(4))
                                {
                                    var objTemp = new ObjTemp
                                    {
                                        Code = result.GetString(4),
                                        Name = result.GetString(3)
                                    };
                                    if (objTemp != null)
                                    {
                                        listTemp.Add(objTemp);
                                    }
                                }
                            }
                            else if (code == "NOT_WORK")
                            {
                                if (!result.IsDBNull(1) && !result.IsDBNull(8))
                                {
                                    var user = _context.Users.FirstOrDefault(x => x.Id.Equals(result.GetString(8)));
                                    var objTemp = new ObjTemp
                                    {
                                        Code = result.GetInt32(0).ToString(),
                                        Name = user != null ? user.GivenName + " báo nghỉ" : ""
                                    };
                                    if (objTemp != null)
                                    {
                                        listTemp.Add(objTemp);
                                    }
                                }
                            }
                            else
                            {
                                if (!result.IsDBNull(1) && !result.IsDBNull(2))
                                {
                                    var objTemp = new ObjTemp
                                    {
                                        Code = result.GetString(1),
                                        Name = result.GetString(2)
                                    };
                                    if (objTemp != null)
                                    {
                                        listTemp.Add(objTemp);
                                    }
                                }
                            }
                        }

                    }
                }
                _context.Database.CloseConnection();
            }
            return listTemp;
        }
        public class ObjTemp
        {
            public string Code { get; set; }
            public string Name { get; set; }
        }
        public class ObjTempRela
        {
            public int ID { get; set; }
            public string Code { get; set; }
            public string Name { get; set; }
        }
        [HttpPost]
        public JsonResult GetObjectRelative(string CardCode)
        {
            var data = (from a in _context.JcObjectTypes
                        join b in _context.JcObjectIdRelatives on a.ObjTypeCode equals b.ObjTypeCode
                        where !a.IsDeleted && !b.IsDeleted && b.CardCode == CardCode
                        select new
                        {
                            Sql = a.ScriptSQL,
                            Code = a.ObjTypeCode
                        }).DistinctBy(x => x.Code).ToList();


            List<ObjTempRela> listTemp = new List<ObjTempRela>();

            using (var command = _context.Database.GetDbConnection().CreateCommand())
            {
                _context.Database.OpenConnection();
                foreach (var item in data)
                {
                    command.CommandText = item.Sql;
                    using (var result = command.ExecuteReader())
                    {
                        while (result.Read())
                        {
                            if (result != null)
                            {
                                if (item.Code == "CONTRACT_PO")
                                {
                                    if (!result.IsDBNull(4) && !result.IsDBNull(3))
                                    {
                                        var objTemp = new ObjTempRela
                                        {
                                            ID = result.GetInt32(0),
                                            Code = result.GetString(4),
                                            Name = result.GetString(3)
                                        };
                                        if (objTemp != null)
                                        {
                                            listTemp.Add(objTemp);
                                        }
                                    }
                                }
                                else if (item.Code == "NOT_WORK")
                                {
                                    if (!result.IsDBNull(1) && !result.IsDBNull(8))
                                    {
                                        var user = _context.Users.FirstOrDefault(x => x.Id.Equals(result.GetString(8)));
                                        var objTemp = new ObjTempRela
                                        {
                                            ID = result.GetInt32(0),
                                            Code = result.GetInt32(0).ToString(),
                                            Name = user != null ? user.GivenName + " báo nghỉ" : ""
                                        };
                                        if (objTemp != null)
                                        {
                                            listTemp.Add(objTemp);
                                        }
                                    }
                                }
                                else
                                {
                                    if (!result.IsDBNull(1) && !result.IsDBNull(2))
                                    {
                                        var objTemp = new ObjTempRela
                                        {
                                            ID = result.GetInt32(0),
                                            Code = result.GetString(1),
                                            Name = result.GetString(2)
                                        };
                                        if (objTemp != null)
                                        {
                                            listTemp.Add(objTemp);
                                        }
                                    }
                                }

                            }

                        }
                    }
                }
                _context.Database.CloseConnection();
            }
            var data2 = (from a in _context.JcObjectIdRelatives
                         join b in listTemp on a.ObjID equals b.Code
                         join c in _context.JcObjectTypes on a.ObjTypeCode equals c.ObjTypeCode
                         join d in _context.CardItemChecks.Where(x => !x.Flag) on a.ItemCode equals d.ChkListCode into d1
                         from d in d1.DefaultIfEmpty()
                         where a.CardCode == CardCode && !a.IsDeleted
                         select new
                         {
                             ID = a.ID,
                             ObjName = b.Name,
                             ObjTypeName = c.ObjTypeName,
                             ObjTypeCode = c.ObjTypeCode,
                             ObjID = b.Code,
                             RelativeCode = a.Relative,
                             RelativeName = _context.CommonSettings.FirstOrDefault(x => x.CodeSet.Equals(a.Relative)).ValueSet,
                             Weight = a.Weight.ToString() != null ? a.Weight.ToString() : "",
                             IdObjTemp = b.ID,
                             ItemCode = d != null ? d.ChkListCode : "",
                             ItemName = d != null ? d.CheckTitle : ""
                         }).DistinctBy(x => new { x.ObjTypeCode, x.RelativeCode, x.ObjID });
            return Json(data2);
        }

        [HttpPost]
        public JsonResult DeleteCardDependency(int Id)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var session = HttpContext.GetSessionUser();

                var data = _context.JcObjectIdRelatives.FirstOrDefault(x => x.ID == Id && !x.IsDeleted);
                if (data != null)
                {
                    if (session.IsAllData || data.CreatedBy.Equals(session.UserName))
                    {
                        data.IsDeleted = true;
                        data.DeletedBy = ESEIM.AppContext.UserName;
                        data.DeletedTime = DateTime.Now;
                        _context.JcObjectIdRelatives.Update(data);
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "DELETE",
                            IdObject = "CARD_OBJ_RELATIVE",
                            IsCheck = true,
                            CardCode = data.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = ""
                        };
                        _context.CardUserActivities.Add(activity);

                        UpdateChangeCard(data.CardCode);

                        _context.SaveChanges();
                        msg.Title = _sharedResources["COM_DELETE_SUCCESS"];
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = "Bạn không có quyền xóa";
                    }
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy dữ liệu";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                msg.Object = ex;
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetRelative()
        {
            var data = _context.CommonSettings.Where(x => x.Group.Equals(EnumHelper<CardEnum>.GetDisplayValue(CardEnum.ObjRelative)) && x.IsDeleted == false)
                            .Select(x => new { Code = x.CodeSet, Name = x.ValueSet });
            return Json(data);
        }

        [NonAction]
        public string GetObjectRelativeName(string objCode, string objType)
        {
            var result = "";
            if (objType == EnumHelper<ProjectEnum>.GetDisplayValue(ProjectEnum.Project))
            {
                result = _context.Projects.FirstOrDefault(x => x.ProjectCode == objCode && !x.FlagDeleted)?.ProjectTitle;
            }
            else if (objType == EnumHelper<ContractEnum>.GetDisplayValue(ContractEnum.Contract))
            {
                result = _context.PoSaleHeaders.FirstOrDefault(x => x.ContractCode == objCode && !x.IsDeleted)?.Title;
            }
            else if (objType == EnumHelper<CustomerEnum>.GetDisplayValue(CustomerEnum.Customer))
            {
                result = _context.Customerss.FirstOrDefault(x => x.CusCode == objCode && !x.IsDeleted)?.CusName;
            }
            else if (objType == EnumHelper<SupplierEnum>.GetDisplayValue(SupplierEnum.Supplier))
            {
                result = _context.Suppliers.FirstOrDefault(x => x.SupCode == objCode && !x.IsDeleted)?.SupName;
            }
            return result;
        }

        [HttpPost]
        public JsonResult GetObjCode(string Dependency)
        {
            if (Dependency == EnumHelper<ProjectEnum>.GetDisplayValue(ProjectEnum.Project))
            {
                var project = _context.Projects.Where(x => x.FlagDeleted == false).Select(x => new { Code = x.ProjectCode, Name = x.ProjectTitle, Id = x.Id }).OrderByDescending(x => x.Id).ToList();
                return Json(project);
            }
            else if (Dependency == EnumHelper<ContractEnum>.GetDisplayValue(ContractEnum.Contract))
            {
                var contract = _context.PoSaleHeaders.Where(x => x.IsDeleted == false).Select(x => new { Code = x.ContractCode, Name = x.Title, Id = x.ContractHeaderID }).OrderByDescending(x => x.Id).ToList();
                return Json(contract);
            }
            else if (Dependency == EnumHelper<PoSupplierEnum>.GetDisplayValue(PoSupplierEnum.PoSupplier))
            {
                var contract = _context.PoBuyerHeaders.Where(x => x.IsDeleted == false).Select(x => new { Code = x.PoSupCode, Name = x.PoTitle, Id = x.Id }).OrderByDescending(x => x.Id).ToList();
                return Json(contract);
            }
            else if (Dependency == EnumHelper<CustomerEnum>.GetDisplayValue(CustomerEnum.Customer))
            {
                var customer = _context.Customerss.Where(x => x.IsDeleted == false).Select(x => new { Code = x.CusCode, Name = x.CusName, Id = x.CusID }).OrderByDescending(x => x.Id).ToList();
                return Json(customer);
            }
            else if (Dependency == EnumHelper<SupplierEnum>.GetDisplayValue(SupplierEnum.Supplier))
            {
                var supplier = _context.Suppliers.Where(x => x.IsDeleted == false).Select(x => new { Code = x.SupCode, Name = x.SupName, Id = x.SupID }).OrderByDescending(x => x.Id).ToList();
                return Json(supplier); ;
            }
            else
            {
                return Json("");
            }
        }

        [HttpPost]
        public JsonResult GetItemChk(string cardCode)
        {
            var cardItemChecks = _context.CardItemChecks
                .Where(x => !x.Flag && x.CardCode.Equals(cardCode))
                .Select(x => new { Code = x.ChkListCode, Name = x.CheckTitle });
            return Json(cardItemChecks);
        }
        #endregion

        #region Product
        [HttpPost]
        public object GetProduct()
        {
            return _context.MaterialProducts.Where(x => !x.IsDeleted).Select(x => new { Code = x.ProductCode, Name = x.ProductName }).AsNoTracking();
        }

        [HttpPost]
        public object GetCardProduct(string CardCode)
        {
            var query = from a in _context.JcProducts
                        join b in _context.MaterialProducts on a.ProductCode equals b.ProductCode
                        where a.CardCode == CardCode && !a.IsDeleted
                        select new
                        {
                            a.ID,
                            a.CreatedTime,
                            a.CreatedBy,
                            a.Quantity,
                            b.ProductCode,
                            b.ProductName,
                        };
            return query;
        }

        [HttpPost]
        public JsonResult InsertProduct([FromBody] JcProduct product)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var checkExist = _context.JcProducts.FirstOrDefault(x => x.CardCode == product.CardCode && x.ProductCode == product.ProductCode && !x.IsDeleted);
                if (checkExist != null)
                {
                    if ((checkExist.Quantity + product.Quantity) > 10000)
                    {
                        msg.Error = true;
                        msg.Title = "Số lượng sản phẩm tối đa " + (10000 - checkExist.Quantity);
                        return Json(msg);
                    }
                    checkExist.Quantity += product.Quantity;
                    _context.JcProducts.Update(checkExist);
                }
                else
                {
                    if (product.Quantity > 10000)
                    {
                        msg.Error = true;
                        msg.Title = "Số lượng sản phẩm tối đa 10000";
                        return Json(msg);
                    }
                    product.CreatedBy = ESEIM.AppContext.UserName;
                    product.CreatedTime = DateTime.Now;
                    _context.JcProducts.Add(product);
                }
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    IdObject = "PROD",
                    Action = "ADD",
                    IsCheck = true,
                    CardCode = product.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = _context.MaterialProducts.FirstOrDefault(x => x.ProductCode == product.ProductCode).ProductName
                };
                _context.CardUserActivities.Add(activity);
                UpdateChangeCard(product.CardCode);
                _context.SaveChanges();
                msg.Title = String.Format(_sharedResources["COM_MSG_ADD_SUCCESS"], _stringLocalizer["CJ_MSG_PRODUCT"]);
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpGet]
        public JsonResult DeleteProduct(int id)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var cardProduct = _context.JcProducts.FirstOrDefault(x => x.ID == id);
                if (cardProduct != null)
                {
                    cardProduct.IsDeleted = true;
                    cardProduct.DeletedBy = ESEIM.AppContext.UserName;
                    cardProduct.DeletedTime = DateTime.Now;
                    _context.Update(cardProduct);

                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        IdObject = "PROD",
                        Action = "DELETE",
                        IsCheck = true,
                        CardCode = cardProduct.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = _context.MaterialProducts.FirstOrDefault(x => x.ProductCode == cardProduct.ProductCode).ProductName
                    };
                    _context.CardUserActivities.Add(activity);
                    UpdateChangeCard(cardProduct.CardCode);
                    _context.SaveChanges();
                    //msg.Title = "Xóa sản phẩm thành công!";
                    msg.Title = String.Format(_sharedResources["COM_MSG_DELETE_SUCCESS"], _stringLocalizer["CJ_MSG_PRODUCT"]);
                }
                else
                {
                    msg.Error = true;
                    //msg.Title = "Sản phẩm không tồn tại!";
                    msg.Title = _stringLocalizer["CJ_MSG_PRODUCT_NOT_EXISTS"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                //msg.Title = "Có lỗi khi thêm sản phẩm!";
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetActivityProduct()
        {
            var data = _context.CommonSettings.Where(x => x.Group == "JC_ACTIVITY_PRODUCT" && !x.IsDeleted).Select(x => new { Code = x.CodeSet, Name = x.ValueSet });
            return Json(data);
        }
        #endregion

        #region Service
        [HttpPost]
        public object GetService()
        {
            return _context.ServiceCategorys.Where(x => !x.IsDeleted).Select(x => new { Code = x.ServiceCode, Name = x.ServiceName }).AsNoTracking();
        }

        [HttpPost]
        public object GetCardService(string CardCode)
        {
            var query = from a in _context.JcServices
                        join b in _context.ServiceCategorys on a.ServiceCode equals b.ServiceCode
                        where a.CardCode == CardCode && !a.IsDeleted
                        select new
                        {
                            a.ID,
                            a.CreatedTime,
                            a.CreatedBy,
                            a.Quantity,
                            b.ServiceCode,
                            b.ServiceName,
                        };
            return query;
        }

        [HttpPost]
        public JsonResult InsertService([FromBody] JcService service)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var checkExist = _context.JcServices.FirstOrDefault(x => x.CardCode == service.CardCode && x.ServiceCode == service.ServiceCode && !x.IsDeleted);
                if (checkExist != null)
                {
                    if ((checkExist.Quantity + service.Quantity) > 10000)
                    {
                        msg.Error = true;
                        msg.Title = "Số lượng sản phẩm tối đa " + (10000 - checkExist.Quantity);
                        return Json(msg);
                    }
                    checkExist.Quantity += service.Quantity;
                    _context.JcServices.Update(checkExist);
                }
                else
                {
                    if (service.Quantity > 10000)
                    {
                        msg.Error = true;
                        msg.Title = "Số lượng sản phẩm tối đa 10000";
                        return Json(msg);
                    }
                    service.CreatedBy = ESEIM.AppContext.UserName;
                    service.CreatedTime = DateTime.Now;
                    _context.JcServices.Add(service);
                }

                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    IdObject = "SER",
                    Action = "ADD",
                    IsCheck = true,
                    CardCode = service.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = _context.ServiceCategorys.FirstOrDefault(x => !x.IsDeleted && x.ServiceCode == service.ServiceCode).ServiceName
                };
                _context.CardUserActivities.Add(activity);
                UpdateChangeCard(service.CardCode);
                _context.SaveChanges();
                msg.Title = _stringLocalizer["CJ_MSG_ADD_SERVICE_SUCCESS"];

            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpGet]
        public JsonResult DeleteService(int id)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var cardService = _context.JcServices.FirstOrDefault(x => x.ID == id);
                if (cardService != null)
                {
                    cardService.IsDeleted = true;
                    cardService.DeletedBy = ESEIM.AppContext.UserName;
                    cardService.DeletedTime = DateTime.Now;
                    _context.JcServices.Update(cardService);

                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        IdObject = "SER",
                        Action = "DELETE",
                        IsCheck = true,
                        CardCode = cardService.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = _context.ServiceCategorys.FirstOrDefault(x => !x.IsDeleted && x.ServiceCode == cardService.ServiceCode).ServiceName
                    };
                    _context.CardUserActivities.Add(activity);
                    UpdateChangeCard(cardService.CardCode);
                    _context.SaveChanges();
                    msg.Title = _stringLocalizer["CJ_MSG_DELETE_SERVICE_SUCCESS"];
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_SERVICE_NOT_EXIST"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetActivityService()
        {
            var data = _context.CommonSettings.Where(x => x.Group == "JC_ACTIVITY_SERVICE" && !x.IsDeleted).Select(x => new { Code = x.CodeSet, Name = x.ValueSet });
            return Json(data);
        }
        #endregion

        #region Notification
        [NonAction]
        public async Task<int> SendPushNotification(IQueryable<CardMemberCustom> listUserId, string message, object data, string fromSrc)
        {
            if (listUserId != null && listUserId.Any())
            {
                var query = (from a in listUserId
                             join b in _context.FcmTokens on a.UserId equals b.UserId
                             join c in _context.Users on a.UserId equals c.Id
                             where c.Active == true && b.AppCode == "SMARTWORK"
                             select new DeviceFcm
                             {
                                 Token = b.Token,
                                 Device = b.Device,
                                 UserId = a.UserId
                             }).AsNoTracking().Select(y => new DeviceFcm { Token = y.Token, Device = y.Device, UserId = y.UserId });
                if (query.Any())
                {
                    var countToken = query.Count();
                    if (countToken > 100000)
                    {
                        int countPush = (query.Count() / 100000) + 1;
                        for (int i = 0; i < countPush; i++)
                        {
                            List<DeviceFcm> listDevices = query.Skip(i * 1000).Take(100000).AsNoTracking().ToList();

                            var sendNotication = await _notification.SendNotification("Thông báo", message, listDevices, data, fromSrc, ESEIM.AppContext.UserName);
                        }
                    }
                    else
                    {
                        var sendNotication = await _notification.SendNotification("Thông báo", message, query.ToList(), data, fromSrc, ESEIM.AppContext.UserName);
                    }
                }
            }
            return 1;
        }

        [HttpPost]
        public async Task<JsonResult> SendNotification([FromBody] CardNotifi notifi)
        {
            var msg = new JMessage();
            try
            {
                var session = HttpContext.GetSessionUser();
                var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == notifi.CardCode && !x.IsDeleted);
                var list = _context.WORKOSLists.FirstOrDefault(x => x.ListCode == card.ListCode && !x.IsDeleted);
                var board = _context.WORKOSBoards.FirstOrDefault(x => x.BoardCode == list.BoardCode && !x.IsDeleted);

                await SendPushNotification(notifi.LstUser.AsQueryable(), string.Format("Thẻ #{0} được cập nhật bởi {1}", card.CardCode, session.FullName), new
                {
                    board.BoardCode,
                    board.BoardName,
                    list.ListCode,
                    card.CardCode,
                    card.CardName,
                    card.BeginTime,
                    card.EndTime,
                    card.CardID,
                    card.CardLevel,
                    card.Deadline,
                    card.Currency,
                    card.Completed,
                    card.Cost,
                    Type = board.BoardType == "BOARD_REPEAT" ? "REPEAT" : board.BoardType == "BOARD_PROJECT" ? "PROJECT" : "BUILDING",
                    ProjectCode = "",
                    ProjectName = "",
                }, EnumHelper<FromSrcSendNotify>.GetDisplayValue(FromSrcSendNotify.FromCardJob));
                msg.Title = _stringLocalizer["CJ_MSG_SEND_NOTIFI_SUCCESS"];
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }
        public class CardNotifi
        {
            public string CardCode { get; set; }
            public List<CardMemberCustom> LstUser { get; set; }
        }
        [NonAction]
        public string GetNotificationBatch()
        {
            var notifBatch = _context.CommonSettings.FirstOrDefault(x => x.CodeSet == "NOTIFICATION_CARD"
            && x.Group == "NOTIFICATION" && x.AssetCode == "CARDJOB" && !x.IsDeleted).ValueSet;
            return notifBatch;
        }

        [HttpPost]
        public JsonResult UpdateListUserView(string cardCode)
        {
            var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == cardCode && !x.IsDeleted);
            data.ListUserView = ESEIM.AppContext.UserId;
            _context.SaveChanges();
            return Json("");
        }
        [HttpPost]
        public JsonResult InsertListUserView(string cardCode)
        {
            var data = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == cardCode && !x.IsDeleted);
            if (data != null)
            {
                data.ListUserView = ";" + ESEIM.AppContext.UserId;
                _context.SaveChanges();
            }
            return Json("");
        }

        [HttpPost]
        public JsonResult GetMemberSendNotification(string cardCode)
        {
            var listUsers = from a in _context.JobCardAssignees.Where(x => !x.IsDeleted && x.CardCode.Equals(cardCode) && x.Status.Equals("ASSIGN_STATUS_WORK"))
                            join b in _context.Users.Where(x => x.Active) on a.UserId equals b.Id
                            select new
                            {
                                a.UserId,
                                b.GivenName,
                                IsCheck = true
                            };
            return Json(listUsers);
        }

        public class NotificationBatch
        {
            public string IdObject { get; set; }
            public string Action { get; set; }
            public string UserAction { get; set; }
            public DateTime CreatedTime { get; set; }
        }
        public class NotificationBatchModel
        {
            public string CardCode { get; set; }
            public List<NotificationBatch> List { get; set; }
        }
        #endregion

        #region Assign
        [HttpPost]
        public object GetListRoleAssign()
        {

            var data = _context.CommonSettings.Where(x => x.Group == EnumHelper<CardEnum>.GetDisplayValue(CardEnum.Role)).OrderBy(x => x.Priority)
                .Select(x => new { Code = x.CodeSet, Name = x.ValueSet });
            return data;
        }

        [HttpPost]
        public JsonResult AssignGroupOrTeam([FromBody] Assignee data)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var session = HttpContext.GetSessionUser();

                var json = new List<JobCardAssignee>();
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(data.CardCode));
                if (card != null)
                {
                    card.LstUser = string.Join(",", data.LstAssign.Select(x => x.UserId));

                    var cardAttachments = _context.CardAttachments.Where(x => !x.Flag && x.CardCode.Equals(card.CardCode));
                    if (cardAttachments.Any())
                    {
                        foreach (var item in cardAttachments)
                        {
                            item.ListPermissionViewFile = string.Join(",", data.LstAssign.Select(x => x.UserId));
                            _context.CardAttachments.Update(item);
                        }
                    }

                    if (!string.IsNullOrEmpty(card.JsonAssign))
                    {
                        json = JsonConvert.DeserializeObject<List<JobCardAssignee>>(card.JsonAssign);
                    }
                }
                //Delete ListObj, Delete member
                if (data.LstDelAssign.Any())
                {
                    foreach (var item in data.LstDelAssign)
                    {
                        if (item.Id > 0)
                        {
                            var assign = _context.JobCardAssignees.FirstOrDefault(x => x.ID == item.Id);
                            assign.IsDeleted = true;
                            assign.DeletedBy = ESEIM.AppContext.UserName;
                            assign.DeletedTime = DateTime.Now;
                            _context.JobCardAssignees.Update(assign);

                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                IdObject = "DEL_MEMBER",
                                Action = "DEL",
                                IsCheck = true,
                                CardCode = data.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = item.GivenName + " khỏi thẻ việc"
                            };
                            _context.CardUserActivities.Add(activity);

                            var itemStaff = _context.WorkItemAssignStaffs.Where(x => x.UserId.Equals(assign.UserId) && x.CardCode.Equals(data.CardCode));
                            if (itemStaff.Any())
                            {
                                _context.WorkItemAssignStaffs.RemoveRange(itemStaff);
                            }
                            json.Remove(assign);
                        }
                    }
                }

                //Insert ListObject, member

                if (data.LstAssign.Any())
                {
                    var listUserNotify = new List<UserNotify>();

                    foreach (var item in data.LstAssign)
                    {
                        if (item.Id < 0)
                        {
                            var isManager = CheckRoleCurrenUser(data.CardCode, item);
                            var assign = new JobCardAssignee
                            {
                                CardCode = item.CardCode,
                                UserId = item.UserId,
                                Role = item.Role,
                                DepartmentCode = item.Depart,
                                GroupCode = item.Group,
                                Item = "",
                                CreatedBy = ESEIM.AppContext.UserName,
                                CreatedTime = DateTime.Now,
                                Approve = isManager ? true : (bool?)null,
                                ApproveTime = item.Approve ? DateTime.Now : (DateTime?)null,
                                Branch = item.Branch,
                                Status = item.Status,
                                Type = 3
                            };
                            _context.JobCardAssignees.Add(assign);
                            json.Add(assign);

                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                IdObject = "ADD_MEMBER",
                                Action = "ADD",
                                IsCheck = true,
                                CardCode = data.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = item.GivenName + " vào thẻ việc"
                            };
                            _context.CardUserActivities.Add(activity);
                        }
                        else
                        {
                            var check = _context.JobCardAssignees.FirstOrDefault(x => x.ID == item.Id);
                            check.Role = item.Role;
                            check.Approve = item.Approve;
                            check.ApproveTime = item.Approve ? DateTime.Now : (DateTime?)null;
                            check.Status = item.Status;
                            _context.JobCardAssignees.Update(check);
                        }

                        //Add user to Notification
                        var userNotify = new UserNotify
                        {
                            UserId = item.UserId
                        };

                        if (!listUserNotify.Any(p => p.UserId.Equals(userNotify.UserId)) && !userNotify.UserId.Equals(ESEIM.AppContext.UserId))
                            listUserNotify.Add(userNotify);
                    }

                    if (listUserNotify.Count > 0)
                    {
                        var notification = new NotificationManager
                        {
                            ListUser = listUserNotify,
                            Title = string.Format("{0} đã tạo 1 thẻ việc mới: #{1} {2}", session.FullName, card.CardCode, card.CardName),
                            ObjCode = card.CardCode,
                            ObjType = EnumHelper<NotificationType>.GetDisplayValue(NotificationType.CardJob),
                        };

                        UpdateNotification(notification);
                    }
                }
                card.JsonAssign = JsonConvert.SerializeObject(json);

                UpdateChangeCard(card.CardCode);
                _context.SaveChanges();
                msg.Title = String.Format(_sharedResources["COM_MSG_UPDATE_SUCCESS"], _stringLocalizer["CJ_CURD_TAB_ADD_MEMBER"]);//"Thêm thành viên thành công!";
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [NonAction]
        public List<UserIdModel> GetMemberInDepartment(string departmentCode)
        {
            var listUserInDepartment = from a in _context.AdDepartments.Where(x => x.DepartmentCode == departmentCode)
                                       join b in _context.Users on a.DepartmentCode equals b.DepartmentId
                                       select new UserIdModel
                                       {
                                           UserId = b.Id,
                                           GivenName = b.GivenName
                                       };
            return listUserInDepartment.ToList();
        }
        [NonAction]
        public List<UserIdModel> GetMemberInGroup(string groupCode)
        {
            var listUserInGroup = from a in _context.AdUserInGroups.Where(x => x.GroupUserCode == groupCode && !x.IsDeleted)
                                  select new UserIdModel
                                  {
                                      UserId = a.UserId,
                                  };
            return listUserInGroup.ToList();
        }

        [HttpPost]
        public JsonResult GetMemberAssign(string CardCode)
        {
            var session = HttpContext.GetSessionUser();
            var query = (from a in _context.JobCardAssignees.Where(x => !x.IsDeleted)
                         join b in _context.Users on a.UserId equals b.Id
                         join c in _context.AdDepartments.Where(x => !x.IsDeleted && x.IsEnabled) on b.DepartmentId equals c.DepartmentCode into c1
                         from c2 in c1.DefaultIfEmpty()
                         let card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(CardCode))
                         where a.CardCode == CardCode
                         select new LstMemberAssign
                         {
                             Id = a.ID,
                             UserId = b.Id,
                             GivenName = b.GivenName,
                             Role = a.Role,
                             IsManager = false,
                             Department = !string.IsNullOrEmpty(b.DepartmentId) ? b.DepartmentId : "",
                             DepartmentName = c2 != null ? c2.Title : "",
                             Status = a.Status,
                             IsSameDepartment = false,
                             IsAccept = a.Approve.HasValue ? a.Approve.Value : false,
                             IsReject = false,
                             Approve = a.Approve.HasValue ? a.Approve.Value : false,
                             CreatedBy = a.CreatedBy,
                             IsInteract = session.IsAllData ? false : card.CreatedBy.Equals(session.UserName) ? false : true,
                             RoleSys = (from m in _context.UserRoles.Where(x => x.UserId.Equals(b.Id))
                                        join n in _context.Roles on m.RoleId equals n.Id
                                        select n).FirstOrDefault() != null ? (from m in _context.UserRoles.Where(x => x.UserId.Equals(b.Id))
                                                                              join n in _context.Roles on m.RoleId equals n.Id
                                                                              select n).FirstOrDefault().Title : "Nhân viên"
                         }).ToList();
            if (query.Any())
            {
                var check = false;
                foreach (var item in query)
                {
                    if (item.UserId.Equals(ESEIM.AppContext.UserId))
                    {
                        if (CheckManager(item.Role, item.UserId))
                        {
                            item.IsManager = true;
                            check = true;
                            break;
                        }
                    }
                }
                foreach (var item in query)
                {
                    if (check && item.UserId != session.UserId && !string.IsNullOrEmpty(session.DepartmentCode)
                        && !string.IsNullOrEmpty(item.Department) && item.Department.Equals(session.DepartmentCode))
                    {
                        item.IsSameDepartment = true;
                    }
                }
            }
            return Json(query);
        }

        [NonAction]
        private bool CheckManager(string role, string userId)
        {
            var isManager = false;
            var roleSys = _context.UserRoles.FirstOrDefault(x => x.UserId.Equals(userId));
            if (role.Equals("ROLE_LEADER_ACCEPTED") || (roleSys != null && roleSys.RoleId.Equals("49b018ad-68af-4625-91fd-2273bb5cf749")))
            {
                isManager = true;
            }
            return isManager;
        }

        [HttpGet]
        public bool CheckShowLabelAssign(string cardCode, List<JobCardUser> users)
        {
            var isShow = false;
            var session = HttpContext.GetSessionUser();
            var data = users.Where(x => x.CardCode.Equals(cardCode));
            //var data = from a in _context.JobCardAssignees.Where(x => !x.IsDeleted && x.CardCode.Equals(cardCode))
            //           join b in _context.Users on a.UserId equals b.Id
            //           select new
            //           {
            //               a.Role,
            //               a.UserId,
            //               b.DepartmentId,
            //               a.Approve
            //           };
            var roleSys = _context.UserRoles.FirstOrDefault(x => x.UserId.Equals(ESEIM.AppContext.UserId) && x.RoleId.Equals("49b018ad-68af-4625-91fd-2273bb5cf749"));
            var roleAccept = data.FirstOrDefault(x => x.UserId.Equals(ESEIM.AppContext.UserId) && x.Role.Equals("ROLE_LEADER_ACCEPTED"));

            if (roleAccept != null || roleSys != null)
            {
                foreach (var item in data)
                {
                    if (!string.IsNullOrEmpty(item.DepartmentId) && item.DepartmentId.Equals(session.DepartmentCode) && item.UserId != session.UserId)
                    {
                        if (!item.Approve.HasValue || !item.Approve.Value)
                        {
                            isShow = true;
                            break;
                        }
                    }
                }
            }
            return isShow;
        }

        [HttpPost]
        public object RoleInCardOfUser(string cardCode)
        {
            var session = HttpContext.GetSessionUser();
            var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.Status != "TRASH" && x.CardCode == cardCode);
            var role = new RoleInCard();
            if (session.IsAllData || session.UserName == card.CreatedBy)
            {
                role = new RoleInCard
                {
                    Id = 0,
                    DepartmentId = "",
                    Responsibility = "ROLE_LEADER",
                    UserId = session.UserId,
                    Priority = 0
                };
            }
            else
            {
                var data = _context.JobCardAssignees.Where(x => !x.IsDeleted && x.CardCode.Equals(cardCode)).ToList();
                foreach (var item in data)
                {
                    if (item.UserId == session.UserId)
                    {
                        role = new RoleInCard
                        {
                            Id = 0,
                            DepartmentId = item.DepartmentCode,
                            Responsibility = item.Role,
                            UserId = item.UserId,
                            Priority = 0
                        };
                    }
                }
            }
            return role;
        }

        [NonAction]
        public bool CheckRoleCurrenUser(string cardCode, LstAssignee data)
        {
            var session = HttpContext.GetSessionUser();
            var isManager = false;

            //Check current user is Manager
            var assign = _context.JobCardAssignees.FirstOrDefault(x => !x.IsDeleted && x.UserId.Equals(session.UserId)
                && x.CardCode.Equals(cardCode) && x.Role.Equals("ROLE_LEADER_ACCEPTED"));
            if ((!string.IsNullOrEmpty(session.RoleCode) && session.RoleCode.Equals("TRUONGPHONG")) || assign != null)
            {
                var user = _context.Users.FirstOrDefault(x => x.Id.Equals(data.UserId));
                if (user != null)
                {
                    if (!string.IsNullOrEmpty(user.DepartmentId))
                    {
                        if (session.DepartmentCode.Equals(user.DepartmentId))
                        {
                            isManager = true;
                        }
                    }
                }
            }
            return isManager;
        }

        [HttpPost]
        public object GetGroupDepartmentAssign(string cardCode)
        {
            var data = _context.JobCardAssignees.Where(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
            var groups = data.Where(x => !(string.IsNullOrEmpty(x.GroupCode))).DistinctBy(x => x.GroupCode);
            var department = data.Where(x => !(string.IsNullOrEmpty(x.DepartmentCode))).DistinctBy(x => x.DepartmentCode);
            var groupAssign = from a in groups
                              join b in _context.AdGroupUsers.Where(x => !x.IsDeleted && x.IsEnabled) on a.GroupCode equals b.GroupUserCode
                              join c in _context.AdOrganizations.Where(x => x.IsEnabled) on a.Branch equals c.OrgAddonCode
                              select new
                              {
                                  b.Title,
                                  c.OrgName
                              };
            var dpmAssign = from a in department
                            join b in _context.AdDepartments.Where(x => !x.IsDeleted && x.IsEnabled) on a.DepartmentCode equals b.DepartmentCode
                            join c in _context.AdOrganizations.Where(x => x.IsEnabled) on a.Branch equals c.OrgAddonCode
                            select new
                            {
                                b.Title,
                                c.OrgName
                            };
            return new
            {
                Group = groupAssign,
                Dpm = dpmAssign
            };
        }

        [HttpPost]
        public JsonResult AssignStatus(int id, string value)
        {
            var session = HttpContext.GetSessionUser();
            var msg = new JMessage();
            if (session.IsAllData)
            {
                var log = new List<JobCardAssignee>();
                var assign = _context.JobCardAssignees.FirstOrDefault(x => x.ID == id);
                if (assign != null)
                {
                    assign.Status = value;
                    log = JsonConvert.DeserializeObject<List<JobCardAssignee>>(assign.Log);
                    log.Add(assign);
                    assign.Log = JsonConvert.SerializeObject(log);
                    _context.JobCardAssignees.Update(assign);
                    _context.SaveChanges();
                    msg.Title = "Cập nhật trạng thái thành công";
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy nhân viên được giao";
                }
            }
            else
            {
                msg.Error = true;
                msg.Title = _sharedResources["caption.COM_MSG_NO_PERMISSION"];
            }


            return Json(msg);
        }

        [HttpGet]
        public JsonResult GetStatusAssign()
        {
            var data = _context.CommonSettings.Where(x => !x.IsDeleted && x.Group.Equals("ASSIGN_STATUS")).Select(x => new { Code = x.CodeSet, Name = x.ValueSet });
            return Json(data);
        }

        [HttpGet]
        public JsonResult RoleChangeStatusAssign()
        {
            var isChange = false;
            var session = HttpContext.GetSessionUser();
            if (session.IsAllData)
            {
                isChange = true;
            }
            return Json(isChange);
        }

        public class LstMemberAssign
        {
            public int Id { get; set; }
            public string UserId { get; set; }
            public string GivenName { get; set; }
            public string Role { get; set; }
            public string Department { get; set; }
            public bool IsManager { get; set; }
            public bool IsSameDepartment { get; set; }
            public bool IsAccept { get; set; }
            public bool IsReject { get; set; }
            public bool Approve { get; set; }
            public string RoleSys { get; set; }
            public string DepartmentName { get; set; }
            public string CreatedBy { get; set; }
            public bool IsInteract { get; set; }
            public string Status { get; set; }
        }
        public class Assignee
        {
            public Assignee()
            {
                LstAssign = new List<LstAssignee>();
                LstDelAssign = new List<LstDelAssign>();
            }
            public List<LstAssignee> LstAssign { get; set; }
            public List<LstDelAssign> LstDelAssign { get; set; }
            public string CardCode { get; set; }
        }
        public class LstDelAssign
        {
            public int Id { get; set; }
            public string GivenName { get; set; }
        }
        public class LstAssignee
        {
            public int Id { get; set; }
            public string UserId { get; set; }
            public string Role { get; set; }
            public string Group { get; set; }
            public string Depart { get; set; }
            public string GivenName { get; set; }
            public string CardCode { get; set; }
            public bool Approve { get; set; }
            public string Branch { get; set; }
            public string Status { get; set; }

        }
        public class UserIdModel
        {
            public string UserId { get; set; }
            public string GivenName { get; set; }
        }
        public class ModelAssign
        {
            public string UserId { get; set; }
            public string Role { get; set; }
            public string Depart { get; set; }
            public string Group { get; set; }
        }
        public class RoleInCard
        {
            public int Id { get; set; }
            public string UserId { get; set; }
            public string Responsibility { get; set; }
            public string DepartmentId { get; set; }
            public int? Priority { get; set; }
        }

        public class ActivityAssignee
        {
            public int Id { get; set; }
            public string UserId { get; set; }
            public string GivenName { get; set; }
            public string Picture { get; set; }
            public string Action { get; set; }
            public string IdObject { get; set; }
            public string CreatedTime { get; set; }
            public bool IsCheck { get; set; }
            public string ChangeDetails { get; set; }
            public string CardCode { get; set; }
        }

        private object GetActivityAssignPrivate(string cardCode, List<ActivityAssignee> data)
        {
            var obj = data.Where(x => x.CardCode == cardCode)
                .OrderByDescending(x => x.Id).FirstOrDefault();
            return obj;
        }

        [HttpGet]
        public object GetActivityAssign(string cardCode)
        {
            var query = (from a in _context.CardUserActivities.Where(x => x.CardCode == cardCode)
                        .OrderByDescending(x => x.Id).Take(10)
                         join b in _context.Users on a.UserId equals b.Id
                         select new
                         {
                             a.Id,
                             a.UserId,
                             b.GivenName,
                             b.Picture,
                             a.Action,
                             a.IdObject,
                             CreatedTime = a.CreatedTime.ToString("dd/MM/yyyy HH:mm:ss"),
                             a.IsCheck,
                             a.ChangeDetails
                         });
            return Json(query);
        }

        [HttpGet]
        public object LogActivityUser(string cardCode)
        {
            var userId = ESEIM.AppContext.UserId;
            var activityExceptUser = (from a in _context.CardUserActivities
                                      join b in _context.Users on a.UserId equals b.Id
                                      where a.CardCode == cardCode && (a.Action == "REVIEW" || a.Action == "REJECT" || a.Action == "ACCEPT")
                                      && a.UserId != userId
                                      select new
                                      {
                                          a.Id,
                                          a.UserId,
                                          b.GivenName,
                                          b.Picture,
                                          a.Action,
                                          a.IdObject,
                                          CreatedTime = a.CreatedTime.ToString("dd/MM/yyyy HH:mm:ss"),
                                          a.IsCheck,
                                          a.ChangeDetails
                                      }).OrderByDescending(x => x.Id);
            var activityCurrentUser = (from a in _context.CardUserActivities
                                       join b in _context.Users on a.UserId equals b.Id
                                       where a.CardCode == cardCode && (a.Action == "REVIEW" || a.Action == "REJECT" || a.Action == "ACCEPT")
                                       && a.UserId == userId
                                       select new
                                       {
                                           a.Id,
                                           a.UserId,
                                           b.GivenName,
                                           b.Picture,
                                           a.Action,
                                           a.IdObject,
                                           CreatedTime = a.CreatedTime.ToString("dd/MM/yyyy HH:mm:ss"),
                                           a.IsCheck,
                                           a.ChangeDetails
                                       }).OrderByDescending(x => x.Id);
            var query = activityCurrentUser.Concat(activityExceptUser);

            var allActivity = (from a in _context.CardUserActivities
                               join b in _context.Users on a.UserId equals b.Id
                               where a.CardCode == cardCode && (a.Action == "REVIEW" || a.Action == "REJECT" || a.Action == "ACCEPT")
                               select new
                               {
                                   a.Id,
                                   a.UserId,
                                   b.GivenName,
                                   b.Picture,
                                   a.Action,
                                   a.IdObject,
                                   CreatedTime = a.CreatedTime.ToString("dd/MM/yyyy HH:mm:ss"),
                                   a.IsCheck,
                                   a.ChangeDetails
                               }).DistinctBy(x => new { x.Action, x.UserId });


            var countView = allActivity.Where(x => x.Action == "REVIEW");
            var countReject = allActivity.Where(x => x.Action == "REJECT");
            var countAccept = allActivity.Where(x => x.Action == "ACCEPT");
            return new
            {
                Log = query,
                CountView = countView.Count(),
                CountReject = countReject.Count(),
                CountAccept = countAccept.Count(),
            };
        }

        [HttpPost]
        public JsonResult GetMemberInCardJob(string cardCode)
        {
            var listUsers = from a in _context.JobCardAssignees.Where(x => !x.IsDeleted && x.CardCode.Equals(cardCode))
                            join b in _context.Users.Where(x => x.Active) on a.UserId equals b.Id
                            select new
                            {
                                a.UserId,
                                b.GivenName,
                                IsCheck = true
                            };
            return Json(listUsers);
        }


        [HttpPost]
        public JsonResult GetUserInItemWork([FromBody] JobCardUserItemMember obj)
        {
            var data = from a in _context.WorkItemAssignStaffs
                       join b in _context.Users on a.UserId equals b.Id
                       where !a.IsDeleted && a.CardCode.Equals(obj.CardCode) && a.CheckListCode.Equals(obj.CheckListCode)
                       select new
                       {
                           a.UserId,
                           b.GivenName
                       };
            return Json(data);
        }

        [HttpPost]
        public JsonResult InsertJobCardUser([FromBody] WorkItemAssignStaff obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var data = _context.WorkItemAssignStaffs.FirstOrDefault(x => x.UserId.Equals(obj.UserId) && x.CardCode.Equals(obj.CardCode) && !x.IsDeleted && x.CheckListCode.Equals(obj.CheckListCode));
                if (data == null)
                {
                    var jobCardUser = new WorkItemAssignStaff
                    {
                        CardCode = obj.CardCode,
                        UserId = obj.UserId,
                        CheckItem = obj.CheckItem,
                        CheckListCode = obj.CheckListCode,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now,
                        EstimateTime = obj.EstimateTime,
                        Unit = obj.Unit
                    };

                    _context.WorkItemAssignStaffs.Add(jobCardUser);

                    UpdateChangeCard(obj.CardCode);

                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_ADD_SUCCESS"];
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_MEMBER_ADDED_ITEM"];
                }

            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetJobCardUser([FromBody] JobCardUserItemMember obj)
        {
            var data = from a in _context.WorkItemAssignStaffs
                       join b in _context.Users on a.UserId equals b.Id
                       where a.CheckListCode.Equals(obj.CheckListCode) && a.CardCode.Equals(obj.CardCode) && !a.IsDeleted && (a.CheckItem == "" || a.CheckItem == null)
                       select new
                       {
                           a.ID,
                           a.UserId,
                           b.GivenName,
                           a.EstimateTime,
                           Status = _context.CommonSettings.FirstOrDefault(x => x.CodeSet == a.Unit && !x.IsDeleted).ValueSet
                       };
            return Json(data);
        }

        [HttpPost]
        public JsonResult GetJobCardSubItemUser([FromBody] JobCardUserSubItemMember obj)
        {
            var data = (from a in _context.WorkItemAssignStaffs
                        join b in _context.Users on a.UserId equals b.Id
                        where a.CheckListCode.Equals(obj.CheckListCode) && a.CardCode.Equals(obj.CardCode) && !a.IsDeleted && a.CheckItem.Equals(obj.CheckItem)
                        select new
                        {
                            a.ID,
                            a.UserId,
                            b.GivenName,
                            a.EstimateTime,
                            Status = _context.CommonSettings.FirstOrDefault(x => x.CodeSet == a.Unit && !x.IsDeleted).ValueSet
                        }).DistinctBy(x => x.UserId);
            return Json(data);
        }
        [HttpPost]
        public JsonResult InsertUserToSubItem([FromBody] WorkItemAssignStaff obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var data = _context.WorkItemAssignStaffs.FirstOrDefault(x => x.UserId.Equals(obj.UserId) && x.CardCode.Equals(obj.CardCode) && !x.IsDeleted && x.CheckListCode.Equals(obj.CheckListCode) && x.CheckItem.Equals(obj.CheckItem));
                if (data == null)
                {
                    var jobCardUser = new WorkItemAssignStaff
                    {
                        CardCode = obj.CardCode,
                        UserId = obj.UserId,
                        CheckItem = obj.CheckItem,
                        CheckListCode = obj.CheckListCode,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now,
                        EstimateTime = obj.EstimateTime,
                        Unit = obj.Unit
                    };

                    _context.WorkItemAssignStaffs.Add(jobCardUser);
                    UpdateChangeCard(obj.CardCode);
                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_ADD_SUCCESS"];
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_MEMBER_EXISTED"];
                }

            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }
        [HttpPost]
        public JsonResult DeleteJobCardUser(int id)
        {
            var msg = new JMessage { Error = false, Title = "" };
            var data = _context.WorkItemAssignStaffs.FirstOrDefault(x => x.ID == id);
            if (data != null)
            {
                var isEmpInSubItem = _context.WorkItemAssignStaffs.Where(x => x.CardCode == data.CardCode && x.CheckItem != "" && x.CheckListCode == data.CheckListCode && x.UserId == data.UserId && !x.IsDeleted).ToList();
                if (data.CheckItem != "")
                {
                    data.IsDeleted = true;
                    data.DeletedBy = ESEIM.AppContext.UserName;
                    data.DeletedTime = DateTime.Now;
                    _context.WorkItemAssignStaffs.Update(data);
                    UpdateChangeCard(data.CardCode);
                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_DELETE_SUCCESS"];
                }
                else if (data.CheckItem == "" && isEmpInSubItem.Count == 0)
                {
                    data.IsDeleted = true;
                    data.DeletedBy = ESEIM.AppContext.UserName;
                    data.DeletedTime = DateTime.Now;
                    _context.WorkItemAssignStaffs.Update(data);
                    UpdateChangeCard(data.CardCode);
                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_DELETE_SUCCESS"];
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_MEMBER_ADDED_ITEM"];
                }

            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetUnitAssignStaff()
        {
            var data = _context.CommonSettings.Where(x => !x.IsDeleted && x.Group == "UNIT_ASSIGN_STAFF").Select(x => new { Code = x.CodeSet, Name = x.ValueSet });
            return Json(data);
        }
        #endregion

        #region WorkItemActivity

        [HttpPost]
        public object JTableFileWorkRequest([FromBody] JTableModelFile jTablePara)
        {
            if (string.IsNullOrEmpty(jTablePara.ItemCode))
            {
                return JTableHelper.JObjectTable(new List<object>(), jTablePara.Draw, 0, "Id", "FileName", "FileTypePhysic", "Desc", "Url", "CreatedTime", "UpdatedTime", "ReposName", "TypeFile", "FileID", "SizeOfFile");
            }
            int intBeginFor = (jTablePara.CurrentPage - 1) * jTablePara.Length;
            var fromDate = !string.IsNullOrEmpty(jTablePara.FromDate) ? DateTime.ParseExact(jTablePara.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
            var toDate = !string.IsNullOrEmpty(jTablePara.ToDate) ? DateTime.ParseExact(jTablePara.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
            var session = HttpContext.GetSessionUser();

            string[] param = new string[] { "@ItemCode" };
            object[] val = new object[] { jTablePara.ItemCode };
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_FILE_WORK_REQUEST", param, val);
            var query = CommonUtil.ConvertDataTable<FileCardJob>(rs);
            int count = query.Count();
            var data = query.AsQueryable().OrderUsingSortExpression(jTablePara.QueryOrderBy).Skip(intBeginFor).Take(jTablePara.Length).AsNoTracking().ToList();
            var jdata = JTableHelper.JObjectTable(data, jTablePara.Draw, count, "Id", "FileCode", "FileName", "FileTypePhysic", "Desc",
                "CreatedTime", "CloudFileId", "ReposName", "TypeFile", "FileID", "SizeOfFile", "ListUserShare", "CreatedBy");
            return jdata;
        }

        [HttpPost]
        public object JTableFileWorkResult([FromBody] JTableModelFile jTablePara)
        {
            if (string.IsNullOrEmpty(jTablePara.ItemCode))
            {
                return JTableHelper.JObjectTable(new List<object>(), jTablePara.Draw, 0, "Id", "FileName", "FileTypePhysic", "Desc", "Url", "CreatedTime", "UpdatedTime", "ReposName", "TypeFile", "FileID", "SizeOfFile");
            }
            int intBeginFor = (jTablePara.CurrentPage - 1) * jTablePara.Length;
            var fromDate = !string.IsNullOrEmpty(jTablePara.FromDate) ? DateTime.ParseExact(jTablePara.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
            var toDate = !string.IsNullOrEmpty(jTablePara.ToDate) ? DateTime.ParseExact(jTablePara.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
            var session = HttpContext.GetSessionUser();

            string[] param = new string[] { "@ItemCode" };
            object[] val = new object[] { jTablePara.ItemCode };
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_FILE_WORK_RESULT", param, val);
            var query = CommonUtil.ConvertDataTable<FileCardJob>(rs);
            int count = query.Count();
            var data = query.AsQueryable().OrderUsingSortExpression(jTablePara.QueryOrderBy).Skip(intBeginFor).Take(jTablePara.Length).AsNoTracking().ToList();
            var jdata = JTableHelper.JObjectTable(data, jTablePara.Draw, count, "Id", "FileCode", "FileName", "FileTypePhysic", "Desc",
                "CreatedTime", "CloudFileId", "ReposName", "TypeFile", "FileID", "SizeOfFile", "ListUserShare", "CreatedBy");
            return jdata;
        }

        [HttpPost]
        public JsonResult AutoGenerateWorkSession()
        {
            var workSession = _context.SessionWorkResults.Count() > 0 ? _context.SessionWorkResults.Max(x => x.Id) + 1 : 1;
            return Json(workSession);
        }

        [HttpPost]
        public JsonResult GetCardItemCheck(string cardCode)
        {
            var data = _context.CardItemChecks.Where(x => x.CardCode.Equals(cardCode) && !x.Flag).Select(x => new { Code = x.ChkListCode, Text = x.CheckTitle });
            return Json(data);
        }

        [HttpPost]
        public JsonResult InsertWorkItem([FromBody] ItemWork item)
        {
            var msg = new JMessage { Error = false, Title = "" };
            var session = HttpContext.GetSessionUser();
            try
            {
                DateTime? startTime = !string.IsNullOrEmpty(item.StartTime) ? DateTime.ParseExact(item.StartTime, "dd/MM/yyyy HH:mm", CultureInfo.InvariantCulture) : (DateTime?)null;
                DateTime? endTime = !string.IsNullOrEmpty(item.EndTime) ? DateTime.ParseExact(item.EndTime, "dd/MM/yyyy HH:mm", CultureInfo.InvariantCulture) : (DateTime?)null;
                var staffItemWork = _context.SessionWorkResults.FirstOrDefault(x => x.WorkSession.Equals(item.WorkSession));
                if (staffItemWork == null)
                {
                    var listSubItem = _context.CardSubitemChecks.Where(x => !x.Flag && x.ChkListCode.Equals(item.ChkListCode)).ToList();

                    var sessionItemChkItem = new SessionWork
                    {
                        Session = item.WorkSession,
                        ItemType = "1",
                        Item = item.ChkListCode,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now
                    };
                    _context.SessionWorks.Add(sessionItemChkItem);

                    var itemStaff = new SessionWorkResult
                    {
                        WorkSession = item.WorkSession,
                        StartTime = startTime,
                        EndTime = endTime,
                        ProgressFromStaff = item.ProgressFromStaff,
                        ProgressFromLeader = item.ProgressFromLeader,
                        NoteFromLeader = item.NoteFromLeader,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now,
                        ShiftCode = item.ShiftCode,
                        CardCode = item.CardCode,
                        ChkListCode = item.ChkListCode,
                        ItemWorkList = item.ChkListCode,
                        ListSubItem = JsonConvert.SerializeObject(listSubItem)
                    };
                    _context.SessionWorkResults.Add(itemStaff);

                    var cardItem = _context.CardItemChecks.FirstOrDefault(x => x.ChkListCode == item.ChkListCode && !x.Flag);
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "ADD",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = item.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Cho đầu mục việc " + string.Concat(cardItem.CheckTitle?.Take(20) ?? "") + "..."
                    };
                    _context.CardUserActivities.Add(activity);

                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_ADD_SUCCESS"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateWorkItem([FromBody] ItemWork item)
        {
            var msg = new JMessage();
            try
            {
                if (item.ProgressFromLeader > 100)
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_PLS_ENTER_PROGRESS_LESS_THAN_100"];
                    return Json(msg);
                }
                DateTime? startTime = !string.IsNullOrEmpty(item.StartTime) ? DateTime.ParseExact(item.StartTime, "dd/MM/yyyy HH:mm", CultureInfo.InvariantCulture) : (DateTime?)null;
                DateTime? endTime = !string.IsNullOrEmpty(item.EndTime) ? DateTime.ParseExact(item.EndTime, "dd/MM/yyyy HH:mm", CultureInfo.InvariantCulture) : (DateTime?)null;
                var workResult = _context.SessionWorkResults.FirstOrDefault(x => !x.IsDeleted && x.WorkSession == item.WorkSession);
                var workSession = _context.SessionWorkResults.FirstOrDefault(x => !x.IsDeleted && x.WorkSession == item.WorkSession);
                if (workResult != null && workSession != null)
                {
                    var listSubItem = _context.CardSubitemChecks.Where(x => !x.Flag && x.ChkListCode.Equals(workResult.ChkListCode)).ToList();

                    workSession.ShiftCode = item.ShiftCode;
                    workSession.UpdatedBy = ESEIM.AppContext.UserName;
                    workSession.UpdatedTime = DateTime.Now;
                    _context.SessionWorkResults.Update(workSession);

                    workResult.StartTime = startTime;
                    workResult.EndTime = endTime;
                    workResult.ProgressFromStaff = item.ProgressFromStaff;
                    workResult.NoteFromLeader = item.NoteFromLeader;
                    workResult.ShiftCode = item.ShiftCode;
                    workResult.UpdatedBy = ESEIM.AppContext.UserName;
                    workResult.UpdatedTime = DateTime.Now;
                    workResult.ListSubItem = JsonConvert.SerializeObject(listSubItem);
                    _context.SessionWorkResults.Update(workResult);
                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                }
            }
            catch (Exception ex)
            {
                msg.Title = _sharedResources["COM_MSG_ERR"];
                msg.Error = true;
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateAutoShiftCodeWorkItem(string shiftCodeNew, string shiftCode)
        {
            var msg = new JMessage();
            try
            {
                var workResults = _context.SessionWorkResults.Where(x => !x.IsDeleted && x.ShiftCode == shiftCode);
                var workSessions = _context.SessionWorkResults.Where(x => !x.IsDeleted && x.ShiftCode == shiftCode);
                foreach (var workResult in workResults)
                {
                    workResult.ShiftCode = shiftCodeNew;
                    workResult.UpdatedBy = ESEIM.AppContext.UserName;
                    workResult.UpdatedTime = DateTime.Now;
                    _context.SessionWorkResults.Update(workResult);
                }
                foreach (var workSession in workSessions)
                {
                    workSession.ShiftCode = shiftCodeNew;
                    workSession.UpdatedBy = ESEIM.AppContext.UserName;
                    workSession.UpdatedTime = DateTime.Now;
                    _context.SessionWorkResults.Update(workSession);
                }
                _context.SaveChanges();
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public object GetShift(string shiftCode)
        {
            var data = _context.ShiftLogs.FirstOrDefault(x => x.ShiftCode == shiftCode);
            var shift = new ShiftLogManual
            {
                ShiftCode = data.ShiftCode,
                ChkinTime = data.ChkinTime,
                ChkinLocationTxt = data.ChkinLocationTxt,
                ChkoutTime = data.ChkoutTime,
                ChkoutLocationTxt = data.ChkoutLocationTxt,
                ChkinPicRealtime = data.ChkinPicRealtime,
                ChkoutPicRealtime = data.ChkoutPicRealtime,
                Note = data.Note,
                IsChkinRealTime = data.IsChkinRealTime
            };
            return shift;
        }

        [HttpPost]
        public JsonResult DeleteWorkItemActivity(int id)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            var session = HttpContext.GetSessionUser();
            if (CheckInOut(session.UserName) == true)
            {
                try
                {
                    var data = _context.SessionWorkResults.FirstOrDefault(x => !x.IsDeleted && x.Id == id);
                    var progress = data.ProgressFromLeader != 0 ? data.ProgressFromLeader : 0;
                    if (data != null)
                    {
                        if (data.CreatedBy == ESEIM.AppContext.UserName)
                        {
                            if (progress == 0)
                            {
                                data.IsDeleted = true;
                                data.DeletedBy = ESEIM.AppContext.UserName;
                                data.DeletedTime = DateTime.Now;
                                _context.SessionWorkResults.Update(data);

                                var data1 = _context.SessionWorkResults.FirstOrDefault(x => x.WorkSession == data.WorkSession && !x.IsDeleted);
                                var activity = new CardUserActivity
                                {
                                    UserId = ESEIM.AppContext.UserId,
                                    Action = "DELETE",
                                    IdObject = "ITEMWORK",
                                    IsCheck = true,
                                    CardCode = data1.CardCode,
                                    CreatedTime = DateTime.Now,
                                    FromDevice = "Laptop/Desktop"
                                };
                                _context.CardUserActivities.Add(activity);

                                _context.SaveChanges();
                                msg.Title = _stringLocalizer["CJ_MSG_DELETE_DATA_SUCCESS"];
                            }
                            else
                            {
                                msg.Error = true;
                                msg.Title = _stringLocalizer["CJ_MSG_LEADER_EXAM_NOT_DEL"];
                            }
                        }
                        else
                        {
                            msg.Error = true;
                            msg.Title = _stringLocalizer["CJ_MSG_CANNOT_DELETE"];
                        }
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["CJ_MSG_NOT_FOUND_RECORD"];
                    }

                }
                catch (Exception ex)
                {
                    msg.Error = true;
                    msg.Object = ex;
                    msg.Title = _sharedResources["COM_MSG_ERR"];
                }
            }
            else
            {
                msg.Error = true;
                msg.Title = _stringLocalizer["CJ_MSG_CHECKIN_TO_WORK"];
            }

            return Json(msg);
        }
        [HttpPost]
        public JsonResult GetListWorkItem(string CardCode)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var list = (from a in _context.SessionWorkResults
                            join b in _context.ShiftLogs on a.ShiftCode equals b.ShiftCode
                            where !a.IsDeleted && a.CardCode.Equals(CardCode)
                            select new ViewItem
                            {
                                Id = a.Id,
                                WorkSession = a.WorkSession,
                                ItemWorkList = _context.SessionWorks.Where(x => !x.IsDeleted && x.Session == a.WorkSession).ToList(),
                                Note = a.Note,
                                Status = "",
                                Progress = a.Progress,
                                UserName = _context.Users.FirstOrDefault(x => x.UserName.Equals(a.CreatedBy)).GivenName,
                                CheckItem = false,
                                TimeCheckIn = b.ChkinTime.Value,
                                Value = "",
                                listItemActivity = (from c in _context.SessionWorkResults
                                                    join d in _context.SessionWorks on c.WorkSession equals d.Session
                                                    join e in _context.CardItemChecks on d.Item equals e.ChkListCode
                                                    where c.WorkSession.Equals(a.WorkSession) && !c.IsDeleted
                                                    select new WorkSessionResultTemp
                                                    {
                                                        Id = c.Id,
                                                        StartTime = c.StartTime,
                                                        EndTime = c.EndTime,
                                                        ProgressFromLeader = c.ProgressFromLeader,
                                                        ProgressFromStaff = c.ProgressFromStaff,
                                                        CheckTitle = e.CheckTitle
                                                    }).DistinctBy(x => x.Id).ToList(),
                            }).ToList();
                foreach (var item in list)
                {
                    string value = "";
                    foreach (var i in item.ItemWorkList)
                    {
                        var CheckTitle = _context.CardItemChecks.FirstOrDefault(x => !x.Flag && x.ChkListCode == i.Item);
                        if (CheckTitle != null)
                        {
                            value += CheckTitle.CheckTitle + ", ";
                        }
                    }
                    item.Value = value;
                }
                msg.Object = list.DistinctBy(x => x.WorkSession);
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public object GetItemWork(int id)
        {
            var data = (from a in _context.SessionWorkResults.Where(x => !x.IsDeleted && x.Id == id)
                        join b in _context.SessionWorkResults.Where(x => !x.IsDeleted) on a.WorkSession equals b.WorkSession
                        select new
                        {
                            a.WorkSession,
                            ChkListCode = b.ItemWorkList,
                            StartTime = a.StartTime,
                            EndTime = a.EndTime,
                            a.ProgressFromLeader,
                            a.ProgressFromStaff,
                            a.ShiftCode,
                            a.NoteFromLeader,
                            a.CreatedBy
                        }).FirstOrDefault();
            return data;
        }

        [NonAction]
        public bool CheckInOut(string userName)
        {
            var data = _context.ShiftLogs.LastOrDefault(x => x.CreatedBy == userName);
            if (data != null)
            {
                if (data.ChkinTime.HasValue && data.ChkoutTime.HasValue)
                {
                    return false;
                }
                else
                {
                    return true;
                }
            }
            else
            {
                return false;
            }
        }
        [NonAction]
        public string GetShiftCode(string userName)
        {
            string shifCode = "";
            var shiftLog = _context.ShiftLogs.LastOrDefault(x => x.CreatedBy == userName);
            if (shiftLog != null)
            {
                if (shiftLog.ChkinTime.HasValue)
                    shifCode = shiftLog.ShiftCode;
            }
            return shifCode;
        }

        [HttpPost]
        public JsonResult UpdateProgressFromLeader([FromBody] SessionWorkResult item)
        {
            var msg = new JMessage { Error = false, Title = "" };
            var data = _context.SessionWorkResults.FirstOrDefault(x => x.Id == item.Id && !x.IsDeleted);

            var progress = _context.SessionWorkResults.FirstOrDefault(x => x.WorkSession == data.WorkSession && !x.IsDeleted);

            var data1 = _context.SessionWorkResults.Where(x => x.WorkSession == data.WorkSession && !x.IsDeleted).ToList();
            decimal sum = 0;
            foreach (var i in data1)
            {
                sum += i.ProgressFromLeader;
            }
            sum = sum - data.ProgressFromLeader;
            if (item.ProgressFromLeader <= (100 - sum))
            {
                if (data != null)
                {
                    data.ProgressFromLeader = item.ProgressFromLeader;
                    data.UpdatedBy = ESEIM.AppContext.UserName;
                    data.UpdatedTime = DateTime.Now;

                    progress.Progress = sum + data.ProgressFromLeader;
                    progress.UpdatedBy = ESEIM.AppContext.UserName;
                    progress.UpdatedTime = DateTime.Now;
                    _context.SessionWorkResults.Update(progress);
                    _context.SessionWorkResults.Update(data);

                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "LEADER",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = progress.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop"
                    };
                    _context.CardUserActivities.Add(activity);

                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_NOT_FOUND_RECORD"];
                }
            }
            else
            {
                msg.Error = true;
                msg.Title = _stringLocalizer["CJ_MSG_VALIDATE_PROGRESS"] + (100 - sum);
            }

            return Json(msg);
        }
        [HttpPost]
        public bool CheckRoleInCard(string cardCode)
        {
            var user = ESEIM.AppContext.UserId;
            var data = _context.JobCardAssignees.FirstOrDefault(x => x.CardCode.Equals(cardCode) && x.UserId.Equals(user));
            if (data != null)
            {
                if (data.Role == "ROLE_LEADER")
                {
                    return true;
                }
            }
            return false;
        }
        [HttpPost]
        public JsonResult UpdateItemWork([FromBody] ItemWork item)
        {
            var msg = new JMessage { Error = false, Title = "" };
            var userName = ESEIM.AppContext.UserName;
            //if (CheckInOut(userName) == true)
            //{
            try
            {
                DateTime? startTime = !string.IsNullOrEmpty(item.StartTime) ? DateTime.ParseExact(item.StartTime, "dd/MM/yyyy HH:mm", CultureInfo.InvariantCulture) : (DateTime?)null;
                DateTime? endTime = !string.IsNullOrEmpty(item.EndTime) ? DateTime.ParseExact(item.EndTime, "dd/MM/yyyy HH:mm", CultureInfo.InvariantCulture) : (DateTime?)null;
                var staffItemWork = _context.SessionWorkResults.FirstOrDefault(x => x.WorkSession.Equals(item.WorkSession) && !x.IsDeleted);
                if (staffItemWork != null)
                {
                    var shiftCode = GetShiftCode(userName);
                    var checkItemWorkByShift = _context.SessionWorkResults.Any(x => !x.IsDeleted && x.WorkSession.Equals(item.WorkSession) && x.ShiftCode.Equals(shiftCode) && x.CreatedBy.Equals(userName));
                    if (checkItemWorkByShift)
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["CJ_MSG_SHIFT_EXIST_RPT"];
                    }
                    else
                    {
                        var itemActivity = new SessionWorkResult
                        {
                            WorkSession = item.WorkSession,
                            StartTime = startTime,
                            EndTime = endTime,
                            ProgressFromStaff = item.ProgressFromStaff,
                            ProgressFromLeader = item.ProgressFromLeader,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            ShiftCode = GetShiftCode(userName)
                            //ShiftCode = item.ShiftCode
                        };
                        _context.SessionWorkResults.Add(itemActivity);
                        staffItemWork.UpdatedBy = ESEIM.AppContext.UserName;
                        staffItemWork.UpdatedTime = DateTime.Now;
                        staffItemWork.ShiftCode = shiftCode;
                        //staffItemWork.ShiftCode = item.ShiftCode;
                        _context.SessionWorkResults.Update(staffItemWork);
                        _context.SaveChanges();
                        msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                    }
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            //}
            //else
            //{
            //    msg.Error = true;
            //    msg.Title = _stringLocalizer["CJ_MSG_CHECKIN_TO_WORK"];
            //}

            return Json(msg);

        }

        [HttpPost]
        public JsonResult GetItemApprove(string itemCode)
        {
            var data = from a in _context.SessionWorkResults.Where(x => !x.IsDeleted && x.ItemWorkList.Equals(itemCode))
                       join b in _context.SessionWorkResults.Where(x => !x.IsDeleted) on a.WorkSession equals b.WorkSession
                       join c in _context.Users.Where(x => x.Active) on a.CreatedBy equals c.UserName
                       select new
                       {
                           a.Id,
                           c.GivenName,
                           b.ProgressFromStaff,
                           b.ProgressFromLeader,
                           b.WorkSession,
                           UserAssessor = string.IsNullOrEmpty(b.UserAssessor) ? "" : b.UserAssessor,
                           ApproveTime = b.ApproveTime.HasValue ? b.ApproveTime.Value.ToString("dd/MM/yyyy HH:mm") : "",
                           CreateTime = a.CreatedTime.ToString("dd/MM/yyyy HH:mm"),
                           IsAllow = string.IsNullOrEmpty(b.UserAssessor) ? true : false
                       };
            return Json(data);
        }

        [HttpPost]
        public JsonResult Approve([FromBody] ApproveItem item)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                if (item.IsAllow)
                {
                    var data = _context.SessionWorkResults.FirstOrDefault(x => x.WorkSession.Equals(item.WorkSession) && !x.IsDeleted);
                    if (data != null)
                    {
                        data.ProgressFromLeader = item.ProgressFromLeader == 0 ? data.ProgressFromStaff : item.ProgressFromLeader;
                        data.UserAssessor = ESEIM.AppContext.UserName;
                        data.ApproveTime = DateTime.Now;
                        _context.SessionWorkResults.Update(data);

                        //Real time card
                        var query = (from a in _context.SessionWorkResults.Where(x => x.WorkSession.Equals(item.WorkSession) && !x.IsDeleted)
                                     join b in _context.SessionWorkResults.Where(x => !x.IsDeleted) on a.WorkSession equals b.WorkSession
                                     select new
                                     {
                                         b.ItemWorkList
                                     }).FirstOrDefault();
                        if (query != null)
                        {
                            var chkList = _context.CardItemChecks.FirstOrDefault(x => !x.Flag && x.ChkListCode.Equals(query.ItemWorkList));
                            if (chkList != null)
                            {
                                UpdateChangeCard(chkList.CardCode);
                            }
                        }
                        _context.SaveChanges();
                        msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                    }


                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_PROGRESS_APPROVED"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult ApproveAll(string itemCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var data = (from a in _context.SessionWorkResults.Where(x => !x.IsDeleted && x.ItemWorkList.Equals(itemCode))
                            join b in _context.SessionWorkResults.Where(x => !x.IsDeleted && string.IsNullOrEmpty(x.UserAssessor)) on a.WorkSession equals b.WorkSession
                            join c in _context.Users.Where(x => x.Active) on a.CreatedBy equals c.UserName
                            select b).ToList();

                if (data.Count == 0)
                {
                    msg.Error = true;
                    msg.Title = "Đầu mục việc chưa có báo tiến độ";
                    return Json(msg);
                }

                foreach (var item in data)
                {
                    item.ProgressFromLeader = item.ProgressFromStaff;
                    item.UserAssessor = ESEIM.AppContext.UserName;
                    item.ApproveTime = DateTime.Now;
                    _context.SessionWorkResults.Update(item);
                }

                var chkList = _context.CardItemChecks.FirstOrDefault(x => !x.Flag && x.ChkListCode.Equals(itemCode));
                if (chkList != null)
                {
                    UpdateChangeCard(chkList.CardCode);
                }

                _context.SaveChanges();

                msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public object GetCardRelative(string cardCode)
        {
            var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(cardCode) && !x.IsDeleted);
            var cardInherit = new CardInherit();
            if (!string.IsNullOrEmpty(card.Inherit))
            {
                cardInherit = (from a in _context.WORKOSCards.Where(x => x.CardCode.Equals(card.Inherit) && !x.IsDeleted)
                               join b in _context.CommonSettings on a.Status equals b.CodeSet
                               select new CardInherit
                               {
                                   Code = a.CardCode,
                                   Name = a.CardName,
                                   Status = b.ValueSet,
                                   EndDate = a.EndTime.HasValue ? a.EndTime.Value.ToString("dd/MM/yyyy") : ""
                               }).FirstOrDefault();
            }
            else
            {
                cardInherit = null;
            }
            var link = from a in _context.WORKOSCards.Where(x => x.CardCode.Equals(cardCode) && !x.IsDeleted)
                       join b in _context.JobCardLinks.Where(x => !x.IsDeleted) on a.CardCode equals b.CardCode
                       select new
                       {
                           b.CardLink,
                           b.Id
                       };
            var cardLinks = from a in link
                            join b in _context.WORKOSCards.Where(x => !x.IsDeleted) on a.CardLink equals b.CardCode
                            select new
                            {
                                a.Id,
                                Code = b.CardCode,
                                Name = b.CardName,
                                Status = _context.CommonSettings.FirstOrDefault(x => x.CodeSet == b.Status).ValueSet,
                                EndDate = b.EndTime.HasValue ? b.EndTime.Value.ToString("dd/MM/yyyy") : ""
                            };
            return new
            {
                Inherit = cardInherit,
                Links = cardLinks
            };
        }
        public class JobCardUserItemMember
        {
            public string CardCode { get; set; }
            public string CheckListCode { get; set; }
        }
        public class CardInherit
        {
            public string Code { get; set; }
            public string Name { get; set; }
            public string Status { get; set; }
            public string EndDate { get; set; }
        }
        public class JobCardUserSubItemMember
        {
            public string CardCode { get; set; }
            public string CheckListCode { get; set; }
            public string CheckItem { get; set; }
        }
        public class CalenderCard
        {
            public DateTime Date { get; set; }
            public int Created { get; set; }
            public int Started { get; set; }
            public int Done { get; set; }
            public int Canceled { get; set; }
        }
        public class ShiftLogManual
        {
            public string ShiftCode { get; set; }
            public string ChkinLocationTxt { get; set; }
            public string ChkoutLocationTxt { get; set; }
            public DateTime? ChkinTime { get; set; }
            public DateTime? ChkoutTime { get; set; }
            public string ChkinPicRealtime { get; set; }
            public string ChkoutPicRealtime { get; set; }
            public string Note { get; set; }
            public bool IsChkinRealTime { get; set; }
        }
        public class ItemWork
        {
            public string WorkSession { get; set; }
            public string StartTime { get; set; }
            public string EndTime { get; set; }
            public decimal ProgressFromStaff { get; set; }
            public decimal ProgressFromLeader { get; set; }
            public string NoteFromLeader { get; set; }
            public string CardCode { get; set; }
            public string UserName { get; set; }
            public string ShiftCode { get; set; }
            public string ChkListCode { get; set; }
            public string UserLeader { get; set; }
            public string UserId { get; set; }
        }
        public class ApproveItem
        {
            public string WorkSession { get; set; }
            public decimal ProgressFromLeader { get; set; }
            public string UserName { get; set; }
            public bool IsAllow { get; set; }
        }
        public class WorkSessionResultTemp
        {
            public int Id { get; set; }
            public DateTime? StartTime { get; set; }
            public DateTime? EndTime { get; set; }
            public decimal ProgressFromLeader { get; set; }
            public decimal ProgressFromStaff { get; set; }
            public string CheckTitle { get; set; }
        }
        public class ViewItem
        {
            public int Id { get; set; }
            public string WorkSession { get; set; }
            public List<SessionWork> ItemWorkList { get; set; }
            public string Note { get; set; }
            public string Status { get; set; }
            public decimal Progress { get; set; }
            public string Value { get; set; }
            public string UserName { get; set; }
            public string CreatedBy { get; set; }
            public bool CheckItem { get; set; }
            public DateTime TimeCheckIn { get; set; }
            public List<WorkSessionResultTemp> listItemActivity { get; set; }
        }
        public class ItemStaff
        {
            public int Id { get; set; }
            public string WorkSession { get; set; }
            public decimal Progress { get; set; }
            public string CardCode { get; set; }
            public string[] ListCode { get; set; }
        }
        #endregion

        #region Check success
        [HttpPost]
        public bool CheckCardSuccess(string cardCode)
        {
            var listCardItem = _context.CardItemChecks.Where(x => x.CardCode == cardCode && !x.Flag).ToList();
            //var listSession = from a in _context.WORKItemSessions.Where(x => x.CardCode == cardCode && !x.IsDeleted)
            //                  join b in _context.WORKItemSessionResults.Where(x => !x.IsDeleted) on a.WorkSession equals b.WorkSession
            //                  select new
            //                  {
            //                      Progress = b.ProgressFromLeader
            //                  };
            bool check = false;

            if (listCardItem.Count > 0)
            {
                foreach (var cardItem in listCardItem)
                {
                    if (cardItem.Completed == 100)
                    {
                        check = true;
                    }
                    else
                    {
                        check = false;
                        break;
                    }

                }
                //if (listSession.Count > 0 && check == true)
                //{
                //    foreach (var session in listSession)
                //    {
                //        if (session.Progress == 100)
                //        {
                //            check = true;

                //        }
                //        else
                //        {
                //            check = false;
                //            break;
                //        }
                //    }
                //}
                //else
                //{
                //    check = false;
                //}
            }
            else
            {
                check = false;
            }
            return check;
        }

        public class CheckListSuccess
        {
            public string ListCode { get; set; }
            public bool IsSuccess { get; set; }
        }
        #endregion

        #region Show gantt
        [HttpPost]
        public JsonResult SearchProgress(string boardCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                boardCode = string.IsNullOrEmpty(boardCode) ? _context.WORKOSBoards.Where(x => !string.IsNullOrEmpty(x.BoardCode)).Last().BoardCode : boardCode;
                if (!string.IsNullOrEmpty(boardCode))
                {
                    var query = from a in _context.WORKOSBoards
                                join b in _context.WORKOSLists on a.BoardCode equals b.BoardCode
                                join c in _context.WORKOSCards on b.ListCode equals c.ListCode
                                where a.BoardCode == boardCode && !string.IsNullOrEmpty(a.BoardCode) && !c.IsDeleted
                                select new
                                {
                                    c.CardID,
                                    c.CardCode,
                                    c.CardName,
                                    BeginTime = c.BeginTime.ToString("dd/MM/yyyy"),
                                    Deadline = c.Deadline.ToString("dd/MM/yyyy"),
                                    //Duration = (int)((c.EndTime != null ? c.EndTime : DateTime.Now) - c.BeginTime).TotalDays,
                                    Completed = c.Completed / 100
                                };
                    msg.Object = new
                    {
                        ListProgress = query,
                        DetailBoard = _context.WORKOSBoards.Where(x => x.BoardCode == boardCode && x.IsDeleted == false).Select(x => new
                        {
                            x.BoardID,
                            x.BoardName,
                            StartTime = x.BeginTime.ToString("dd/MM/yyyy"),
                            EndTime = x.Deadline.ToString("dd/MM/yyyy"),
                            Duration = (int)(x.Deadline - x.BeginTime).TotalDays,
                            Completed = x.Completed
                        }).FirstOrDefault()
                    };
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }
        #endregion

        #region Language
        [HttpGet]
        public IActionResult Translation(string lang)
        {
            var resourceObject = new JObject();
            var query = _stringLocalizer.GetAllStrings().Select(x => new { x.Name, x.Value })
                .Union(_stringLocalizerProject.GetAllStrings().Select(x => new { x.Name, x.Value }))
                .Union(_stringLocalizerCustomer.GetAllStrings().Select(x => new { x.Name, x.Value }))
                .Union(_stringLocalizerSupplier.GetAllStrings().Select(x => new { x.Name, x.Value }))
                .Union(_stringLocalizerContract.GetAllStrings().Select(x => new { x.Name, x.Value }))
                .Union(_stringLocalizerRQWPrice.GetAllStrings().Select(x => new { x.Name, x.Value }))
                .Union(_sharedResources.GetAllStrings().Select(x => new { x.Name, x.Value }))
                .Union(_stringLocalizerContractPO.GetAllStrings().Select(x => new { x.Name, x.Value }))
                .Union(_stringLocalizerRQRaw.GetAllStrings().Select(x => new { x.Name, x.Value }))
                .Union(_stringLocalizerSVC.GetAllStrings().Select(x => new { x.Name, x.Value }))
                .Union(_stringLocalizerMaterialProd.GetAllStrings().Select(x => new { x.Name, x.Value }))
                .Union(_stringLocalizerEDMSFile.GetAllStrings().Select(x => new { x.Name, x.Value }))
                .Union(_staffTimeKeepingController.GetAllStrings().Select(x => new { x.Name, x.Value }))
                ;
            foreach (var item in query)
            {
                resourceObject.Add(item.Name, item.Value);
            }
            return Ok(resourceObject);
        }
        #endregion

        #region Location
        public class AddressJobCarModel
        {
            public string CardCode { get; set; }
            public string LocationText { get; set; }
            public string LocationGps { get; set; }
        }
        [HttpPost]
        public JsonResult InsertAddressJobCard([FromBody] AddressJobCarModel obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                WORKOSAddressCard insertAddress = new WORKOSAddressCard
                {
                    CardCode = obj.CardCode,
                    LocationText = obj.LocationText,
                    LocationGps = obj.LocationGps,
                    CreatedBy = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now
                };
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    IdObject = "ADDR",
                    Action = "ADD",
                    IsCheck = true,
                    CardCode = obj.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = obj.LocationText
                };

                _context.CardUserActivities.Add(activity);
                _context.WORKOSAddressCards.Add(insertAddress);

                UpdateChangeCard(obj.CardCode);

                _context.SaveChanges();
                msg.Title = _stringLocalizer["CJ_MSG_ADD_ADDRESS_SUCCESS"];
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                msg.Object = ex.Message;
            }
            return Json(msg);
        }
        [HttpPost]
        public JsonResult DeleteAddressJobCard(int Id)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var data = _context.WORKOSAddressCards.FirstOrDefault(x => x.Id == Id);
                data.IsDeleted = true;
                data.DeletedBy = ESEIM.AppContext.UserName;
                data.DeletedTime = DateTime.Now;

                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    IdObject = "ADDR",
                    Action = "DELETE",
                    IsCheck = true,
                    CardCode = data.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = data.LocationText
                };
                _context.CardUserActivities.Add(activity);
                _context.WORKOSAddressCards.Update(data);
                UpdateChangeCard(data.CardCode);
                _context.SaveChanges();
                msg.Title = _stringLocalizer["CJ_MSG_DELETE_ADDRESS_SUCCESS"];

            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
                msg.Object = ex.Message;
            }
            return Json(msg);
        }
        [HttpPost]
        public object GetLisAddressJobCard(string CardCode)
        {
            var query = _context.WORKOSAddressCards.Where(x => x.CardCode.Equals(CardCode) && x.IsDeleted == false)
                .Select(x => new RollbackAddress
                {
                    Id = x.Id,
                    LocationGps = x.LocationGps,
                    LocationText = x.LocationText,
                    CreatedBy = x.CreatedBy,
                    CreatedTime = x.CreatedTime
                }).ToList();

            return Json(query);
        }
        #endregion

        #region Schedule card
        [HttpPost]
        public JsonResult ScheduleCard(int month, int year)
        {
            var session = HttpContext.GetSessionUser();
            var msg = new JMessage();
            var lstCountCard = new List<CalenderCard>();
            var listDateInMonth = DateTimeExtensions.GetDates(year, month);
            foreach (var item in listDateInMonth)
            {
                var cards = from a in _context.WORKOSCards.Where(x => !x.IsDeleted && x.BeginTime <= item.Date && (x.EndTime.HasValue ? x.EndTime.Value : x.Deadline) >= item.Date)
                            let lt = a.LstUser.Split(",", StringSplitOptions.None)
                            where session.IsAllData || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName
                            select new
                            {
                                a.CardID,
                                a.Status,
                                a.CardCode
                            };
                var countCreated = cards.Where(x => x.Status == "CREATED").Count();
                var countStart = cards.Where(x => x.Status == "START").Count();
                var countDone = cards.Where(x => x.Status == "DONE").Count();
                var countCancled = cards.Where(x => x.Status == "CANCLED").Count();
                var calender = new CalenderCard
                {
                    Date = item,
                    Created = countCreated,
                    Started = countStart,
                    Done = countDone,
                    Canceled = countCancled
                };
                lstCountCard.Add(calender);
            }
            msg.Object = lstCountCard;
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetCardInCalendar([FromBody] CardCalendarModel jtablePara)
        {
            var msg = new JMessage { Error = false, Title = "" };
            var date = !string.IsNullOrEmpty(jtablePara.Date) ? DateTime.ParseExact(jtablePara.Date, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
            int intBeginFor = (jtablePara.CurrentPage - 1) * jtablePara.Length;
            var status = "";
            if (jtablePara.Value == 4)
            {
                status = "CREATED";
            }
            else if (jtablePara.Value == 3)
            {
                status = "START";
            }
            else if (jtablePara.Value == 2)
            {
                status = "DONE";
            }
            else
            {
                status = "CANCLED";
            }
            var session = HttpContext.GetSessionUser();
            var queryTab = from a in _context.WORKOSCards.Where(x => !x.IsDeleted && x.BeginTime <= date
                           && (x.EndTime.HasValue ? x.EndTime.Value : x.Deadline) >= date && x.Status == status && x.Status != "TRASH")
                           let lt = a.LstUser.Split(",", StringSplitOptions.None)
                           where session.IsAllData || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => session.UserId == y)) || a.CreatedBy == session.UserName
                           select new
                           {
                               a.CardID,
                               a.CardCode,
                               a.CardName,
                               a.Deadline,
                               Status = _context.CommonSettings.FirstOrDefault(k => k.CodeSet == a.Status && !k.IsDeleted).ValueSet,
                               a.BeginTime,
                               a.EndTime
                           };

            int count = queryTab.Count();
            var data = queryTab.Skip(intBeginFor).Take(jtablePara.Length).AsNoTracking().ToList();
            var jdata = JTableHelper.JObjectTable(
                                data,
                                jtablePara.Draw,
                                count,
                                "CardID", "CardCode", "CardName", "Deadline", "Status", "BeginTime", "EndTime");
            return Json(jdata);
        }

        public class CardCalendarModel : JTableModel
        {
            public string Date { get; set; }
            public int Value { get; set; }
            public string userId { get; set; }
        }
        #endregion

        #region Count card
        //Grid card
        [HttpPost]
        public JsonResult GetCountCard([FromBody] AdvanceSearchObj data)
        {
            var countCard = new CountCard();
            if (data.TabBoard == 1)
            {
                countCard = GetCountBoard(data);
            }
            else if (data.TabBoard == 2)
            {
                countCard = GetCountDepartment(data);
            }
            else if (data.TabBoard == 3)
            {
                countCard = GetCountCardUser(data);
            }
            else if (data.TabBoard == 4)
            {
                countCard = GetCountCardGroupUser(data);
            }
            else if (data.TabBoard == 5)
            {
                countCard = GetCountCardProject(data);
            }
            else if (data.TabBoard == 6)
            {
                countCard = GetCountCardCustomer(data);
            }
            else if (data.TabBoard == 7)
            {
                countCard = GetCountCardContract(data);
            }
            else if (data.TabBoard == 8)
            {
                countCard = GetCountCardSupplier(data);
            }
            return Json(countCard);
        }

        [NonAction]
        public CountCard GetCountBoard(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            if (!string.IsNullOrEmpty(dataSearch.BoardCode))
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
                "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName", "@WorkflowInstCode" };
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
                    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch,
                    !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",session.UserId,  !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "",
                    dataSearch.Status, !string.IsNullOrEmpty(dataSearch.Object) ? dataSearch.Object : "",
                    !string.IsNullOrEmpty(dataSearch.ObjType) ? dataSearch.ObjType : "", dataSearch.CardName, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_BOARD", param, val);
                var query = CommonUtil.ConvertDataTable<CountCard>(rs);
                if (query.Count > 0)
                    return query[0];
                else
                {
                    var data = new CountCard
                    {
                        Cancle = 0,
                        CloseStatus = 0,
                        CountAll = 0,
                        Created = 0,
                        Start = 0,
                        Success = 0,
                        Trash = 0
                    };
                    return data;
                }
            }
            else
            {
                string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch","@UserName", "@ListUserOfBranch",
                 "@DepartmentId", "@BoardSearch", "@UserId", "@BranchId", "@Status", "@CardName", "@ListCode", "@Group", "@Project", "@Customer", "@Supplier", "@Contract",
                "@UserIdSearch", "@UserNameSearch", "@DepartmentSearch"};
                object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
                  session.IsBranch, session.UserName, listUserOfBranch, !string.IsNullOrEmpty(session.DepartmentCode) ? session.DepartmentCode : "",!string.IsNullOrEmpty(dataSearch.BoardSearch) ? dataSearch.BoardSearch : "", session.UserId,
                  dataSearch.BranchId, dataSearch.Status, dataSearch.CardName, !string.IsNullOrEmpty(dataSearch.ListCode) ? dataSearch.ListCode : "",
                    !string.IsNullOrEmpty(dataSearch.Group) ? dataSearch.Group : "", !string.IsNullOrEmpty(dataSearch.Project) ? dataSearch.Project : "",
                    !string.IsNullOrEmpty(dataSearch.Customer)? dataSearch.Customer : "", !string.IsNullOrEmpty(dataSearch.Supplier) ? dataSearch.Supplier : "",
                    !string.IsNullOrEmpty(dataSearch.Contract) ? dataSearch.Contract : "", !string.IsNullOrEmpty(dataSearch.UserId) ? dataSearch.UserId : "",
                    !string.IsNullOrEmpty(dataSearch.UserName) ? dataSearch.UserName : "", !string.IsNullOrEmpty(dataSearch.Department) ? dataSearch.Department: ""};
                DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_ADVANTAGE", param, val);
                var query = CommonUtil.ConvertDataTable<CountCard>(rs);
                if (query.Count > 0)
                    return query[0];
                else
                {
                    var data = new CountCard
                    {
                        Cancle = 0,
                        CloseStatus = 0,
                        CountAll = 0,
                        Created = 0,
                        Start = 0,
                        Success = 0,
                        Trash = 0
                    };
                    return data;
                }
            }
        }

        [NonAction]
        public CountCard GetCountDepartment(AdvanceSearchObj dataSearch)
        {
            var count = new CountCard();
            if (dataSearch.ListObjCode.Any())
            {
                count = GetCountInDepartment(dataSearch);
            }
            else
            {
                count = GetCountOutDepartment(dataSearch);
            }
            return count;
        }

        [NonAction]
        public CountCard GetCountInDepartment(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }

            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }
            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
                "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object",
                "@ObjType", "@listObjCode", "@CardName", "@WorkflowInstCode" };
            object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
                session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch,
                !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",session.UserId,  !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "",
                dataSearch.Status, dataSearch.Object, dataSearch.ObjType, listObjCode, dataSearch.CardName, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("[P_GET_COUNT_CARD_IN_DEPARTMENT]", param, val);
            var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            if (query.Count > 0)
                return query[0];
            else
            {
                var data = new CountCard
                {
                    Cancle = 0,
                    CloseStatus = 0,
                    CountAll = 0,
                    Created = 0,
                    Start = 0,
                    Success = 0,
                    Trash = 0
                };
                return data;
            }
        }

        [NonAction]
        public CountCard GetCountOutDepartment(AdvanceSearchObj dataSearch)
        {
            //var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            //var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            //var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            //var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            //var listUserOfBranch = "";
            //if (session.IsBranch)
            //{
            //    if (session.ListUserOfBranch.Any())
            //    {
            //        listUserOfBranch = string.Join(",", session.ListUserOfBranch);
            //    }
            //}
            //string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
            //    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            //object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
            //    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch,
            //    !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",session.UserId,  !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "",
            //    dataSearch.Status, dataSearch.Object, dataSearch.ObjType, dataSearch.CardName};
            //DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_OUT_DEPARTMENT", param, val);
            //var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            //if (query.Count > 0)
            //    return query[0];
            //else
            //{
            //    var data = new CountCard
            //    {
            //        Cancle = 0,
            //        CloseStatus = 0,
            //        CountAll = 0,
            //        Created = 0,
            //        Start = 0,
            //        Success = 0,
            //        Trash = 0
            //    };
            //    return data;
            //}
            var data = new CountCard
            {
                Cancle = 0,
                CloseStatus = 0,
                CountAll = 0,
                Created = 0,
                Start = 0,
                Success = 0,
                Trash = 0
            };
            return data;
        }

        [NonAction]
        public CountCard GetCountCardUser(AdvanceSearchObj dataSearch)
        {
            var query = new CountCard();
            if (dataSearch.ListObjCode.Any())
            {
                query = GetCountCardInUser(dataSearch);
            }
            else
            {
                query = GetCountCardOutUser(dataSearch);
            }
            return query;
        }

        [NonAction]
        public CountCard GetCountCardInUser(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }

            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
                "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object",
                "@ObjType", "@listObjCode", "@CardName", "@WorkflowInstCode" };
            object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
                session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch,
                !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",session.UserId,  !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "",
                dataSearch.Status, dataSearch.Object, dataSearch.ObjType, listObjCode, dataSearch.CardName, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_IN_USER", param, val);
            var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            if (query.Count > 0)
                return query[0];
            else
            {
                var data = new CountCard
                {
                    Cancle = 0,
                    CloseStatus = 0,
                    CountAll = 0,
                    Created = 0,
                    Start = 0,
                    Success = 0,
                    Trash = 0
                };
                return data;
            }
        }

        [NonAction]
        public CountCard GetCountCardOutUser(AdvanceSearchObj dataSearch)
        {
            //var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);

            //var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            //var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            //var listUserOfBranch = "";
            //if (session.IsBranch)
            //{
            //    if (session.ListUserOfBranch.Any())
            //    {
            //        listUserOfBranch = string.Join(",", session.ListUserOfBranch);
            //    }
            //}
            //string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
            //    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            //object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
            //    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch,
            //    !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",session.UserId,  !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "",
            //    dataSearch.Status, !string.IsNullOrEmpty(dataSearch.Object) ? dataSearch.Object : "", !string.IsNullOrEmpty(dataSearch.ObjType) ? dataSearch.ObjType : "", dataSearch.CardName};
            //DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_OUT_USER", param, val);
            //var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            //if (query.Count > 0)
            //    return query[0];
            //else
            //{
            //    var data = new CountCard
            //    {
            //        Cancle = 0,
            //        CloseStatus = 0,
            //        CountAll = 0,
            //        Created = 0,
            //        Start = 0,
            //        Success = 0,
            //        Trash = 0
            //    };
            //    return data;
            //}
            var data = new CountCard
            {
                Cancle = 0,
                CloseStatus = 0,
                CountAll = 0,
                Created = 0,
                Start = 0,
                Success = 0,
                Trash = 0
            };
            return data;
        }

        [NonAction]
        public CountCard GetCountCardGroupUser(AdvanceSearchObj dataSearch)
        {
            var query = new CountCard();
            if (dataSearch.ListObjCode.Any())
            {
                query = GetCountCardInGroupUser(dataSearch);
            }
            else
            {
                query = GetCountCardOutGroupUser(dataSearch);
            }
            return query;
        }

        [NonAction]
        public CountCard GetCountCardInGroupUser(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }

            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
                "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object",
                "@ObjType", "@listObjCode", "@CardName", "@WorkflowInstCode" };
            object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
                session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch,
                !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",session.UserId,  !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "",
                dataSearch.Status, dataSearch.Object, dataSearch.ObjType, listObjCode, dataSearch.CardName, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_IN_GROUP_USER", param, val);
            var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            if (query.Count > 0)
                return query[0];
            else
            {
                var data = new CountCard
                {
                    Cancle = 0,
                    CloseStatus = 0,
                    CountAll = 0,
                    Created = 0,
                    Start = 0,
                    Success = 0,
                    Trash = 0
                };
                return data;
            }
        }

        [NonAction]
        public CountCard GetCountCardOutGroupUser(AdvanceSearchObj dataSearch)
        {
            //var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            //var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            //var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            //var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            //var listUserOfBranch = "";
            //if (session.IsBranch)
            //{
            //    if (session.ListUserOfBranch.Any())
            //    {
            //        listUserOfBranch = string.Join(",", session.ListUserOfBranch);
            //    }
            //}
            //string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
            //    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            //object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
            //    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch,
            //    !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",session.UserId,  !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "",
            //    dataSearch.Status, dataSearch.Object, dataSearch.ObjType, dataSearch.CardName};
            //DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_OUT_GROUP_USER", param, val);
            //var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            //if (query.Count > 0)
            //    return query[0];
            //else
            //{
            //    var data = new CountCard
            //    {
            //        Cancle = 0,
            //        CloseStatus = 0,
            //        CountAll = 0,
            //        Created = 0,
            //        Start = 0,
            //        Success = 0,
            //        Trash = 0
            //    };
            //    return data;
            //}
            var data = new CountCard
            {
                Cancle = 0,
                CloseStatus = 0,
                CountAll = 0,
                Created = 0,
                Start = 0,
                Success = 0,
                Trash = 0
            };
            return data;
        }

        [NonAction]
        public CountCard GetCountCardProject(AdvanceSearchObj dataSearch)
        {
            var query = new CountCard();
            if (dataSearch.ListObjCode.Any())
            {
                query = GetCountCardInProject(dataSearch);
            }
            else
            {
                query = GetCountCardOutProject(dataSearch);
            }
            return query;
        }

        [NonAction]
        public CountCard GetCountCardInProject(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }

            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
                "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object",
                "@ObjType","@listObjCode", "@CardName", "@WorkflowInstCode" };
            object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
                session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",
                session.UserId, !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "", dataSearch.Status, dataSearch.Object,
                dataSearch.ObjType, listObjCode, dataSearch.CardName, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_IN_PROJECT", param, val);
            var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            if (query.Count > 0)
                return query[0];
            else
            {
                var data = new CountCard
                {
                    Cancle = 0,
                    CloseStatus = 0,
                    CountAll = 0,
                    Created = 0,
                    Start = 0,
                    Success = 0,
                    Trash = 0
                };
                return data;
            }
        }

        [NonAction]
        public CountCard GetCountCardOutProject(AdvanceSearchObj dataSearch)
        {
            //var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            //var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            //var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            //var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            //var listUserOfBranch = "";
            //if (session.IsBranch)
            //{
            //    if (session.ListUserOfBranch.Any())
            //    {
            //        listUserOfBranch = string.Join(",", session.ListUserOfBranch);
            //    }
            //}
            //string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
            //    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            //object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
            //    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",
            //    session.UserId, !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : "", dataSearch.Status, dataSearch.Object, dataSearch.ObjType, dataSearch.CardName};
            //DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_CARD_OUT_PROJECT", param, val);
            //var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            //if (query.Count > 0)
            //    return query[0];
            //else
            //{
            //    var data = new CountCard
            //    {
            //        Cancle = 0,
            //        CloseStatus = 0,
            //        CountAll = 0,
            //        Created = 0,
            //        Start = 0,
            //        Success = 0,
            //        Trash = 0
            //    };
            //    return data;
            //}
            var data = new CountCard
            {
                Cancle = 0,
                CloseStatus = 0,
                CountAll = 0,
                Created = 0,
                Start = 0,
                Success = 0,
                Trash = 0
            };
            return data;
        }

        [NonAction]
        public CountCard GetCountCardCustomer(AdvanceSearchObj dataSearch)
        {
            var query = new CountCard();
            if (dataSearch.ListObjCode.Any())
            {
                query = GetCountCardInCustomer(dataSearch);
            }
            else
            {
                query = GetCountCardOutCustomer(dataSearch);
            }
            return query;
        }

        [NonAction]
        public CountCard GetCountCardInCustomer(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }
            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
                "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object",
                "@ObjType","@listObjCode", "@CardName", "@WorkflowInstCode" };
            object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
                session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",
                session.UserId, user.BranchId, dataSearch.Status, dataSearch.Object, dataSearch.ObjType, listObjCode, dataSearch.CardName,
                !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_IN_CUSTOMER", param, val);
            var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            if (query.Count > 0)
                return query[0];
            else
            {
                var data = new CountCard
                {
                    Cancle = 0,
                    CloseStatus = 0,
                    CountAll = 0,
                    Created = 0,
                    Start = 0,
                    Success = 0,
                    Trash = 0
                };
                return data;
            }
        }

        [NonAction]
        public CountCard GetCountCardOutCustomer(AdvanceSearchObj dataSearch)
        {
            //var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            //var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            //var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            //var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            //var listUserOfBranch = "";
            //if (session.IsBranch)
            //{
            //    if (session.ListUserOfBranch.Any())
            //    {
            //        listUserOfBranch = string.Join(",", session.ListUserOfBranch);
            //    }
            //}
            //string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
            //    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            //object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
            //    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",
            //    session.UserId, user.BranchId, dataSearch.Status, dataSearch.Object, dataSearch.ObjType, dataSearch.CardName};
            //DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_OUT_CUSTOMER", param, val);
            //var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            //if (query.Count > 0)
            //    return query[0];
            //else
            //{
            //    var data = new CountCard
            //    {
            //        Cancle = 0,
            //        CloseStatus = 0,
            //        CountAll = 0,
            //        Created = 0,
            //        Start = 0,
            //        Success = 0,
            //        Trash = 0
            //    };
            //    return data;
            //}
            var data = new CountCard
            {
                Cancle = 0,
                CloseStatus = 0,
                CountAll = 0,
                Created = 0,
                Start = 0,
                Success = 0,
                Trash = 0
            };
            return data;
        }

        [NonAction]
        public CountCard GetCountCardContract(AdvanceSearchObj dataSearch)
        {
            var query = new CountCard();
            if (dataSearch.ListObjCode.Any())
            {
                query = GetCountCardInContract(dataSearch);
            }
            else
            {
                query = GetCountCardOutContract(dataSearch);
            }
            return query;
        }

        [NonAction]
        public CountCard GetCountCardInContract(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }
            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
                "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object",
                "@ObjType","@listObjCode", "@CardName", "@WorkflowInstCode" };
            object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
                session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",
                session.UserId, user.BranchId, dataSearch.Status, dataSearch.Object, dataSearch.ObjType, listObjCode,
                dataSearch.CardName, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_IN_CONTRACT", param, val);
            var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            if (query.Count > 0)
                return query[0];
            else
            {
                var data = new CountCard
                {
                    Cancle = 0,
                    CloseStatus = 0,
                    CountAll = 0,
                    Created = 0,
                    Start = 0,
                    Success = 0,
                    Trash = 0
                };
                return data;
            }
        }

        [NonAction]
        public CountCard GetCountCardOutContract(AdvanceSearchObj dataSearch)
        {
            //var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            //var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            //var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            //var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            //var listUserOfBranch = "";
            //if (session.IsBranch)
            //{
            //    if (session.ListUserOfBranch.Any())
            //    {
            //        listUserOfBranch = string.Join(",", session.ListUserOfBranch);
            //    }
            //}
            //string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
            //    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            //object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
            //    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",
            //    session.UserId, user.BranchId, dataSearch.Status, dataSearch.Object, dataSearch.ObjType, dataSearch.CardName};
            //DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_OUT_CONTRACT", param, val);
            //var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            //if (query.Count > 0)
            //    return query[0];
            //else
            //{
            //    var data = new CountCard
            //    {
            //        Cancle = 0,
            //        CloseStatus = 0,
            //        CountAll = 0,
            //        Created = 0,
            //        Start = 0,
            //        Success = 0,
            //        Trash = 0
            //    };
            //    return data;
            //}
            var data = new CountCard
            {
                Cancle = 0,
                CloseStatus = 0,
                CountAll = 0,
                Created = 0,
                Start = 0,
                Success = 0,
                Trash = 0
            };
            return data;
        }

        [NonAction]
        public CountCard GetCountCardSupplier(AdvanceSearchObj dataSearch)
        {
            var query = new CountCard();
            if (dataSearch.ListObjCode.Any())
            {
                query = GetCountCardInSupplier(dataSearch);
            }
            else
            {
                query = GetCountCardOutSupplier(dataSearch);
            }
            return query;
        }

        [NonAction]
        public CountCard GetCountCardInSupplier(AdvanceSearchObj dataSearch)
        {
            var session = HttpContext.GetSessionUser();
            var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            var listUserOfBranch = "";
            if (session.IsBranch)
            {
                if (session.ListUserOfBranch.Any())
                {
                    listUserOfBranch = string.Join(",", session.ListUserOfBranch);
                }
            }
            var listObjCode = "";
            if (dataSearch.ListObjCode.Any())
            {
                listObjCode = string.Join(",", dataSearch.ListObjCode.Select(x => x.Code));
            }
            string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
                "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object",
                "@ObjType","@listObjCode", "@CardName", "@WorkflowInstCode" };
            object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
                session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",
                session.UserId, user.BranchId, dataSearch.Status, dataSearch.Object, dataSearch.ObjType, listObjCode,
                dataSearch.CardName, !string.IsNullOrEmpty(dataSearch.WorkflowInstCode) ? dataSearch.WorkflowInstCode : ""};
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_IN_SUPPLIER", param, val);
            var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            if (query.Count > 0)
                return query[0];
            else
            {
                var data = new CountCard
                {
                    Cancle = 0,
                    CloseStatus = 0,
                    CountAll = 0,
                    Created = 0,
                    Start = 0,
                    Success = 0,
                    Trash = 0
                };
                return data;
            }
        }

        [NonAction]
        public CountCard GetCountCardOutSupplier(AdvanceSearchObj dataSearch)
        {
            //var session = HttpContext.GetSessionUser();
            //var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
            //var fromDate = string.IsNullOrEmpty(dataSearch.FromDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
            //var toDate = string.IsNullOrEmpty(dataSearch.ToDate) ? (DateTime?)null : DateTime.ParseExact(dataSearch.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);

            //var fromDatePara = fromDate.HasValue ? fromDate.Value.ToString("yyyy-MM-dd") : "";
            //var toDatePara = toDate.HasValue ? toDate.Value.ToString("yyyy-MM-dd") : "";
            //var listUserOfBranch = "";
            //if (session.IsBranch)
            //{
            //    if (session.ListUserOfBranch.Any())
            //    {
            //        listUserOfBranch = string.Join(",", session.ListUserOfBranch);
            //    }
            //}
            //string[] param = new string[] { "@PageNo", "@PageSize", "@fromDate", "@toDate", "@IsAllData", "@IsUser", "@IsBranch",
            //    "@DepartmentId", "@UserName", "@ListUserOfBranch", "@boardCode", "@UserId", "@BranchId", "@Status", "@Object", "@ObjType", "@CardName" };
            //object[] val = new object[] { dataSearch.CurrentPage, dataSearch.Length , fromDatePara, toDatePara , session.IsAllData, session.IsUser,
            //    session.IsBranch, !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "", session.UserName, listUserOfBranch, !string.IsNullOrEmpty(dataSearch.BoardCode) ? dataSearch.BoardCode : "",
            //    session.UserId, user.BranchId, dataSearch.Status, dataSearch.Object, dataSearch.ObjType, dataSearch.CardName};
            //DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_COUNT_CARD_OUT_SUPPLIER", param, val);
            //var query = CommonUtil.ConvertDataTable<CountCard>(rs);
            //if (query.Count > 0)
            //    return query[0];
            //else
            //{
            //    var data = new CountCard
            //    {
            //        Cancle = 0,
            //        CloseStatus = 0,
            //        CountAll = 0,
            //        Created = 0,
            //        Start = 0,
            //        Success = 0,
            //        Trash = 0
            //    };
            //    return data;
            //}
            var data = new CountCard
            {
                Cancle = 0,
                CloseStatus = 0,
                CountAll = 0,
                Created = 0,
                Start = 0,
                Success = 0,
                Trash = 0
            };
            return data;
        }

        public class CountCard
        {
            public int Created { get; set; }
            public int Start { get; set; }
            public int Success { get; set; }
            public int Cancle { get; set; }
            public int Trash { get; set; }
            public int CloseStatus { get; set; }
            public int CountAll { get; set; }
        }

        #endregion

        #region Detail job of user
        [HttpPost]
        public JsonResult DetailOfEmploy([FromBody] JTableDetailShift jTablePara)
        {
            var msg = new JMessage();

            var fromDate = !string.IsNullOrEmpty(jTablePara.FromDate) ? DateTime.ParseExact(jTablePara.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
            var toDate = !string.IsNullOrEmpty(jTablePara.ToDate) ? DateTime.ParseExact(jTablePara.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
            int intBeginFor = (jTablePara.CurrentPage - 1) * jTablePara.Length;
            var getUser = _context.Users.FirstOrDefault(x => x.Id.Equals(jTablePara.UserId) && x.Active);
            var query = _context.ShiftLogs
                .Where(x => string.IsNullOrEmpty(x.Flag) && x.CreatedBy.Equals(getUser.UserName)
                && (fromDate == null || x.ChkinTime.Value.Date >= fromDate.Value.Date)
                && (toDate == null || x.ChkoutTime.HasValue && x.ChkoutTime.Value.Date <= toDate.Value.Date))
                .GroupBy(x => x.ShiftCode)
                .Select(x => new
                {
                    ID = x.FirstOrDefault().Id,
                    TimeIn = x.FirstOrDefault().ChkinTime.Value.ToString("HH:mm dd/MM/yyyy"),
                    TimeOut = x.FirstOrDefault().ChkoutTime.HasValue ? x.FirstOrDefault().ChkoutTime.Value.ToString("HH:mm dd/MM/yyyy") : "",
                    x.FirstOrDefault().ChkoutTime,
                    x.FirstOrDefault().ChkinTime,
                    x.Key,
                    TimeWorkShift = x.FirstOrDefault().ChkoutTime.HasValue ? Math.Round(((x.FirstOrDefault().ChkoutTime.Value.Subtract(x.FirstOrDefault().ChkinTime.Value)).TotalMinutes) / 60, 1, MidpointRounding.AwayFromZero) : 0,
                    ListCard = (from a in _context.WORKOSCards.Where(k => !k.IsDeleted && k.Status != "TRASH")
                                let lt = a.LstUser.Split(",", StringSplitOptions.None)
                                join b in _context.CardItemChecks.Where(k => !k.Flag) on a.CardCode equals b.CardCode
                                join c in _context.SessionWorkResults.Where(k => !k.IsDeleted && k.CreatedBy.Equals(getUser.UserName)) on b.ChkListCode equals c.ItemWorkList
                                join d in _context.SessionWorkResults.Where(k => !k.IsDeleted) on c.WorkSession equals d.WorkSession
                                where a.CreatedBy.Equals(getUser.UserName) || (!string.IsNullOrEmpty(a.LstUser) && lt.Any(y => y.Equals(jTablePara.UserId)))
                                && c.ShiftCode.Equals(x.Key)
                                select new
                                {
                                    a.CardID,
                                    a.CardCode,
                                    a.CardName,
                                    Status = !string.IsNullOrEmpty(a.Status) ? _context.CommonSettings.FirstOrDefault(k => !k.IsDeleted && k.CodeSet == a.Status).ValueSet : "",
                                    Cost = GetCostValueInShift(a.CardCode, a.Cost, x.Key, getUser.UserName),
                                    b.CheckTitle,
                                    d.ProgressFromStaff,
                                    d.ProgressFromLeader
                                }).DistinctBy(k => k.CardCode)
                }).OrderByDescending(x => x.ChkinTime).ThenByDescending(x => x.ChkoutTime).DistinctBy(x => x.Key);

            var timeWork = 0.0;
            var lstDetail = new List<DetailShift>();
            foreach (var item in query)
            {
                if (item.ChkoutTime.HasValue)
                {
                    timeWork = timeWork + ((item.ChkoutTime.Value.Subtract(item.ChkinTime.Value)).TotalMinutes);
                }
                var detail = new DetailShift();
                detail.ID = item.ID;
                detail.TimeIn = item.TimeIn;
                detail.TimeOut = item.TimeOut;
                detail.ShiftCode = "<span class = 'text-green'>" + item.TimeIn + "</span> - <span class='text-danger'>" + item.TimeOut + "</span>";
                detail.TimeWorkShift = item.TimeWorkShift;
                var lstCardName = "";
                var lstItemCheck = "";
                var address = "";
                foreach (var card in item.ListCard)
                {
                    lstCardName += card.CardName + "; ";
                    lstItemCheck += card.CheckTitle + "; ";
                    var cardAddr = _context.WORKOSAddressCards.Where(x => x.CardCode == card.CardCode && !x.IsDeleted);
                    if (cardAddr.Any())
                    {
                        foreach (var addr in cardAddr)
                        {
                            address += addr.LocationText + ";";
                        }
                    }
                }
                detail.LstCardName = (!string.IsNullOrEmpty(lstCardName) && !string.IsNullOrEmpty(lstItemCheck)) ? ("<span class='text-green'>" + lstCardName + "</span>  ->  " + "<span class='text-danger'>" + lstItemCheck + "</span>") : "";
                detail.CostValue = item.ListCard.Sum(x => x.Cost);
                detail.Address = address;

                lstDetail.Add(detail);
            }

            lstDetail.ForEach(x => x.TotalTimeWork = lstDetail.Sum(y => y.TimeWorkShift));
            lstDetail.ForEach(x => x.TotalCostValue = lstDetail.Sum(y => y.CostValue));

            var count = lstDetail.Count();
            var data = lstDetail.Skip(intBeginFor).Take(jTablePara.Length).ToList();
            var jdata = JTableHelper.JObjectTable(data, jTablePara.Draw, count, "ID", "ShiftCode", "TimeIn", "TimeOut", "ShiftCode", "LstCardName", "TimeWorkShift", "CostValue", "TotalTimeWork", "TotalCostValue", "Address");
            return Json(jdata);
        }


        [NonAction]
        public decimal GetCostValueInShift(string cardCode, decimal cost, string shiftCode, string userName)
        {
            var data = _context.CardItemChecks.Where(x => x.CardCode.Equals(cardCode) && !x.Flag)
                .Select(x => new
                {
                    x.ChkListCode,
                    x.WeightNum
                });
            decimal money = 0;
            foreach (var item in data)
            {
                if (ItemSuccesInShift(item.ChkListCode, shiftCode, userName))
                {
                    money += Math.Round((item.WeightNum * cost) / 100);
                }
            }
            return money;
        }

        [NonAction]
        public bool ItemSuccesInShift(string itemCode, string shiftCode, string userName)
        {
            var isSuccess = true;

            var progressItem = (from a in _context.SessionWorkResults.Where(x => x.ItemWorkList.Equals(itemCode) && x.ShiftCode.Equals(shiftCode) && x.CreatedBy.Equals(userName))
                                join c in _context.SessionWorkResults.Where(x => !x.IsDeleted) on a.WorkSession equals c.WorkSession
                                select new
                                {
                                    a.ItemWorkList,
                                    a.CreatedBy,
                                    c.ProgressFromLeader,
                                    a.CreatedTime
                                }).OrderByDescending(x => x.CreatedTime).GroupBy(x => new { x.ItemWorkList, x.CreatedBy });
            if (progressItem.Any())
            {
                foreach (var item in progressItem)
                {
                    var progress = item.FirstOrDefault().ProgressFromLeader;
                    if (progress != 100)
                    {
                        isSuccess = false;
                    }
                }
            }
            else
            {
                isSuccess = false;
            }
            return isSuccess;
        }

        public class JTableDetailShift : JTableModel
        {
            public string UserId { get; set; }
            public string FromDate { get; set; }
            public string ToDate { get; set; }
        }

        public class DetailShift
        {
            public int ID { get; set; }
            public string TimeIn { get; set; }
            public string TimeOut { get; set; }
            public string ShiftCode { get; set; }
            public string LstCardName { get; set; }
            public string Progress { get; set; }
            public double TimeWorkShift { get; set; }
            public decimal CostValue { get; set; }
            public double TotalTimeWork { get; set; }
            public decimal TotalCostValue { get; set; }
            public string Address { get; set; }
        }
        #endregion

        #region Work flow 
        [AllowAnonymous]
        [HttpPost]
        public JsonResult GetWorkFlow()
        {
            var data = _context.WorkFlows.Where(x => !x.IsDeleted.Value)
                .Select(x => new
                {
                    Code = x.WfCode,
                    Name = x.WfName,
                    Group = x.WfGroup,
                    Type = x.WfType,
                    ObjectType = x.ObjectType
                });
            return Json(data);
        }

        [HttpPost]
        public JsonResult CreateFlow(string wfCode, string cardCode)
        {
            var msg = new JMessage() { Error = false, Title = "" };

            try
            {
                var session = HttpContext.GetSessionUser();
                var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(cardCode) && !x.IsDeleted);
                var list = _context.WORKOSLists.FirstOrDefault(x => x.ListCode.Equals(card.ListCode) && !x.IsDeleted);
                var board = _context.WORKOSBoards.FirstOrDefault(x => x.BoardCode.Equals(list.BoardCode) && !x.IsDeleted);
                var assign = _context.JobCardAssignees.Where(x => x.CardCode.Equals(card.CardCode) && !string.IsNullOrEmpty(x.UserId) && !x.IsDeleted).ToList();
                if (!string.IsNullOrEmpty(wfCode))
                {
                    card.WorkflowCode = wfCode;
                    //Rollback
                    var chkList = _context.CardItemChecks.Where(x => !x.Flag && x.CardCode.Equals(card.CardCode));
                    var itemStaff = _context.WorkItemAssignStaffs.Where(x => !x.IsDeleted && x.CardCode.Equals(card.CardCode));
                    var attachments = _context.CardAttachments.Where(x => !x.Flag && x.CardCode.Equals(cardCode));
                    if (chkList.Any())
                    {
                        foreach (var item in chkList)
                        {
                            item.Flag = true;
                            item.DeletedBy = ESEIM.AppContext.UserName;
                            item.DeletedTime = DateTime.Now;
                            _context.CardItemChecks.Update(item);
                        }
                    }
                    if (itemStaff.Any())
                    {
                        foreach (var item in itemStaff)
                        {
                            item.IsDeleted = true;
                            item.DeletedBy = ESEIM.AppContext.UserName;
                            item.DeletedTime = DateTime.Now;
                            _context.WorkItemAssignStaffs.Update(item);
                        }
                    }
                    if (attachments.Any())
                    {
                        foreach (var item in attachments)
                        {
                            item.Flag = true;
                            _context.CardAttachments.Update(item);
                        }
                    }

                    //Create
                    var getActCode = (from a in _context.ObjectActivitys.Where(x => !x.IsDeleted && x.WorkFlowCode.Equals(wfCode))
                                      join b in _context.CatActivitys.Where(x => !x.IsDeleted) on a.ActCode equals b.ActCode
                                      join c in _context.WorkflowActivityRoles.Where(x => !x.IsDeleted) on new { a.WorkFlowCode, a.ActCode } equals new { c.WorkFlowCode, c.ActCode }
                                      select new
                                      {
                                          a.WorkFlowCode,
                                          b.ActCode,
                                          b.ActName,
                                          a.Priority,
                                          c.BranchCode,
                                          c.Role,
                                          c.DepartCode,
                                          a.LimitTime,
                                          a.UnitTime,
                                          b.FileName,
                                          b.FileUrl,
                                          b.IdMapping
                                      }).OrderBy(x => x.Priority);
                    if (getActCode.Any())
                    {

                        int weightNum = 100 / getActCode.Count();
                        var index = 0;
                        var chkCodeBefore = "";
                        var countAttachment = _context.CardAttachments.Count() > 0 ? _context.CardAttachments.Last().Id + 1 : 0;
                        foreach (var item in getActCode)
                        {
                            var users = from a in _context.Users.Where(x => x.Active && x.DepartmentId.Equals(item.DepartCode) && x.BranchId.Equals(item.BranchCode))
                                        join b in _context.UserRoles on a.Id equals b.UserId
                                        join c in _context.Roles.Where(x => x.Code.Equals(item.Role)) on b.RoleId equals c.Id
                                        select new
                                        {
                                            a.Id,
                                            a.GivenName
                                        };
                            if (index == 0)
                            {
                                var data = new CardItemCheck()
                                {
                                    CardCode = cardCode,
                                    CheckTitle = item.ActName,
                                    WeightNum = weightNum,
                                    ChkListCode = "CHECK_LIST_" + Guid.NewGuid().ToString(),
                                    CreatedBy = ESEIM.AppContext.UserName,
                                    CreatedTime = DateTime.Now,
                                    Constraint = ""
                                };
                                _context.CardItemChecks.Add(data);

                                if (!string.IsNullOrEmpty(item.FileUrl))
                                {
                                    var attachment = new CardAttachment
                                    {
                                        FileCode = "ATTACHMENT_" + cardCode + "_" + countAttachment,
                                        CreatedTime = DateTime.Now,
                                        MemberId = ESEIM.AppContext.UserName,
                                        ListPermissionViewFile = card.LstUser,
                                        CardCode = cardCode,
                                        FileName = item.FileName,
                                        FileUrl = item.FileUrl,
                                        IsEdms = true,
                                        IdMapping = item.IdMapping,
                                        ChkListCode = data.ChkListCode
                                    };
                                    _context.CardAttachments.Add(attachment);
                                    countAttachment++;
                                }

                                if (users.Any())
                                {
                                    var json = !string.IsNullOrEmpty(card.JsonAssign) ? JsonConvert.DeserializeObject<List<JobCardAssignee>>(card.JsonAssign) : new List<JobCardAssignee>();
                                    foreach (var user in users)
                                    {
                                        if (!assign.Any(x => x.UserId.Equals(user.Id)))
                                        {
                                            var assignee = new JobCardAssignee
                                            {
                                                UserId = user.Id,
                                                CardCode = cardCode,
                                                DepartmentCode = "",
                                                GroupCode = "",
                                                Role = "ROLE_LEADER",
                                                Item = "",
                                                CreatedBy = ESEIM.AppContext.UserName,
                                                CreatedTime = DateTime.Now,
                                                Approve = true,
                                                ApproveTime = DateTime.Now,
                                                Status = "ASSIGN_STATUS_WORK",
                                                Branch = !string.IsNullOrEmpty(session.BranchId) ? session.BranchId : ""
                                            };
                                            _context.JobCardAssignees.Add(assignee);
                                            json.Add(assignee);
                                            assign.Add(assignee);
                                            //card.LstUser += user.Id + ",";
                                            card.LstUser += string.Join(",", user.Id);
                                        }
                                        var jobCardUser = new WorkItemAssignStaff
                                        {
                                            CardCode = cardCode,
                                            UserId = user.Id,
                                            CheckItem = "",
                                            CheckListCode = data.ChkListCode,
                                            CreatedBy = ESEIM.AppContext.UserName,
                                            CreatedTime = DateTime.Now,
                                            EstimateTime = item.LimitTime,
                                            Unit = item.UnitTime
                                        };
                                        _context.WorkItemAssignStaffs.Add(jobCardUser);
                                    }
                                    card.JsonAssign = JsonConvert.SerializeObject(json);
                                }
                                index++;
                                chkCodeBefore = data.ChkListCode;
                            }
                            else
                            {
                                var data = new CardItemCheck()
                                {
                                    CardCode = cardCode,
                                    CheckTitle = item.ActName,
                                    WeightNum = weightNum,
                                    ChkListCode = "CHECK_LIST_" + Guid.NewGuid().ToString(),
                                    CreatedBy = ESEIM.AppContext.UserName,
                                    CreatedTime = DateTime.Now,
                                    Constraint = chkCodeBefore + ","
                                };
                                _context.CardItemChecks.Add(data);

                                if (!string.IsNullOrEmpty(item.FileUrl))
                                {
                                    var attachment = new CardAttachment
                                    {
                                        FileCode = "ATTACHMENT_" + cardCode + "_" + countAttachment,
                                        CreatedTime = DateTime.Now,
                                        MemberId = ESEIM.AppContext.UserName,
                                        ListPermissionViewFile = card.LstUser,
                                        CardCode = cardCode,
                                        FileName = item.FileName,
                                        FileUrl = item.FileUrl,
                                        IsEdms = true,
                                        IdMapping = item.IdMapping,
                                        ChkListCode = data.ChkListCode
                                    };
                                    _context.CardAttachments.Add(attachment);
                                    countAttachment++;
                                }

                                if (users.Any())
                                {
                                    var json = !string.IsNullOrEmpty(card.JsonAssign) ? JsonConvert.DeserializeObject<List<JobCardAssignee>>(card.JsonAssign) : new List<JobCardAssignee>();
                                    foreach (var user in users)
                                    {
                                        if (!assign.Any(x => x.UserId.Equals(user.Id)))
                                        {
                                            var assignee = new JobCardAssignee
                                            {
                                                UserId = user.Id,
                                                CardCode = cardCode,
                                                DepartmentCode = "",
                                                GroupCode = "",
                                                Role = "ROLE_LEADER",
                                                Item = "",
                                                CreatedBy = ESEIM.AppContext.UserName,
                                                CreatedTime = DateTime.Now,
                                                Approve = true,
                                                ApproveTime = DateTime.Now,
                                                Status = "ASSIGN_STATUS_WORK",
                                                Branch = !string.IsNullOrEmpty(session.BranchId) ? session.BranchId : ""
                                            };
                                            _context.JobCardAssignees.Add(assignee);
                                            json.Add(assignee);
                                            assign.Add(assignee);
                                            card.LstUser += user.Id + ",";
                                        }

                                        var jobCardUser = new WorkItemAssignStaff
                                        {
                                            CardCode = cardCode,
                                            UserId = user.Id,
                                            CheckItem = "",
                                            CheckListCode = data.ChkListCode,
                                            CreatedBy = ESEIM.AppContext.UserName,
                                            CreatedTime = DateTime.Now,
                                            EstimateTime = item.LimitTime,
                                            Unit = item.UnitTime
                                        };
                                        _context.WorkItemAssignStaffs.Add(jobCardUser);
                                    }
                                    card.JsonAssign = JsonConvert.SerializeObject(json);
                                }
                                index++;
                                chkCodeBefore = data.ChkListCode;
                            }
                        }
                        _context.SaveChanges();
                        msg.Title = "Tạo luồng việc thành công";

                        var listUsers = from a in _context.JobCardAssignees.Where(x => !x.IsDeleted && x.CardCode.Equals(cardCode))
                                        join b in _context.Users.Where(x => x.Active) on a.UserId equals b.Id
                                        select new CardMemberCustom
                                        {
                                            Id = a.ID,
                                            UserId = a.UserId,
                                            Responsibility = a.Role,
                                            CreatedTime = a.CreatedTime.ToString("dd/MM/yyyy")
                                        };

                        SendPushNotification(listUsers.AsQueryable(), string.Format("Thẻ #{0} được cập nhật bởi {1}", card.CardCode, session.FullName), new
                        {
                            board.BoardCode,
                            board.BoardName,
                            list.ListCode,
                            card.CardCode,
                            card.CardName,
                            card.BeginTime,
                            card.EndTime,
                            card.CardID,
                            card.CardLevel,
                            card.Deadline,
                            card.Currency,
                            card.Completed,
                            card.Cost,
                            Type = board.BoardType == "BOARD_REPEAT" ? "REPEAT" : board.BoardType == "BOARD_PROJECT" ? "PROJECT" : "BUILDING",
                            ProjectCode = "",
                            ProjectName = "",
                        }, EnumHelper<FromSrcSendNotify>.GetDisplayValue(FromSrcSendNotify.FromCardJob));
                        msg.Title = _stringLocalizer["CJ_MSG_SEND_NOTIFI_SUCCESS"];
                    }
                }
                else
                {
                    if (!string.IsNullOrEmpty(card.WorkflowCode))
                    {
                        //Rollback
                        var chkList = _context.CardItemChecks.Where(x => !x.Flag && x.CardCode.Equals(card.CardCode));
                        var itemStaff = _context.WorkItemAssignStaffs.Where(x => !x.IsDeleted && x.CardCode.Equals(card.CardCode));
                        var attachments = _context.CardAttachments.Where(x => !x.Flag && x.CardCode.Equals(cardCode));

                        if (chkList.Any())
                        {
                            foreach (var item in chkList)
                            {
                                item.Flag = true;
                                item.DeletedBy = ESEIM.AppContext.UserName;
                                item.DeletedTime = DateTime.Now;
                                _context.CardItemChecks.Update(item);
                            }
                        }
                        if (itemStaff.Any())
                        {
                            foreach (var item in itemStaff)
                            {
                                item.IsDeleted = true;
                                item.DeletedBy = ESEIM.AppContext.UserName;
                                item.DeletedTime = DateTime.Now;
                                _context.WorkItemAssignStaffs.Update(item);
                            }
                        }
                        if (attachments.Any())
                        {
                            foreach (var item in attachments)
                            {
                                item.Flag = true;
                                _context.CardAttachments.Update(item);
                            }
                        }
                        if (assign.Any())
                        {
                            _context.JobCardAssignees.RemoveRange(assign);
                            card.LstUser = "";
                            card.JsonAssign = "";
                        }
                        card.WorkflowCode = "";
                        _context.SaveChanges();
                        msg.Title = "Xóa luồng việc thành công";
                    }
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public object CheckWfInstCard(string cardCode)
        {
            var check = false;
            var process = _context.WfActivityObjectProccessings.FirstOrDefault(x => !x.IsDeleted && x.ObjectInst.Equals(cardCode)
                        && x.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard));
            if (process != null)
            {
                check = true;
            }
            return check;
        }

        [HttpPost]
        public async Task<JsonResult> CreateInstanceWF(string wfCode, string cardCode, bool isMain)
        {
            var msg = new JMessage { Error = false, Title = "" };
            var wfInstCode = string.Empty;
            try
            {
                using (await objLock.LockAsync(string.Concat(cardCode, EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard))))
                {
                    var activities = _context.Activitys.Where(x => !x.IsDeleted && x.WorkflowCode.Equals(wfCode));
                    if (!activities.Any())
                    {
                        msg.Error = true;
                        msg.Title = "Vui lòng thêm hoạt động cho luồng";
                        return Json(msg);
                    }

                    var session = HttpContext.GetSessionUser();

                    var check = _context.WorkflowInstances.FirstOrDefault(x => !x.IsDeleted.Value && x.ObjectInst == cardCode && x.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard));

                    var processing = _context.WfActivityObjectProccessings.Where(x => !x.IsDeleted && x.ObjectType.Equals(EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard))
                                        && x.ObjectInst.Equals(cardCode));
                    if (check == null && !processing.Any())
                    {
                        var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == cardCode && !x.IsDeleted);
                        var list = _context.WORKOSLists.FirstOrDefault(x => x.ListCode.Equals(card.ListCode) && !x.IsDeleted);
                        var board = _context.WORKOSBoards.FirstOrDefault(x => x.BoardCode.Equals(list.BoardCode) && !x.IsDeleted);
                        var wf = _context.WorkFlows.FirstOrDefault(x => !x.IsDeleted.Value && x.WfCode.Equals(wfCode));
                        var lstAssign = _context.JobCardAssignees.Where(x => x.CardCode.Equals(cardCode) && !string.IsNullOrEmpty(x.UserId) && !x.IsDeleted).ToList();
                        if (card != null)
                        {
                            card.WorkflowCode = wfCode;

                            //Rollback
                            var chkList = _context.CardItemChecks.Where(x => !x.Flag && x.CardCode.Equals(card.CardCode));
                            var itemStaff = _context.WorkItemAssignStaffs.Where(x => !x.IsDeleted && x.CardCode.Equals(card.CardCode));
                            if (itemStaff.Any())
                            {
                                foreach (var item in itemStaff)
                                {
                                    item.IsDeleted = true;
                                    item.DeletedBy = ESEIM.AppContext.UserName;
                                    item.DeletedTime = DateTime.Now;
                                    _context.WorkItemAssignStaffs.Update(item);
                                }
                            }
                            UpdateChangeCard(card.CardCode);
                        }
                        var wfName = wf != null ? wf.WfName : "";
                        var dataAttrs = GetAttrSetup(activities);
                        var wfInstance = new WorkflowInstance
                        {
                            ObjectType = EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard),
                            ObjectInst = cardCode,
                            WorkflowCode = wfCode,
                            WfInstCode = "" + (_context.WorkflowInstances.Count() > 0 ? _context.WorkflowInstances.Max(x => x.Id) + 1 : 1),
                            WfInstName = card.CardName + " - " + wfName,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            IsDeleted = false,
                            StartTime = DateTime.Now,
                            Status = "STATUS_WF_PENDING",
                            DataAttr = JsonConvert.SerializeObject(dataAttrs),
                        };
                        _context.WorkflowInstances.Add(wfInstance);
                        _context.SaveChanges();

                        if (!wfInstance.WfInstCode.Equals(wfInstance.Id.ToString()))
                        {
                            wfInstance.WfInstCode = wfInstance.Id.ToString();
                            _context.WorkflowInstances.Update(wfInstance);
                            _context.SaveChanges();
                        }

                        wfInstCode = wfInstance.WfInstCode;

                        //Instance Activity
                        //var activities = _context.Activitys.Where(x => !x.IsDeleted && x.WorkflowCode.Equals(wfCode));
                        var countAct = _context.ActivityInstances.Count();
                        if (activities.Any())
                        {
                            foreach (var item in activities)
                            {
                                countAct++;
                                var actInst = new ActivityInstance
                                {
                                    WorkflowCode = wfInstance.WfInstCode,
                                    ActivityCode = item.ActivityCode,
                                    ActivityInstCode = item.ActivityCode + "_A_" + countAct,
                                    CreatedBy = ESEIM.AppContext.UserName,
                                    CreatedTime = DateTime.Now,
                                    Desc = item.Desc,
                                    Duration = item.Duration,
                                    Group = item.Group,
                                    Located = item.Located,
                                    ShapeJson = item.ShapeJson,
                                    Status = item.Type == "TYPE_ACTIVITY_INITIAL"
                                                    ? "STATUS_ACTIVITY_ACTIVE" : "STATUS_ACTIVITY_NOT_DOING",
                                    Title = item.Title,
                                    Type = item.Type,
                                    Unit = item.Unit,
                                    IsDeleted = false,
                                    //IsLock = item.Type == "TYPE_ACTIVITY_INITIAL" ? false : true,
                                    StartTime = item.Type == "TYPE_ACTIVITY_INITIAL" ? DateTime.Now : (DateTime?)null
                                };
                                _context.ActivityInstances.Add(actInst);

                                if (item.Type == "TYPE_ACTIVITY_INITIAL")
                                {
                                    var process = new WfActivityObjectProccessing
                                    {
                                        WfInstCode = wfInstance.WfInstCode,
                                        ActInstCode = actInst.ActivityInstCode,
                                        ObjectInst = card.CardCode,
                                        ObjectType = EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard),
                                        ObjEntry = true,
                                        CreatedBy = ESEIM.AppContext.UserName,
                                        CreatedTime = DateTime.Now,
                                    };
                                    _context.WfActivityObjectProccessings.Add(process);
                                }

                                var assigns = _context.ExcuterControlRoles.Where(x => !x.IsDeleted && x.ActivityCode == item.ActivityCode);
                                //Add attachment
                                var fileRepos = _context.EDMSRepoCatFiles.Where(x => x.ObjectType.Equals(EnumHelper<ActivityCat>.GetDisplayValue(ActivityCat.ActivityCat))
                                                && x.ObjectCode.Equals(item.ActivityCode));
                                foreach (var fileRepo in fileRepos)
                                {
                                    var edmsReposCatFile = new EDMSRepoCatFile
                                    {
                                        FileCode = string.Concat("ActInst_", Guid.NewGuid().ToString()),
                                        ReposCode = fileRepo.ReposCode,
                                        CatCode = fileRepo.CatCode,
                                        ObjectCode = actInst.ActivityInstCode,
                                        ObjectType = EnumHelper<ActivityInst>.GetDisplayValue(ActivityInst.ActivityInst),
                                        Path = fileRepo.Path,
                                        FolderId = fileRepo.FolderId
                                    };
                                    _context.EDMSRepoCatFiles.Add(edmsReposCatFile);

                                    var edmsReposCard = new EDMSRepoCatFile
                                    {
                                        FileCode = string.Concat("CARDJOB_", Guid.NewGuid().ToString()),
                                        ReposCode = fileRepo.ReposCode,
                                        CatCode = fileRepo.CatCode,
                                        ObjectCode = card.CardCode,
                                        ObjectType = EnumHelper<CardEnum>.GetDisplayValue(CardEnum.CardJob),
                                        Path = fileRepo.Path,
                                        FolderId = fileRepo.FolderId
                                    };
                                    _context.EDMSRepoCatFiles.Add(edmsReposCard);

                                    var edmsFile = _context.EDMSFiles.FirstOrDefault(x => !x.IsDeleted && x.FileCode.Equals(fileRepo.FileCode) && (x.IsFileMaster == true || x.IsFileMaster == null));
                                    if (edmsFile != null)
                                    {
                                        var fileNew = string.Concat(Path.GetFileNameWithoutExtension(edmsFile.FileName), "_", Guid.NewGuid().ToString().Substring(0, 8), Path.GetExtension(edmsFile.FileName));
                                        var byteData = DownloadFileFromServer(fileRepo.Id);
                                        var urlUpload = UploadFileToServer(byteData, fileRepo.ReposCode, fileRepo.CatCode, fileNew, edmsFile.MimeType);

                                        var edms = new EDMSFile
                                        {
                                            FileCode = edmsReposCatFile.FileCode,
                                            FileName = edmsFile.FileName,
                                            Desc = edmsFile.Desc,
                                            ReposCode = fileRepo.ReposCode,
                                            Tags = edmsFile.Tags,
                                            FileSize = edmsFile.FileSize,
                                            FileTypePhysic = edmsFile.FileTypePhysic,
                                            NumberDocument = edmsFile.NumberDocument,
                                            CreatedBy = ESEIM.AppContext.UserName,
                                            CreatedTime = DateTime.Now,
                                            Url = urlUpload.Object.ToString(),
                                            MimeType = edmsFile.MimeType,
                                            CloudFileId = edmsFile.CloudFileId,
                                        };
                                        _context.EDMSFiles.Add(edms);

                                        var edmsCard = new EDMSFile
                                        {
                                            FileCode = edmsReposCard.FileCode,
                                            FileName = edmsFile.FileName,
                                            Desc = edmsFile.Desc,
                                            ReposCode = fileRepo.ReposCode,
                                            Tags = edmsFile.Tags,
                                            FileSize = edmsFile.FileSize,
                                            FileTypePhysic = edmsFile.FileTypePhysic,
                                            NumberDocument = edmsFile.NumberDocument,
                                            CreatedBy = ESEIM.AppContext.UserName,
                                            CreatedTime = DateTime.Now,
                                            Url = urlUpload.Object.ToString(),
                                            MimeType = edmsFile.MimeType,
                                            CloudFileId = edmsFile.CloudFileId,
                                        };
                                        _context.EDMSFiles.Add(edmsCard);

                                        var actInstFile = new ActivityInstFile
                                        {
                                            FileID = edmsReposCatFile.FileCode,
                                            ActivityInstCode = actInst.ActivityInstCode,
                                            CreatedBy = ESEIM.AppContext.UserName,
                                            CreatedTime = DateTime.Now,
                                            IsSign = false,
                                            SignatureRequire = false,
                                        };
                                        _context.ActivityInstFiles.Add(actInstFile);

                                        var listUserShare = from a in assigns
                                                            join b in _context.Users on a.UserId equals b.Id
                                                            join c in _context.AdDepartments.Where(x => !x.IsDeleted && x.IsEnabled) on b.DepartmentId equals c.DepartmentCode into c1
                                                            from c in c1.DefaultIfEmpty()
                                                            select new
                                                            {
                                                                Code = b.UserName,
                                                                Name = b.GivenName,
                                                                DepartmentName = c != null ? c.Title : "",
                                                                Permission = new PermissionFile()
                                                            };
                                        var rela = new
                                        {
                                            ObjectType = EnumHelper<CardEnum>.GetDisplayValue(CardEnum.CardJob),
                                            ObjectInstance = actInst.ActivityInstCode
                                        };
                                        var files = new FilesShareObjectUser
                                        {
                                            CreatedBy = ESEIM.AppContext.UserName,
                                            CreatedTime = DateTime.Now,
                                            FileID = edmsCard.FileCode,
                                            FileCreated = User.Identity.Name,
                                            FileUrl = edmsCard.Url,
                                            FileName = edmsCard.FileName,
                                            ObjectRelative = JsonConvert.SerializeObject(rela),
                                            ListUserShare = JsonConvert.SerializeObject(listUserShare)
                                        };
                                        _context.FilesShareObjectUsers.Add(files);
                                    }
                                }
                                var user = _context.Users.FirstOrDefault(x => x.Id.Equals(ESEIM.AppContext.UserId));
                                var listManager = new List<CreatorManager>(); //AddCreatorManager(userId);
                                var listManagerUserName = !String.IsNullOrEmpty(user.LeadersOfUser) ? user.LeadersOfUser.Split(",", StringSplitOptions.None).ToList() : new List<string>();
                                foreach (var managerUserName in listManagerUserName)
                                {
                                    var manager = _context.Users.FirstOrDefault(x => x.UserName == managerUserName);
                                    if (manager != null)
                                    {
                                        var creatorManager = new CreatorManager()
                                        {
                                            BranchId = manager.BranchId,
                                            DepartmentId = manager.DepartmentId,
                                            UserId = manager.Id
                                        };
                                        listManager.Add(creatorManager);
                                    }
                                }

                                //Add user assign
                                if (assigns.Any())
                                {
                                    //var listManager = AddCreatorManager(ESEIM.AppContext.UserId);
                                    foreach (var assign in assigns)
                                    {
                                        if ((assign.UserId.Equals(EnumHelper<CreatorAssign>.GetDisplayValue(CreatorAssign.Creator))
                                                || assign.UserId.Equals(EnumHelper<CreatorAssign>.GetDisplayValue(CreatorAssign.CreatorManager))))
                                        {
                                            if (assign.UserId.Equals(EnumHelper<CreatorAssign>.GetDisplayValue(CreatorAssign.CreatorManager)))
                                            {
                                                foreach (var manager in listManager)
                                                {
                                                    if (!assigns.Any(x => x.UserId.Equals(manager.UserId)))
                                                    {
                                                        var assignInst = new ExcuterControlRoleInst
                                                        {
                                                            UserId = manager.UserId,
                                                            ActivityCodeInst = actInst.ActivityInstCode,
                                                            Approve = false,
                                                            ApproveTime = (DateTime?)null,
                                                            Branch = manager.BranchId,
                                                            DepartmentCode = "",
                                                            GroupCode = "",
                                                            CreatedTime = DateTime.Now,
                                                            CreatedBy = ESEIM.AppContext.UserName,
                                                            Status = "ASSIGN_STATUS_WORK",
                                                            Role = assign.Role
                                                        };
                                                        _context.ExcuterControlRoleInsts.Add(assignInst);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                if (!assigns.Any(x => x.UserId.Equals(ESEIM.AppContext.UserId)))
                                                {
                                                    var assignInst = new ExcuterControlRoleInst
                                                    {
                                                        UserId = ESEIM.AppContext.UserId,
                                                        ActivityCodeInst = actInst.ActivityInstCode,
                                                        Approve = false,
                                                        ApproveTime = (DateTime?)null,
                                                        Branch = "",
                                                        DepartmentCode = "",
                                                        GroupCode = "",
                                                        CreatedTime = DateTime.Now,
                                                        CreatedBy = ESEIM.AppContext.UserName,
                                                        Status = "ASSIGN_STATUS_WORK",
                                                        Role = assign.Role
                                                    };
                                                    _context.ExcuterControlRoleInsts.Add(assignInst);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            var assignInst = new ExcuterControlRoleInst
                                            {
                                                UserId = assign.UserId,
                                                ActivityCodeInst = actInst.ActivityInstCode,
                                                Approve = assign.Approve,
                                                ApproveTime = assign.ApproveTime,
                                                Branch = assign.Branch,
                                                DepartmentCode = assign.DepartmentCode,
                                                GroupCode = assign.GroupCode,
                                                CreatedTime = DateTime.Now,
                                                CreatedBy = ESEIM.AppContext.UserName,
                                                Status = assign.Status,
                                                Role = assign.Role
                                            };
                                            _context.ExcuterControlRoleInsts.Add(assignInst);
                                        }
                                    }
                                }
                            }
                        }
                        _context.SaveChanges();
                        msg.Title = "Tạo mới thành công";
                        msg.Object = wfInstance;

                        var listUsers = from a in _context.JobCardAssignees.Where(x => !x.IsDeleted && x.CardCode.Equals(cardCode))
                                        join b in _context.Users.Where(x => x.Active) on a.UserId equals b.Id
                                        select new CardMemberCustom
                                        {
                                            Id = a.ID,
                                            UserId = a.UserId,
                                            Responsibility = a.Role,
                                            CreatedTime = a.CreatedTime.ToString("dd/MM/yyyy")
                                        };

                        SendPushNotification(listUsers.AsQueryable(), string.Format("Thẻ #{0} được cập nhật bởi {1}", card.CardCode, session.FullName), new
                        {
                            board.BoardCode,
                            board.BoardName,
                            list.ListCode,
                            card.CardCode,
                            card.CardName,
                            card.BeginTime,
                            card.EndTime,
                            card.CardID,
                            card.CardLevel,
                            card.Deadline,
                            card.Currency,
                            card.Completed,
                            card.Cost,
                            Type = board.BoardType == "BOARD_REPEAT" ? "REPEAT" : board.BoardType == "BOARD_PROJECT" ? "PROJECT" : "BUILDING",
                            ProjectCode = "",
                            ProjectName = "",
                        }, EnumHelper<FromSrcSendNotify>.GetDisplayValue(FromSrcSendNotify.FromCardJob));
                        msg.Title = _stringLocalizer["CJ_MSG_SEND_NOTIFI_SUCCESS"];
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = "Thẻ việc đã được tạo luồng";
                    }
                }
            }
            catch (Exception ex)
            {
                //Rollback wfInstace
                if (!string.IsNullOrEmpty(wfInstCode))
                    DeleteWfInstance(wfInstCode);

                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpGet]
        public JsonResult DeleteWfInstance(string wfInstCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            var session = HttpContext.GetSessionUser();
            var data = _context.WorkflowInstances.FirstOrDefault(x => !x.IsDeleted.Value && x.WfInstCode == wfInstCode);
            if (data != null)
            {
                if (data.CreatedBy == session.UserName || session.IsAllData)
                {
                    data.IsDeleted = true;
                    data.DeletedBy = ESEIM.AppContext.UserName;
                    data.DeletedTime = DateTime.Now;
                    _context.WorkflowInstances.Update(data);

                    var processing = _context.WfActivityObjectProccessings.Where(x => !x.IsDeleted && x.WfInstCode.Equals(data.WfInstCode));
                    foreach (var item in processing)
                    {
                        item.IsDeleted = true;
                        item.DeletedBy = ESEIM.AppContext.UserName;
                        item.DeletedTime = DateTime.Now;
                        _context.WfActivityObjectProccessings.Update(item);
                    }

                    var actInst = _context.ActivityInstances.Where(x => !x.IsDeleted && x.WorkflowCode == wfInstCode);
                    if (actInst.Any())
                    {
                        foreach (var item in actInst)
                        {
                            item.IsDeleted = true;
                            item.DeletedBy = ESEIM.AppContext.UserName;
                            item.DeletedTime = DateTime.Now;
                            _context.ActivityInstances.Update(item);

                            var assigns = _context.ExcuterControlRoleInsts.Where(x => !x.IsDeleted && x.ActivityCodeInst.Equals(item.ActivityInstCode));
                            foreach (var assign in assigns)
                            {
                                assign.IsDeleted = true;
                                assign.DeletedBy = ESEIM.AppContext.UserName;
                                assign.DeletedTime = DateTime.Now;
                                _context.ExcuterControlRoleInsts.Update(assign);
                            }

                            var files = _context.ActivityInstFiles.Where(x => !x.IsDeleted && x.ActivityInstCode.Equals(item.ActivityInstCode));
                            foreach (var file in files)
                            {
                                file.IsDeleted = true;
                                file.DeletedBy = ESEIM.AppContext.UserName;
                                file.DeletedTime = DateTime.Now;
                                _context.ActivityInstFiles.Update(file);
                            }

                            var attrData = _context.ActivityAttrDatas.Where(x => !x.IsDeleted && x.ActCode.Equals(item.ActivityInstCode));
                            foreach (var attr in attrData)
                            {
                                attr.IsDeleted = true;
                                attr.DeletedBy = ESEIM.AppContext.UserName;
                                attr.DeletedTime = DateTime.Now;
                                _context.ActivityAttrDatas.Update(attr);
                            }
                        }
                    }
                    var runnings = _context.WorkflowInstanceRunnings.Where(x => !x.IsDeleted && x.WfInstCode == wfInstCode);
                    if (runnings.Any())
                    {
                        foreach (var item in runnings)
                        {
                            item.IsDeleted = true;
                            item.DeletedBy = ESEIM.AppContext.UserName;
                            item.DeletedTime = DateTime.Now;
                            _context.WorkflowInstanceRunnings.Update(item);
                        }
                    }

                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_DELETE_SUCCESS"];

                    RemoveUserInNotify(wfInstCode, EnumHelper<NotificationType>.GetDisplayValue(NotificationType.WorkFlow), true);
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["WFAI_MSG_U_NOT_PERMISSION_DELETE"];
                }
            }
            else
            {
                msg.Error = true;
                msg.Title = _stringLocalizer["WFAI_MSG_RECORD_NO_EXIST"];
            }
            return Json(msg);
        }

        [NonAction]
        private List<DataAtt> GetAttrSetup(IQueryable<Activity> activities)
        {
            var listData = new List<DataAtt>();

            foreach (var item in activities)
            {
                if (!string.IsNullOrEmpty(item.ListGroupData))
                {
                    var listGroupData = item.ListGroupData.Split(',');

                    var data = (from a in _context.CommonSettings.Where(x => !x.IsDeleted && x.Group == "CARD_DATA_LOGGER")
                                join b in _context.AttrSetups.Where(x => !x.IsDeleted && listGroupData.Any(p => p.Equals(x.AttrGroup)))
                                    on a.CodeSet equals b.AttrGroup
                                select new DataAttrWf
                                {
                                    AttrCode = b != null ? b.AttrCode : "",
                                    AttrName = b != null ? b.AttrName : "",
                                    AttrGroup = a.CodeSet,
                                    AttrDataType = b != null ? b.AttrDataType : "",
                                    AttrNote = b != null ? b.Note : "",
                                    AttrUnit = b != null ? b.AttrUnit : "",
                                    SessionId = "",
                                    Value = "",
                                    ActCode = item.ActivityCode
                                }).GroupBy(x => new { x.AttrGroup, x.ActCode }).ToList();

                    var rs = data.Select(x => new DataAtt
                    {
                        AttrGroup = x.Key.AttrGroup,
                        ActCode = x.Key.ActCode,
                        DataAttrWf = x.ToList()
                    }).ToList();

                    if (rs.Count > 0)
                        listData.AddRange(rs);
                }
            }

            return listData;
        }

        [NonAction]
        public List<CreatorManager> AddCreatorManager(string userId)
        {
            var user = _context.Users.FirstOrDefault(x => x.Id.Equals(userId));
            var lstUser = new List<CreatorManager>();
            if (user != null)
            {
                if (!string.IsNullOrEmpty(user.DepartmentId))
                {
                    lstUser = (from a in _context.AdUserDepartments.Where(x => !x.IsDeleted && x.DepartmentCode.Equals(user.DepartmentId))
                               where a.RoleId.Equals("49b018ad-68af-4625-91fd-2273bb5cf749") || a.RoleId.Equals("4fdd7913-cb36-4621-bf4b-c9359138881c")
                               select new CreatorManager
                               {
                                   UserId = a.UserId,
                                   BranchId = user.BranchId,
                                   DepartmentId = user.DepartmentId
                               }).DistinctBy(x => x.UserId).ToList();
                }
            }
            return lstUser;
        }

        [HttpPost]
        public object ChangeActIns(string actInsCode, string cardCode)
        {
            var check = _context.WfActivityObjectProccessings.FirstOrDefault(x => !x.IsDeleted && x.ActInstCode == actInsCode
                && x.ObjectInst == cardCode && x.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard));
            if (check == null)
            {
                var process = new WfActivityObjectProccessing
                {
                    ActInstCode = actInsCode,
                    Beshare = true,
                    ObjEntry = false,
                    ObjectInst = cardCode,
                    ObjectType = EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard),
                    CreatedBy = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now
                };
                _context.WfActivityObjectProccessings.Add(process);
                UpdateChangeCard(cardCode);
                _context.SaveChanges();
                return process;
            }
            else
            {
                return check;
            }
        }

        [HttpPost]
        public JsonResult ChangeObjEntry(string actInsCode, string cardCode, bool isEntry)
        {
            var msg = new JMessage { Error = false, Title = "" };
            var check = _context.WfActivityObjectProccessings.Where(x => !x.IsDeleted && x.ObjectInst == cardCode
            && x.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard) && x.ObjEntry);
            if (check.Any() && isEntry)
            {
                msg.Error = true;
                msg.Title = "Thẻ việc đã là đối tượng chính của hoạt động khác";
            }
            else
            {
                var data = _context.WfActivityObjectProccessings.FirstOrDefault(x => !x.IsDeleted && x.ObjectInst == cardCode && x.ActInstCode == actInsCode
                    && x.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard));
                if (data != null)
                {
                    data.ObjEntry = isEntry ? true : false;
                    data.Beshare = isEntry ? false : true;
                    _context.WfActivityObjectProccessings.Update(data);
                    _context.SaveChanges();
                    msg.Title = "Cập nhật thành công";
                }
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetActInstCard(string wfInstCode, string cardCode)
        {
            var data = (_context.ActivityInstances.Where(x => !x.IsDeleted && x.WorkflowCode.Equals(wfInstCode))
                        .Select(x => new ViewActInstance
                        {
                            Code = x.ActivityInstCode,
                            Name = x.Title,
                            IsProcess = false
                        })).ToList();
            foreach (var item in data)
            {
                var process = _context.WfActivityObjectProccessings.FirstOrDefault(x => !x.IsDeleted && x.ObjectInst == cardCode
                            && x.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard) && x.ActInstCode.Equals(item.Code));
                if (process != null)
                {
                    item.IsProcess = true;
                }
            }
            return Json(data);
        }

        [HttpPost]
        public JsonResult GetActInstFromWf(string wfCode, string cardCode)
        {
            var data = from a in _context.WorkflowInstances.Where(x => !x.IsDeleted.Value && x.WorkflowCode == wfCode)
                       join b in _context.ActivityInstances.Where(x => !x.IsDeleted) on a.WfInstCode equals b.WorkflowCode
                       join c in _context.WfActivityObjectProccessings.Where(x => !x.IsDeleted) on a.ObjectInst equals c.ObjectInst
                       where a.ObjectInst == cardCode && a.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard)
                       select new
                       {
                           Code = b.ActivityInstCode,
                           Name = b.Title,
                           ActCode = b.ActivityCode,
                           WfInstCode = b.WorkflowCode,
                           IsCheck = c.ObjEntry
                       };
            return Json(data);
        }

        [HttpPost]
        public JsonResult GetCheckListInCard(string cardCode)
        {
            var data = _context.CardItemChecks.Where(x => !x.Flag && x.CardCode == cardCode)
                .Select(x => new
                {
                    Id = x.Id,
                    Title = x.CheckTitle,
                    IsChecked = true,
                    ChkListCode = x.ChkListCode
                });
            return Json(data);
        }

        [HttpPost]
        public JsonResult GetWfInstanceOfCard(string cardCode)
        {
            var wfInstCode = string.Empty;
            var process = _context.WfActivityObjectProccessings.FirstOrDefault(x => !x.IsDeleted && x.ObjectInst == cardCode
                            && x.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard));
            if (process != null)
            {
                wfInstCode = process.WfInstCode;
            }
            return Json(wfInstCode);
        }

        [HttpPost]
        public JsonResult GetAllWfInstance()
        {
            var data = (from a in _context.WorkflowInstances.Where(x => !x.IsDeleted.Value)
                            //join b in _context.WorkFlows.Where(x => !x.IsDeleted.Value) on a.WorkflowCode equals b.WfCode
                        orderby a.Id descending
                        select new
                        {
                            Code = a.WfInstCode,
                            Name = /*b.WfName*/a.WfInstName
                        }).DistinctBy(x => x.Code);
            return Json(data);
        }

        [HttpPost]
        public JsonResult GetAllWf()
        {
            var data = _context.WorkFlows.Where(x => !x.IsDeleted.Value).Select(x => new { Code = x.WfCode, Name = x.WfName });

            return Json(data);
        }

        [NonAction]
        public byte[] DownloadFileFromServer(int idRepoCatFile)
        {
            byte[] fileStream = new byte[0];

            var data = (from a in _context.EDMSRepoCatFiles.Where(x => x.Id == idRepoCatFile)
                        join b in _context.EDMSRepositorys on a.ReposCode equals b.ReposCode into b2
                        from b in b2.DefaultIfEmpty()
                        join c in _context.EDMSFiles on a.FileCode equals c.FileCode into c2
                        from c in c2.DefaultIfEmpty()
                        select new
                        {
                            a.Id,
                            Server = (b != null ? b.Server : null),
                            Token = (b != null ? b.Token : null),
                            Type = (b != null ? b.Type : null),
                            ReposCode = (b != null ? b.ReposCode : null),
                            Url = (c != null ? c.Url : null),
                            FileId = (c != null ? c.CloudFileId : null),
                            FileTypePhysic = c.FileTypePhysic,
                            c.FileName,
                            c.MimeType,
                            b.Account,
                            b.PassWord,
                            c.FileCode,
                            c.IsEdit,
                            c.IsFileMaster,
                            c.FileParentId
                        }).FirstOrDefault();

            var getRepository = _context.EDMSRepositorys.FirstOrDefault(x => x.ReposCode == data.ReposCode);
            if (getRepository.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.Server))
            {
                using (var ms = new MemoryStream())
                {
                    string ftphost = data.Server;
                    string ftpfilepath = data.Url;
                    var urlEnd = System.Web.HttpUtility.UrlPathEncode("ftp://" + ftphost + ftpfilepath);
                    using (WebClient request = new WebClient())
                    {
                        request.Credentials = new NetworkCredential(data.Account, data.PassWord);
                        fileStream = request.DownloadData(urlEnd);
                    }
                }
            }
            else if (getRepository.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.GooglerDriver))
            {
                var apiTokenService = _context.TokenManagers.FirstOrDefault(x => x.AccountCode == data.Token);
                var json = apiTokenService.CredentialsJson;
                var user = apiTokenService.Email;
                var token = apiTokenService.RefreshToken;
                fileStream = FileExtensions.DownloadFileGoogle(json, token, data.FileId, user);
            }

            return fileStream;
        }

        [NonAction]
        public JMessage UploadFileToServer(byte[] fileByteArr, string repoCode, string catCode, string fileName, string contentType)
        {
            var msg = new JMessage() { Error = false, Title = "Tải tệp thành công" };
            try
            {
                var data = (from a in _context.EDMSCatRepoSettings.Where(x => x.ReposCode.Equals(repoCode) && x.CatCode.Equals(catCode))
                            join b in _context.EDMSRepositorys on a.ReposCode equals b.ReposCode into b2
                            from b in b2.DefaultIfEmpty()
                            select new
                            {
                                Server = (b != null ? b.Server : null),
                                Token = (b != null ? b.Token : null),
                                Type = (b != null ? b.Type : null),
                                a.Path,
                                a.FolderId,
                                b.Account,
                                b.PassWord,
                            }).FirstOrDefault();

                var getRepository = _context.EDMSRepositorys.FirstOrDefault(x => x.ReposCode == repoCode);
                if (getRepository.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.Server))
                {
                    var fileBytes = fileByteArr;
                    var urlFile = string.Concat(data.Path, "/", fileName);
                    var urlFileServer = System.Web.HttpUtility.UrlPathEncode("ftp://" + data.Server + urlFile);
                    var result = FileExtensions.UploadFileToFtpServer(urlFileServer, urlFileServer, fileBytes, data.Account, data.PassWord);
                    if (result.Status == WebExceptionStatus.ConnectFailure || result.Status == WebExceptionStatus.ProtocolError)
                    {
                        msg.Error = true;
                        msg.Title = _sharedResources["COM_CONNECT_FAILURE"];

                        return msg;
                    }
                    else if (result.Status == WebExceptionStatus.Success)
                    {
                        msg.Object = urlFile;
                        if (result.IsSaveUrlPreventive)
                        {
                            //urlFile = urlFilePreventive;
                        }
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Object = "Ex3";
                        msg.Title = _sharedResources["COM_MSG_ERR"];
                        return msg;
                    }
                }
                else if (getRepository.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.GooglerDriver))
                {
                    Stream stream = new MemoryStream(fileByteArr); var apiTokenService = _context.TokenManagers.FirstOrDefault(x => x.AccountCode == data.Token);
                    var json = apiTokenService.CredentialsJson;
                    var user = apiTokenService.Email;
                    var token = apiTokenService.RefreshToken;
                    msg.Object = FileExtensions.UploadFileToDrive(json, token, fileName, stream, contentType, data.FolderId, user);
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = "Ex4";
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }

            return msg;
        }

        public class DataAtt
        {
            public string ActCode { get; set; }
            public string AttrGroup { get; set; }
            public List<DataAttrWf> DataAttrWf { get; set; }
        }
        public class DataAttrWf
        {
            public string ActCode { get; set; }
            public string AttrCode { get; set; }
            public string AttrName { get; set; }
            public string AttrGroup { get; set; }
            public string AttrNote { get; set; }
            public string AttrDataType { get; set; }
            public string AttrUnit { get; set; }
            public string SessionId { get; set; }
            public string Value { get; set; }
        }
        public class ViewActInstance
        {
            public string Code { get; set; }
            public string Name { get; set; }
            public bool IsProcess { get; set; }
        }
        public class CreatorManager
        {
            public string UserId { get; set; }
            public string BranchId { get; set; }
            public string DepartmentId { get; set; }
        }
        #endregion

        #region Jobcard data logger

        [HttpPost]
        public JsonResult InsertDataLogger([FromBody] List<JobcardDataLogger> listData)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                if (listData.Count > 0)
                {
                    var commonSettings = _context.CommonSettings.Where(x => !x.IsDeleted && x.Group == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.CardDataLogger));
                    var date = DateTime.Now.ToString("ddMMyyyy_hhmmss");

                    var cardCode = "";

                    var isAllValueNull = true;
                    foreach (var item in listData)
                    {
                        if (!string.IsNullOrEmpty(item.DtValue))
                        {
                            isAllValueNull = false;
                            break;
                        }
                    }

                    if (isAllValueNull)
                    {
                        msg.Error = true;
                        msg.Title = "Vui lòng nhập giá trị";
                        return Json(msg);
                    }

                    foreach (var item in listData.Where(x => !string.IsNullOrEmpty(x.DtValue)))
                    {
                        var dataLog = new JobcardDataLogger
                        {
                            DtUnit = item.DtUnit,
                            DtValueType = commonSettings.FirstOrDefault(p => p.CodeSet.Equals(item.DtValueType)) != null ? commonSettings.FirstOrDefault(p => p.CodeSet.Equals(item.DtValueType)).ValueSet : null,
                            DtGroup = item.DtGroup,
                            SessionId = string.Format("{0}_{1}", date, User.Identity.Name),
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            WfInstCode = "",
                            JobcardCode = item.JobcardCode,
                            ItemList = item.ItemList,
                            ActInstCode = "",
                            DtCode = item.DtCode,
                            DtTitle = item.DtTitle,
                            DtValue = item.DtValue,
                            ShiftCode = item.ShiftCode,
                            Flag = false
                        };
                        _context.JobcardDataLoggers.Add(dataLog);
                        cardCode = item.JobcardCode;
                    }
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "ADD",
                        IdObject = "ATTR_RESULT",
                        IsCheck = true,
                        CardCode = cardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = ""
                    };
                    _context.CardUserActivities.Add(activity);
                    //Realtime card
                    UpdateChangeCard(cardCode);

                    _context.SaveChanges();
                    msg.Title = "Thêm thành công";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult DeleteDataLogger(string sessionId)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var session = HttpContext.GetSessionUser();
                var dataLoggers = _context.JobcardDataLoggers.Where(x => !x.Flag && x.SessionId.Equals(sessionId)).ToList();
                if (dataLoggers.Count > 0)
                {
                    if (dataLoggers[0].CreatedBy.Equals(session.UserName) || session.IsAllData)
                    {
                        dataLoggers.ForEach(x => x.Flag = true);
                        _context.JobcardDataLoggers.UpdateRange(dataLoggers);
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "DELETE",
                            IdObject = "ATTR_RESULT",
                            IsCheck = true,
                            CardCode = dataLoggers[0].JobcardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = ""
                        };
                        _context.CardUserActivities.Add(activity);
                        //Realtime card
                        UpdateChangeCard(dataLoggers[0].JobcardCode);
                        _context.SaveChanges();
                        msg.Title = "Xóa thành công";
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = "Bạn không có quyền xóa";
                    }
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetUnitAttr()
        {
            var data = _context.CommonSettings.Where(x => !x.IsDeleted
            && x.Group == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.AttrUnit))
            .Select(x => new { Code = x.CodeSet, Name = x.ValueSet });
            return Json(data);
        }

        [HttpPost]
        public JsonResult GetAttrDataType()
        {
            var data = _context.CommonSettings.Where(x => !x.IsDeleted
            && x.Group == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.AttrDataType))
            .Select(x => new { Code = x.CodeSet, Name = x.ValueSet });
            return Json(data);
        }
        [HttpPost]
        public JsonResult GetAttrGroup(string cardCode)
        {
            var group = _context.CommonSettings.Where(x => !x.IsDeleted
                        && x.Group.Equals(EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.CardDataLogger)))
                .Select(x => new AttrGroupModel
                {
                    Code = x.CodeSet,
                    Name = x.ValueSet,
                    Count = 0
                }).ToList();


            var groupSession = _context.JobcardDataLoggers
                .Where(x => !x.Flag && x.JobcardCode == cardCode)
                .GroupBy(x => x.SessionId).Select(p => new SessionLogger
                {
                    SessionId = p.Key,
                    Color = "",
                    Index = 0
                }).ToList();

            foreach (var item in group)
            {
                item.Count = GetCountSession(cardCode, groupSession, item.Code);
            }
            return Json(group);
        }
        [NonAction]
        private int GetCountSession(string cardCode, List<SessionLogger> groupSession, string groupCode)
        {
            var data = (from a in _context.JobcardDataLoggers.Where(x => !x.Flag
                            && x.JobcardCode.Equals(cardCode) && x.DtGroup.Equals(groupCode)
                            && x.CreatedTime.Date == DateTime.Now.Date)
                        join b in _context.ShiftLogs on a.ShiftCode equals b.ShiftCode into b1
                        from b in b1.DefaultIfEmpty()
                        join c in _context.Users on a.CreatedBy equals c.UserName
                        join d in groupSession on a.SessionId equals d.SessionId
                        orderby d.Index
                        select new DataLoggerCardModel
                        {
                            ID = a.ID,
                            SessionId = a.SessionId,
                        }).GroupBy(x => x.SessionId);
            return data.Count();
        }

        public class AttrGroupModel
        {
            public string Code { get; set; }
            public string Name { get; set; }
            public int Count { get; set; }
        }

        [HttpPost]
        public JsonResult GetAttrByGroup(string attrGroup)
        {
            var data = _context.AttrSetups.Where(x => !x.IsDeleted &&
                                                           x.AttrGroup.Equals(attrGroup))
                                              .Select(p => new
                                              {
                                                  Code = p.AttrCode,
                                                  p.AttrGroup,
                                                  p.AttrName,
                                                  p.Note,
                                                  p.AttrDataType,
                                                  p.AttrUnit
                                              });

            var dataRs = (from a in data
                          join b in _context.CommonSettings.Where(x => !x.IsDeleted) on a.AttrUnit equals b.CodeSet into b1
                          from b2 in b1.DefaultIfEmpty()
                          join c in _context.CommonSettings.Where(x => !x.IsDeleted) on a.AttrDataType equals c.CodeSet into c1
                          from c2 in c1.DefaultIfEmpty()
                          join d in _context.CommonSettings.Where(x => !x.IsDeleted) on a.AttrGroup equals d.CodeSet into d1
                          from d2 in d1.DefaultIfEmpty()
                              //join e in _context.ActivityAttrSetups.Where(x => !x.IsDeleted && x.PaperTypeCode.Equals(attrGroup) && x.ProfileCode.Equals(profileCode)) on a.Code equals e.AttrCode into e1
                              //from e in e1.DefaultIfEmpty()
                          let user = _context.Users.FirstOrDefault(x => x.Active && x.UserName.Equals(User.Identity.Name))
                          select new
                          {
                              ID = 0,
                              a.Code,
                              Name = a.AttrName,
                              Unit = b2 != null ? b2.ValueSet : "",
                              UnitRaw = a.AttrUnit,
                              Type = c2 != null ? c2.ValueSet : "",
                              TypeRaw = a.AttrDataType,
                              Group = d2 != null ? d2.ValueSet : "",
                              DtGroup = d2 != null ? d2.CodeSet : "",
                              //Value = e != null ? e.AttrValue : "",
                              a.Note,
                              CreatedBy = user != null ? user.GivenName : "",
                              CreatedTime = DateTime.Now.ToString("HH:mm dd/MM/yyyy"),
                          }).ToList();

            return Json(dataRs);
        }

        [HttpPost]
        public JsonResult GetDataLoggerCard(string cardCode)
        {
            var groupSession = _context.JobcardDataLoggers.Where(x => !x.Flag && x.JobcardCode == cardCode).GroupBy(x => x.SessionId).Select(p => new
            SessionLogger
            {
                SessionId = p.Key,
                Color = "",
                Index = 0
            }).ToList();

            var index = 1;
            foreach (var item in groupSession)
            {
                item.Index = index;
                item.Color = index % 2 == 0 ? "" : "#f1f5f7";
                index++;
            }

            var data = (from a in _context.JobcardDataLoggers.Where(x => !x.Flag && x.JobcardCode == cardCode)
                        join b in _context.ShiftLogs on a.ShiftCode equals b.ShiftCode into b1
                        from b in b1.DefaultIfEmpty()
                        join c in _context.Users on a.CreatedBy equals c.UserName
                        join d in groupSession on a.SessionId equals d.SessionId
                        orderby d.Index
                        select new DataLoggerCardModel
                        {
                            ID = a.ID,
                            Code = a.DtCode,
                            Title = a.DtTitle,
                            Value = a.DtValue,
                            Unit = !string.IsNullOrEmpty(a.DtUnit) ? a.DtUnit : "",
                            CreatedBy = c.GivenName,
                            CreatedTime = a.CreatedTime.ToString("HH:mm dd/MM/yyyy"),
                            ItemList = new List<JsonItemList>(),
                            Shift = b != null ? ((b.ChkinTime.HasValue ? b.ChkinTime.Value.ToString("HH:mm dd/MM/yyyy") : "") + " - " + (b.ChkoutTime.HasValue ? b.ChkoutTime.Value.ToString("HH:mm dd/MM/yyy") : "")) : "",
                            DataTypeAttr = a.DtValueType,
                            SessionId = a.SessionId,
                            Color = d.Color,
                            ItemListLog = a.ItemList,
                            Group = _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet.Equals(a.DtGroup)).ValueSet ?? ""
                        }).OrderByDescending(x => x.ID).GroupBy(x => x.SessionId).ToList();
            return Json(data);
        }

        public class DataLoggerCardModel
        {
            public int ID { get; set; }
            public string Code { get; set; }
            public string Title { get; set; }
            public string Value { get; set; }
            public string Unit { get; set; }
            public string CreatedBy { get; set; }
            public string CreatedTime { get; set; }
            public List<JsonItemList> ItemList { get; set; }
            public string Shift { get; set; }
            public string DataTypeAttr { get; set; }
            public FileAttr FileAttr { get; set; }
            public string SessionId { get; set; }
            public string Color { get; set; }
            public string ItemListLog { get; set; }
            public string Group { get; set; }
            public string GroupName { get; set; }
            public string SessionCode { get; set; }
            public List<JsonItemList> ListDetail { get; set; }
        }

        public class JsonItemList
        {
            public string Code { get; set; }
            public string Title { get; set; }
            public string Unit { get; set; }
            public string Value { get; set; }
            public string Name { get; set; }
            public int ID { get; set; }
            public string Type { get; set; }
        }
        public class FileAttr
        {
            public string FileName { get; set; }
            public string FileUrl { get; set; }
            public string CardCode { get; set; }
        }
        public class SessionLogger
        {
            public string Color { get; set; }
            public string SessionId { get; set; }
            public int Index { get; set; }
        }
        #endregion

        #region Create card auto
        [HttpPost]
        public JsonResult InsertCardAuto()
        {
            var msg = new JMessage();
            try
            {
                var maxIdCard = GetMaxIdCard() + 1;
                var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName == ESEIM.AppContext.UserName);
                var rnd = new Random();
                var projects = GetProject();
                var boards = GetBoard();
                for (var i = 0; i < 100000; i++)
                {
                    var idxBoard = rnd.Next(boards.Count() - 1);
                    var boardCode = boards[idxBoard].BoardCode;

                    var lists = GetList(boardCode);
                    var idxList = rnd.Next(lists.Count() - 1);
                    var listCode = lists[idxList].ListCode;

                    //Insert card and attr
                    var card = new WORKOSCard
                    {
                        CardName = "" + maxIdCard,
                        CardCode = "" + maxIdCard,
                        ListCode = listCode,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedDate = DateTime.Now,
                        Currency = "VND",
                        Status = "CREATED",
                        BeginTime = DateTime.Now,
                        Deadline = DateTime.Now,
                        Description = ""
                    };
                    _context.WORKOSCards.Add(card);
                    var comment = new CardCommentList()
                    {
                        CardCode = card.CardCode,
                        CmtId = "Comment" + Guid.NewGuid().ToString(),
                        CmtContent = "Đã tạo công việc",
                        MemberId = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now
                    };
                    _context.CardCommentLists.Add(comment);
                    //Leader
                    var json = new List<JobCardAssignee>();
                    var assignee = new JobCardAssignee
                    {
                        CardCode = card.CardCode,
                        UserId = ESEIM.AppContext.UserId,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now,
                        Role = "ROLE_LEADER",
                        DepartmentCode = "",
                        GroupCode = "",
                        Item = "",
                        Approve = true,
                        ApproveTime = DateTime.Now
                    };
                    card.LstUser += ESEIM.AppContext.UserId + ",";
                    json.Add(assignee);
                    card.JsonAssign = JsonConvert.SerializeObject(json);

                    _context.JobCardAssignees.Add(assignee);


                    var idxProj = rnd.Next(projects.Count());
                    var project = projects[idxProj];
                    var rela = new JcObjectIdRelative
                    {
                        CardCode = card.CardCode,
                        ObjTypeCode = "PROJECT",
                        ObjID = project.ProjectCode,
                        Relative = "MAIN",
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now,
                        Weight = 0
                    };
                    _context.JcObjectIdRelatives.Add(rela);
                    maxIdCard++;
                }
                _context.SaveChanges();
                msg.Title = "Thêm thành công";
            }
            catch (Exception ex)
            {

                throw;
            }
            return Json(msg);
        }
        [NonAction]
        private List<WORKOSBoard> GetBoard()
        {
            var boards = _context.WORKOSBoards.Where(x => !x.IsDeleted).ToList();
            return boards;
        }
        [NonAction]
        private List<WORKOSList> GetList(string boardCode)
        {
            var lists = _context.WORKOSLists.Where(x => !x.IsDeleted && x.BoardCode.Equals(boardCode)).ToList();
            return lists;
        }
        [NonAction]
        private int GetMaxIdCard()
        {
            int maxID = 0;
            var card = _context.WORKOSCards.Where(x => !x.IsDeleted);
            if (card.Any())
            {
                maxID = card.MaxBy(x => x.CardID).CardID;
            }
            return maxID;
        }

        [NonAction]
        private List<Project> GetProject()
        {
            var projects = _context.Projects.Where(x => !x.FlagDeleted).ToList();
            return projects;
        }
        #endregion

        #region Share file

        [HttpPost]
        public JsonResult GetObjFileShare()
        {
            var data = new List<ObjFileShare>();
            var contract = new ObjFileShare
            {
                Code = "CONTRACT",
                Name = "Hợp đồng bán"
            };
            data.Add(contract);

            var contractPO = new ObjFileShare
            {
                Code = "CONTRACT_PO",
                Name = "Hợp đồng mua"
            };
            data.Add(contractPO);

            var project = new ObjFileShare
            {
                Code = "PROJECT",
                Name = "Dự án/đấu thầu"
            };
            data.Add(project);

            var customer = new ObjFileShare
            {
                Code = "CUSTOMER",
                Name = "Khách hàng"
            };
            data.Add(customer);

            var supp = new ObjFileShare
            {
                Code = "SUPPLIER",
                Name = "Nhà cung cấp"
            };
            data.Add(supp);

            var product = new ObjFileShare
            {
                Code = "PRODUCT",
                Name = "Hàng hóa và vật tư"
            };
            data.Add(product);

            var jobCard = new ObjFileShare
            {
                Code = "JOBCARD",
                Name = "Thẻ việc"
            };
            data.Add(jobCard);

            var asset = new ObjFileShare
            {
                Code = "ASSET",
                Name = "Tài sản"
            };
            data.Add(asset);

            var fund = new ObjFileShare
            {
                Code = "FUND",
                Name = "Quỹ"
            };
            data.Add(fund);

            var user = new ObjFileShare
            {
                Code = "USER",
                Name = "Tệp tin đã tải lên"
            };
            data.Add(user);

            var cms = new ObjFileShare
            {
                Code = "CMS",
                Name = "Bài viết"
            };
            data.Add(cms);

            return Json(data);
        }

        [HttpPost]
        public JsonResult GetFileByObjShare([FromBody] FileShareModel jTablePara)
        {
            int intBeginFor = (jTablePara.CurrentPage - 1) * jTablePara.Length;
            IQueryable<GridFileShare> query = null;

            var listFileShare = _context.FilesShareObjectUsers.Where(x => !x.IsDeleted);

            if (string.IsNullOrEmpty(jTablePara.ObjCode))
            {
                var query2 = (from a in _context.EDMSFiles.Where(x => !x.IsDeleted && (x.IsFileMaster == null || x.IsFileMaster == true))
                              join b in _context.EDMSRepoCatFiles on a.FileCode equals b.FileCode
                              join d in _context.EDMSRepositorys on a.ReposCode equals d.ReposCode into d2
                              from d in d2.DefaultIfEmpty()
                              join e in _context.EDMSCategorys.Where(x => !x.IsDeleted) on b.CatCode equals e.CatCode into e1
                              from e in e1.DefaultIfEmpty()
                              where (jTablePara.LstObjCode.Count() != 0 && jTablePara.LstObjCode.Any(x => x == b.CatCode)) &&
                                    (listFileShare.Any(x => x.FileID.Equals(a.FileCode)) || a.CreatedBy.Equals(User.Identity.Name))
                              select new { a, b, d, e });
                var query3 = query2.AsNoTracking().Skip(intBeginFor).Take(jTablePara.Length);
                var count = (from a in _context.EDMSFiles.Where(x => !x.IsDeleted && (x.IsFileMaster == null || x.IsFileMaster == true))
                             join b in _context.EDMSRepoCatFiles on a.FileCode equals b.FileCode
                             select a).AsNoTracking().Count();

                query = query3.Select(x => new GridFileShare
                {
                    Id = x.b != null ? x.b.Id : -1,
                    FileCode = x.a.FileCode,
                    FileName = x.a.FileName,
                    FileCreated = x.a.CreatedBy,
                    FileUrl = x.a.Url,
                });
            }
            else
            {
                switch (jTablePara.ObjCode)
                {
                    case "CONTRACT":
                        query = GetFileContract(listFileShare);
                        break;

                    case "CONTRACT_PO":
                        query = GetFileContractPO(listFileShare);
                        break;

                    case "PROJECT":
                        query = GetFileProject(listFileShare);
                        break;

                    case "CUSTOMER":
                        query = GetFileCustomer(listFileShare);
                        break;

                    case "SUPPLIER":
                        query = GetFileSupplier(listFileShare);
                        break;

                    case "PRODUCT":
                        query = GetFileProduct(listFileShare);
                        break;

                    case "JOBCARD":
                        query = GetFileCardJob(listFileShare);
                        break;

                    case "ASSET":
                        query = GetFileAsset(listFileShare);
                        break;

                    case "FUND":
                        query = GetFileFund();
                        break;

                    case "CMS":
                        query = GetFileCms();
                        break;

                    case "USER":
                        query = GetFileUser(listFileShare);
                        break;
                }
            }
            if (query.Count() > 0)
            {
                var count = query.Count();
                var data = query.OrderUsingSortExpression(jTablePara.QueryOrderBy).Skip(intBeginFor).Take(jTablePara.Length).AsNoTracking().ToList();
                var jdata = JTableHelper.JObjectTable(data, jTablePara.Draw, count, "Id", "FileName", "FileCode", "FileUrl", "FileCreated");
                return Json(jdata);
            }
            else
            {
                var jdata = JTableHelper.JObjectTable(new List<GridFileShare>(), jTablePara.Draw, 0, "Id", "FileName", "FileCode", "FileUrl", "FileCreated");
                return Json(jdata);
            }
        }

        [NonAction]
        public IQueryable<GridFileShare> GetFileContract(IQueryable<FilesShareObjectUser> listFileShare)
        {
            var query = from a in _context.EDMSRepoCatFiles.Where(x => x.ObjectType == EnumHelper<ContractEnum>.GetDisplayValue(ContractEnum.Contract))
                        join b in _context.EDMSFiles.Where(x => !x.IsDeleted) on a.FileCode equals b.FileCode
                        join f in _context.EDMSRepositorys on a.ReposCode equals f.ReposCode into f1
                        from f in f1.DefaultIfEmpty()
                        where (listFileShare.Any(x => x.FileID.Equals(a.FileCode)) || b.CreatedBy.Equals(User.Identity.Name))
                        select new GridFileShare
                        {
                            Id = a.Id,
                            FileCode = b.FileCode,
                            FileName = b.FileName,
                            FileUrl = b.Url,
                            FileCreated = b.CreatedBy
                        };
            return query;
        }

        [NonAction]
        public IQueryable<GridFileShare> GetFileContractPO(IQueryable<FilesShareObjectUser> listFileShare)
        {
            var query = from a in _context.EDMSRepoCatFiles.Where(x => x.ObjectType == EnumHelper<PoSupplierEnum>.GetDisplayValue(PoSupplierEnum.PoSupplier))
                        join b in _context.EDMSFiles.Where(x => !x.IsDeleted) on a.FileCode equals b.FileCode
                        join f in _context.EDMSRepositorys on a.ReposCode equals f.ReposCode into f1
                        from f in f1.DefaultIfEmpty()
                        where (listFileShare.Any(x => x.FileID.Equals(a.FileCode)) || b.CreatedBy.Equals(User.Identity.Name))
                        select new GridFileShare
                        {
                            Id = a.Id,
                            FileCode = b.FileCode,
                            FileName = b.FileName,
                            FileUrl = b.Url,
                            FileCreated = b.CreatedBy
                        };
            return query;
        }

        [NonAction]
        public IQueryable<GridFileShare> GetFileProject(IQueryable<FilesShareObjectUser> listFileShare)
        {
            var query = from a in _context.EDMSRepoCatFiles.Where(x => x.ObjectType == EnumHelper<ProjectEnum>.GetDisplayValue(ProjectEnum.Project))
                        join b in _context.EDMSFiles on a.FileCode equals b.FileCode
                        join f in _context.EDMSRepositorys on a.ReposCode equals f.ReposCode into f1
                        from f in f1.DefaultIfEmpty()
                        where (listFileShare.Any(x => x.FileID.Equals(a.FileCode)) || b.CreatedBy.Equals(User.Identity.Name))
                        select new GridFileShare
                        {
                            Id = a.Id,
                            FileCode = b.FileCode,
                            FileName = b.FileName,
                            FileUrl = b.Url,
                            FileCreated = b.CreatedBy
                        };
            return query;
        }

        [NonAction]
        public IQueryable<GridFileShare> GetFileCustomer(IQueryable<FilesShareObjectUser> listFileShare)
        {
            var query = from a in _context.EDMSRepoCatFiles.Where(x => x.ObjectType == EnumHelper<CustomerEnum>.GetDisplayValue(CustomerEnum.Customer))
                        join b in _context.EDMSFiles on a.FileCode equals b.FileCode
                        join f in _context.EDMSRepositorys on a.ReposCode equals f.ReposCode into f1
                        from f in f1.DefaultIfEmpty()
                        where (listFileShare.Any(x => x.FileID.Equals(a.FileCode)) || b.CreatedBy.Equals(User.Identity.Name))
                        select new GridFileShare
                        {
                            Id = a.Id,
                            FileCode = b.FileCode,
                            FileName = b.FileName,
                            FileUrl = b.Url,
                            FileCreated = b.CreatedBy
                        };
            return query;
        }

        [NonAction]
        public IQueryable<GridFileShare> GetFileSupplier(IQueryable<FilesShareObjectUser> listFileShare)
        {
            var query = from a in _context.EDMSRepoCatFiles.Where(x => x.ObjectType == EnumHelper<SupplierEnum>.GetDisplayValue(SupplierEnum.Supplier))
                        join b in _context.EDMSFiles on a.FileCode equals b.FileCode
                        join f in _context.EDMSRepositorys on a.ReposCode equals f.ReposCode into f1
                        from f in f1.DefaultIfEmpty()
                        where (listFileShare.Any(x => x.FileID.Equals(a.FileCode)) || b.CreatedBy.Equals(User.Identity.Name))
                        select new GridFileShare
                        {
                            Id = a.Id,
                            FileCode = b.FileCode,
                            FileName = b.FileName,
                            FileUrl = b.Url,
                            FileCreated = b.CreatedBy
                        };
            return query;
        }

        [NonAction]
        public IQueryable<GridFileShare> GetFileProduct(IQueryable<FilesShareObjectUser> listFileShare)
        {
            var query = ((from a in _context.EDMSRepoCatFiles.Where(x => x.ObjectType == EnumHelper<WarehouseEnum>.GetDisplayValue(WarehouseEnum.Warehouse))
                          join b in _context.EDMSFiles on a.FileCode equals b.FileCode
                          join f in _context.EDMSRepositorys on a.ReposCode equals f.ReposCode into f1
                          from f in f1.DefaultIfEmpty()
                          where (listFileShare.Any(x => x.FileID.Equals(a.FileCode)) || b.CreatedBy.Equals(User.Identity.Name))
                          select new GridFileShare
                          {
                              Id = a.Id,
                              FileCode = b.FileCode,
                              FileName = b.FileName,
                              FileUrl = b.Url,
                              FileCreated = b.CreatedBy
                          }).Union(
                          from a in _context.EDMSRepoCatFiles.Where(x => x.ObjectType == EnumHelper<EnumMaterialProduct>.GetDisplayValue(EnumMaterialProduct.Product))
                          join b in _context.EDMSFiles on a.FileCode equals b.FileCode
                          join f in _context.EDMSRepositorys on a.ReposCode equals f.ReposCode into f1
                          from f in f1.DefaultIfEmpty()
                          select new GridFileShare
                          {
                              Id = a.Id,
                              FileCode = b.FileCode,
                              FileName = b.FileName,
                              FileUrl = b.Url,
                              FileCreated = b.CreatedBy
                          })).AsNoTracking();
            return query;
        }

        [NonAction]
        public IQueryable<GridFileShare> GetFileCardJob(IQueryable<FilesShareObjectUser> listFileShare)
        {
            var query = from a in _context.CardAttachments.Where(x => !x.Flag)
                        where (listFileShare.Any(x => x.FileID.Equals(a.FileCode)) || a.MemberId.Equals(User.Identity.Name))
                        select new GridFileShare
                        {
                            Id = a.Id,
                            FileCode = a.FileCode,
                            FileName = a.FileName,
                            FileUrl = a.FileUrl,
                            FileCreated = a.MemberId
                        };
            return query;
        }

        [NonAction]
        public IQueryable<GridFileShare> GetFileAsset(IQueryable<FilesShareObjectUser> listFileShare)
        {
            var query = from a in _context.EDMSRepoCatFiles.Where(x => x.ObjectType == EnumHelper<AssetEnum>.GetDisplayValue(AssetEnum.Asset))
                        join b in _context.EDMSFiles.Where(x => !x.IsDeleted && x.IsFileMaster == null || x.IsFileMaster == true) on a.FileCode equals b.FileCode
                        join f in _context.EDMSRepositorys on a.ReposCode equals f.ReposCode into f1
                        from f in f1.DefaultIfEmpty()
                        where (listFileShare.Any(x => x.FileID.Equals(a.FileCode)) || b.CreatedBy.Equals(User.Identity.Name))
                        select new GridFileShare
                        {
                            Id = a.Id,
                            FileCode = b.FileCode,
                            FileName = b.FileName,
                            FileUrl = b.Url,
                            FileCreated = b.CreatedBy
                        };
            return query;
        }

        [NonAction]
        public IQueryable<GridFileShare> GetFileFund()
        {
            var query = _context.FundFiless.Where(x => !x.IsDeleted).Select(x => new GridFileShare
            {
                Id = x.Id,
                FileCode = x.FileCode,
                FileName = x.FileName,
                FileUrl = x.FilePath,
                FileCreated = x.CreatedBy
            });
            return query;
        }

        [NonAction]
        public IQueryable<GridFileShare> GetFileCms()
        {
            var query = from a in _context.cms_attachments
                        select new GridFileShare
                        {
                            Id = a.id,
                            FileCode = "",
                            FileName = a.file_name,
                            FileUrl = a.file_url,
                            FileCreated = ""
                        };
            return query;
        }

        [NonAction]
        public IQueryable<GridFileShare> GetFileUser(IQueryable<FilesShareObjectUser> listFileShare)
        {
            var query = (from a in _context.EDMSRepoCatFiles
                         join b in _context.EDMSFiles.Where(x => !x.IsDeleted && x.CreatedBy.Equals(ESEIM.AppContext.UserName) && x.IsFileMaster == null || x.IsFileMaster == true) on a.FileCode equals b.FileCode
                         join f in _context.EDMSRepositorys on a.ReposCode equals f.ReposCode into f1
                         from f in f1.DefaultIfEmpty()
                         where (listFileShare.Any(x => x.FileID.Equals(a.FileCode)) || b.CreatedBy.Equals(User.Identity.Name))
                         select new GridFileShare
                         {
                             Id = a.Id,
                             FileCode = b.FileCode,
                             FileName = b.FileName,
                             FileUrl = b.Url,
                             FileCreated = b.CreatedBy
                         }).Union(
                  from a in _context.FundFiless.Where(x => !x.IsDeleted && x.CreatedBy.Equals(ESEIM.AppContext.UserName))
                  select new GridFileShare
                  {
                      Id = a.Id,
                      FileCode = a.FileCode,
                      FileName = a.FileName,
                      FileUrl = a.FilePath,
                      FileCreated = a.CreatedBy
                  }).Union(
                from a in _context.CardAttachments.Where(x => !x.Flag && x.MemberId.Equals(ESEIM.AppContext.UserName))
                select new GridFileShare
                {
                    Id = a.Id,
                    FileCode = a.FileCode,
                    FileName = a.FileName,
                    FileUrl = a.FileUrl,
                    FileCreated = a.MemberId
                }).Union(
                from a in _context.cms_attachments
                select new GridFileShare
                {
                    Id = a.id,
                    FileCode = "",
                    FileName = a.file_name,
                    FileUrl = a.file_url,
                    FileCreated = ""
                });
            return query;
        }

        [HttpPost]
        public JsonResult InsertFileShare([FromBody] List<FilesShareObjectUserModel> obj)
        {
            var msg = new JMessage { Title = "", Error = false };
            try
            {
                if (obj.Any())
                {
                    var session = HttpContext.GetSessionUser();
                    var lstUserShare = new List<LstUserShare>();
                    var lstId = new List<int>();
                    foreach (var item in obj)
                    {
                        var repoCatFile = (from a in _context.EDMSRepoCatFiles.Where(x => x.FileCode.Equals(item.FileID))
                                           join b in _context.EDMSFiles.Where(x => !x.IsDeleted && (x.IsFileMaster == true || x.IsFileMaster == null)) on a.FileCode equals b.FileCode
                                           select new { a, b }).FirstOrDefault();
                        if (repoCatFile != null)
                        {
                            var fileNew = string.Concat(Path.GetFileNameWithoutExtension(item.FileName), "_", Guid.NewGuid().ToString().Substring(0, 8), Path.GetExtension(item.FileName));
                            var byteData = DownloadFileFromServer(repoCatFile.a.Id);
                            var urlUpload = UploadFileToServer(byteData, repoCatFile.a.ReposCode, repoCatFile.a.CatCode, fileNew, repoCatFile.b.MimeType);

                            var edmsReposCatFile = new EDMSRepoCatFile
                            {
                                FileCode = string.Concat("Card_", Guid.NewGuid().ToString()),
                                ReposCode = repoCatFile.a.ReposCode,
                                CatCode = repoCatFile.a.CatCode,
                                ObjectCode = item.ObjectInstance,
                                ObjectType = EnumHelper<CardEnum>.GetDisplayValue(CardEnum.CardJob),
                                Path = repoCatFile.a.Path,
                                FolderId = repoCatFile.a.FolderId
                            };
                            _context.EDMSRepoCatFiles.Add(edmsReposCatFile);

                            var edms = new EDMSFile
                            {
                                FileCode = edmsReposCatFile.FileCode,
                                FileName = item.FileName,
                                Desc = "",
                                ReposCode = repoCatFile.a.ReposCode,
                                Tags = "",
                                FileSize = repoCatFile.b.FileSize,
                                FileTypePhysic = repoCatFile.b.FileTypePhysic,
                                NumberDocument = "",
                                CreatedBy = ESEIM.AppContext.UserName,
                                CreatedTime = DateTime.Now,
                                Url = urlUpload.Object.ToString(),
                                MimeType = repoCatFile.b.MimeType,
                                CloudFileId = repoCatFile.b.CloudFileId,
                            };
                            _context.EDMSFiles.Add(edms);
                            lstId.Add(edmsReposCatFile.Id);

                        }
                    }
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "ADD",
                        IdObject = "FILE",
                        IsCheck = true,
                        CardCode = obj[0].ObjectInstance,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = ""
                    };
                    _context.CardUserActivities.Add(activity);
                    UpdateChangeCard(obj[0].ObjectInstance);
                    _context.SaveChanges();
                    msg.Title = "Chọn tệp tin thành công";
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Vui lòng chọn tệp tin";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        public class ObjFileShare
        {
            public string Code { get; set; }
            public string Name { get; set; }
        }
        public class FileShareModel : JTableModel
        {
            public string ObjCode { get; set; }
            public List<string> LstObjCode { get; set; }
        }
        public class GridFileShare
        {
            public int Id { get; set; }
            public string FileCode { get; set; }
            public string FileName { get; set; }
            public string FileUrl { get; set; }
            public string FileCreated { get; set; }
        }
        public class FilesShareObjectUserModel
        {
            public string FileID { get; set; }
            public string ObjectType { get; set; }
            public string ObjectInstance { get; set; }
            public string FileCreated { get; set; }
            public string FileUrl { get; set; }
            public string FileName { get; set; }
        }
        public class ObjRelative
        {
            public string ObjectType { get; set; }
            public string ObjectInstance { get; set; }
        }
        public class LstUserShare
        {
            public string Code { get; set; }
            public string Name { get; set; }
            public string DepartmentName { get; set; }
            public PermissionFile Permission { get; set; }
        }

        #endregion

        #region View card by work flow
        public JsonResult GetGridCardByWF([FromBody] ViewCardWf jtablePara)
        {
            int intBegin = (jtablePara.CurrentPage - 1) * jtablePara.Length;
            int count = 0;
            List<GridCardJtable> queryTab = new List<GridCardJtable>();

            var query = (from a in _context.WORKOSCards.Where(x => !x.IsDeleted && x.Status != "TRASH")
                         join b in _context.WorkflowInstances.Where(x => !x.IsDeleted.Value
                             && x.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard)) on a.CardCode equals b.ObjectInst
                         join c in _context.CommonSettings.Where(x => !x.IsDeleted) on a.Status equals c.CodeSet into c1
                         from c in c1.DefaultIfEmpty()
                         join d in _context.CommonSettings.Where(x => !x.IsDeleted) on a.WorkType equals d.CodeSet into d1
                         from d in c1.DefaultIfEmpty()
                         join e in _context.CommonSettings.Where(x => !x.IsDeleted) on a.CardLevel equals e.CodeSet into e1
                         from e in c1.DefaultIfEmpty()
                         join f in _context.Users on a.CreatedBy equals f.UserName
                         join g in _context.WORKOSLists.Where(x => !x.IsDeleted) on a.ListCode equals g.ListCode
                         join h in _context.WORKOSBoards.Where(x => !x.IsDeleted) on g.BoardCode equals h.BoardCode
                         join i in _context.WfActivityObjectProccessings.Where(x => !x.IsDeleted
                            && x.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard)) on a.CardCode equals i.ObjectInst into i1
                         from i2 in i1.DefaultIfEmpty()
                         where (string.IsNullOrEmpty(jtablePara.WfCode) || b.WorkflowCode == jtablePara.WfCode)
                          && (string.IsNullOrEmpty(jtablePara.WfInstCode) || b.WfInstCode == jtablePara.WfInstCode)
                         select new GridCardJtable
                         {
                             CardID = a.CardID,
                             CardCode = a.CardCode,
                             CardName = a.CardName,
                             ListName = g.ListName,
                             BoardName = h.BoardName,
                             Deadline = a.Deadline,
                             Currency = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == a.Currency).ValueSet ?? "",
                             Cost = a.Cost,
                             Completed = a.Completed,
                             BeginTime = a.BeginTime,
                             Status = c != null ? c.ValueSet : "",
                             EndTime = a.EndTime,
                             UpdateTime = a.UpdatedTime,
                             CreatedBy = f.GivenName,
                             CreatedTime = a.CreatedDate.ToString("dd/MM/yyyy"),
                             CreatedDate = a.CreatedDate,
                             UpdatedTimeTxt = a.UpdatedTime.HasValue ? a.UpdatedTime.Value.ToString("dd/MM/yyyy HH:mm:ss") : "",
                             WorkType = d != null ? d.ValueSet : "",
                             Priority = e != null ? e.ValueSet : "",
                             GroupAssign = "",
                             DepartmentAssign = "",
                             WfName = "",
                             ActName = ""
                         }).OrderBy(x => x.CardID).DistinctBy(x => x.CardID);

            var query1 = (from a in _context.WORKOSCards.Where(x => !x.IsDeleted && x.Status != "TRASH")
                          join c in _context.CommonSettings.Where(x => !x.IsDeleted) on a.Status equals c.CodeSet into c1
                          from c in c1.DefaultIfEmpty()
                          join d in _context.CommonSettings.Where(x => !x.IsDeleted) on a.WorkType equals d.CodeSet into d1
                          from d in c1.DefaultIfEmpty()
                          join e in _context.CommonSettings.Where(x => !x.IsDeleted) on a.CardLevel equals e.CodeSet into e1
                          from e in c1.DefaultIfEmpty()
                          join f in _context.Users on a.CreatedBy equals f.UserName
                          join g in _context.WORKOSLists.Where(x => !x.IsDeleted) on a.ListCode equals g.ListCode
                          join h in _context.WORKOSBoards.Where(x => !x.IsDeleted) on g.BoardCode equals h.BoardCode
                          join i in _context.WfActivityObjectProccessings.Where(x => !x.IsDeleted
                             && x.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard)) on a.CardCode equals i.ObjectInst
                          join b in _context.ActivityInstances.Where(x => !x.IsDeleted) on i.ActInstCode equals b.ActivityInstCode
                          where (string.IsNullOrEmpty(jtablePara.WfInstCode) || b.WorkflowCode == jtablePara.WfInstCode)
                          select new GridCardJtable
                          {
                              CardID = a.CardID,
                              CardCode = a.CardCode,
                              CardName = a.CardName,
                              ListName = g.ListName,
                              BoardName = h.BoardName,
                              Deadline = a.Deadline,
                              Currency = _context.CommonSettings.FirstOrDefault(y => y.CodeSet == a.Currency).ValueSet ?? "",
                              Cost = a.Cost,
                              Completed = a.Completed,
                              BeginTime = a.BeginTime,
                              Status = c != null ? c.ValueSet : "",
                              EndTime = a.EndTime,
                              UpdateTime = a.UpdatedTime,
                              CreatedBy = f.GivenName,
                              CreatedTime = a.CreatedDate.ToString("dd/MM/yyyy"),
                              CreatedDate = a.CreatedDate,
                              UpdatedTimeTxt = a.UpdatedTime.HasValue ? a.UpdatedTime.Value.ToString("dd/MM/yyyy HH:mm:ss") : "",
                              WorkType = d != null ? d.ValueSet : "",
                              Priority = e != null ? e.ValueSet : "",
                              GroupAssign = "",
                              DepartmentAssign = "",
                              WfName = "",
                              ActName = ""
                          }).OrderBy(x => x.CardID).DistinctBy(x => x.CardID);
            queryTab = query.Concat(query1).DistinctBy(x => x.CardID).ToList();

            if (queryTab.Count() > 0)
            {
                string[] param = new string[] { "@CardCodeSequence" };
                var cardCodeSequence = String.Join(";", queryTab.Select(x => x.CardCode));
                object[] val = new object[] { cardCodeSequence };
                DataTable rs = null;
                rs = _repositoryService.GetDataTableProcedureSql("P_GET_ACT_CARD_JOB", param, val);
                var acts = CommonUtil.ConvertDataTable<WfActObjProcess>(rs);
                rs = _repositoryService.GetDataTableProcedureSql("P_GET_USER_CARD_JOB", param, val);
                var users = CommonUtil.ConvertDataTable<JobCardUser>(rs);
                rs = _repositoryService.GetDataTableProcedureSql("P_GET_DEPARTMENT_CARD_JOB", param, val);
                var assignees = CommonUtil.ConvertDataTable<DepartmentGroupAssignee>(rs);
                rs = _repositoryService.GetDataTableProcedureSql("P_GET_LAST_CHANGE_CARD_JOB", param, val);
                var activityAssignees = CommonUtil.ConvertDataTable<ActivityAssignee>(rs);
                rs = _repositoryService.GetDataTableProcedureSql("P_GET_NOTI_CARD_JOB", param, val);
                var managers = CommonUtil.ConvertDataTable<NotificationManager>(rs);
                foreach (var item in queryTab)
                {
                    var tuple = GetWfActName(item.CardCode, acts);
                    item.IsShowLabelAssign = CheckShowLabelAssign(item.CardCode, users);
                    var assign = GetDepartmentGroupAssign(item.CardCode, assignees);
                    item.GroupAssign = assign.Item2;
                    item.DepartmentAssign = assign.Item1;
                    item.WfName = tuple.Item1;
                    item.ActName = tuple.Item2;
                }
                count = queryTab.Count;
                var jdata = JTableHelper.JObjectTable(
                                queryTab,
                                jtablePara.Draw,
                                count,
                                "CardID", "CardCode", "CardName", "ListName", "Deadline", "Status",
                                "Completed", "BeginTime", "EndTime", "Cost", "Currency", "CreatedBy", "CreatedTime",
                                "Priority", "WorkType", "UpdatedTimeTxt", "UpdateTime", "BoardName", "IsShowLabelAssign",
                                "GroupAssign", "DepartmentAssign", "WfName", "ActName"
                                );
                return Json(jdata);
            }
            else
            {
                var jdata = JTableHelper.JObjectTable(
                                queryTab,
                                jtablePara.Draw,
                                count,
                                "CardID", "CardCode", "CardName", "ListName", "Deadline", "Status",
                                "Completed", "BeginTime", "EndTime", "Cost", "Currency", "CreatedBy", "CreatedTime",
                                "Priority", "WorkType", "UpdatedTimeTxt", "UpdateTime", "BoardName", "IsShowLabelAssign",
                                "GroupAssign", "DepartmentAssign", "WfName", "ActName"
                                );
                return Json(jdata);
            }
        }
        public class ViewCardWf : JTableModel
        {
            public string WfCode { get; set; }
            public string WfInstCode { get; set; }
        }
        #endregion

        #region Role system with card
        [HttpGet]
        public object PermissionHeaderCard(string cardCode)
        {
            // check permission of user for interact with header card
            var session = HttpContext.GetSessionUser();
            var hasPermission = false;
            var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode == cardCode);
            if (card != null)
            {
                if (card.CreatedBy == session.UserName || session.IsAllData)
                    hasPermission = true;
            }
            return hasPermission;
        }
        #endregion

        #region Lock card
        [HttpPost]
        public JsonResult LockCard(string cardCode, bool value)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var session = HttpContext.GetSessionUser();
                var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == cardCode && !x.IsDeleted);
                if (card != null)
                {
                    if (session.IsAllData)
                    {
                        card.IsLock = value;
                        UpdateChangeCard(card.CardCode);
                        _context.SaveChanges();
                        msg.Title = card.IsLock ? "Khóa thẻ việc thành công" : "Mở khóa thẻ việc thành công";
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = "Bạn không có quyền thực hiện chức năng này";
                    }
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Bản ghi không tồn tại";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }
        #endregion

        #region View Log WF

        [HttpGet]
        public JsonResult ViewLogWF(string cardCode, string wfInstCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            var wfInst = _context.WorkflowInstances.FirstOrDefault(x => !x.IsDeleted.Value /*&& x.ObjectInst.Equals(cardCode)*/
            && x.WfInstCode.Equals(wfInstCode) /*&& x.ObjectType == EnumHelper<PublishEnum>.GetDisplayValue(PublishEnum.TypeInstCard)*/);
            if (wfInst != null)
            {
                var common = _context.CommonSettings.Where(k => !k.IsDeleted);

                var acts = _context.ActivityInstances.Where(x => !x.IsDeleted
                    && x.WorkflowCode.Equals(wfInst.WfInstCode))
                    .Select(x => new ActGrid
                    {
                        ActInstCode = x.ActivityInstCode,
                        ActInstName = x.Title,
                        Duration = x.Duration,
                        Status = common.FirstOrDefault(k => k.CodeSet.Equals(x.Status)) != null ?
                                   common.FirstOrDefault(k => k.CodeSet.Equals(x.Status)).ValueSet : "",
                        Unit = common.FirstOrDefault(k => k.CodeSet.Equals(x.Unit)) != null ?
                                   common.FirstOrDefault(k => k.CodeSet.Equals(x.Unit)).ValueSet : "",
                        Type = x.Type,
                        IsLock = (x.Type.Equals("STATUS_ACTIVITY_NOT_DOING") || x.Type.Equals("STATUS_ACTIVITY_LOCK")) ? true : false
                    }).ToList();

                var actInitial = acts.FirstOrDefault(x => x.Type.Equals("TYPE_ACTIVITY_INITIAL"));

                acts = ArrangeAct(acts, 1, actInitial, new List<ActInstInfo>());

                msg.Object = acts;
            }
            return Json(msg);
        }

        [NonAction]
        private List<ActGrid> ArrangeAct(List<ActGrid> listInst, int level,
            ActGrid instInitial, List<ActInstInfo> listActInfo)
        {
            try
            {
                if (instInitial != null)
                {
                    instInitial.Level = level;
                    var runnings = _context.WorkflowInstanceRunnings.Where(x => !x.IsDeleted && x.ActivityInitial.Equals(instInitial.ActInstCode));
                    foreach (var item in runnings)
                    {
                        var actRunning = listInst.FirstOrDefault(x => x.ActInstCode.Equals(item.ActivityDestination));
                        if (actRunning != null)
                        {
                            if (!listActInfo.Any(x => x.ActInstCode.Equals(actRunning.ActInstCode)))
                            {
                                actRunning.Level = instInitial.Level + 1;

                                var info = new ActInstInfo
                                {
                                    ActInstCode = actRunning.ActInstCode
                                };

                                listActInfo.Add(info);
                                listInst = ArrangeAct(listInst, actRunning.Level, actRunning, listActInfo);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {

            }

            return listInst.OrderBy(x => x.Level).ToList();
        }

        public class ActGrid
        {
            public string ActInstCode { get; set; }
            public string ActInstName { get; set; }
            public string Status { get; set; }
            public decimal Duration { get; set; }
            public string Unit { get; set; }
            public int Level { get; set; }
            public string Type { get; set; }
            public bool IsLock { get; set; }
        }
        public class ActInstInfo
        {
            public string ActInstCode { get; set; }
        }
        #endregion

        #region File card to repo

        public class FileCardJob
        {
            public int Id { get; set; }
            public string FileCode { get; set; }
            public string FileName { get; set; }
            public string FileTypePhysic { get; set; }
            public string Desc { get; set; }
            public DateTime CreatedTime { get; set; }
            public string CloudFileId { get; set; }
            public string ReposType { get; set; }
            public string ReposName { get; set; }
            public int FileID { get; set; }
            public decimal SizeOfFile { get; set; }
            public string TypeFile { get; set; }
            public string ListUserShare { get; set; }
            public string CreatedBy { get; set; }
        }

        [HttpPost]
        public object JTableFile([FromBody] JTableModelFile jTablePara)
        {
            if (string.IsNullOrEmpty(jTablePara.CardCode))
            {
                return JTableHelper.JObjectTable(new List<object>(), jTablePara.Draw, 0, "Id", "FileName", "FileTypePhysic", "Desc", "Url", "CreatedTime", "UpdatedTime", "ReposName", "TypeFile", "FileID", "SizeOfFile");
            }
            int intBeginFor = (jTablePara.CurrentPage - 1) * jTablePara.Length;
            var fromDate = !string.IsNullOrEmpty(jTablePara.FromDate) ? DateTime.ParseExact(jTablePara.FromDate, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
            var toDate = !string.IsNullOrEmpty(jTablePara.ToDate) ? DateTime.ParseExact(jTablePara.ToDate, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;

            //var listFileByUser = _context.FilesShareObjectUsers.Where(x => !x.IsDeleted && x.UserShares.Any(p => p.Code.Equals(User.Identity.Name)))
            //                                               .Select(p => new
            //                                               {
            //                                                   p.FileID,
            //                                                   p.ListUserShare,
            //                                                   p.UserShares
            //                                               }).ToList();
            var session = HttpContext.GetSessionUser();

            string[] param = new string[] { "@CardCode" };
            object[] val = new object[] { jTablePara.CardCode };
            DataTable rs = _repositoryService.GetDataTableProcedureSql("P_GET_FILE_CARD_JOB", param, val);
            var query = CommonUtil.ConvertDataTable<FileCardJob>(rs);
            int count = query.Count();
            var data = query.AsQueryable().OrderUsingSortExpression(jTablePara.QueryOrderBy).Skip(intBeginFor).Take(jTablePara.Length).AsNoTracking().ToList();
            var jdata = JTableHelper.JObjectTable(data, jTablePara.Draw, count, "Id", "FileCode", "FileName", "FileTypePhysic", "Desc",
                "CreatedTime", "CloudFileId", "ReposName", "TypeFile", "FileID", "SizeOfFile", "ListUserShare", "CreatedBy");
            return jdata;
        }

        [AllowAnonymous]
        [HttpPost]
        public object CheckPermisionFileNoShare(string fileCode)
        {
            var session = HttpContext.GetSessionUser();
            var listFileByUser = _context.FilesShareObjectUsers
                .Where(x => !x.IsDeleted && x.FileID == fileCode
                            && x.UserShares.Any(p => p.Code.Equals(User.Identity.Name)))
                                                           .Select(p => new
                                                           {
                                                               p.FileID,
                                                               p.ListUserShare,
                                                               p.UserShares
                                                           }).ToList();
            var file = _context.EDMSFiles.FirstOrDefault(x => !x.IsDeleted && x.FileCode == fileCode);
            return listFileByUser.Any()
                   || (file?.CreatedBy == User.Identity.Name) ||
                   session.IsAllData;
        }

        private static readonly log4net.ILog logCj = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);
        [HttpPost]
        [RequestFormLimits(MultipartBodyLengthLimit = long.MaxValue)]
        [RequestSizeLimit(long.MaxValue)]
        public JsonResult InsertCardJobFile(EDMSRepoCatFileModel obj, IFormFile fileUpload)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                logCj.Info($"Begin getting path");
                var mimeType = fileUpload.ContentType;
                string extension = Path.GetExtension(fileUpload.FileName);
                string urlFile = "";
                string fileId = "";
                string reposCode = "";
                string catCode = "";
                string path = "";
                string folderId = "";
                //Chọn file ngắn gọn
                if (!obj.IsMore)
                {
                    //var suggesstion = GetSuggestionsCardCodeFile(obj.CardCode);
                    //if (suggesstion != null)
                    //{
                    //    reposCode = suggesstion.ReposCode;
                    //    path = suggesstion.Path;
                    //    folderId = suggesstion.FolderId;
                    //    catCode = suggesstion.CatCode;
                    //}
                    //else
                    //{
                    //    msg.Error = true;
                    //    msg.Title = _stringLocalizer["Vui lòng nhập thuộc tính mở rộng"];
                    //    return Json(msg);
                    //}

                    var repoDefault = _context.EDMSRepoDefaultObjects.FirstOrDefault(x => !x.IsDeleted
                            && x.ObjectCode.Equals(obj.CardCode) && x.ObjectType.Equals(EnumHelper<ObjectType>.GetDisplayValue(ObjectType.Cardjob)));
                    if (repoDefault != null)
                    {
                        reposCode = repoDefault.ReposCode;
                        path = repoDefault.Path;
                        folderId = repoDefault.FolderId;
                        catCode = repoDefault.CatCode;
                    }
                    else
                    {
                        var setting = (EDMSCatRepoSetting)_upload.GetPathByModule(module_name).Object;
                        reposCode = setting.ReposCode;
                        catCode = setting.CatCode;
                        if (setting.Path == "")
                        {
                            host_type = 1;
                            path_upload_file = setting.FolderId;
                        }
                        else
                        {
                            host_type = 0;
                            path_upload_file = setting.Path;
                        }
                        path = host_type == 0 ? path_upload_file : "";
                        folderId = host_type == 1 ? path_upload_file : "";
                        //msg.Error = true;
                        //msg.Title = _sharedResources["COM_MSG_PLS_SETUP_FOLDER_DEFAULT"];
                        //return Json(msg);
                    }
                }
                //Hiển file mở rộng
                else
                {
                    var setting = _context.EDMSCatRepoSettings.FirstOrDefault(x => x.Id == obj.CateRepoSettingId);
                    if (setting != null)
                    {
                        reposCode = setting.ReposCode;
                        path = setting.Path;
                        folderId = setting.FolderId;
                        catCode = setting.CatCode;
                    }
                    else
                    {
                        var defaultSetting = (EDMSCatRepoSetting)_upload.GetPathByModule(module_name).Object;
                        reposCode = defaultSetting.ReposCode;
                        catCode = defaultSetting.CatCode;
                        if (defaultSetting.Path == "")
                        {
                            host_type = 1;
                            path_upload_file = defaultSetting.FolderId;
                        }
                        else
                        {
                            host_type = 0;
                            path_upload_file = defaultSetting.Path;
                        }
                        path = host_type == 0 ? path_upload_file : "";
                        folderId = host_type == 1 ? path_upload_file : "";
                        //msg.Error = true;
                        //msg.Title = _stringLocalizer["CJ_MSG_PLS_SELECT_FOLDER"];
                        //return Json(msg);
                    }
                }
                logCj.Info($"End getting path");
                var getRepository = _context.EDMSRepositorys.FirstOrDefault(x => x.ReposCode == reposCode);
                if (getRepository.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.Server))
                {
                    using (var ms = new MemoryStream())
                    {
                        fileUpload.CopyTo(ms);
                        var fileBytes = ms.ToArray();
                        urlFile = path + Path.Combine("/", fileUpload.FileName);
                        var urlFilePreventive = path + Path.Combine("/", Guid.NewGuid().ToString().Substring(0, 8) + fileUpload.FileName);
                        var urlEnd = System.Web.HttpUtility.UrlPathEncode("ftp://" + getRepository.Server + urlFile);
                        var urlEndPreventive = System.Web.HttpUtility.UrlPathEncode("ftp://" + getRepository.Server + urlFilePreventive);
                        logCj.Info($"Begin upload file");
                        var result = FileExtensions.UploadFileToFtpServer(urlEnd, urlEndPreventive, fileBytes, getRepository.Account, getRepository.PassWord);
                        if (result.Status == WebExceptionStatus.ConnectFailure || result.Status == WebExceptionStatus.ProtocolError)
                        {
                            msg.Error = true;
                            msg.Title = _sharedResources["COM_CONNECT_FAILURE"];
                            return Json(msg);
                        }
                        else if (result.Status == WebExceptionStatus.Success)
                        {
                            if (result.IsSaveUrlPreventive)
                            {
                                urlFile = urlFilePreventive;
                            }
                        }
                        else
                        {
                            msg.Error = true;
                            msg.Title = _sharedResources["COM_MSG_ERR"];
                            return Json(msg);
                        }
                        logCj.Info($"Finish upload file");
                    }
                }
                else if (getRepository.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.GooglerDriver))
                {
                    var apiTokenService = _context.TokenManagers.FirstOrDefault(x => x.AccountCode == getRepository.Token);
                    var json = apiTokenService.CredentialsJson;
                    var user = apiTokenService.Email;
                    var token = apiTokenService.RefreshToken;
                    fileId = FileExtensions.UploadFileToDrive(json, token, fileUpload.FileName, fileUpload.OpenReadStream(), fileUpload.ContentType, folderId, user);
                }
                logCj.Info($"Upload file successfully");
                var edmsReposCatFile = new EDMSRepoCatFile
                {
                    FileCode = string.Concat("CARDJOB_", Guid.NewGuid().ToString()),
                    ReposCode = reposCode,
                    CatCode = catCode,
                    ObjectCode = obj.CardCode,
                    ObjectType = EnumHelper<CardEnum>.GetDisplayValue(CardEnum.CardJob),
                    Path = path,
                    FolderId = folderId
                };
                _context.EDMSRepoCatFiles.Add(edmsReposCatFile);

                /// created Index lucene
                if (Array.IndexOf(LuceneExtension.fileMimetypes, mimeType) >= 0 && (Array.IndexOf(LuceneExtension.fileExt, extension.ToUpper()) >= 0))
                {
                    var moduleObj = (EDMSCatRepoSetting)_upload.GetPathByModule("DB_LUCENE_INDEX").Object;
                    var luceneCategory = _context.EDMSCategorys.FirstOrDefault(x => x.CatCode == moduleObj.CatCode);
                    logCj.Info($"Begin index file");
                    LuceneExtension.IndexFile(edmsReposCatFile.FileCode, fileUpload, /*string.Concat(_hostingEnvironment.WebRootPath, "\\uploads\\luceneIndex")*/ luceneCategory.PathServerPhysic);
                }
                logCj.Info($"Index successfully");

                //add File
                var file = new EDMSFile
                {
                    FileCode = edmsReposCatFile.FileCode,
                    FileName = fileUpload.FileName,
                    Desc = obj.Desc,
                    ReposCode = reposCode,
                    Tags = obj.Tags,
                    FileSize = fileUpload.Length,
                    FileTypePhysic = Path.GetExtension(fileUpload.FileName),
                    NumberDocument = obj.NumberDocument,
                    CreatedBy = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now,
                    Url = urlFile,
                    MimeType = mimeType,
                    CloudFileId = fileId,
                };
                _context.EDMSFiles.Add(file);
                logCj.Info($"Add file {fileUpload.FileName}");
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    Action = "ADD",
                    IdObject = "FILE",
                    IsCheck = true,
                    CardCode = obj.CardCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = fileUpload.FileName
                };
                _context.CardUserActivities.Add(activity);
                UpdateChangeCard(obj.CardCode);

                _context.SaveChanges();
                msg.Title = _sharedResources["COM_ADD_SUCCESS"];
                msg.Object = edmsReposCatFile.Id;
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpGet]
        public EDMSRepoCatFile GetSuggestionsCardCodeFile(string cardCode)
        {
            var query = _context.EDMSRepoCatFiles.Where(x => x.ObjectCode == cardCode && x.ObjectType == EnumHelper<CardEnum>.GetDisplayValue(CardEnum.CardJob)).MaxBy(x => x.Id);
            return query;
        }

        [HttpPost]
        public JsonResult GetCardFile(int id)
        {
            var msg = new JMessage { Error = false, Title = "" };
            var model = new EDMSRepoCatFileModel();
            try
            {
                var data = _context.EDMSRepoCatFiles.FirstOrDefault(m => m.Id == id);
                if (data != null)
                {
                    var file = _context.EDMSFiles.FirstOrDefault(x => x.FileCode == data.FileCode);
                    //header file
                    model.FileCode = file.FileCode;
                    model.NumberDocument = file.NumberDocument;
                    model.Tags = file.Tags;
                    model.Desc = file.Desc;
                    //category file
                    model.CateRepoSettingCode = data.CatCode;
                    model.CateRepoSettingId = data.Id;
                    model.Path = data.Path;
                    model.FolderId = data.FolderId;
                    msg.Object = model;
                }
                else
                {
                    msg.Error = true;
                    msg.Title = String.Format(_stringLocalizer["Tệp tin không tồn tại"]);//"Tệp tin không tồn tại!";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateCardFile(EDMSRepoCatFileModel obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                string path = "";
                string fileId = "";
                var oldSetting = _context.EDMSRepoCatFiles.FirstOrDefault(x => x.FileCode == obj.FileCode);
                if (oldSetting != null)
                {
                    var newSetting = _context.EDMSCatRepoSettings.FirstOrDefault(x => x.Id == obj.CateRepoSettingId);
                    if (newSetting != null)
                    {
                        var file = _context.EDMSFiles.FirstOrDefault(x => x.FileCode == oldSetting.FileCode);
                        //change folder
                        if ((string.IsNullOrEmpty(oldSetting.Path) && oldSetting.FolderId != newSetting.FolderId) || (string.IsNullOrEmpty(oldSetting.FolderId) && oldSetting.Path != newSetting.Path))
                        {
                            //dowload file old
                            var oldRepo = _context.EDMSRepositorys.FirstOrDefault(x => x.ReposCode == oldSetting.ReposCode);
                            byte[] fileData = null;
                            if (oldRepo.Type == "SERVER")
                            {
                                string ftphost = oldRepo.Server;
                                string ftpfilepath = file.Url;
                                var urlEnd = System.Web.HttpUtility.UrlPathEncode("ftp://" + ftphost + ftpfilepath);
                                using (WebClient request = new WebClient())
                                {
                                    request.Credentials = new NetworkCredential(oldRepo.Account, oldRepo.PassWord);
                                    fileData = request.DownloadData(urlEnd);
                                }
                            }
                            else
                            {
                                var apiTokenService = _context.TokenManagers.FirstOrDefault(x => x.AccountCode == oldRepo.Token);
                                var json = apiTokenService.CredentialsJson;
                                var user = apiTokenService.Email;
                                var token = apiTokenService.RefreshToken;
                                fileData = FileExtensions.DownloadFileGoogle(json, token, file.CloudFileId, user);
                            }
                            //delete folder old
                            if (oldRepo.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.Server))
                            {
                                var urlEnd = System.Web.HttpUtility.UrlPathEncode("ftp://" + oldRepo.Server + file.Url);
                                FileExtensions.DeleteFileFtpServer(urlEnd, oldRepo.Account, oldRepo.PassWord);
                            }
                            else if (oldRepo.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.GooglerDriver))
                            {
                                var apiTokenService = _context.TokenManagers.FirstOrDefault(x => x.AccountCode == oldRepo.Token);
                                var json = apiTokenService.CredentialsJson;
                                var user = apiTokenService.Email;
                                var token = apiTokenService.RefreshToken;
                                FileExtensions.DeleteFileGoogleServer(json, token, file.CloudFileId, user);
                            }

                            //insert folder new
                            var newRepo = _context.EDMSRepositorys.FirstOrDefault(x => x.ReposCode == newSetting.ReposCode);
                            if (newRepo.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.Server))
                            {
                                path = newSetting.Path + Path.Combine("/", file.FileName);
                                var pathPreventive = path + Path.Combine("/", Guid.NewGuid().ToString().Substring(0, 8) + file.FileName);
                                var urlEnd = System.Web.HttpUtility.UrlPathEncode("ftp://" + newRepo.Server + path);
                                var urlEndPreventive = System.Web.HttpUtility.UrlPathEncode("ftp://" + newRepo.Server + pathPreventive);
                                var result = FileExtensions.UploadFileToFtpServer(urlEnd, urlEndPreventive, fileData, newRepo.Account, newRepo.PassWord);
                                if (result.Status == WebExceptionStatus.ConnectFailure || result.Status == WebExceptionStatus.ProtocolError)
                                {
                                    msg.Error = true;
                                    msg.Title = _sharedResources["COM_CONNECT_FAILURE"];
                                    return Json(msg);
                                }
                                else if (result.Status == WebExceptionStatus.Success)
                                {
                                    if (result.IsSaveUrlPreventive)
                                    {
                                        path = pathPreventive;
                                    }
                                }
                                else
                                {
                                    msg.Error = true;
                                    msg.Title = _sharedResources["COM_MSG_ERR"];
                                    return Json(msg);
                                }
                            }
                            else if (newRepo.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.GooglerDriver))
                            {
                                var apiTokenService = _context.TokenManagers.FirstOrDefault(x => x.AccountCode == newRepo.Token);
                                var json = apiTokenService.CredentialsJson;
                                var user = apiTokenService.Email;
                                var token = apiTokenService.RefreshToken;
                                fileId = FileExtensions.UploadFileToDrive(json, token, file.FileName, new MemoryStream(fileData), file.MimeType, newSetting.FolderId, user);
                            }
                            file.CloudFileId = fileId;
                            file.Url = path;

                            //update setting new
                            oldSetting.CatCode = newSetting.CatCode;
                            oldSetting.ReposCode = newSetting.ReposCode;
                            oldSetting.Path = newSetting.Path;
                            oldSetting.FolderId = newSetting.FolderId;
                            _context.EDMSRepoCatFiles.Update(oldSetting);
                        }
                        //update header
                        file.Desc = obj.Desc;
                        file.Tags = obj.Tags;
                        file.NumberDocument = obj.NumberDocument;
                        _context.EDMSFiles.Update(file);
                        _context.SaveChanges();
                        msg.Title = _stringLocalizer["HR_HR_MSG_UPDATE_SUCCESS"];
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["HR_HR_MAN_MSG_SELECT_FORDER"];
                    }
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["HR_HR_MSG_FILE_NOT_EXIST"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = String.Format(_sharedResources["COM_MSG_UPDATE_FAILED"], _stringLocalizer[""]);// "Có lỗi xảy ra khi cập nhật!";
                msg.Object = ex;
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult DeleteCardFile(int id)
        {
            var msg = new JMessage() { Error = false };
            try
            {
                var data = _context.EDMSRepoCatFiles.FirstOrDefault(x => x.Id == id);
                _context.EDMSRepoCatFiles.Remove(data);

                var file = _context.EDMSFiles.FirstOrDefault(x => x.FileCode == data.FileCode);
                _context.EDMSFiles.Remove(file);

                var moduleObj = (EDMSCatRepoSetting)_upload.GetPathByModule("DB_LUCENE_INDEX").Object;
                var luceneCategory = _context.EDMSCategorys.FirstOrDefault(x => x.CatCode == moduleObj.CatCode);
                LuceneExtension.DeleteIndexFile(file.FileCode, /*_hostingEnvironment.WebRootPath + "\\uploads\\luceneIndex"*/ luceneCategory.PathServerPhysic);
                var getRepository = _context.EDMSRepositorys.FirstOrDefault(x => x.ReposCode == data.ReposCode);
                if (getRepository != null)
                {
                    if (getRepository.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.Server))
                    {
                        var urlEnd = System.Web.HttpUtility.UrlPathEncode("ftp://" + getRepository.Server + file.Url);
                        FileExtensions.DeleteFileFtpServer(urlEnd, getRepository.Account, getRepository.PassWord);
                    }
                    else if (getRepository.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.GooglerDriver))
                    {
                        var apiTokenService = _context.TokenManagers.FirstOrDefault(x => x.AccountCode == getRepository.Token);
                        var json = apiTokenService.CredentialsJson;
                        var user = apiTokenService.Email;
                        var token = apiTokenService.RefreshToken;
                        FileExtensions.DeleteFileGoogleServer(json, token, file.CloudFileId, user);
                    }
                }
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    Action = "DELETE",
                    IdObject = "FILE",
                    IsCheck = true,
                    CardCode = data.ObjectCode,
                    CreatedTime = DateTime.Now,
                    FromDevice = "Laptop/Desktop",
                    ChangeDetails = file.FileName
                };
                _context.CardUserActivities.Add(activity);
                UpdateChangeCard(data.ObjectCode);
                _context.SaveChanges();
                msg.Title = String.Format(_sharedResources["COM_MSG_DELETE_SUCCESS"], _stringLocalizer[""]);// "Xóa thành công";
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = String.Format(_sharedResources["COM_MSG_DELETE_FAIL"], _stringLocalizer[""]);//"Có lỗi xảy ra khi xóa!";
                msg.Object = ex;
            }
            return Json(msg);
        }

        [HttpPost]
        public List<LstUserShare> GetListUserShare(string cardCode)
        {
            var data = from a in _context.Users.Select(x => new { Code = x.UserName, Name = x.GivenName, x.DepartmentId, UserId = x.Id })
                       join b in _context.AdDepartments.Where(x => !x.IsDeleted && x.IsEnabled) on a.DepartmentId equals b.DepartmentCode into b1
                       from b in b1.DefaultIfEmpty()
                       join c in _context.JobCardAssignees.Where(x => !x.IsDeleted && x.CardCode.Equals(cardCode)) on a.UserId equals c.UserId
                       select new LstUserShare
                       {
                           Code = a.Code,
                           Name = a.Name,
                           DepartmentName = b != null ? b.Title : "",
                           Permission = new PermissionFile()
                       };
            return data.ToList();
        }

        [HttpPost]
        public JsonResult InsertFileShareCard([FromBody] ShareFilePermission obj)
        {
            var msg = new JMessage { Title = "", Error = false };
            try
            {
                var data = (from a in _context.EDMSRepoCatFiles.Where(x => x.Id == obj.Id)
                            join b in _context.EDMSRepositorys on a.ReposCode equals b.ReposCode into b2
                            from b in b2.DefaultIfEmpty()
                            join c in _context.EDMSFiles on a.FileCode equals c.FileCode into c2
                            from c in c2.DefaultIfEmpty()
                            select new
                            {
                                a.Id,
                                Server = (b != null ? b.Server : null),
                                Type = (b != null ? b.Type : null),
                                Url = (c != null ? c.Url : null),
                                FileId = (c != null ? c.CloudFileId : null),
                                FileTypePhysic = c.FileTypePhysic,
                                c.FileName,
                                c.MimeType,
                                b.Account,
                                b.PassWord,
                                c.FileCode,
                                c.IsEdit,
                                c.IsFileMaster,
                                c.FileParentId,
                                a.ObjectCode
                            }).FirstOrDefault();

                if (data != null)
                {
                    var check = _context.FilesShareObjectUsers.FirstOrDefault(x => !x.IsDeleted && x.FileID.Equals(data.FileCode));

                    var share = new UserShare
                    {
                        Code = obj.Code,
                        Name = obj.Name,
                        DepartmentName = obj.DepartmentName,
                        Permission = obj.Permission
                    };
                    var lstUserShare = new List<UserShare>();
                    if (check == null)
                    {
                        lstUserShare.Add(share);
                        var rela = new
                        {
                            ObjectType = EnumHelper<CardEnum>.GetDisplayValue(CardEnum.CardJob),
                            ObjectInstance = data.Id
                        };
                        var files = new FilesShareObjectUser
                        {
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            FileID = data.FileCode,
                            FileCreated = User.Identity.Name,
                            FileUrl = data.Url,
                            FileName = data.FileName,
                            ObjectRelative = JsonConvert.SerializeObject(rela),
                            ListUserShare = JsonConvert.SerializeObject(lstUserShare)
                        };
                        _context.FilesShareObjectUsers.Add(files);
                        UpdateChangeCard(data.ObjectCode);
                        _context.SaveChanges();
                        msg.Title = "Chia sẻ thành công";
                    }
                    else
                    {
                        if (!string.IsNullOrEmpty(check.ListUserShare))
                        {
                            lstUserShare = JsonConvert.DeserializeObject<List<UserShare>>(check.ListUserShare);
                            var isAdded = false;
                            foreach (var item in lstUserShare)
                            {
                                if (item.Code == obj.Code)
                                {
                                    item.Permission = obj.Permission;
                                    isAdded = true;
                                    break;
                                }
                            }
                            if (isAdded)
                            {
                                check.ListUserShare = JsonConvert.SerializeObject(lstUserShare);
                                check.UpdatedBy = ESEIM.AppContext.UserName;
                                check.UpdatedTime = DateTime.Now;
                                _context.FilesShareObjectUsers.Update(check);
                                UpdateChangeCard(data.ObjectCode);
                                _context.SaveChanges();
                                msg.Title = "Cập nhật thành công";
                            }
                            else
                            {
                                lstUserShare.Add(share);
                                check.ListUserShare = JsonConvert.SerializeObject(lstUserShare);
                                check.UpdatedBy = ESEIM.AppContext.UserName;
                                check.UpdatedTime = DateTime.Now;
                                _context.FilesShareObjectUsers.Update(check);
                                UpdateChangeCard(data.ObjectCode);
                                _context.SaveChanges();
                                msg.Title = "Chia sẻ thành công";
                            }
                        }
                        else
                        {
                            lstUserShare.Add(share);
                            check.ListUserShare = JsonConvert.SerializeObject(lstUserShare);
                            check.UpdatedBy = ESEIM.AppContext.UserName;
                            check.UpdatedTime = DateTime.Now;
                            _context.FilesShareObjectUsers.Update(check);
                            UpdateChangeCard(data.ObjectCode);
                            _context.SaveChanges();
                            msg.Title = "Chia sẻ thành công";
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetUserShareFilePermission(int id)
        {
            try
            {
                var data = (from a in _context.EDMSRepoCatFiles.Where(x => x.Id == id)
                            join b in _context.EDMSRepositorys on a.ReposCode equals b.ReposCode into b2
                            from b in b2.DefaultIfEmpty()
                            join c in _context.EDMSFiles on a.FileCode equals c.FileCode into c2
                            from c in c2.DefaultIfEmpty()
                            select new
                            {
                                a.Id,
                                Server = (b != null ? b.Server : null),
                                Type = (b != null ? b.Type : null),
                                Url = (c != null ? c.Url : null),
                                FileId = (c != null ? c.CloudFileId : null),
                                FileTypePhysic = (c != null ? c.FileTypePhysic : null),
                                FileName = (c != null ? c.FileName : null),
                                MimeType = (c != null ? c.MimeType : null),
                                Account = (b != null ? b.Account : null),
                                PassWord = (b != null ? b.PassWord : null),
                                FileCode = (c != null ? c.FileCode : null),
                                IsEdit = (c != null ? c.IsEdit : null),
                                IsFileMaster = (c != null ? c.IsFileMaster : null),
                                FileParentId = (c != null ? c.FileParentId : null)
                            }).FirstOrDefault();
                var lstUserShare = new List<UserShare>();
                if (data != null)
                {
                    var check = _context.FilesShareObjectUsers.FirstOrDefault(x => !x.IsDeleted && x.FileID.Equals(data.FileCode));
                    if (check != null)
                    {
                        if (!string.IsNullOrEmpty(check.ListUserShare))
                        {
                            lstUserShare = JsonConvert.DeserializeObject<List<UserShare>>(check.ListUserShare);
                        }
                    }
                }
                return Json(lstUserShare);
            }
            catch (Exception ex)
            {
                var lstUserShare = new List<UserShare>();
                return Json(ex);
            }
        }

        [HttpPost]
        public JsonResult DeleteShareFile(int id, string userName)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var data = (from a in _context.EDMSRepoCatFiles.Where(x => x.Id == id)
                            join b in _context.EDMSRepositorys on a.ReposCode equals b.ReposCode into b2
                            from b in b2.DefaultIfEmpty()
                            join c in _context.EDMSFiles on a.FileCode equals c.FileCode into c2
                            from c in c2.DefaultIfEmpty()
                            select new
                            {
                                a.Id,
                                Server = (b != null ? b.Server : null),
                                Type = (b != null ? b.Type : null),
                                Url = (c != null ? c.Url : null),
                                FileId = (c != null ? c.CloudFileId : null),
                                FileTypePhysic = c.FileTypePhysic,
                                c.FileName,
                                c.MimeType,
                                b.Account,
                                b.PassWord,
                                c.FileCode,
                                c.IsEdit,
                                c.IsFileMaster,
                                c.FileParentId,
                                a.ObjectCode
                            }).FirstOrDefault();
                var lstUserShare = new List<UserShare>();
                if (data != null)
                {
                    var check = _context.FilesShareObjectUsers.FirstOrDefault(x => !x.IsDeleted && x.FileID.Equals(data.FileCode));
                    if (check != null)
                    {
                        if (!string.IsNullOrEmpty(check.ListUserShare))
                        {
                            lstUserShare = JsonConvert.DeserializeObject<List<UserShare>>(check.ListUserShare);
                            foreach (var item in lstUserShare)
                            {
                                if (item.Code.Equals(userName))
                                {
                                    lstUserShare.Remove(item);
                                    break;
                                }
                            }
                            check.ListUserShare = JsonConvert.SerializeObject(lstUserShare);
                            _context.FilesShareObjectUsers.Update(check);
                            UpdateChangeCard(data.ObjectCode);
                            _context.SaveChanges();
                            msg.Title = "Xóa thành công";
                        }
                        else
                        {
                            msg.Error = true;
                            msg.Title = "Không tìm thấy bản ghi";
                        }
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = "Không tìm thấy bản ghi";
                    }
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy bản ghi";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public void AutoShareFilePermission([FromBody] AutoShareFileModel obj)
        {
            var data = (from a in _context.EDMSRepoCatFiles.Where(x => x.Id == obj.Id)
                        join b in _context.EDMSRepositorys on a.ReposCode equals b.ReposCode into b2
                        from b in b2.DefaultIfEmpty()
                        join c in _context.EDMSFiles on a.FileCode equals c.FileCode into c2
                        from c in c2.DefaultIfEmpty()
                        select new
                        {
                            a.Id,
                            Server = (b != null ? b.Server : null),
                            Type = (b != null ? b.Type : null),
                            Url = (c != null ? c.Url : null),
                            FileId = (c != null ? c.CloudFileId : null),
                            FileTypePhysic = c.FileTypePhysic,
                            c.FileName,
                            c.MimeType,
                            b.Account,
                            b.PassWord,
                            c.FileCode,
                            c.IsEdit,
                            c.IsFileMaster,
                            c.FileParentId
                        }).FirstOrDefault();

            if (data != null)
            {
                var check = _context.FilesShareObjectUsers.FirstOrDefault(x => !x.IsDeleted && x.FileID.Equals(data.FileCode));
                if (check == null)
                {
                    var rela = new
                    {
                        ObjectType = EnumHelper<CardEnum>.GetDisplayValue(CardEnum.CardJob),
                        ObjectInstance = data.Id
                    };
                    var files = new FilesShareObjectUser
                    {
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now,
                        FileID = data.FileCode,
                        FileCreated = User.Identity.Name,
                        FileUrl = data.Url,
                        FileName = data.FileName,
                        ObjectRelative = JsonConvert.SerializeObject(rela),
                        ListUserShare = obj.LstShare
                    };
                    _context.FilesShareObjectUsers.Add(files);
                    _context.SaveChanges();
                }
            }
        }

        #region File Item Request
        [HttpPost]
        [RequestFormLimits(MultipartBodyLengthLimit = long.MaxValue)]
        [RequestSizeLimit(long.MaxValue)]
        public JsonResult InsertCardJobFileRequest(EDMSRepoCatFileModel obj, IFormFile fileUpload)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var mimeType = fileUpload.ContentType;
                string extension = Path.GetExtension(fileUpload.FileName);
                string urlFile = "";
                string fileId = "";
                if (Array.IndexOf(LuceneExtension.fileMimetypes, mimeType) >= 0 && (Array.IndexOf(LuceneExtension.fileExt, extension.ToUpper()) >= 0))
                {
                    string reposCode = "";
                    string catCode = "";
                    string path = "";
                    string folderId = "";
                    //Chọn file ngắn gọn
                    if (!obj.IsMore)
                    {
                        //var suggesstion = GetSuggestionsCardCodeFile(obj.CardCode);
                        //if (suggesstion != null)
                        //{
                        //    reposCode = suggesstion.ReposCode;
                        //    path = suggesstion.Path;
                        //    folderId = suggesstion.FolderId;
                        //    catCode = suggesstion.CatCode;
                        //}
                        //else
                        //{
                        //    msg.Error = true;
                        //    msg.Title = _stringLocalizer["Vui lòng nhập thuộc tính mở rộng"];
                        //    return Json(msg);
                        //}

                        var repoDefault = _context.EDMSRepoDefaultObjects.FirstOrDefault(x => !x.IsDeleted
                                && x.ObjectCode.Equals(obj.CardCode) && x.ObjectType.Equals(EnumHelper<CardEnum>.GetDisplayValue(CardEnum.ItemRequest)));
                        if (repoDefault != null)
                        {
                            reposCode = repoDefault.ReposCode;
                            path = repoDefault.Path;
                            folderId = repoDefault.FolderId;
                            catCode = repoDefault.CatCode;
                        }
                        else
                        {
                            var setting = (EDMSCatRepoSetting)_upload.GetPathByModule(module_name).Object;
                            reposCode = setting.ReposCode;
                            catCode = setting.CatCode;
                            if (setting.Path == "")
                            {
                                host_type = 1;
                                path_upload_file = setting.FolderId;
                            }
                            else
                            {
                                host_type = 0;
                                path_upload_file = setting.Path;
                            }
                            path = host_type == 0 ? path_upload_file : "";
                            folderId = host_type == 1 ? path_upload_file : "";
                            //msg.Error = true;
                            //msg.Title = _sharedResources["COM_MSG_PLS_SETUP_FOLDER_DEFAULT"];
                            //return Json(msg);
                        }
                    }
                    //Hiển file mở rộng
                    else
                    {
                        var setting = _context.EDMSCatRepoSettings.FirstOrDefault(x => x.Id == obj.CateRepoSettingId);
                        if (setting != null)
                        {
                            reposCode = setting.ReposCode;
                            path = setting.Path;
                            folderId = setting.FolderId;
                            catCode = setting.CatCode;
                        }
                        else
                        {
                            var defaultSetting = (EDMSCatRepoSetting)_upload.GetPathByModule(module_name).Object;
                            reposCode = defaultSetting.ReposCode;
                            catCode = defaultSetting.CatCode;
                            if (defaultSetting.Path == "")
                            {
                                host_type = 1;
                                path_upload_file = defaultSetting.FolderId;
                            }
                            else
                            {
                                host_type = 0;
                                path_upload_file = defaultSetting.Path;
                            }
                            path = host_type == 0 ? path_upload_file : "";
                            folderId = host_type == 1 ? path_upload_file : "";
                            //msg.Error = true;
                            //msg.Title = _stringLocalizer["CJ_MSG_PLS_SELECT_FOLDER"];
                            //return Json(msg);
                        }
                    }
                    var getRepository = _context.EDMSRepositorys.FirstOrDefault(x => x.ReposCode == reposCode);
                    if (getRepository.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.Server))
                    {
                        using (var ms = new MemoryStream())
                        {
                            fileUpload.CopyTo(ms);
                            var fileBytes = ms.ToArray();
                            urlFile = path + Path.Combine("/", fileUpload.FileName);
                            var urlFilePreventive = path + Path.Combine("/", Guid.NewGuid().ToString().Substring(0, 8) + fileUpload.FileName);
                            var urlEnd = System.Web.HttpUtility.UrlPathEncode("ftp://" + getRepository.Server + urlFile);
                            var urlEndPreventive = System.Web.HttpUtility.UrlPathEncode("ftp://" + getRepository.Server + urlFilePreventive);
                            var result = FileExtensions.UploadFileToFtpServer(urlEnd, urlEndPreventive, fileBytes, getRepository.Account, getRepository.PassWord);
                            if (result.Status == WebExceptionStatus.ConnectFailure || result.Status == WebExceptionStatus.ProtocolError)
                            {
                                msg.Error = true;
                                msg.Title = _sharedResources["COM_CONNECT_FAILURE"];
                                return Json(msg);
                            }
                            else if (result.Status == WebExceptionStatus.Success)
                            {
                                if (result.IsSaveUrlPreventive)
                                {
                                    urlFile = urlFilePreventive;
                                }
                            }
                            else
                            {
                                msg.Error = true;
                                msg.Title = _sharedResources["COM_MSG_ERR"];
                                return Json(msg);
                            }
                        }
                    }
                    else if (getRepository.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.GooglerDriver))
                    {
                        var apiTokenService = _context.TokenManagers.FirstOrDefault(x => x.AccountCode == getRepository.Token);
                        var json = apiTokenService.CredentialsJson;
                        var user = apiTokenService.Email;
                        var token = apiTokenService.RefreshToken;
                        fileId = FileExtensions.UploadFileToDrive(json, token, fileUpload.FileName, fileUpload.OpenReadStream(), fileUpload.ContentType, folderId, user);
                    }
                    var edmsReposCatFile = new EDMSRepoCatFile
                    {
                        FileCode = string.Concat("WORK_REQUEST_", Guid.NewGuid().ToString()),
                        ReposCode = reposCode,
                        CatCode = catCode,
                        ObjectCode = obj.CardCode,
                        ObjectType = EnumHelper<CardEnum>.GetDisplayValue(CardEnum.ItemRequest),
                        Path = path,
                        FolderId = folderId
                    };
                    _context.EDMSRepoCatFiles.Add(edmsReposCatFile);

                    /// created Index lucene
                    var moduleObj = (EDMSCatRepoSetting)_upload.GetPathByModule("DB_LUCENE_INDEX").Object;
                    var luceneCategory = _context.EDMSCategorys.FirstOrDefault(x => x.CatCode == moduleObj.CatCode);
                    LuceneExtension.IndexFile(edmsReposCatFile.FileCode, fileUpload, /*string.Concat(_hostingEnvironment.WebRootPath, "\\uploads\\luceneIndex")*/ luceneCategory.PathServerPhysic);

                    //add File
                    var file = new EDMSFile
                    {
                        FileCode = edmsReposCatFile.FileCode,
                        FileName = fileUpload.FileName,
                        Desc = obj.Desc,
                        ReposCode = reposCode,
                        Tags = obj.Tags,
                        FileSize = fileUpload.Length,
                        FileTypePhysic = Path.GetExtension(fileUpload.FileName),
                        NumberDocument = obj.NumberDocument,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now,
                        Url = urlFile,
                        MimeType = mimeType,
                        CloudFileId = fileId,
                    };
                    _context.EDMSFiles.Add(file);
                    UpdateChangeCard(obj.CardCode);

                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_ADD_SUCCESS"];
                    msg.Object = edmsReposCatFile.Id;
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _sharedResources["COM_MSG_INVALID_FORMAT"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpGet]
        public EDMSRepoCatFile GetSuggestionsCardCodeFileRequest(string cardCode)
        {
            var query = _context.EDMSRepoCatFiles.Where(x => x.ObjectCode == cardCode && x.ObjectType == EnumHelper<CardEnum>.GetDisplayValue(CardEnum.ItemRequest)).MaxBy(x => x.Id);
            return query;
        }

        [HttpPost]
        public JsonResult GetCardFileRequest(int id)
        {
            var msg = new JMessage { Error = false, Title = "" };
            var model = new EDMSRepoCatFileModel();
            try
            {
                var data = _context.EDMSRepoCatFiles.FirstOrDefault(m => m.Id == id);
                if (data != null)
                {
                    var file = _context.EDMSFiles.FirstOrDefault(x => x.FileCode == data.FileCode);
                    //header file
                    model.FileCode = file.FileCode;
                    model.NumberDocument = file.NumberDocument;
                    model.Tags = file.Tags;
                    model.Desc = file.Desc;
                    //category file
                    model.CateRepoSettingCode = data.CatCode;
                    model.CateRepoSettingId = data.Id;
                    model.Path = data.Path;
                    model.FolderId = data.FolderId;
                    msg.Object = model;
                }
                else
                {
                    msg.Error = true;
                    msg.Title = String.Format(_stringLocalizer["Tệp tin không tồn tại"]);//"Tệp tin không tồn tại!";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }
        #endregion

        #region File Item Result
        [HttpPost]
        [RequestFormLimits(MultipartBodyLengthLimit = long.MaxValue)]
        [RequestSizeLimit(long.MaxValue)]
        public JsonResult InsertCardJobFileResult(EDMSRepoCatFileModel obj, IFormFile fileUpload)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var mimeType = fileUpload.ContentType;
                string extension = Path.GetExtension(fileUpload.FileName);
                string urlFile = "";
                string fileId = "";
                if (Array.IndexOf(LuceneExtension.fileMimetypes, mimeType) >= 0 && (Array.IndexOf(LuceneExtension.fileExt, extension.ToUpper()) >= 0))
                {
                    string reposCode = "";
                    string catCode = "";
                    string path = "";
                    string folderId = "";
                    //Chọn file ngắn gọn
                    if (!obj.IsMore)
                    {
                        var repoDefault = _context.EDMSRepoDefaultObjects.FirstOrDefault(x => !x.IsDeleted
                                && x.ObjectCode.Equals(obj.CardCode) && x.ObjectType.Equals(EnumHelper<CardEnum>.GetDisplayValue(CardEnum.ItemResult)));
                        if (repoDefault != null)
                        {
                            reposCode = repoDefault.ReposCode;
                            path = repoDefault.Path;
                            folderId = repoDefault.FolderId;
                            catCode = repoDefault.CatCode;
                        }
                        else
                        {
                            var setting = (EDMSCatRepoSetting)_upload.GetPathByModule(module_name).Object;
                            reposCode = setting.ReposCode;
                            catCode = setting.CatCode;
                            if (setting.Path == "")
                            {
                                host_type = 1;
                                path_upload_file = setting.FolderId;
                            }
                            else
                            {
                                host_type = 0;
                                path_upload_file = setting.Path;
                            }
                            path = host_type == 0 ? path_upload_file : "";
                            folderId = host_type == 1 ? path_upload_file : "";
                            //msg.Error = true;
                            //msg.Title = _sharedResources["COM_MSG_PLS_SETUP_FOLDER_DEFAULT"];
                            //return Json(msg);
                        }
                    }
                    //Hiển file mở rộng
                    else
                    {
                        var setting = _context.EDMSCatRepoSettings.FirstOrDefault(x => x.Id == obj.CateRepoSettingId);
                        if (setting != null)
                        {
                            reposCode = setting.ReposCode;
                            path = setting.Path;
                            folderId = setting.FolderId;
                            catCode = setting.CatCode;
                        }
                        else
                        {
                            var defaultSetting = (EDMSCatRepoSetting)_upload.GetPathByModule(module_name).Object;
                            reposCode = defaultSetting.ReposCode;
                            catCode = defaultSetting.CatCode;
                            if (defaultSetting.Path == "")
                            {
                                host_type = 1;
                                path_upload_file = defaultSetting.FolderId;
                            }
                            else
                            {
                                host_type = 0;
                                path_upload_file = defaultSetting.Path;
                            }
                            path = host_type == 0 ? path_upload_file : "";
                            folderId = host_type == 1 ? path_upload_file : "";
                            //msg.Error = true;
                            //msg.Title = _stringLocalizer["CJ_MSG_PLS_SELECT_FOLDER"];
                            //return Json(msg);
                        }
                    }
                    var getRepository = _context.EDMSRepositorys.FirstOrDefault(x => x.ReposCode == reposCode);
                    if (getRepository.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.Server))
                    {
                        using (var ms = new MemoryStream())
                        {
                            fileUpload.CopyTo(ms);
                            var fileBytes = ms.ToArray();
                            urlFile = path + Path.Combine("/", fileUpload.FileName);
                            var urlFilePreventive = path + Path.Combine("/", Guid.NewGuid().ToString().Substring(0, 8) + fileUpload.FileName);
                            var urlEnd = System.Web.HttpUtility.UrlPathEncode("ftp://" + getRepository.Server + urlFile);
                            var urlEndPreventive = System.Web.HttpUtility.UrlPathEncode("ftp://" + getRepository.Server + urlFilePreventive);
                            var result = FileExtensions.UploadFileToFtpServer(urlEnd, urlEndPreventive, fileBytes, getRepository.Account, getRepository.PassWord);
                            if (result.Status == WebExceptionStatus.ConnectFailure || result.Status == WebExceptionStatus.ProtocolError)
                            {
                                msg.Error = true;
                                msg.Title = _sharedResources["COM_CONNECT_FAILURE"];
                                return Json(msg);
                            }
                            else if (result.Status == WebExceptionStatus.Success)
                            {
                                if (result.IsSaveUrlPreventive)
                                {
                                    urlFile = urlFilePreventive;
                                }
                            }
                            else
                            {
                                msg.Error = true;
                                msg.Title = _sharedResources["COM_MSG_ERR"];
                                return Json(msg);
                            }
                        }
                    }
                    else if (getRepository.Type == EnumHelper<TypeConnection>.GetDisplayValue(TypeConnection.GooglerDriver))
                    {
                        var apiTokenService = _context.TokenManagers.FirstOrDefault(x => x.AccountCode == getRepository.Token);
                        var json = apiTokenService.CredentialsJson;
                        var user = apiTokenService.Email;
                        var token = apiTokenService.RefreshToken;
                        fileId = FileExtensions.UploadFileToDrive(json, token, fileUpload.FileName, fileUpload.OpenReadStream(), fileUpload.ContentType, folderId, user);
                    }
                    var edmsReposCatFile = new EDMSRepoCatFile
                    {
                        FileCode = string.Concat("WORK_RESULT_", Guid.NewGuid().ToString()),
                        ReposCode = reposCode,
                        CatCode = catCode,
                        ObjectCode = obj.CardCode,
                        ObjectType = EnumHelper<CardEnum>.GetDisplayValue(CardEnum.ItemResult),
                        Path = path,
                        FolderId = folderId
                    };
                    _context.EDMSRepoCatFiles.Add(edmsReposCatFile);

                    /// created Index lucene
                    var moduleObj = (EDMSCatRepoSetting)_upload.GetPathByModule("DB_LUCENE_INDEX").Object;
                    var luceneCategory = _context.EDMSCategorys.FirstOrDefault(x => x.CatCode == moduleObj.CatCode);
                    LuceneExtension.IndexFile(edmsReposCatFile.FileCode, fileUpload, /*string.Concat(_hostingEnvironment.WebRootPath, "\\uploads\\luceneIndex")*/ luceneCategory.PathServerPhysic);

                    //add File
                    var file = new EDMSFile
                    {
                        FileCode = edmsReposCatFile.FileCode,
                        FileName = fileUpload.FileName,
                        Desc = obj.Desc,
                        ReposCode = reposCode,
                        Tags = obj.Tags,
                        FileSize = fileUpload.Length,
                        FileTypePhysic = Path.GetExtension(fileUpload.FileName),
                        NumberDocument = obj.NumberDocument,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now,
                        Url = urlFile,
                        MimeType = mimeType,
                        CloudFileId = fileId,
                    };
                    _context.EDMSFiles.Add(file);
                    UpdateChangeCard(obj.CardCode);

                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_ADD_SUCCESS"];
                    msg.Object = edmsReposCatFile.Id;
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _sharedResources["COM_MSG_INVALID_FORMAT"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpGet]
        public EDMSRepoCatFile GetSuggestionsCardCodeFileResult(string cardCode)
        {
            var query = _context.EDMSRepoCatFiles.Where(x => x.ObjectCode == cardCode && x.ObjectType == EnumHelper<CardEnum>.GetDisplayValue(CardEnum.ItemResult)).MaxBy(x => x.Id);
            return query;
        }

        [HttpPost]
        public JsonResult GetCardFileResult(int id)
        {
            var msg = new JMessage { Error = false, Title = "" };
            var model = new EDMSRepoCatFileModel();
            try
            {
                var data = _context.EDMSRepoCatFiles.FirstOrDefault(m => m.Id == id);
                if (data != null)
                {
                    var file = _context.EDMSFiles.FirstOrDefault(x => x.FileCode == data.FileCode);
                    //header file
                    model.FileCode = file.FileCode;
                    model.NumberDocument = file.NumberDocument;
                    model.Tags = file.Tags;
                    model.Desc = file.Desc;
                    //category file
                    model.CateRepoSettingCode = data.CatCode;
                    model.CateRepoSettingId = data.Id;
                    model.Path = data.Path;
                    model.FolderId = data.FolderId;
                    msg.Object = model;
                }
                else
                {
                    msg.Error = true;
                    msg.Title = String.Format(_stringLocalizer["Tệp tin không tồn tại"]);//"Tệp tin không tồn tại!";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Object = ex.Message;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }
        #endregion

        public class AutoShareFileModel
        {
            public int Id { get; set; }
            public string LstShare { get; set; }
        }

        public class JTableModelFile : JTableModel
        {
            public string ItemCode { get; set; }
            public string CardCode { get; set; }
            public string FromDate { get; set; }
            public string ToDate { get; set; }
            public string CatCode { get; set; }
        }
        public class CardFileShareModel
        {
            public int? Id { get; set; }
            public string ListUserShare { get; set; }
        }
        public class ShareFilePermission
        {
            public string Code { get; set; }
            public string Name { get; set; }
            public string DepartmentName { get; set; }
            public PermissionFile Permission { get; set; }
            public int Id { get; set; }
        }
        public class UserShare
        {
            public string Code { get; set; }
            public string Name { get; set; }
            public string DepartmentName { get; set; }
            public PermissionFile Permission { get; set; }
        }

        #endregion

        #region Lock Update Card

        [HttpPost]
        public JsonResult GetInfoLockShare(string cardCode)
        {
            var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
            var infoLockShare = new InfoLockShare();
            var session = HttpContext.GetSessionUser();
            if (card != null)
            {
                if (!string.IsNullOrEmpty(card.LockShare))
                {
                    var lockShare = JsonConvert.DeserializeObject<LockShare>(card.LockShare);
                    if (lockShare.StartTime.AddMinutes(5) > DateTime.Now)
                    {
                        infoLockShare.Name = _context.Users.FirstOrDefault(x => x.UserName.Equals(lockShare.User)).GivenName ?? "";
                        infoLockShare.Time = lockShare.StartTime.ToString("HH:mm");
                        infoLockShare.UserName = lockShare.User;
                        infoLockShare.TimeStamp = session.TimeStamp;
                    }
                    else
                    {
                        return Json(infoLockShare);
                    }
                }
            }
            return Json(infoLockShare);
        }

        [HttpPost]
        public void RemoveLockShare(string cardCode)
        {
            var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
            if (card != null)
            {
                card.LockShare = "";
                _context.SaveChanges();
            }
        }

        [HttpPost]
        public void UpdateLockShareCard(string cardCode)
        {
            var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
            var session = HttpContext.GetSessionUser();
            if (card != null)
            {
                if (!string.IsNullOrEmpty(card.LockShare))
                {
                    var lockShare = JsonConvert.DeserializeObject<LockShare>(card.LockShare);
                    if (lockShare.StartTime.AddMinutes(5) < DateTime.Now)
                    {
                        var share = new LockShare
                        {
                            User = ESEIM.AppContext.UserName,
                            StartTime = DateTime.Now,
                            TimeStamp = session.TimeStamp
                        };
                        card.LockShare = JsonConvert.SerializeObject(share);
                        _context.SaveChanges();
                    }
                }
                else
                {
                    var lockShare = new LockShare
                    {
                        User = ESEIM.AppContext.UserName,
                        StartTime = DateTime.Now,
                        TimeStamp = session.TimeStamp
                    };
                    card.LockShare = JsonConvert.SerializeObject(lockShare);
                    _context.SaveChanges();
                }
            }
        }

        [HttpPost]
        public bool CheckSessionCard(string cardCode)
        {
            bool multiSession = false;

            var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
            if (card != null)
            {
                if (!string.IsNullOrEmpty(card.LockShare))
                {
                    var lockShare = JsonConvert.DeserializeObject<LockShare>(card.LockShare);
                    if (lockShare != null)
                    {
                        if (lockShare.User.Equals(ESEIM.AppContext.UserName))
                        {
                            var user = _context.Users.FirstOrDefault(x => x.UserName.Equals(ESEIM.AppContext.UserName));
                            var lstSessionLogin = new List<JsonSessionLogin>();
                            if (user != null)
                            {
                                if (!string.IsNullOrEmpty(user.SessionLogin))
                                {
                                    lstSessionLogin = JsonConvert.DeserializeObject<List<JsonSessionLogin>>(user.SessionLogin);
                                    if (lstSessionLogin.Count > 1)
                                    {
                                        multiSession = true;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            return multiSession;
        }

        public class LockShare
        {
            public string User { get; set; }
            public DateTime StartTime { get; set; }
            public DateTime TimeStamp { get; set; }
        }

        public class InfoLockShare
        {
            public string Name { get; set; }
            public string Time { get; set; }
            public string UserName { get; set; }
            public DateTime? TimeStamp { get; set; }
            public int CountUpdate { get; set; }
        }
        #endregion

        #region Card new
        [HttpPost]
        public JsonResult InsertCardNew([FromBody] ModelCard obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var sumWeightList = _context.WORKOSCards.Where(x => !x.IsDeleted && x.ListCode.Equals(obj.ListCode)).Sum(x => x.WeightNum);
                if ((100 - sumWeightList) < decimal.Parse(obj.WeightNum))
                {
                    msg.Error = true;
                    msg.Title = "Vui lòng nhập trọng số nhỏ hơn " + (100 - sumWeightList);
                    return Json(msg);
                }

                var beginTime = !string.IsNullOrEmpty(obj.BeginTime) ? DateTime.ParseExact(obj.BeginTime, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
                var deadLine = !string.IsNullOrEmpty(obj.Deadline) ? DateTime.ParseExact(obj.Deadline, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
                var endTime = !string.IsNullOrEmpty(obj.EndTime) ? DateTime.ParseExact(obj.EndTime, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
                var lstJsonStatus = new List<JsonStatusCard>();
                var jsonStatus = new JsonStatusCard
                {
                    Status = "CREATED",
                    CreatedBy = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now,
                    Lock = false
                };
                lstJsonStatus.Add(jsonStatus);
                var cardSession = new CardSessionUser
                {
                    User = ESEIM.AppContext.UserName,
                    TimeStamp = DateTime.Now,
                    NewDataUpdate = false
                };
                var lstShare = new List<CardSessionUser>();
                lstShare.Add(cardSession);
                var card = new WORKOSCard
                {
                    ListCode = obj.ListCode,
                    CardCode = "" + (_context.WORKOSCards.Count() > 0 ? _context.WORKOSCards.Max(x => x.CardID) + 1 : 1),
                    CardName = obj.CardName,
                    AttachmentList = "",
                    BeginTime = beginTime.Value,
                    Deadline = deadLine.Value,
                    EndTime = endTime,
                    CardLevel = obj.CardLevel,
                    Completed = 0,
                    Cost = decimal.Parse(obj.Cost),
                    Currency = obj.Currency,
                    WorkType = obj.WorkType,
                    WeightNum = decimal.Parse(obj.WeightNum),
                    Status = obj.Status,
                    CreatedBy = ESEIM.AppContext.UserName,
                    CreatedDate = DateTime.Now,
                    Description = obj.Description,
                    IsLock = false,
                    ListUserView = ";" + ESEIM.AppContext.UserId,
                    //IsRecurrent = obj.IsRecurrent,
                    Cycle = obj.Cycle,
                    JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus),
                    LockShare = JsonConvert.SerializeObject(lstShare)
                };
                _context.WORKOSCards.Add(card);

                var comment = new CardCommentList()
                {
                    CardCode = card.CardCode,
                    CmtId = "Comment" + Guid.NewGuid().ToString(),
                    CmtContent = "Đã tạo công việc",
                    MemberId = ESEIM.AppContext.UserName,
                    CreatedTime = DateTime.Now
                };
                _context.CardCommentLists.Add(comment);

                _context.SaveChanges();
                msg.Title = _sharedResources["COM_ADD_SUCCESS"];
                msg.Object = card.CardCode;
                _cardService.UpdatePercentParentCard(card.CardCode);
                _context.SaveChanges();
            }
            catch (Exception ex)
            {
                msg.Title = _sharedResources["COM_MSG_ERR"];
                msg.Error = true;
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateCardNew([FromBody] ModelCard obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(obj.CardCode));
                if (card != null)
                {
                    if (obj.IsApprove)
                    {
                        decimal sumWeightList = 0;
                        if (card.ListCode != obj.ListCode)
                        {
                            sumWeightList = _context.WORKOSCards.Where(x => !x.IsDeleted && x.ListCode.Equals(obj.ListCode)).Sum(x => x.WeightNum);
                        }
                        else
                        {
                            sumWeightList = _context.WORKOSCards.Where(x => !x.IsDeleted && x.ListCode.Equals(obj.ListCode) && x.CardCode != card.CardCode).Sum(x => x.WeightNum);
                        }
                        if ((100 - sumWeightList) < decimal.Parse(obj.WeightNum))
                        {
                            msg.Error = true;
                            msg.Title = "Vui lòng nhập trọng số nhỏ hơn " + (100 - sumWeightList);
                            return Json(msg);
                        }

                        var beginTime = !string.IsNullOrEmpty(obj.BeginTime) ? DateTime.ParseExact(obj.BeginTime, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
                        var deadLine = !string.IsNullOrEmpty(obj.Deadline) ? DateTime.ParseExact(obj.Deadline, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
                        var endTime = !string.IsNullOrEmpty(obj.EndTime) ? DateTime.ParseExact(obj.EndTime, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
                        var lstJsonStatus = new List<JsonStatusCard>();
                        if (!string.IsNullOrEmpty(card.JsonStatusLog))
                        {
                            lstJsonStatus = JsonConvert.DeserializeObject<List<JsonStatusCard>>(card.JsonStatusLog);
                        }
                        var jsonStatus = new JsonStatusCard
                        {
                            Status = obj.Status,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            Lock = false
                        };
                        lstJsonStatus.Add(jsonStatus);

                        if (card.BeginTime != beginTime)
                        {
                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                Action = "UPDATE",
                                IdObject = "ITEMWORK",
                                IsCheck = true,
                                CardCode = card.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = "Ngày bắt đầu từ " + card.BeginTime != null ? card.BeginTime.ToString("dd/MM/yyyy") : "trống" + " sang " + beginTime != null ? beginTime.Value.ToString("dd/MM/yyyy") : "trống"
                            };
                            _context.CardUserActivities.Add(activity);
                        }
                        if (card.CardName != obj.CardName)
                        {
                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                Action = "UPDATE",
                                IdObject = "ITEMWORK",
                                IsCheck = true,
                                CardCode = card.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = "Tên thẻ việc từ [" + card.CardName + "] sang [" + obj.CardName + "]"
                            };
                            _context.CardUserActivities.Add(activity);
                        }
                        if (card.Deadline != deadLine)
                        {
                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                Action = "UPDATE",
                                IdObject = "ITEMWORK",
                                IsCheck = true,
                                CardCode = card.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = "Ngày hết hạn từ " + card.Deadline != null ? card.Deadline.ToString("dd/MM/yyyy") : "trống" + " sang " + deadLine != null ? deadLine.Value.ToString("dd/MM/yyyy") : "trống"
                            };
                            _context.CardUserActivities.Add(activity);
                        }
                        if (card.EndTime != endTime)
                        {
                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                Action = "UPDATE",
                                IdObject = "ITEMWORK",
                                IsCheck = true,
                                CardCode = card.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = card.EndTime.HasValue ? "Ngày kết thúc từ " + card.EndTime.Value.ToString("dd/MM/yyyy") + " sang " + (endTime.HasValue ? endTime.Value.ToString("dd/MM/yyyy") : "trống") : "Ngày kết thúc " + (endTime.HasValue ? endTime.Value.ToString("dd/MM/yyyy") : "trống")
                            };
                            _context.CardUserActivities.Add(activity);
                        }
                        if (card.Description != obj.Description)
                        {
                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                Action = "UPDATE",
                                IdObject = "DESCRIPTION",
                                IsCheck = true,
                                CardCode = card.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = !string.IsNullOrEmpty(card.Description) ? "Mô tả từ " + string.Concat(card.Description?.Take(20) ?? "") + "... sang " + string.Concat(obj.Description?.Take(20) ?? "") : "Thêm mới mô tả " + string.Concat(obj.Description?.Take(20) ?? "") + "..."
                            };
                            _context.CardUserActivities.Add(activity);
                        }
                        if (card.WorkType != obj.WorkType)
                        {
                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                Action = "UPDATE",
                                IdObject = "ITEMWORK",
                                IsCheck = true,
                                CardCode = card.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = !string.IsNullOrEmpty(card.WorkType) ? "Kiểu công việc từ " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == card.WorkType && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == card.WorkType && !x.IsDeleted).ValueSet : "")
                        + " sang " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == obj.WorkType && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == obj.WorkType && !x.IsDeleted).ValueSet : "") : "Thêm mới kiểu công việc " + _context.CommonSettings.FirstOrDefault(x => x.CodeSet == obj.WorkType && !x.IsDeleted).ValueSet
                            };
                            _context.CardUserActivities.Add(activity);
                        }
                        if (card.CardLevel != obj.CardLevel)
                        {
                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                Action = "UPDATE",
                                IdObject = "ITEMWORK",
                                IsCheck = true,
                                CardCode = card.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = !(string.IsNullOrEmpty(card.CardLevel)) ? "Độ ưu tiên từ " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == card.CardLevel && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == card.CardLevel && !x.IsDeleted).ValueSet : "")
                        + " sang " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == obj.CardLevel && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == obj.CardLevel && !x.IsDeleted).ValueSet : "") : "Thêm mới độ ưu tiên " + _context.CommonSettings.FirstOrDefault(x => x.CodeSet == obj.CardLevel && !x.IsDeleted).ValueSet
                            };
                            _context.CardUserActivities.Add(activity);
                        }
                        if (card.WeightNum != Decimal.Parse(obj.WeightNum))
                        {
                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                Action = "UPDATE",
                                IdObject = "ITEMWORK",
                                IsCheck = true,
                                CardCode = card.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = "Trọng số từ " + card.WeightNum + " sang " + Convert.ToDecimal(obj.WeightNum)
                            };
                            _context.CardUserActivities.Add(activity);
                        }
                        if (card.Status != obj.Status)
                        {
                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                Action = "UPDATE",
                                IdObject = "ITEMWORK",
                                IsCheck = true,
                                CardCode = card.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = "Trạng thái từ " + (_context.CommonSettings.FirstOrDefault(x => x.CodeSet == card.Status && !x.IsDeleted) != null ? _context.CommonSettings.FirstOrDefault(x => x.CodeSet == card.Status && !x.IsDeleted).ValueSet : "")
                                + " sang " + _context.CommonSettings.FirstOrDefault(x => x.CodeSet == obj.Status && !x.IsDeleted).ValueSet
                            };
                            _context.CardUserActivities.Add(activity);
                        }

                        card.JsonStatusLog = JsonConvert.SerializeObject(lstJsonStatus);
                        card.CardName = obj.CardName;
                        card.BeginTime = beginTime.Value;
                        card.Deadline = deadLine.Value;
                        card.EndTime = endTime;
                        card.Status = obj.Status;
                        card.CardLevel = obj.CardLevel;
                        card.WorkType = obj.WorkType;
                        card.WeightNum = decimal.Parse(obj.WeightNum);
                        card.Completed = obj.Completed;
                        card.ListCode = obj.ListCode;
                        card.Description = obj.Description;
                        card.LockShare = "";
                        card.Inherit = obj.Inherit;
                        card.UpdatedBy = ESEIM.AppContext.UserName;
                        card.UpdatedTime = DateTime.Now;
                        _cardService.UpdatePercentParentCard(card.CardCode);
                        _context.SaveChanges();
                        msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                    }
                    else
                    {
                        if (card.Description != obj.Description)
                        {
                            var activity = new CardUserActivity
                            {
                                UserId = ESEIM.AppContext.UserId,
                                Action = "UPDATE",
                                IdObject = "DESCRIPTION",
                                IsCheck = true,
                                CardCode = card.CardCode,
                                CreatedTime = DateTime.Now,
                                FromDevice = "Laptop/Desktop",
                                ChangeDetails = !string.IsNullOrEmpty(card.Description) ? "Mô tả từ " + string.Concat(card.Description?.Take(20) ?? "") + "... sang " + string.Concat(obj.Description?.Take(20) ?? "") : "Thêm mới mô tả " + string.Concat(obj.Description?.Take(20) ?? "") + "..."
                            };
                            _context.CardUserActivities.Add(activity);
                        }
                        card.LockShare = "";
                        card.Description = obj.Description;
                        _context.SaveChanges();
                        msg.Title = _sharedResources["COM_UPDATE_SUCCESS"];
                    }
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy thẻ việc";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public object GetListDefault(string boardCode)
        {
            var listCode = "";
            var boardSelect = "";
            var noInfo = false;

            if (!string.IsNullOrEmpty(boardCode))
            {
                var list = _context.WORKOSLists.Where(x => !x.IsDeleted && x.BoardCode.Equals(boardCode));
                if (list.Any())
                {
                    var card = _context.WORKOSCards.Where(x => !x.IsDeleted && x.Status != "TRASH"
                                && list.Any(k => k.ListCode.Equals(x.ListCode))).MaxBy(x => x.CardID);
                    if (card != null)
                    {
                        listCode = card.ListCode;
                        boardSelect = boardCode;
                    }
                    else
                    {
                        listCode = list.FirstOrDefault().ListCode;
                        boardSelect = boardCode;
                    }
                }
                else
                {
                    noInfo = true;
                }
            }
            else
            {
                var card = _context.WORKOSCards.Where(x => !x.IsDeleted && x.Status != "TRASH").MaxBy(x => x.CardID);
                if (card != null)
                {
                    var list = _context.WORKOSLists.FirstOrDefault(x => !x.IsDeleted && x.ListCode.Equals(card.ListCode));
                    if (list != null)
                    {
                        var board = _context.WORKOSBoards.FirstOrDefault(x => !x.IsDeleted && x.BoardCode.Equals(list.BoardCode));
                        if (board != null)
                        {
                            listCode = card.ListCode;
                            boardSelect = board.BoardCode;
                        }
                    }
                }
                else
                {
                    noInfo = true;
                }
            }

            if (noInfo)
            {
                var info = (from a in _context.WORKOSLists.Where(x => !x.IsDeleted)
                            join b in _context.WORKOSBoards.Where(x => !x.IsDeleted) on a.BoardCode equals b.BoardCode
                            select new
                            {
                                a.BoardCode,
                                a.ListCode
                            }).FirstOrDefault();
                if (info != null)
                {
                    boardSelect = info.BoardCode;
                    listCode = info.ListCode;
                }
            }
            return new
            {
                BoardCode = boardSelect,
                ListCode = listCode
            };
        }

        [HttpPost]
        public void InsertJcRela([FromBody] ModelRela listRela)
        {
            var jcRela = _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.CardCode.Equals(listRela.CardCode));
            foreach (var item in jcRela)
            {
                item.IsDeleted = true;
                item.DeletedBy = ESEIM.AppContext.UserName;
                item.DeletedTime = DateTime.Now;
                _context.JcObjectIdRelatives.Update(item);
            }

            if (listRela.ListRela.Count > 0)
            {
                foreach (var item in listRela.ListRela)
                {
                    var check = _context.JcObjectIdRelatives.FirstOrDefault(x => !x.IsDeleted
                        && x.ObjTypeCode.Equals(item.ObjTypeCode) && x.ObjID.Equals(item.ObjID) && x.CardCode.Equals(listRela.CardCode));
                    if (check != null)
                    {
                        check.Weight = item.Weight;
                        _context.JcObjectIdRelatives.Update(check);
                    }
                    else
                    {
                        var jc = new JcObjectIdRelative
                        {
                            CardCode = listRela.CardCode,
                            ObjID = item.ObjID,
                            ObjTypeCode = item.ObjTypeCode,
                            Weight = item.Weight,
                            Relative = item.RelativeCode,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                        };
                        _context.JcObjectIdRelatives.Add(jc);
                    }
                }
            }
            _context.SaveChanges();
        }

        [HttpPost]
        public void InsertCardSuggestion(string cardCode)
        {
            var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.Status != "TRASH" && x.CardCode.Equals(cardCode));
            if (card != null)
            {
                var user = _context.Users.FirstOrDefault(x => x.Active && x.UserName.Equals(ESEIM.AppContext.UserName));
                var cards = _context.WORKOSCards.Where(x => !x.IsDeleted && x.ListCode.Equals(card.ListCode)
                                && x.CreatedBy.Equals(ESEIM.AppContext.UserName) && x.Status != "TRASH" && x.CardID != card.CardID)
                                ;
                var cardSuggest = cards.MaxBy(x => x.CardID);
                if (cardSuggest != null)
                {
                    var json = new List<JobCardAssignee>();
                    var addLeader = new JobCardAssignee
                    {
                        CardCode = card.CardCode,
                        UserId = ESEIM.AppContext.UserId,
                        CreatedBy = ESEIM.AppContext.UserName,
                        CreatedTime = DateTime.Now,
                        Role = "ROLE_LEADER",
                        DepartmentCode = user != null ? !string.IsNullOrEmpty(user.DepartmentId) ? user.DepartmentId : "" : "",
                        GroupCode = "",
                        Item = "",
                        Approve = true,
                        ApproveTime = DateTime.Now,
                        Status = "ASSIGN_STATUS_WORK",
                        Branch = !string.IsNullOrEmpty(user.BranchId) ? user.BranchId : ""
                    };
                    _context.JobCardAssignees.Add(addLeader);
                    json.Add(addLeader);

                    var suggestAssign = _context.JobCardAssignees.Where(x => !x.IsDeleted && x.CardCode.Equals(cardSuggest.CardCode));
                    var listUserNotify = new List<UserNotify>();
                    foreach (var item in suggestAssign)
                    {
                        if (item.UserId != ESEIM.AppContext.UserId)
                        {
                            card.LstUser += item.UserId + ",";
                            var assignee = new JobCardAssignee
                            {
                                CardCode = card.CardCode,
                                UserId = item.UserId,
                                DepartmentCode = item.DepartmentCode,
                                GroupCode = item.GroupCode,
                                Role = item.Role,
                                CreatedBy = ESEIM.AppContext.UserName,
                                CreatedTime = DateTime.Now,
                                Item = item.Item,
                                Approve = true,
                                ApproveTime = DateTime.Now,
                                Status = item.Status,
                                Branch = item.Branch
                            };
                            _context.JobCardAssignees.Add(assignee);
                            json.Add(assignee);

                            //Add user to Notification
                            var userNotify = new UserNotify
                            {
                                UserId = item.UserId
                            };

                            if (!listUserNotify.Any(p => p.UserId.Equals(userNotify.UserId)) && !userNotify.UserId.Equals(ESEIM.AppContext.UserId))
                                listUserNotify.Add(userNotify);
                        }
                    }

                    if (listUserNotify.Count > 0)
                    {
                        var notification = new NotificationManager
                        {
                            ListUser = listUserNotify,
                            Title = string.Format("{0} đã tạo 1 thẻ việc mới: #{1} {2}", user.GivenName, card.CardCode, card.CardName),
                            ObjCode = card.CardCode,
                            ObjType = EnumHelper<NotificationType>.GetDisplayValue(NotificationType.CardJob),
                        };

                        InsertNotification(notification);
                    }

                    card.LstUser += ESEIM.AppContext.UserId + ",";
                    card.JsonAssign = JsonConvert.SerializeObject(json);

                    var jcSuggest = _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.CardCode.Equals(cardSuggest.CardCode));
                    foreach (var item in jcSuggest)
                    {
                        var rela = new JcObjectIdRelative
                        {
                            CardCode = card.CardCode,
                            ObjTypeCode = item.ObjTypeCode,
                            ObjID = item.ObjID,
                            Relative = item.Relative,
                            CreatedBy = ESEIM.AppContext.UserName
,
                            CreatedTime = DateTime.Now,
                            Weight = 0
                        };
                        _context.JcObjectIdRelatives.Add(rela);
                    }
                    _context.SaveChanges();
                }
            }
        }

        public class ModelCard
        {
            public string CardCode { get; set; }
            public string CardName { get; set; }
            public string BeginTime { get; set; }
            public string Deadline { get; set; }
            public string EndTime { get; set; }
            public string Status { get; set; }
            public string CardLevel { get; set; }
            public string WorkType { get; set; }
            public string WeightNum { get; set; }
            public decimal Completed { get; set; }
            public string Cost { get; set; }
            public string Currency { get; set; }
            public string ListCode { get; set; }
            public string Description { get; set; }
            public string CreatedBy { get; set; }
            public string ListUserView { get; set; }
            public string Inherit { get; set; }
            public bool IsApprove { get; set; }
            public bool? IsRecurrent { get; set; }
            public string Cycle { get; set; }
        }
        public class ModelRela
        {
            public ModelRela()
            {
                ListRela = new List<JcObjectRela>();
            }
            public string CardCode { get; set; }
            public List<JcObjectRela> ListRela { get; set; }
        }
        public class JcObjectRela
        {
            public int ID { get; set; }
            public string ObjID { get; set; }
            public string ObjName { get; set; }
            public string ObjTypeCode { get; set; }
            public string ObjTypeName { get; set; }
            public string RelativeCode { get; set; }
            public string RelativeName { get; set; }
            public decimal? Weight { get; set; }
        }
        #endregion

        #region Reason reject in card
        [HttpPost]
        public JsonResult RejectCard([FromBody] RejectCardModel obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var actionText = EnumHelper<CardAction>.GetDisplayValue(CardAction.Reject);
                var activity = new CardUserActivity
                {
                    UserId = ESEIM.AppContext.UserId,
                    CardCode = obj.CardCode,
                    Action = actionText,
                    IsCheck = true,
                    FromDevice = "Laptop/Desktop",
                    CreatedTime = DateTime.Now,
                    ChangeDetails = obj.ChangeDetails
                };
                _context.CardUserActivities.Add(activity);
                _context.SaveChanges();
                msg.Title = "Thêm lý do thành công";
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetReasonRejectUser(string cardCode)
        {
            var reason = "";
            var check = _context.CardUserActivities.Where(x => x.Action.Equals("REJECT")
                    && x.UserId.Equals(ESEIM.AppContext.UserId)).MaxBy(x => x.Id);
            if (check != null)
            {
                reason = !string.IsNullOrEmpty(check.ChangeDetails) ? check.ChangeDetails : "";
            }
            return Json(reason);
        }

        public class RejectCardModel
        {
            public string CardCode { get; set; }
            public string Value { get; set; }
            public string ChangeDetails { get; set; }
        }
        #endregion

        #region Update card realtime
        [HttpPost]
        public JsonResult UpdateCardNameReal(string cardCode, string cardName)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
                if (card != null)
                {
                    var lstSession = new List<CardSessionUser>();
                    if (!string.IsNullOrEmpty(card.LockShare))
                    {
                        lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                        var isExist = false;
                        foreach (var item in lstSession)
                        {
                            if (item.User == ESEIM.AppContext.UserName)
                            {
                                item.NewDataUpdate = false;
                                isExist = true;
                            }
                            else
                            {
                                item.NewDataUpdate = true;
                            }

                            item.TimeStamp = DateTime.Now;
                        }
                        if (!isExist)
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                    }
                    else
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = card.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Tên thẻ việc từ [" + card.CardName + "] sang [" + cardName + "]"
                    };
                    _context.CardUserActivities.Add(activity);

                    card.CardName = cardName;
                    card.LockShare = JsonConvert.SerializeObject(lstSession);

                    _context.SaveChanges();
                    msg.Title = "Cập nhật tên thẻ việc thành công";
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy bản ghi";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateCardBegintimeReal(string cardCode, string beginTime)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                if (string.IsNullOrEmpty(beginTime))
                {
                    msg.Error = true;
                    msg.Title = "Vui lòng chọn ngày bắt đầu";
                    return Json(msg);
                }
                var time = DateTime.ParseExact(beginTime, "dd/MM/yyyy", CultureInfo.InvariantCulture);
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
                if (card != null)
                {
                    var lstSession = new List<CardSessionUser>();
                    if (!string.IsNullOrEmpty(card.LockShare))
                    {
                        lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                        var isExist = false;
                        foreach (var item in lstSession)
                        {
                            if (item.User == ESEIM.AppContext.UserName)
                            {
                                item.NewDataUpdate = false;
                                isExist = true;
                            }
                            else
                            {
                                item.NewDataUpdate = true;
                            }

                            item.TimeStamp = DateTime.Now;
                        }
                        if (!isExist)
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                    }
                    else
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }
                    card.LockShare = JsonConvert.SerializeObject(lstSession);
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = card.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Ngày bắt đầu từ [" + card.BeginTime.ToString("dd/MM/yyyy") + "] sang [" + beginTime + "]"
                    };
                    _context.CardUserActivities.Add(activity);

                    card.BeginTime = time;
                    _context.SaveChanges();
                    msg.Title = "Cập nhật ngày bắt đầu thành công";
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy bản ghi";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = "Vui lòng nhập đúng định dạng dd/MM/yyyy";
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateCardDeadlineReal(string cardCode, string deadline)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                if (string.IsNullOrEmpty(deadline))
                {
                    msg.Error = true;
                    msg.Title = "Vui lòng chọn ngày bắt đầu";
                    return Json(msg);
                }
                var time = DateTime.ParseExact(deadline, "dd/MM/yyyy", CultureInfo.InvariantCulture);
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
                if (card != null)
                {
                    var lstSession = new List<CardSessionUser>();
                    if (!string.IsNullOrEmpty(card.LockShare))
                    {
                        lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                        var isExist = false;
                        foreach (var item in lstSession)
                        {
                            if (item.User == ESEIM.AppContext.UserName)
                            {
                                item.NewDataUpdate = false;
                                isExist = true;
                            }
                            else
                            {
                                item.NewDataUpdate = true;
                            }

                            item.TimeStamp = DateTime.Now;
                        }
                        if (!isExist)
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                    }
                    else
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = card.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Ngày kế hoạch kết thúc từ [" + card.Deadline.ToString("dd/MM/yyyy") + "] sang [" + deadline + "]"
                    };
                    _context.CardUserActivities.Add(activity);
                    card.Deadline = time;
                    card.LockShare = JsonConvert.SerializeObject(lstSession);
                    _context.SaveChanges();
                    msg.Title = "Cập nhật ngày kế hoạch kết thúc thành công";
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy bản ghi";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = "Vui lòng nhập đúng định dạng dd/MM/yyyy";
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateCardEndtimeReal(string cardCode, string endtime)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var time = !string.IsNullOrEmpty(endtime) ? DateTime.ParseExact(endtime, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
                if (card != null)
                {
                    var lstSession = new List<CardSessionUser>();
                    if (!string.IsNullOrEmpty(card.LockShare))
                    {
                        lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                        var isExist = false;
                        foreach (var item in lstSession)
                        {
                            if (item.User == ESEIM.AppContext.UserName)
                            {
                                item.NewDataUpdate = false;
                                isExist = true;
                            }
                            else
                            {
                                item.NewDataUpdate = true;
                            }

                            item.TimeStamp = DateTime.Now;
                        }
                        if (!isExist)
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                    }
                    else
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = card.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Ngày hoàn thành từ [" + (card.EndTime.HasValue ? card.EndTime.Value.ToString("dd/MM/yyyy") : "Trống") + "] sang [" + endtime + "]"
                    };
                    _context.CardUserActivities.Add(activity);

                    card.EndTime = time;
                    card.LockShare = JsonConvert.SerializeObject(lstSession);
                    _context.SaveChanges();
                    msg.Title = "Cập nhật ngày hoàn thành thành công";
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy bản ghi";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = "Vui lòng nhập đúng định dạng dd/MM/yyyy";
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateCardStatusReal(string cardCode, string status)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
                if (card != null)
                {
                    var lstSession = new List<CardSessionUser>();
                    if (!string.IsNullOrEmpty(card.LockShare))
                    {
                        lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                        var isExist = false;
                        foreach (var item in lstSession)
                        {
                            if (item.User == ESEIM.AppContext.UserName)
                            {
                                item.NewDataUpdate = false;
                                isExist = true;
                            }
                            else
                            {
                                item.NewDataUpdate = true;
                            }

                            item.TimeStamp = DateTime.Now;
                        }
                        if (!isExist)
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                    }
                    else
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }

                    var common = _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet.Equals(card.Status));
                    var commonNew = _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet.Equals(status));

                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = card.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Trạng thái từ [" + (common != null ? common.ValueSet : "Trống")
                            + "] sang [" + (commonNew != null ? commonNew.ValueSet : "") + "]"
                    };
                    _context.CardUserActivities.Add(activity);

                    card.Status = status;
                    card.LockShare = JsonConvert.SerializeObject(lstSession);
                    _context.SaveChanges();
                    msg.Title = "Cập nhật trạng thái thành công";
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy bản ghi";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateCardLevelReal(string cardCode, string cardLevel)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
                if (card != null)
                {
                    var lstSession = new List<CardSessionUser>();
                    if (!string.IsNullOrEmpty(card.LockShare))
                    {
                        lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                        var isExist = false;
                        foreach (var item in lstSession)
                        {
                            if (item.User == ESEIM.AppContext.UserName)
                            {
                                item.NewDataUpdate = false;
                                isExist = true;
                            }
                            else
                            {
                                item.NewDataUpdate = true;
                            }

                            item.TimeStamp = DateTime.Now;
                        }
                        if (!isExist)
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                    }
                    else
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }

                    var commonNew = _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet.Equals(cardLevel));
                    var level = "";
                    if (!string.IsNullOrEmpty(card.CardLevel))
                    {
                        var common = _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet.Equals(card.CardLevel));
                        level = common != null ? common.ValueSet : "";
                    }

                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = card.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Độ ưu tiên từ [" + level
                            + "] sang [" + (commonNew != null ? commonNew.ValueSet : "") + "]"
                    };
                    _context.CardUserActivities.Add(activity);

                    card.CardLevel = cardLevel;
                    card.LockShare = JsonConvert.SerializeObject(lstSession);
                    _context.SaveChanges();
                    msg.Title = "Cập nhật độ ưu tiên thành công";
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy bản ghi";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateCardWorkTypeReal(string cardCode, string worktype)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
                if (card != null)
                {
                    var lstSession = new List<CardSessionUser>();
                    if (!string.IsNullOrEmpty(card.LockShare))
                    {
                        lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                        var isExist = false;
                        foreach (var item in lstSession)
                        {
                            if (item.User == ESEIM.AppContext.UserName)
                            {
                                item.NewDataUpdate = false;
                                isExist = true;
                            }
                            else
                            {
                                item.NewDataUpdate = true;
                            }

                            item.TimeStamp = DateTime.Now;
                        }
                        if (!isExist)
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                    }
                    else
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }

                    var commonNew = _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet.Equals(worktype));
                    var workType = "";
                    if (!string.IsNullOrEmpty(card.WorkType))
                    {
                        var common = _context.CommonSettings.FirstOrDefault(x => !x.IsDeleted && x.CodeSet.Equals(card.WorkType));
                        workType = common != null ? common.ValueSet : "";
                    }

                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = card.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Kiểu công việc từ [" + workType
                            + "] sang [" + (commonNew != null ? commonNew.ValueSet : "") + "]"
                    };
                    _context.CardUserActivities.Add(activity);

                    card.WorkType = worktype;
                    card.LockShare = JsonConvert.SerializeObject(lstSession);
                    _context.SaveChanges();
                    msg.Title = "Cập nhật kiểu công việc thành công";
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy bản ghi";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateWeightNumReal(string cardCode, decimal weight)
        {
            var msg = new JMessage() { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode == cardCode && x.IsDeleted == false);
                if (card != null)
                {
                    var getSumWeightNum = _context.WORKOSCards.Where(x => x.ListCode == card.ListCode && x.CardCode != card.CardCode && x.IsDeleted == false).Sum(x => x.WeightNum);
                    if ((getSumWeightNum + weight) > 100)
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["CJ_MSG_MAXIMUM_WEIGHT"] + " " + (100 - getSumWeightNum) + " % !";
                    }
                    else if (weight < 0)
                    {
                        msg.Error = true;
                        msg.Title = "Vui lòng nhập trọng số dương";
                    }
                    else
                    {
                        var lstSession = new List<CardSessionUser>();
                        if (!string.IsNullOrEmpty(card.LockShare))
                        {
                            lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                            var isExist = false;
                            foreach (var item in lstSession)
                            {
                                if (item.User == ESEIM.AppContext.UserName)
                                {
                                    item.NewDataUpdate = false;
                                    isExist = true;
                                }
                                else
                                {
                                    item.NewDataUpdate = true;
                                }

                                item.TimeStamp = DateTime.Now;
                            }
                            if (!isExist)
                            {
                                var cardSession = new CardSessionUser
                                {
                                    User = ESEIM.AppContext.UserName,
                                    TimeStamp = DateTime.Now,
                                    NewDataUpdate = false
                                };
                                lstSession.Add(cardSession);
                            }
                        }
                        else
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }

                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "UPDATE",
                            IdObject = "ITEMWORK",
                            IsCheck = true,
                            CardCode = card.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = "Trọng số từ [" + card.WeightNum + "] sang [" + weight + "]"
                        };
                        _context.CardUserActivities.Add(activity);

                        card.WeightNum = weight;
                        card.LockShare = JsonConvert.SerializeObject(lstSession);
                        _context.SaveChanges();
                        msg.Title = "Cập nhật trọng số thành công";
                        msg.Object = _cardService.UpdatePercentParentCard(card.CardCode);
                    }
                }
                else
                {
                    msg.Error = true;
                    msg.Title = _stringLocalizer["CJ_MSG_CARD_NOT_EXISTS"];
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateDescriptionReal([FromBody] CardDesCription obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(obj.CardCode));
                if (card != null)
                {
                    var lstSession = new List<CardSessionUser>();
                    if (!string.IsNullOrEmpty(card.LockShare))
                    {
                        lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                        var isExist = false;
                        foreach (var item in lstSession)
                        {
                            if (item.User == ESEIM.AppContext.UserName)
                            {
                                item.NewDataUpdate = false;
                                isExist = true;
                            }
                            else
                            {
                                item.NewDataUpdate = true;
                            }

                            item.TimeStamp = DateTime.Now;
                        }
                        if (!isExist)
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                    }
                    else
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "DESCRIPTION",
                        IsCheck = true,
                        CardCode = card.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Mô tả từ [" + string.Concat(card.Description?.Take(20) ?? "") + "] sang [" + string.Concat(obj.Description?.Take(20) ?? "") + "]"
                    };
                    _context.CardUserActivities.Add(activity);

                    card.Description = obj.Description;
                    card.LockShare = JsonConvert.SerializeObject(lstSession);
                    _context.SaveChanges();
                    msg.Title = "Cập nhật mô tả thành công";
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy bản ghi";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateListReal(string cardCode, string listCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));

                var getSumWeightNum = _context.WORKOSCards.Where(x => x.ListCode == listCode && x.IsDeleted == false).Sum(x => x.WeightNum);


                if (card != null)
                {
                    var lstSession = new List<CardSessionUser>();
                    if (!string.IsNullOrEmpty(card.LockShare))
                    {
                        lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                        var isExist = false;
                        foreach (var item in lstSession)
                        {
                            if (item.User == ESEIM.AppContext.UserName)
                            {
                                item.NewDataUpdate = false;
                                isExist = true;
                            }
                            else
                            {
                                item.NewDataUpdate = true;
                            }

                            item.TimeStamp = DateTime.Now;
                        }
                        if (!isExist)
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                    }
                    else
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }
                    if ((getSumWeightNum + card.WeightNum) > 100)
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["CJ_MSG_MAXIMUM_WEIGHT"] + " " + (100 - getSumWeightNum) + " % !";
                    }
                    else
                    {
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "UPDATE",
                            IdObject = "ITEMWORK",
                            IsCheck = true,
                            CardCode = card.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = "Danh mục công việc từ [" + _context.WORKOSLists.FirstOrDefault(x => !x.IsDeleted && x.ListCode.Equals(card.ListCode)).ListName ?? ""
                                + "] sang [" + (_context.WORKOSLists.FirstOrDefault(x => !x.IsDeleted && x.ListCode.Equals(listCode)).ListName ?? "") + "]"
                        };

                        _context.CardUserActivities.Add(activity);

                        card.ListCode = listCode;
                        card.LockShare = JsonConvert.SerializeObject(lstSession);
                        _context.SaveChanges();
                        msg.Title = "Cập nhật danh mục công việc thành công";
                        msg.Object = _cardService.UpdatePercentParentCard(card.CardCode);
                    }
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy bản ghi";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult UpdateCardInheritReal(string cardCode, string inherit)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
                if (card != null)
                {
                    var lstSession = new List<CardSessionUser>();
                    if (!string.IsNullOrEmpty(card.LockShare))
                    {
                        lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                        var isExist = false;
                        foreach (var item in lstSession)
                        {
                            if (item.User == ESEIM.AppContext.UserName)
                            {
                                item.NewDataUpdate = false;
                                isExist = true;
                            }
                            else
                            {
                                item.NewDataUpdate = true;
                            }

                            item.TimeStamp = DateTime.Now;
                        }
                        if (!isExist)
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                    }
                    else
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }

                    var cardInherit = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(inherit));

                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = card.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Thẻ kế thừa  từ [" + card.CardName
                                + "] sang [" + (cardInherit != null ? cardInherit.CardName : "") + "]"
                    };

                    _context.CardUserActivities.Add(activity);
                    card.Inherit = inherit;
                    card.LockShare = JsonConvert.SerializeObject(lstSession);
                    _context.SaveChanges();
                    msg.Title = "Cập nhật thẻ kế thừa thành công";
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy bản ghi";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        //[HttpPost]
        //public JsonResult UpdateIsRecurrentReal(string cardCode, bool isRecurrent)
        //{
        //    var msg = new JMessage { Error = false, Title = "" };
        //    try
        //    {
        //        var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
        //        if (card != null)
        //        {
        //            var lstSession = new List<CardSessionUser>();
        //            if (!string.IsNullOrEmpty(card.LockShare))
        //            {
        //                lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
        //                var isExist = false;
        //                foreach (var item in lstSession)
        //                {
        //                    if (item.User == ESEIM.AppContext.UserName)
        //                    {
        //                        item.NewDataUpdate = false;
        //                        isExist = true;
        //                    }
        //                    else
        //                    {
        //                        item.NewDataUpdate = true;
        //                    }

        //                    item.TimeStamp = DateTime.Now;
        //                }
        //                if (!isExist)
        //                {
        //                    var cardSession = new CardSessionUser
        //                    {
        //                        User = ESEIM.AppContext.UserName,
        //                        TimeStamp = DateTime.Now,
        //                        NewDataUpdate = false
        //                    };
        //                    lstSession.Add(cardSession);
        //                }
        //            }
        //            else
        //            {
        //                var cardSession = new CardSessionUser
        //                {
        //                    User = ESEIM.AppContext.UserName,
        //                    TimeStamp = DateTime.Now,
        //                    NewDataUpdate = false
        //                };
        //                lstSession.Add(cardSession);
        //            }
        //            var activity = new CardUserActivity
        //            {
        //                UserId = ESEIM.AppContext.UserId,
        //                Action = "UPDATE",
        //                IdObject = "ITEMWORK",
        //                IsCheck = true,
        //                CardCode = card.CardCode,
        //                CreatedTime = DateTime.Now,
        //                FromDevice = "Laptop/Desktop",
        //                ChangeDetails = "Kiểu lặp lại"
        //            };
        //            _context.CardUserActivities.Add(activity);

        //            card.IsRecurrent = isRecurrent;
        //            card.LockShare = JsonConvert.SerializeObject(lstSession);

        //            _context.SaveChanges();
        //            msg.Title = "Cập nhật kiểu lặp lại thành công";
        //        }
        //        else
        //        {
        //            msg.Error = true;
        //            msg.Title = "Không tìm thấy bản ghi";
        //        }
        //    }
        //    catch (Exception ex)
        //    {
        //        msg.Error = true;
        //        msg.Title = _sharedResources["COM_MSG_ERR"];
        //    }
        //    return Json(msg);
        //}

        [HttpPost]
        public JsonResult UpdateCardCycleReal(string cardCode, string cycleCode)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
                if (card != null)
                {
                    var lstSession = new List<CardSessionUser>();
                    if (!string.IsNullOrEmpty(card.LockShare))
                    {
                        lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                        var isExist = false;
                        foreach (var item in lstSession)
                        {
                            if (item.User == ESEIM.AppContext.UserName)
                            {
                                item.NewDataUpdate = false;
                                isExist = true;
                            }
                            else
                            {
                                item.NewDataUpdate = true;
                            }

                            item.TimeStamp = DateTime.Now;
                        }
                        if (!isExist)
                        {
                            var cardSession = new CardSessionUser
                            {
                                User = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now,
                                NewDataUpdate = false
                            };
                            lstSession.Add(cardSession);
                        }
                    }
                    else
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }
                    var activity = new CardUserActivity
                    {
                        UserId = ESEIM.AppContext.UserId,
                        Action = "UPDATE",
                        IdObject = "ITEMWORK",
                        IsCheck = true,
                        CardCode = card.CardCode,
                        CreatedTime = DateTime.Now,
                        FromDevice = "Laptop/Desktop",
                        ChangeDetails = "Chu kỳ thẻ việc"
                    };
                    _context.CardUserActivities.Add(activity);

                    card.Cycle = cycleCode;
                    card.LockShare = JsonConvert.SerializeObject(lstSession);

                    _context.SaveChanges();
                    msg.Title = "Cập nhật chu kỳ thẻ việc thành công";
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Không tìm thấy bản ghi";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public bool IsUpdateNewData(string cardCode, string timeUpdate)
        {
            DateTime? timeUpdateDt = !string.IsNullOrEmpty(timeUpdate)
                ? DateTime.ParseExact(timeUpdate, "dd/MM/yyyy HH:mm", CultureInfo.InvariantCulture) : (DateTime?)null;
            bool isUpdate = false;
            var card = _context.WORKOSCards.FirstOrDefault(x => x.CardCode.Equals(cardCode) && !x.IsDeleted);
            if (card != null)
            {
                if (!string.IsNullOrEmpty(card.LockShare))
                {
                    var lst = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                    foreach (var item in lst)
                    {
                        if (!string.IsNullOrEmpty(item.User) && item.User.Equals(ESEIM.AppContext.UserName))
                        {
                            isUpdate = item.NewDataUpdate || (timeUpdateDt.HasValue && item.TimeStamp > timeUpdateDt.Value);
                            if (isUpdate)
                            {
                                item.NewDataUpdate = false;
                                card.LockShare = JsonConvert.SerializeObject(lst);
                                _context.SaveChanges();
                            }
                            break;
                        }
                    }
                }
            }
            return isUpdate;
        }

        [NonAction]
        private void UpdateChangeCard(string cardCode)
        {
            var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
            if (card != null)
            {
                var lstSession = new List<CardSessionUser>();
                if (!string.IsNullOrEmpty(card.LockShare))
                {
                    lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                    var isExist = false;
                    foreach (var item in lstSession)
                    {
                        if (item.User == ESEIM.AppContext.UserName)
                        {
                            item.NewDataUpdate = false;
                            isExist = true;
                        }
                        else
                        {
                            item.NewDataUpdate = true;
                        }

                        item.TimeStamp = DateTime.Now;
                    }
                    if (!isExist)
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }
                }
                else
                {
                    var cardSession = new CardSessionUser
                    {
                        User = ESEIM.AppContext.UserName,
                        TimeStamp = DateTime.Now,
                        NewDataUpdate = false
                    };
                    lstSession.Add(cardSession);
                }
                card.LockShare = JsonConvert.SerializeObject(lstSession);
            }
        }

        [HttpPost]
        public void AutoUpdateLockShareJson(string cardCode)
        {
            var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(cardCode));
            if (card != null)
            {
                var lstSession = new List<CardSessionUser>();
                if (!string.IsNullOrEmpty(card.LockShare))
                {
                    lstSession = JsonConvert.DeserializeObject<List<CardSessionUser>>(card.LockShare);
                    var isExist = false;
                    foreach (var item in lstSession)
                    {
                        if (item.User == ESEIM.AppContext.UserName)
                        {
                            item.NewDataUpdate = false;
                            isExist = true;
                        }

                        item.TimeStamp = DateTime.Now;
                    }
                    if (!isExist)
                    {
                        var cardSession = new CardSessionUser
                        {
                            User = ESEIM.AppContext.UserName,
                            TimeStamp = DateTime.Now,
                            NewDataUpdate = false
                        };
                        lstSession.Add(cardSession);
                    }
                }
                else
                {
                    var cardSession = new CardSessionUser
                    {
                        User = ESEIM.AppContext.UserName,
                        TimeStamp = DateTime.Now,
                        NewDataUpdate = false
                    };
                    lstSession.Add(cardSession);
                }
                card.LockShare = JsonConvert.SerializeObject(lstSession);
            }
            _context.SaveChanges();
        }

        public class CardSessionUser
        {
            public string User { get; set; }
            public bool NewDataUpdate { get; set; }
            public DateTime TimeStamp { get; set; }
        }

        public class CardDesCription
        {
            public string CardCode { get; set; }
            public string Description { get; set; }
        }
        #endregion

        #region Rollback card realtime
        [HttpPost]
        public JsonResult RollbackCard([FromBody] RollbackInfoCard obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var card = _context.WORKOSCards.FirstOrDefault(x => !x.IsDeleted && x.CardCode.Equals(obj.CardHeader.CardCode));
                if (card != null)
                {
                    //Rollback header card
                    RollbackHeaderCard(card, obj.CardHeader);

                    //Rollback item check of card
                    RollbackItemChkCard(card, obj.ListChkItemRollback);

                    //Rollback comment
                    RollbackCommentCard(card, obj.Comment);

                    //Rollback Object
                    RollbackObjectCard(card, obj.ObjectRela);

                    //Rollback service
                    RollbackServiceCard(card, obj.Services);

                    //Rollback product
                    RollbackProductCard(card, obj.Products);

                    //Rollback address
                    RollbackAddressCard(card, obj.AddressCard);

                    //Rollback card link
                    RollbackCardLinkFunc(card, obj.CardLinks);

                    UpdateChangeCard(card.CardCode);

                    _context.SaveChanges();
                    msg.Title = "Khôi phục thẻ việc thành công!";
                    msg.Object = _cardService.UpdatePercentParentCard(card.CardCode);
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Thẻ việc không tồn tại";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [NonAction]
        private void RollbackHeaderCard(WORKOSCard card, CardRollback obj)
        {
            var session = HttpContext.GetSessionUser();
            if (session.IsAllData || card.CreatedBy.Equals(ESEIM.AppContext.UserName))
            {
                var endTime = !string.IsNullOrEmpty(obj.EndTime) ? DateTime.ParseExact(obj.EndTime, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
                var deadline = !string.IsNullOrEmpty(obj.Deadline) ? DateTime.ParseExact(obj.Deadline, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;
                var beginTime = !string.IsNullOrEmpty(obj.BeginTime) ? DateTime.ParseExact(obj.BeginTime, "dd/MM/yyyy", CultureInfo.InvariantCulture) : (DateTime?)null;

                card.CardName = obj.CardName;
                card.BeginTime = beginTime.Value;
                card.Deadline = deadline.Value;
                card.EndTime = endTime;
                card.CardLevel = obj.CardLevel;
                card.WorkType = obj.WorkType;
                card.Completed = obj.Completed;
                card.WeightNum = obj.WeightNum;
                card.ListCode = obj.ListCode;
                card.Status = obj.Status;
                card.IsLock = obj.IsLock;
            }
            card.Description = obj.Description;
        }

        [NonAction]
        private void RollbackItemChkCard(WORKOSCard card, List<ItemRollback> listItemChk)
        {
            var currentChkList = _context.CardItemChecks.Where(x => x.CardCode.Equals(card.CardCode) && !x.Flag);
            foreach (var item in currentChkList)
            {
                if (!listItemChk.Any(x => x.ChkListCode.Equals(item.ChkListCode)))
                {
                    item.Flag = true;
                    item.DeletedBy = ESEIM.AppContext.UserName;
                    item.DeletedTime = DateTime.Now;
                    _context.CardItemChecks.Update(item);
                    var subs = _context.CardSubitemChecks.Where(x => !x.Flag && x.ChkListCode.Equals(item.ChkListCode));
                    foreach (var sub in subs)
                    {
                        sub.Flag = true;
                        _context.CardSubitemChecks.Update(sub);
                    }
                }
            }

            foreach (var item in listItemChk)
            {
                var chkList = _context.CardItemChecks.FirstOrDefault(x => x.ChkListCode.Equals(item.ChkListCode));
                if (chkList != null)
                {
                    chkList.CheckTitle = item.CheckTitle;
                    chkList.Completed = item.Completed;
                    chkList.Constraint = item.Constraint;
                    chkList.WeightNum = item.WeightNum;
                    chkList.Flag = false;
                    _context.CardItemChecks.Update(chkList);

                    var subs = _context.CardSubitemChecks.Where(x => !x.Flag && x.ChkListCode.Equals(item.ChkListCode));
                    foreach (var sub in subs)
                    {
                        if (!item.ListSubItem.Any(x => x.Id == sub.Id))
                        {
                            sub.Flag = true;
                            _context.CardSubitemChecks.Update(sub);
                        }
                    }
                    foreach (var subItem in item.ListSubItem)
                    {
                        var chkSubItem = _context.CardSubitemChecks.FirstOrDefault(x => x.Id.Equals(subItem.Id));
                        if (chkSubItem != null)
                        {
                            chkSubItem.Completed = subItem.Completed;
                            chkSubItem.Title = subItem.Title;
                            chkSubItem.WeightNum = subItem.WeightNum;
                            chkSubItem.Approve = subItem.Approve;
                            chkSubItem.Approver = subItem.Approver;
                            chkSubItem.ApprovedTime = subItem.ApprovedTime;
                            _context.CardSubitemChecks.Update(chkSubItem);
                        }
                    }
                }
            }
        }

        [NonAction]
        private void RollbackCommentCard(WORKOSCard card, List<RollbackComment> listComment)
        {
            var currentComment = _context.CardCommentLists.Where(x => x.CardCode.Equals(card.CardCode) && !x.Flag
                    && x.MemberId.Equals(ESEIM.AppContext.UserName));
            foreach (var item in currentComment)
            {
                if (!listComment.Any(x => x.Id == item.Id))
                {
                    item.Flag = true;
                    _context.CardCommentLists.Update(item);
                }
            }

            foreach (var item in listComment)
            {
                if (item.MemberId.Equals(ESEIM.AppContext.UserName))
                {
                    var comment = _context.CardCommentLists.FirstOrDefault(x => x.Id == item.Id);
                    if (comment != null)
                    {
                        comment.Flag = false;
                        comment.CmtContent = item.CmtContent;
                        comment.UpdatedTime = item.UpdatedTime;
                        _context.CardCommentLists.Update(comment);
                    }
                }
            }
        }

        [NonAction]
        private void RollbackObjectCard(WORKOSCard card, List<int> ids)
        {
            var relas = _context.JcObjectIdRelatives.Where(x => !x.IsDeleted && x.CardCode.Equals(card.CardCode));
            foreach (var item in relas)
            {
                if (!ids.Any(x => x == item.ID))
                {
                    item.IsDeleted = true;
                    item.DeletedBy = ESEIM.AppContext.UserName;
                    item.DeletedTime = DateTime.Now;
                    _context.JcObjectIdRelatives.Update(item);
                }
            }
            foreach (var item in ids)
            {
                var jcId = _context.JcObjectIdRelatives.FirstOrDefault(x => x.ID == item);
                if (jcId != null)
                {
                    jcId.IsDeleted = false;
                    _context.JcObjectIdRelatives.Update(jcId);
                }
            }
        }

        [NonAction]
        private void RollbackProductCard(WORKOSCard card, List<RollbackProduct> products)
        {
            var currentProducts = _context.JcProducts.Where(x => !x.IsDeleted && x.CardCode.Equals(card.CardCode));
            foreach (var item in currentProducts)
            {
                if (!products.Any(x => x.ID == item.ID))
                {
                    item.IsDeleted = true;
                    item.DeletedBy = ESEIM.AppContext.UserName;
                    item.DeletedTime = DateTime.Now;
                    _context.JcProducts.Update(item);
                }
            }

            foreach (var item in products)
            {
                var jcProd = _context.JcProducts.FirstOrDefault(x => x.ID == item.ID);
                if (jcProd != null)
                {
                    jcProd.Quantity = item.Quantity;
                    jcProd.IsDeleted = false;
                    _context.JcProducts.Update(jcProd);
                }
            }
        }

        [NonAction]
        private void RollbackServiceCard(WORKOSCard card, List<RollbackService> services)
        {
            var currentServices = _context.JcServices.Where(x => !x.IsDeleted && x.CardCode.Equals(card.CardCode));
            foreach (var item in currentServices)
            {
                if (!services.Any(x => x.ID == item.ID))
                {
                    item.IsDeleted = true;
                    item.DeletedBy = ESEIM.AppContext.UserName;
                    item.DeletedTime = DateTime.Now;
                    _context.JcServices.Update(item);
                }
            }

            foreach (var item in services)
            {
                var jcProd = _context.JcServices.FirstOrDefault(x => x.ID == item.ID);
                if (jcProd != null)
                {
                    jcProd.Quantity = item.Quantity;
                    jcProd.IsDeleted = false;
                    _context.JcServices.Update(jcProd);
                }
            }
        }

        [NonAction]
        private void RollbackAddressCard(WORKOSCard card, List<RollbackAddress> address)
        {
            var currentAddress = _context.WORKOSAddressCards.Where(x => !x.IsDeleted && x.CardCode.Equals(card.CardCode));
            foreach (var item in currentAddress)
            {
                if (!address.Any(x => x.Id == item.Id))
                {
                    item.IsDeleted = true;
                    item.DeletedBy = ESEIM.AppContext.UserName;
                    item.DeletedTime = DateTime.Now;
                    _context.WORKOSAddressCards.Update(item);
                }
            }

            foreach (var item in address)
            {
                var adss = _context.WORKOSAddressCards.FirstOrDefault(x => x.Id == item.Id);
                if (adss != null)
                {
                    adss.IsDeleted = false;
                    _context.WORKOSAddressCards.Update(adss);
                }
            }
        }

        [NonAction]
        private void RollbackCardLinkFunc(WORKOSCard card, List<RollbackCardLink> links)
        {
            var currentLinks = _context.JobCardLinks.Where(x => !x.IsDeleted && x.CardCode.Equals(card.CardCode));
            foreach (var item in currentLinks)
            {
                if (!links.Any(x => x.Id == item.Id))
                {
                    item.IsDeleted = true;
                    item.DeletedBy = ESEIM.AppContext.UserName;
                    item.DeletedTime = DateTime.Now;
                    _context.JobCardLinks.Update(item);
                }
            }

            foreach (var item in links)
            {
                var link = _context.JobCardLinks.FirstOrDefault(x => x.Id == item.Id);
                if (link != null)
                {
                    link.IsDeleted = false;
                    _context.JobCardLinks.Update(link);
                }
            }
        }

        public class RollbackInfoCard
        {
            public RollbackInfoCard()
            {
                ListChkItemRollback = new List<ItemRollback>();
                Comment = new List<RollbackComment>();
                ObjectRela = new List<int>();
                Products = new List<RollbackProduct>();
                Services = new List<RollbackService>();
                AddressCard = new List<RollbackAddress>();
                CardLinks = new List<RollbackCardLink>();
            }
            public CardRollback CardHeader { get; set; }
            public List<RollbackComment> Comment { get; set; }
            public List<ItemRollback> ListChkItemRollback { get; set; }
            public List<int> ObjectRela { get; set; }
            public List<RollbackProduct> Products { get; set; }
            public List<RollbackService> Services { get; set; }
            public List<RollbackAddress> AddressCard { get; set; }
            public List<RollbackCardLink> CardLinks { get; set; }
        }

        public class RollbackComment
        {
            public int Id { get; set; }
            public string GivenName { get; set; }
            public string Picture { get; set; }
            public string MemberId { get; set; }
            public string CmtContent { get; set; }
            public DateTime? CreatedTime { get; set; }
            public DateTime? UpdatedTime { get; set; }
            public string CardCode { get; set; }
            public string UpdatedBy { get; set; }
        }

        public class RollbackProduct
        {
            public int ID { get; set; }
            public DateTime CreatedTime { get; set; }
            public int Quantity { get; set; }
            public string ProductCode { get; set; }
            public string ProductName { get; set; }
        }

        public class RollbackService
        {
            public int ID { get; set; }
            public DateTime CreatedTime { get; set; }
            public int Quantity { get; set; }
            public string ServiceCode { get; set; }
            public string ServiceName { get; set; }
        }

        public class RollbackAddress
        {
            public int Id { get; set; }
            public string LocationGps { get; set; }
            public string LocationText { get; set; }
            public string CreatedBy { get; set; }
            public DateTime CreatedTime { get; set; }
        }

        public class RollbackCardLink
        {
            public int Id { get; set; }
            public string CardCode { get; set; }
            public string CardName { get; set; }
        }

        public class CardRollback
        {
            public string CardCode { get; set; }
            public string CardName { get; set; }
            public string ListCode { get; set; }
            public decimal Completed { get; set; }
            public string BeginTime { get; set; }
            public string Deadline { get; set; }
            public string EndTime { get; set; }
            public string Status { get; set; }
            public string CardLevel { get; set; }
            public string WorkType { get; set; }
            public decimal WeightNum { get; set; }
            public decimal Cost { get; set; }
            public string Currency { get; set; }
            public string Description { get; set; }
            public bool IsLock { get; set; }
        }

        public class UserAssignItemRollBack
        {
            public int ID { get; set; }
            public string UserId { get; set; }
            public string UserName { get; set; }
            public string GivenName { get; set; }
            public string EstimateTime { get; set; }
            public string Status { get; set; }
            public string Unit { get; set; }
            public string CreatedBy { get; set; }
            public DateTime CreatedTime { get; set; }
        }

        public class SubItemRollBack
        {
            public SubItemRollBack()
            {
                ListUserSubItem = new List<UserAssignItemRollBack>();
            }
            public int Id { get; set; }
            public string Title { get; set; }
            public string Approver { get; set; }
            public bool Approve { get; set; }
            public DateTime? ApprovedTime { get; set; }
            public decimal Completed { get; set; }
            public decimal WeightNum { get; set; }
            public List<UserAssignItemRollBack> ListUserSubItem { get; set; }
        }

        public class ItemRollback
        {
            public ItemRollback()
            {
                ListSubItem = new List<SubItemRollBack>();
                ListUserItemChk = new List<UserAssignItemRollBack>();
            }
            public int Id { get; set; }
            public string ChkListCode { get; set; }
            public string CheckTitle { get; set; }
            public decimal Completed { get; set; }
            public decimal WeightNum { get; set; }
            public bool checkItem { get; set; }
            public string TitleSubItemChk { get; set; }
            public string Note { get; set; }
            public string CreatedBy { get; set; }
            public DateTime CreatedTime { get; set; }
            public string Constraint { get; set; }
            public List<UserAssignItemRollBack> ListUserItemChk { get; set; }
            public List<SubItemRollBack> ListSubItem { get; set; }
            public string ListObject { get; set; }
        }
        #endregion

        #region Manager notification
        [NonAction]
        public JsonResult InsertNotification([FromBody] NotificationManager obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var check = _context.NotificationManagers.Any(x => !x.IsDeleted && x.ObjCode.Equals(obj.ObjCode) && x.ObjType.Equals(obj.ObjType));
                if (!check)
                {
                    obj.NotifyCode = string.Format("NOTIFI_{0}", DateTime.Now.ToString("ddMMyyyyHHmmss"));
                    obj.CreatedBy = User.Identity.Name;
                    obj.CreatedTime = DateTime.Now;
                    _context.NotificationManagers.Add(obj);
                    _context.SaveChanges();
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Thông báo đã tồn tại";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [NonAction]
        public JsonResult UpdateNotification([FromBody] NotificationManager obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var notifiManager = _context.NotificationManagers.FirstOrDefault(x => !x.IsDeleted && x.ObjCode.Equals(obj.ObjCode) && x.ObjType.Equals(obj.ObjType));
                if (notifiManager != null)
                {
                    var listDelete = notifiManager.ListUser.Where(x => !obj.ListUser.Any(p => p.UserId.Equals(x.UserId))).ToList();
                    var listInsert = obj.ListUser.Where(x => !notifiManager.ListUser.Any(p => p.UserId.Equals(x.UserId))).ToList();
                    if (listInsert.Count > 0)
                        notifiManager.ListUser.AddRange(listInsert);

                    foreach (var item in listDelete)
                    {
                        notifiManager.ListUser.Remove(item);
                    }

                    notifiManager.UpdatedBy = User.Identity.Name;
                    notifiManager.UpdatedTime = DateTime.Now;
                    _context.NotificationManagers.Update(notifiManager);
                    _context.SaveChanges();
                }
                else
                {
                    InsertNotification(obj);
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [NonAction]
        public JsonResult RemoveUserInNotify(string objCode, string objType, bool delete)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var notifiManager = _context.NotificationManagers.FirstOrDefault(x => !x.IsDeleted && x.ObjCode.Equals(objCode) && x.ObjType.Equals(objType));
                if (notifiManager != null)
                {
                    var listDelete = notifiManager.ListUser.Where(x => x.UserId.Equals(ESEIM.AppContext.UserId)).ToList();
                    foreach (var item in listDelete)
                    {
                        notifiManager.ListUser.Remove(item);
                    }

                    if (notifiManager.ListUser.Count == 0 || delete)
                    {
                        notifiManager.IsDeleted = true;
                        notifiManager.DeletedBy = User.Identity.Name;
                        notifiManager.DeletedTime = DateTime.Now;
                    }

                    notifiManager.UpdatedBy = User.Identity.Name;
                    notifiManager.UpdatedTime = DateTime.Now;
                    _context.NotificationManagers.Update(notifiManager);
                    _context.SaveChanges();
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [NonAction]
        public bool GetIsReadNotification(string objCode, List<NotificationManager> managers)
        {
            var isRead = true;
            try
            {
                var notifiManager = managers.FirstOrDefault(x => x.ObjCode.Equals(objCode));
                if (notifiManager != null)
                {
                    if (notifiManager.ListUser.Any(p => p.UserId.Equals(ESEIM.AppContext.UserId)))
                        isRead = false;
                }
            }
            catch (Exception ex)
            {
            }
            return isRead;
        }
        #endregion

        #region Upgrade item work
        [HttpGet]
        public JsonResult GetItemCheckRpt(string cardCode)
        {
            var data = _context.CardItemChecks
                .Where(x => !x.Flag && x.CardCode.Equals(cardCode))
                .Select(x => new ReportItem
                {
                    Code = x.ChkListCode,
                    Name = x.CheckTitle,
                    Leader = 0,
                    CountUser = _context.WorkItemAssignStaffs.Where(y => y.CheckListCode == x.ChkListCode).Count(),
                    IsUserIn = _context.WorkItemAssignStaffs.Any(y => y.UserId == ESEIM.AppContext.UserId && y.CheckListCode == x.ChkListCode),
                    //Staff = 0,
                    Note = "",
                    Desc = ""
                });
            return Json(data.Where(x => x.CountUser == 0 || x.IsUserIn == true));
        }

        [HttpPost]
        public JsonResult InserReportSession([FromBody] ReportSession obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var count = 0;
                foreach (var item in obj.ListReportItem)
                {
                    if (item.Staff > 100 || item.Leader > 100)
                    {
                        msg.Error = true;
                        msg.Title = "Vui lòng kiểm tra lại dữ liệu báo cáo hoặc duyệt tiến độ";
                        return Json(msg);
                    }

                    if (item.Staff > 0 && item.Leader >= 0 && item.Leader <= 100 && item.Staff >= 0 && item.Staff <= 100)
                    {
                        var sumStaff = _context.SessionWorkResults
                            .Where(x => !x.IsDeleted && x.ChkListCode.Equals(item.Code)).Sum(x => x.ProgressFromStaff);
                        var sumLeader = _context.SessionWorkResults
                            .Where(x => !x.IsDeleted && x.ChkListCode.Equals(item.Code)).Sum(x => x.ProgressFromLeader);
                        if (item.Staff + sumStaff > 100 || item.Leader + sumLeader > 100)
                        {
                            msg.Error = true;
                            msg.Title = "Vui lòng kiểm tra lại dữ liệu báo cáo hoặc duyệt tiến độ";
                            return Json(msg);
                        }
                        var listSubItem = _context.CardSubitemChecks.Where(x => !x.Flag && x.ChkListCode.Equals(item.Code)).ToList();

                        var sessionItemChkItem = new SessionWork
                        {
                            Session = obj.WorkSession,
                            ItemType = "1",
                            Item = item.Code,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            Desc = obj.Desc
                        };
                        _context.SessionWorks.Add(sessionItemChkItem);

                        var itemStaff = new SessionWorkResult
                        {
                            WorkSession = obj.WorkSession,
                            ProgressFromStaff = item.Staff.Value,
                            ProgressFromLeader = item.Leader.Value,
                            NoteFromLeader = item.Note,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            ShiftCode = "",
                            CardCode = obj.CardCode,
                            ChkListCode = item.Code,
                            ItemWorkList = item.Code,
                            ListSubItem = JsonConvert.SerializeObject(listSubItem)
                        };
                        _context.SessionWorkResults.Add(itemStaff);

                        var cardItem = _context.CardItemChecks.FirstOrDefault(x => x.ChkListCode.Equals(item.Code) && !x.Flag);
                        var activity = new CardUserActivity
                        {
                            UserId = ESEIM.AppContext.UserId,
                            Action = "ADD",
                            IdObject = "ITEMWORK",
                            IsCheck = true,
                            CardCode = obj.CardCode,
                            CreatedTime = DateTime.Now,
                            FromDevice = "Laptop/Desktop",
                            ChangeDetails = "Cho đầu mục việc " + cardItem.CheckTitle
                        };
                        _context.CardUserActivities.Add(activity);

                        var itemCheck = _context.CardItemChecks.FirstOrDefault(x => x.ChkListCode == item.Code);
                        if (itemCheck != null)
                        {
                            itemCheck.Completed = item.Leader.Value + sumLeader;
                            _context.CardItemChecks.Update(itemCheck);
                            var data = _context.CardSubitemChecks.Where(x => x.ChkListCode == item.Code);

                            if (item.Leader + sumLeader == 100)
                            {
                                foreach (var subitemCheck in data)
                                {
                                    subitemCheck.Completed = 100;
                                    subitemCheck.Approve = true;
                                    subitemCheck.Approver = ESEIM.AppContext.UserId;
                                    subitemCheck.ApprovedTime = DateTime.Now;
                                    _context.CardSubitemChecks.Update(subitemCheck);
                                }
                            }
                            UpdateChangeCard(itemCheck.CardCode);
                        }
                    }
                    else
                    {
                        count = count + 1;
                    }
                }

                if (count == obj.ListReportItem.Count())
                {
                    msg.Error = true;
                    msg.Title = "Vui lòng kiểm tra lại dữ liệu báo cáo hoặc duyệt tiến độ";
                }
                else
                {
                    _context.SaveChanges();
                    msg.Title = _sharedResources["COM_ADD_SUCCESS"];
                }
            }
            catch (Exception ex)
            {
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpGet]
        public JsonResult GetReportSession(string cardCode)
        {
            var data = (from a in _context.SessionWorkResults.Where(x => !x.IsDeleted && x.CardCode.Equals(cardCode))
                        join b in _context.SessionWorks.Where(x => !x.IsDeleted) on a.WorkSession equals b.Session
                        join c in _context.CardItemChecks.Where(x => !x.Flag) on a.ChkListCode equals c.ChkListCode
                        select new
                        {
                            b.ID,
                            a.ProgressFromStaff,
                            a.ProgressFromLeader,
                            b.Desc,
                            a.WorkSession,
                            a.CreatedTime,
                            a.CreatedBy,
                            c.WeightNum,
                            a.ChkListCode,
                            IdResult = a.Id
                        }).DistinctBy(x => x.IdResult).GroupBy(x => x.WorkSession);

            var listReport = new List<ViewReportBySession>();
            foreach (var item in data)
            {
                var report = new ViewReportBySession();
                var users = _context.Users;
                report.Session = item.Key;

                foreach (var i in item)
                {
                    report.UserReport = i.CreatedBy;
                    report.NameReport = users.FirstOrDefault(x => x.UserName.Equals(i.CreatedBy)) != null ?
                    users.FirstOrDefault(x => x.UserName.Equals(i.CreatedBy)).GivenName : "";
                    report.TimeReport = i.CreatedTime.ToString("dd/MM/yyyy HH:mm");
                    report.Id = i.ID;
                    break;
                }
                var reportPercent = item.Count() > 0 ? item.Sum(x => (x.ProgressFromStaff * x.WeightNum) / 100) : 0;
                var approvePercent = item.Count() > 0 ? item.Sum(x => (x.ProgressFromLeader * x.WeightNum) / 100) : 0;
                report.PercentReport = Math.Round(reportPercent, 2);
                report.PercentApprove = Math.Round(approvePercent, 2);
                report.IsApproveAll = item.Any(x => x.ProgressFromLeader == 0) ? true : false;
                listReport.Add(report);
            }
            return Json(listReport);
        }

        [HttpPost]
        public JsonResult DelReportSession(int id, string createdBy)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var sysSession = HttpContext.GetSessionUser();
                var reportSession = _context.SessionWorks.FirstOrDefault(x => x.ID == id);
                if (reportSession != null)
                {
                    if (sysSession.IsAllData || reportSession.CreatedBy.Equals(sysSession.UserName))
                    {
                        reportSession.IsDeleted = true;
                        reportSession.DeletedBy = ESEIM.AppContext.UserName;
                        reportSession.DeletedTime = DateTime.Now;
                        _context.SessionWorks.Update(reportSession);

                        var reportResult = _context.SessionWorkResults.Where(x => !x.IsDeleted
                                && x.WorkSession.Equals(reportSession.Session));
                        foreach (var item in reportResult)
                        {
                            item.IsDeleted = true;
                            item.DeletedBy = ESEIM.AppContext.UserName;
                            item.DeletedTime = DateTime.Now;
                            _context.SessionWorkResults.Update(item);
                        }

                        _context.SaveChanges();
                        msg.Title = "Xóa thành công";
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = "Bạn không có quyền xóa";
                    }
                }
                else
                {
                    msg.Error = true;
                    msg.Title = "Báo tiến độ không tồn tại";
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public JsonResult GetItemSessionWork(string session, string cardCode)
        {
            var data = (from a in _context.SessionWorks.Where(x => !x.IsDeleted && x.Session.Equals(session))
                        join b in _context.SessionWorkResults.Where(x => !x.IsDeleted && x.CardCode.Equals(cardCode)) on a.Session equals b.WorkSession
                        join c in _context.CardItemChecks.Where(x => !x.Flag) on b.ChkListCode equals c.ChkListCode
                        select new ReportItem
                        {
                            IdResult = b.Id,
                            Code = c.ChkListCode,
                            Name = c.CheckTitle,
                            Leader = b.ProgressFromLeader,
                            Staff = b.ProgressFromStaff,
                            Note = b.NoteFromLeader,
                            Desc = a.Desc
                        }).DistinctBy(x => x.IdResult);
            return Json(data);
        }

        [HttpGet]
        public JsonResult GetItemReportResult(int id)
        {
            var reportResult = from a in _context.SessionWorkResults.Where(x => x.Id == id)
                               join b in _context.CardItemChecks.Where(x => !x.Flag) on a.ChkListCode equals b.ChkListCode
                               select new ReportItem
                               {
                                   Code = a.ChkListCode,
                                   Name = b.CheckTitle,
                                   Note = a.NoteFromLeader,
                                   Staff = a.ProgressFromStaff,
                                   Leader = a.ProgressFromLeader
                               };
            return Json(reportResult);
        }

        [HttpPost]
        public JsonResult UpdateReportSession([FromBody] ReportSession obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var sessionWork = _context.SessionWorks.FirstOrDefault(x => x.Session == obj.WorkSession);
                var user = _context.Users.FirstOrDefault(x => x.UserName == ESEIM.AppContext.UserName);
                if (sessionWork != null)
                {
                    sessionWork.Desc = obj.Desc;
                    sessionWork.UpdatedBy = ESEIM.AppContext.UserName;
                    sessionWork.UpdatedTime = DateTime.Now;
                    _context.SessionWorks.Update(sessionWork);
                }

                foreach (var item in obj.ListReportItem)
                {
                    var sumStaff = _context.SessionWorkResults
                        .Where(x => !x.IsDeleted && x.ChkListCode.Equals(item.Code) && !x.WorkSession.Equals(obj.WorkSession)).Sum(x => x.ProgressFromStaff);
                    if (item.Staff > 0 /*&& item.Leader >= 0 && item.Leader <= 100*/ && item.Staff >= 0 && item.Staff <= 100)
                    {
                        if (item.Staff + sumStaff > 100 || item.Leader /*+ sumLeader*/ > 100 /*|| item.Staff < item.Leader*/)
                        {
                            msg.Error = true;
                            msg.Title = "Vui lòng kiểm tra lại dữ liệu báo cáo hoặc duyệt tiến độ";
                            return Json(msg);
                        }
                        var reportResult = _context.SessionWorkResults
                            .FirstOrDefault(x => !x.IsDeleted && x.WorkSession.Equals(obj.WorkSession)
                                                              && x.ChkListCode.Equals(item.Code));
                        if (reportResult != null)
                        {
                            reportResult.ProgressFromStaff = item.Staff.Value;
                            reportResult.UpdatedBy = ESEIM.AppContext.UserName;
                            reportResult.UpdatedTime = DateTime.Now;
                            _context.SessionWorkResults.Update(reportResult);
                        }
                        _context.SaveChanges();
                        msg.Title = "Cập nhật thành công!";
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = "Vui lòng kiểm tra lại dữ liệu báo cáo hoặc duyệt tiến độ";
                        return Json(msg);
                    }
                }
            }
            catch (Exception ex)
            {
                msg.Title = "Có lỗi xảy ra!";
            }

            return Json(msg);
        }

        [HttpPost]
        public JsonResult ApproveSessionWork([FromBody] ReportSession obj)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var sessionWork = _context.SessionWorks.FirstOrDefault(x => x.Session == obj.WorkSession);
                if (sessionWork != null)
                {
                    sessionWork.Desc = obj.Desc;
                    sessionWork.UpdatedBy = ESEIM.AppContext.UserName;
                    sessionWork.UpdatedTime = DateTime.Now;
                    _context.SessionWorks.Update(sessionWork);
                }

                foreach (var item in obj.ListReportItem)
                {
                    if (item.Staff > 0 && item.Leader >= 0 && item.Leader <= 100 && item.Staff >= 0 && item.Staff <= 100)
                    {
                        var sumStaff = _context.SessionWorkResults
                            .Where(x => !x.IsDeleted && x.ChkListCode.Equals(item.Code) && !x.WorkSession.Equals(obj.WorkSession)).Sum(x => x.ProgressFromStaff);
                        var sumLeader = _context.SessionWorkResults
                            .Where(x => !x.IsDeleted && x.ChkListCode.Equals(item.Code) && !x.WorkSession.Equals(obj.WorkSession)).Sum(x => x.ProgressFromLeader);
                        if (item.Staff + sumStaff > 100 || item.Leader + sumLeader > 100)
                        {
                            msg.Error = true;
                            msg.Title = "Vui lòng kiểm tra lại dữ liệu báo cáo hoặc duyệt tiến độ";
                            return Json(msg);
                        }
                        var reportResult = _context.SessionWorkResults
                        .FirstOrDefault(x => !x.IsDeleted && x.WorkSession.Equals(obj.WorkSession)
                                        && x.ChkListCode.Equals(item.Code));
                        if (reportResult != null)
                        {
                            reportResult.NoteFromLeader = item.Note;
                            reportResult.ProgressFromLeader = item.Leader.Value;
                            reportResult.ProgressFromStaff = item.Staff.Value;
                            var listLogSession = new List<LogSessionWork>();
                            try
                            {
                                listLogSession =
                                    JsonConvert.DeserializeObject<List<LogSessionWork>>(reportResult.LogApprove);
                            }
                            catch (Exception ex)
                            {
                                Console.WriteLine(ex.Message);
                            }
                            listLogSession.Add(new LogSessionWork
                            {
                                ProgressFromStaff = item.Staff.Value,
                                ProgressFromLeader = item.Leader.Value,
                                Note = item.Note,
                                CreatedBy = ESEIM.AppContext.UserName,
                                TimeStamp = DateTime.Now
                            });
                            reportResult.LogApprove = JsonConvert.SerializeObject(listLogSession);
                            reportResult.UserAssessor = ESEIM.AppContext.UserName;
                            reportResult.ApproveTime = DateTime.Now;
                            _context.SessionWorkResults.Update(reportResult);
                        }
                        var itemCheck = _context.CardItemChecks.FirstOrDefault(x => x.ChkListCode == item.Code);
                        if (itemCheck != null)
                        {
                            itemCheck.Completed = item.Leader.Value + sumLeader;
                            _context.CardItemChecks.Update(itemCheck);
                            var data = _context.CardSubitemChecks.Where(x => x.ChkListCode == item.Code);

                            if (item.Leader + sumLeader == 100)
                            {
                                foreach (var subitemCheck in data)
                                {
                                    subitemCheck.Completed = 100;
                                    subitemCheck.Approve = true;
                                    subitemCheck.Approver = ESEIM.AppContext.UserId;
                                    subitemCheck.ApprovedTime = DateTime.Now;
                                    _context.CardSubitemChecks.Update(subitemCheck);
                                }
                            }
                            UpdateChangeCard(itemCheck.CardCode);
                        }
                    }
                }
                _context.SaveChanges();
                msg.Title = "Cập nhật thành công";
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
            return Json(msg);
        }

        [HttpPost]
        public void SetupDefaultRepoObject(string objectCode, string objectType, int? cateRepoSettingId)
        {
            var msg = new JMessage { Error = false, Title = "" };
            try
            {
                var setting = _context.EDMSCatRepoSettings.FirstOrDefault(x => x.Id == cateRepoSettingId);
                var repoDefault = _context.EDMSRepoDefaultObjects.FirstOrDefault(x => !x.IsDeleted && x.ObjectCode.Equals(objectCode) && x.ObjectType.Equals(objectType));
                if (repoDefault != null)
                {
                    if (setting != null)
                    {
                        repoDefault.ReposCode = setting.ReposCode;
                        repoDefault.CatRepoSettingId = cateRepoSettingId;
                        repoDefault.CatCode = setting.CatCode;
                        repoDefault.Path = setting.Path;
                        repoDefault.FolderId = setting.FolderId;
                        repoDefault.UpdatedBy = ESEIM.AppContext.UserName;
                        repoDefault.UpdatedTime = DateTime.Now;
                        _context.EDMSRepoDefaultObjects.Update(repoDefault);
                        msg.Title = _stringLocalizer["SUP_MSG_UPDATE_FOLDER_DEFAULT_SUCCESS"];
                        _context.SaveChanges();
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["SUP_MSG_PLS_SELECT_FOLDER"];

                    }
                }
                else
                {
                    if (setting != null)
                    {
                        var setUp = new EDMSRepoDefaultObject
                        {
                            CatCode = setting.CatCode,
                            ReposCode = setting.ReposCode,
                            FolderId = setting.FolderId,
                            Path = setting.Path,
                            ObjectCode = objectCode,
                            ObjectType = objectType,
                            CreatedBy = ESEIM.AppContext.UserName,
                            CreatedTime = DateTime.Now,
                            CatRepoSettingId = cateRepoSettingId
                        };
                        _context.EDMSRepoDefaultObjects.Add(setUp);
                        msg.Title = _stringLocalizer["SUP_MSG_SETUP_DEFAULT_FOLDER_SUCCESS"];
                        _context.SaveChanges();
                    }
                    else
                    {
                        msg.Error = true;
                        msg.Title = _stringLocalizer["SUP_PLS_SELECT_FORDER_SAVE"];
                    }
                }
            }
            catch (Exception ex)
            {
                msg.Error = true;
                msg.Title = _sharedResources["COM_MSG_ERR"];
            }
        }

        public class ReportSession
        {
            public ReportSession()
            {
                ListReportItem = new List<ReportItem>();
            }
            public List<ReportItem> ListReportItem { get; set; }
            public string Desc { get; set; }
            public string WorkSession { get; set; }
            public string CardCode { get; set; }
            public string UserName { get; set; }
            public string GoogleMap { get; set; }
            public string Address { get; set; }
            public string Image { get; set; }
        }

        public class ReportItem
        {
            public int IdResult { get; set; }
            public string Code { get; set; }
            public string Name { get; set; }
            public string Note { get; set; }
            public decimal? Staff { get; set; }
            public decimal? Leader { get; set; }
            public string Desc { get; set; }
            public int CountUser { get; set; }
            public bool? IsUserIn { get; set; }
            public string GoogleMap { get; set; }
            public string Address { get; set; }
            public decimal? WeightNum { get; set; }
        }

        public class ViewReportBySession
        {
            public int Id { get; set; }
            public string Session { get; set; }
            public string UserReport { get; set; }
            public string NameReport { get; set; }
            public string TimeReport { get; set; }
            public string UserApprove { get; set; }
            public string NameApprove { get; set; }
            public string TimeApprove { get; set; }
            public string GoogleMap { get; set; }
            public string Address { get; set; }
            public string Desc { get; set; }
            public decimal PercentReport { get; set; }
            public decimal PercentApprove { get; set; }
            public bool IsApproveAll { get; set; }
            public string Image { get; set; }
        }
        #endregion
    }
}
